<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Habitu.be ‚Äî Prototype (drops v3 ‚Ä¢ espaces)</title>
<style>
  :root{
    --bg:#f7f3ea; --card:#fffdf8; --text:#1e1f1a;
    --green:#2a7a57; --greenL:#8ec5a8; --border:#e6dfd2;
    --r:4px; --gap:8px; --shadow:0 1px 0 rgba(0,0,0,.03);
    --fs:13px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:400 var(--fs)/1.35 system-ui,-apple-system,Roboto,sans-serif; color:var(--text); background:var(--bg);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  #app{max-width:480px;margin:0 auto;min-height:100%;display:flex;flex-direction:column;position:relative}
  .heat{position:fixed;left:0;right:0;bottom:0;height:0;background:linear-gradient(0deg,var(--greenL),transparent);opacity:.35;pointer-events:none;z-index:0}

  /* Top bar */
  .top{position:sticky; top:0; background:var(--bg); z-index:6; border-bottom:1px solid var(--border);
       padding:6px var(--gap); display:flex; align-items:center; gap:8px}
  .brand{font-weight:800; cursor:pointer; display:flex; align-items:center; gap:6px}
  .brand .logo{font-size:18px}
  .navbtn, .select{font-size:12px;border:1px solid var(--border); background:#f7f3ea; border-radius:var(--r); padding:6px 10px; box-shadow:var(--shadow); cursor:pointer}
  .select{appearance:none}
  .spacer{flex:1}

  /* Day bar */
  .daysWrap{position:sticky; top:44px; background:var(--bg); z-index:5; border-bottom:1px solid var(--border);
            padding:6px var(--gap); display:flex; align-items:center; gap:6px; justify-content:space-between}
  .dateLabel{padding:8px 12px; border:1px solid var(--border); background:var(--card); border-radius:4px; box-shadow:var(--shadow);font-weight:700;
             font-variant-numeric:tabular-nums}
  .todayCount{padding:8px 12px; border:1px solid var(--border); background:var(--card); border-radius:4px; box-shadow:var(--shadow); font-weight:700}

  /* Home list */
  .list{padding:var(--gap); display:grid; grid-template-columns:1fr; gap:var(--gap); position:relative; z-index:1}
  .card{border:1px solid var(--border); background:var(--card); border-radius:var(--r); box-shadow:var(--shadow);
        display:grid; grid-template-columns:1fr 64px; overflow:hidden; transition:border .12s ease}
  .card.done{border:2px solid var(--green)}
  .content{padding:4px; display:flex; flex-direction:column; gap:4px; cursor:pointer}
  .title{font-weight:700; display:flex; align-items:center; gap:4px; font-size:13px; min-height:22px}
  .title .hint{color:#5b5b56; font-weight:500}
  .friends{margin-top:auto; display:flex; gap:6px; align-items:center; flex-wrap:wrap}
  .badge{display:flex; align-items:center; gap:6px; padding:4px 6px; border:1px solid var(--border); border-radius:var(--r); background:white; font-size:11px; line-height:1.2}

  /* Right column */
  .levelCol{padding:0 6px; display:flex; align-items:center; justify-content:center; cursor:pointer}
  .levelBtn{
    width:100%; height:60px; border-radius:var(--r); border:1px solid var(--border); background:#f7f3ea;
    display:flex; flex-direction:column; align-items:center; justify-content:center; user-select:none; line-height:1.05; position:relative
  }
  .levelBtn .big{position:absolute; top:4px; left:0; right:0; text-align:center; font-size:22px; font-weight:800}
  .levelBtn .scoreText{position:absolute; bottom:2px; left:4px; right:4px; text-align:center; font-size:22px; font-weight:800; line-height:1}

  /* Detail */
  .section{padding:var(--gap)}
  .detailHead{display:flex; align-items:center; gap:8px; position:sticky; top:0px; z-index:5; background:var(--bg); padding:6px var(--gap); border-bottom:1px solid var(--border)}
  .detailTitle{font-weight:800; font-size:16px}
  .backMini{border:1px solid var(--border); background:var(--card); border-radius:var(--r); padding:6px 10px; cursor:pointer}

  /* Tabs + views */
  .tabs{display:flex; gap:6px; padding:var(--gap); border-bottom:1px solid var(--border); background:var(--bg); position:sticky; top:80px; z-index:4}
  .tab{flex:1; text-align:center; padding:8px; border:1px solid var(--border); background:var(--card); border-radius:var(--r); cursor:pointer}
  .tab.active{outline:2px solid var(--green); font-weight:700}
  .view{display:none}
  .view.active{display:block}

  /* Rank */
  .rankHeader{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:8px}
  .rank{display:grid; gap:8px; margin-top:8px}
  .row{display:flex; justify-content:space-between; align-items:center; padding:6px; border:1px solid var(--border); background:var(--card); border-radius:var(--r)}
  .clap{cursor:pointer; user-select:none}
  .scoreEmoji{font-size:26px; font-weight:900; margin-left:4px; white-space:pre-line}
  .btnToggle{border:1px solid var(--border); background:var(--card); border-radius:var(--r); padding:6px 10px; cursor:pointer}
  .btnToggle.active{outline:2px solid var(--green)}

  /* Calendar */
  .calendarWrap{padding:0 var(--gap) var(--gap)}
  .calTop{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; gap:8px}
  .calBtn{border:1px solid var(--border); background:var(--card); border-radius:var(--r); padding:6px 10px; cursor:pointer}
  .calendar{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
  .cell{
    height:55px; display:grid; place-items:center; 
    border:1px dashed var(--border); background:var(--card); border-radius:var(--r);
    position:relative; overflow:hidden; cursor:pointer
  }
  .dayNum{position:absolute; top:4px; right:6px; font-size:10px; color:#777}
  .seedMark{position:absolute; top:18px; left:0; right:0; text-align:center; font-size:14px; line-height:1; font-weight:700}

  /* Modals (windowed on desktop) */
  .modal{position:fixed; inset:0; display:none; background:rgba(0,0,0,.2); padding:0; z-index:10;}
  .modal.on{display:flex; align-items:stretch; justify-content:stretch;}
  .sheet{position:absolute; inset:0; background:var(--card); border-radius:0}
  .sheetHeader{position:sticky; top:0; display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px var(--gap); border-bottom:1px solid var(--border); background:var(--bg)}
  .sheetHeader .leftActions{display:flex; gap:8px; align-items:center}
  .iconBtn{border:1px solid var(--border); background:var(--card); border-radius:var(--r); padding:6px 10px; cursor:pointer}
  .sheetBody{padding:var(--gap); height:calc(100% - 50px); overflow:auto}
  .grid{display:grid; gap:8px}
  .opt{border:1px solid var(--border); background:var(--card); border-radius:var(--r); padding:12px; display:flex; gap:8px; align-items:center; cursor:pointer}
  .opt .emoji{font-size:20px}
  .qr{width:160px; height:160px; background:repeating-linear-gradient(45deg,#000 0 6px,#fff 6px 12px); image-rendering:pixelated; border-radius:var(--r)}
  .field{display:grid; gap:4px}
  input[type="text"], textarea{padding:10px; border:1px solid var(--border); border-radius:var(--r); background:#fffdf8; font-size:13px}
  textarea{min-height:72px}
  .btn{border:1px solid var(--border); background:var(--card); border-radius:var(--r); padding:10px 12px; cursor:pointer; text-align:center}
  .btn.primary{background:var(--green); color:#fff; border-color:transparent}
  .btn.danger{border-color:#d99; color:#600; background:#fff5f5}
  .editRow{position:relative}
  .editIcon{position:absolute; top:6px; right:6px; cursor:pointer; font-size:14px}
  .okIcon{position:absolute; top:6px; right:28px; cursor:pointer; font-size:14px; display:none}

  /* Settings tabs */
  .stabs{display:flex; gap:6px; padding:6px; position:sticky; top:52px; background:var(--bg); border-bottom:1px solid var(--border); z-index:2}
  .stab{flex:1; text-align:center; padding:8px; border:1px solid var(--border); background:var(--card); border-radius:var(--r); cursor:pointer}
  .stab.active{outline:2px solid var(--green); font-weight:700}
  .sview{display:none}
  .sview.active{display:block}

  /* Invite modal tweaks */
  .rowInline{display:flex; gap:8px; align-items:center}
  .rowInline input{flex:1}
  .rowInline .btn.copyOnly{padding:6px 10px}

  @media(min-width:900px){
    .modal.on{align-items:center; justify-content:center;}
    .sheet{
      position:relative; inset:auto; width:min(760px,92vw); height:min(80vh,900px);
      border-radius:12px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,.15);
    }
    .sheetBody{height:auto; max-height:calc(80vh - 54px);}
  }
  @media(min-width:481px){ .list{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>
<div class="heat" id="heat"></div>
<div id="app">

  <!-- Top -->
  <div class="top">
    <div class="brand" id="brand"><span class="logo">üå±</span>Habitu.be</div>
    <div class="spacer"></div>

    <!-- S√©lecteur d'espace (avec emoji dans le label) -->
    <select id="spaceSel" class="select" title="Changer d‚Äôespace"></select>

    <button class="navbtn" id="settingsBtn" title="Info">‚ìò</button>
    <button class="navbtn" id="addBtn" title="Ajouter">Ôºã</button>
  </div>

  <!-- Day bar -->
  <div class="daysWrap" id="daysWrap">
    <button class="navbtn" id="prevDay">‚Üê</button>
    <div style="display:flex; align-items:center; gap:6px">
      <div class="dateLabel" id="dateLabel">‚Äî</div>
      <div class="todayCount" id="todayCount">üå±0</div>
    </div>
    <div style="display:flex; gap:6px">
      <button class="navbtn" id="nextDay">‚Üí</button>
    </div>
  </div>

  <!-- Home -->
  <main id="home" class="view active">
    <div class="list" id="cards"></div>
  </main>

  <!-- Detail -->
  <section id="detail" class="view">
    <div class="detailHead">
      <button class="backMini" id="backHome">‚Üê</button>
      <div class="detailTitle" id="detailTitle"></div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="friends">üë• Amis</button>
      <button class="tab" data-tab="progress">üìÖ Historique</button>
    </div>

    <div class="section">
      <div class="view active" id="tab-friends">
        <div class="rankHeader">
          <div><b>Classement</b></div>
          <label style="font-size:12px;display:flex;gap:8px;align-items:center">
            P√©riode:
            <div style="display:flex; gap:8px">
              <button class="btnToggle active" data-period="30" id="btnP30">30 derniers jours</button>
              <button class="btnToggle" data-period="all" id="btnPAll">Total</button>
            </div>
          </label>
        </div>
        <div class="rank" id="rank"></div>
      </div>

      <div class="view" id="tab-progress">
        <div class="calendarWrap">
          <div class="calTop">
            <div style="display:flex; gap:6px; align-items:center">
              <button class="calBtn" id="prevMonth">‚Üê</button>
              <div id="monthLabel" style="font-weight:700"></div>
              <button class="calBtn" id="nextMonth">‚Üí</button>
            </div>
            <div id="calWhoWrap" style="display:none; gap:6px; align-items:center">
              <label style="font-size:12px">Voir :</label>
              <select id="calWho" class="select" style="padding:6px"></select>
            </div>
          </div>
          <div class="calendar" id="cal"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modals -->
  <div class="modal" id="modalAdd">
    <div class="sheet">
      <div class="sheetHeader">
        <div id="modalTitle">Ajouter</div>
        <button class="closeX" id="closeAdd">‚®â</button>
      </div>
      <div class="sheetBody">
        <div class="grid">
          <div class="opt" id="addHabit"><div class="emoji">üå±</div><div><b>Nouvelle habitude</b><div class="subtitle">Rejoindre un d√©fi</div></div></div>
          <div class="opt" id="inviteFriend"><div class="emoji">üåû</div><div><b>Inviter un ami</b><div class="subtitle">Lien √† partager</div></div></div>
          <div class="opt" id="joinSpace"><div class="emoji">ü§ù</div><div><b>Rejoindre un espace</b><div class="subtitle">Entrer un code</div></div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalInvite">
    <div class="sheet">
      <div class="sheetHeader">
        <div>Inviter un ami</div>
        <button class="closeX" id="closeInvite">‚®â</button>
      </div>
      <div class="sheetBody">
        <div class="grid">
          <div class="field">
            <label><b>Lien √† partager</b></label>
            <div class="rowInline">
              <input id="inviteLink" type="text" readonly/>
              <button class="btn copyOnly" id="copyInvite" title="Copier">üîó</button>
            </div>
            <div class="subtitle">Le lien contient le code de ton espace.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Habits -->
  <div class="modal" id="modalHabit">
    <div class="sheet">
      <div class="sheetHeader">
        <div id="habitTitle">Nouvelle habitude</div>
        <button class="closeX" id="closeHabit">‚®â</button>
      </div>
      <div class="sheetBody">
        <div class="grid" id="step1"></div>
        <div class="grid" id="step2" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- Create / Join Space -->
  <div class="modal" id="modalSpace">
    <div class="sheet">
      <div class="sheetHeader">
        <div>Cr√©er / Rejoindre un espace</div>
        <button class="closeX" id="closeSpace">‚®â</button>
      </div>
      <div class="sheetBody">
        <div class="grid">
          <div class="field">
            <label><b>Code (6 caract√®res alphanum√©riques)</b></label>
            <div style="display:flex; gap:8px; align-items:center">
              <input id="spaceCode" type="text" placeholder="ABC123" maxlength="6" style="text-transform:uppercase"/>
              <button class="btn" id="spaceGen">Cr√©er</button>
            </div>
          </div>
          <div class="field">
            <label><b>Ton pr√©nom</b></label>
            <input id="spaceName" type="text" placeholder="Pr√©nom"/>
          </div>
          <div class="grid" style="grid-template-columns:1fr 1fr">
            <button class="btn" id="spaceCancel">Annuler</button>
            <button class="btn primary" id="spaceSave">Rejoindre</button>
          </div>
          <div class="subtitle">Prototype : si tu cr√©es un code, un mini-assistant te demande le type & le profil.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Wizard -->
  <div class="modal" id="modalWizard">
    <div class="sheet">
      <div class="sheetHeader">
        <div id="wizTitle">Configurer l‚Äôespace</div>
        <button class="closeX" id="closeWizard">‚®â</button>
      </div>
      <div class="sheetBody">
        <div class="grid" id="wizStep"></div>
      </div>
    </div>
  </div>

  <!-- INFO / PARAM√àTRES -->
  <div class="modal" id="modalSettings">
    <div class="sheet">
      <div class="sheetHeader">
        <div class="leftActions">
          <button class="iconBtn" id="okSettings">‚úì</button>
        </div>
        <div id="spaceHeaderTitle"><!-- rempli dynamiquement --></div>
        <button class="closeX" id="closeSettings">‚®â</button>
      </div>

      <div class="stabs">
        <button class="stab active" data-sview="sinfo">Info</button>
        <button class="stab" data-sview="sparams">Param√®tres</button>
      </div>

      <div class="sheetBody">
        <!-- Info -->
        <div class="sview active" id="sinfo">
          <div class="grid">
            <div class="field editRow">
              <label><b>Description</b></label>
              <textarea id="spaceDesc" readonly placeholder="Description courte de l‚Äôespace‚Ä¶"></textarea>
              <span class="editIcon" id="editDesc">‚úèÔ∏è</span>
              <span class="okIcon" id="okDesc">‚úì</span>
            </div>
            <div class="opt">
              <div>
                <b>Bar√®me des plantes</b>
                <div class="subtitle" id="legendText"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Param√®tres -->
        <div class="sview" id="sparams">
          <div class="grid">
            <div class="opt">
              <div><b>P√©riode affich√©e</b>
                <div class="subtitle">Classements & badges</div>
                <div style="margin-top:6px;display:flex;gap:8px">
                  <button class="btnToggle" data-period="30">30 jours</button>
                  <button class="btnToggle" data-period="all">Total</button>
                </div>
              </div>
            </div>
            <div class="field editRow">
              <label><b>Pr√©nom</b></label>
              <input id="paramName" type="text" value="Moi" readonly/>
              <span class="editIcon" id="editName">‚úèÔ∏è</span>
              <span class="okIcon" id="okName">‚úì</span>
            </div>
            <div class="field editRow">
              <label><b>Nom de l‚Äôespace</b></label>
              <input id="paramSpaceLabel" type="text" readonly/>
              <span class="editIcon" id="editSpaceLabel">‚úèÔ∏è</span>
              <span class="okIcon" id="okSpaceLabel">‚úì</span>
            </div>
          </div>
          <div style="margin-top:12px">
            <button class="btn danger" id="quitSpaceBtn">Quitter</button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
/* ======= Donn√©es (sans levels) ======= */
const CATS=[
  {id:'sante',emoji:'ü©∫',nom:'Sant√©'},
  {id:'relations',emoji:'ü§ù',nom:'Relations'},
  {id:'esprit',emoji:'üß†',nom:'Esprit'},
  {id:'corps',emoji:'üí™',nom:'Corps'},
  {id:'vie',emoji:'üß∫',nom:'Vie'},
  {id:'loisirs',emoji:'üé®',nom:'Loisirs'},
  {id:'repos',emoji:'üòå',nom:'Repos'}
];

const CHALLENGES=[
  {type:'private',id:'screenoff',cat:'sante',emoji:'üõå',titre:'Sans √©cran avant le coucher',amis:['Anna','Ben','Chlo√©','Marc','Marie']},
  {type:'private',id:'repas',cat:'sante',emoji:'ü•ó',titre:'Repas sain fait maison',amis:['Ben','Duc']},
  {type:'private',id:'lire',cat:'esprit',emoji:'üìñ',titre:'Lire un livre ou un roman',amis:['Chlo√©']},
  {type:'private',id:'etire',cat:'corps',emoji:'ü§∏',titre:'√âtirements corporels',amis:['Anna','Marc']},
  {type:'private',id:'ranger',cat:'vie',emoji:'üßΩ',titre:'Rangement ou m√©nage',amis:['Chlo√©']},
  {type:'private',id:'creer',cat:'loisirs',emoji:'üé∏',titre:'Cr√©er ou jouer',amis:['Ben','Pauline']},
  {type:'private',id:'respirer',cat:'repos',emoji:'üå¨Ô∏è',titre:'Respiration coh√©rence cardiaque',amis:['Anna','Marie']}
];

/* Colocation (group) existant */
const GROUP_CHALLENGES=[
  {type:'group',id:'silence_matin',cat:'coloc',emoji:'ü§´',titre:'Silence matinal',amis:['Anna','Ben','Chlo√©','Marc','Marie']},
  {type:'group',id:'poubelles',cat:'coloc',emoji:'üóëÔ∏è',titre:'Descendre les poubelles',amis:['Anna','Ben','Chlo√©','Marc','Marie']},
  {type:'group',id:'cuisine',cat:'coloc',emoji:'üßΩ',titre:'Nettoyer la cuisine',amis:['Anna','Ben','Chlo√©','Marc','Marie']},
  {type:'group',id:'communs',cat:'coloc',emoji:'üß∫',titre:'Ranger les communs',amis:['Anna','Ben','Chlo√©','Marc','Marie']},
  {type:'group',id:'apero_coloc',cat:'coloc',emoji:'üçù',titre:'Repas partag√©',amis:['Anna','Ben','Chlo√©','Marc','Marie']},
  {type:'group',id:'energie',cat:'coloc',emoji:'‚ö°',titre:'√âconomie d‚Äô√©nergie',amis:['Anna','Ben','Chlo√©','Marc','Marie']},
  {type:'group',id:'wc_sdb',cat:'coloc',emoji:'üöΩ',titre:'Nettoyer WC & SDB',amis:['Anna','Ben','Chlo√©','Marc','Marie']},
  {type:'group',id:'silence_nuit',cat:'coloc',emoji:'üåô',titre:'Silence nocturne',amis:['Anna','Ben','Chlo√©','Marc','Marie']}
];

/* Famille (group) 8 habitudes */
const FAMILY_CHALLENGES=[
  {type:'group',id:'planning_semaine',cat:'famille',emoji:'üìÖ',titre:'Planning familial mis √† jour',amis:['Maman','Papa','L√©a','Tom']},
  {type:'group',id:'courses_pretes',cat:'famille',emoji:'üõí',titre:'Liste de courses faite ensemble',amis:['Maman','Papa','L√©a','Tom']},
  {type:'group',id:'linge_pli√©',cat:'famille',emoji:'üëï',titre:'Linge lav√©, pli√©, rang√©',amis:['Maman','Papa','L√©a','Tom']},
  {type:'group',id:'repas_prevu',cat:'famille',emoji:'üç≤',titre:'Menus de la semaine planifi√©s',amis:['Maman','Papa','L√©a','Tom']},
  {type:'group',id:'rdv_prepares',cat:'famille',emoji:'üìã',titre:'Rendez-vous & trajets anticip√©s',amis:['Maman','Papa','L√©a','Tom']},
  {type:'group',id:'chambres_rangees',cat:'famille',emoji:'üß∫',titre:'Pi√®ces communes et chambres rang√©es',amis:['Maman','Papa','L√©a','Tom']},
  {type:'group',id:'tri_recyclage',cat:'famille',emoji:'‚ôªÔ∏è',titre:'Tri s√©lectif & poubelles sorties',amis:['Maman','Papa','L√©a','Tom']},
  {type:'group',id:'check_dimanche',cat:'famille',emoji:'üïí',titre:'Pr√©paration de la semaine le dimanche',amis:['Maman','Papa','L√©a','Tom']}
];

/* Classe (group) 8 habitudes */
const CLASS_CHALLENGES=[
  {type:'group',id:'materiel_commun',cat:'classe',emoji:'üì¶',titre:'Mat√©riel collectif en ordre',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']},
  {type:'group',id:'tableaux_prop',cat:'classe',emoji:'üßΩ',titre:'Tableau nettoy√© en fin de cours',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']},
  {type:'group',id:'affiches',cat:'classe',emoji:'üìú',titre:'Affichage clair et √† jour',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']},
  {type:'group',id:'projets_planifies',cat:'classe',emoji:'üóÇÔ∏è',titre:'Projets ou expos√©s planifi√©s',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']},
  {type:'group',id:'materiel_partage',cat:'classe',emoji:'‚úèÔ∏è',titre:'Outils partag√©s bien rang√©s',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']},
  {type:'group',id:'retard_groupe',cat:'classe',emoji:'‚è∞',titre:'Tous √† l‚Äôheure au d√©but du cours',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']},
  {type:'group',id:'bilan_vendredi',cat:'classe',emoji:'üìä',titre:'Bilan collectif du vendredi fait',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']},
  {type:'group',id:'gestion_roles',cat:'classe',emoji:'ü™ë',titre:'R√¥les (pr√©sident, secr√©taire...) r√©partis',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']}
];


/* Bureau (group) 8 habitudes */
const OFFICE_CHALLENGES=[
  {type:'group',id:'planning_equipe',cat:'bureau',emoji:'üìÖ',titre:'Planning d‚Äô√©quipe synchronis√©',amis:['Alice','Bob','Carla','Dan']},
  {type:'group',id:'reunion_prete',cat:'bureau',emoji:'üóìÔ∏è',titre:'R√©union pr√©par√©e & document√©e',amis:['Alice','Bob','Carla','Dan']},
  {type:'group',id:'projets_suivis',cat:'bureau',emoji:'üìã',titre:'Suivi des projets mis √† jour',amis:['Alice','Bob','Carla','Dan']},
  {type:'group',id:'stock_rang√©',cat:'bureau',emoji:'üì¶',titre:'Mat√©riel ou fournitures en ordre',amis:['Alice','Bob','Carla','Dan']},
  {type:'group',id:'postes_propres',cat:'bureau',emoji:'üßΩ',titre:'Bureaux et espace commun rang√©s',amis:['Alice','Bob','Carla','Dan']},
  {type:'group',id:'checkin_lundi',cat:'bureau',emoji:'üß≠',titre:'Check-in collectif du lundi',amis:['Alice','Bob','Carla','Dan']},
  {type:'group',id:'docs_partages',cat:'bureau',emoji:'üíæ',titre:'Docs communs organis√©s et nomm√©s',amis:['Alice','Bob','Carla','Dan']},
  {type:'group',id:'cloture_vendredi',cat:'bureau',emoji:'üïî',titre:'Cl√¥ture de la semaine en √©quipe',amis:['Alice','Bob','Carla','Dan']}
];

/* Amis g√©n√©riques (d√©mo) */
const FRIENDS=['Anna','Ben','Chlo√©','Duc','Marc','Marie','Pauline','M. Dupond','Maman','Papa','L√©a','Tom','Alice','Bob','Carla','Dan','Emma','Lucas','Sarah','Yanis','Clara'];

/* ======= Scores (al√©atoires pour la d√©mo) ======= */
const challengeClaps={};
(function seedClaps(){
  const all=[...CHALLENGES,...GROUP_CHALLENGES,...FAMILY_CHALLENGES,...CLASS_CHALLENGES,...OFFICE_CHALLENGES];
  all.forEach(c=>{
    challengeClaps[c.id]={};
    [...new Set([...c.amis,'Moi'])].forEach(n=>{
      challengeClaps[c.id][n]=Math.floor(Math.random()*101);
    });
  });
})();

/* ======= Helpers ======= */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
function fmtDate(d){const m=['01','02','03','04','05','06','07','08','09','10','11','12'][d.getMonth()];const j=String(d.getDate()).padStart(2,'0');const J=['Di','Lu','Ma','Me','Je','Ve','Sa'][d.getDay()];return `${J} ${j}/${m}`;}
function genCode(){ const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let s=''; for(let i=0;i<6;i++){ s+=chars[Math.floor(Math.random()*chars.length)]; } return s; }
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

/* Bar√®me */
function levelEmojiFromScore(v){
  if(v<=7) return 'üå∞';
  if(v<=14) return 'üå±';
  if(v<=21) return 'üçÄ';
  if(v<=28) return 'üåº';
  if(v<=35) return 'üåª';
  if(v<=42) return 'üå∑';
  if(v<=49) return 'üåπ';
  if(v<=56) return 'ü™ª';
  if(v<=64) return 'üíê';
  return 'üéã';
}
function emojiScaleLegend() {
  return [
    'üå∞ 0‚Äì7 ‚Äî Graine ‚Äî d√©but du chemin',
    'üå± 8‚Äì14 ‚Äî Pousse ‚Äî premiers pas',
    'üçÄ 15‚Äì21 ‚Äî Tr√®fle ‚Äî petites victoires',
    'üåº 22‚Äì28 ‚Äî Bourgeon ‚Äî r√©gularit√© naissante',
    'üåª 29‚Äì35 ‚Äî Tournesol ‚Äî confiance qui grandit',
    'üå∑ 36‚Äì42 ‚Äî Tulipe ‚Äî curiosit√© √©panouie',
    'üåπ 43‚Äì49 ‚Äî Rose ‚Äî ma√Ætrise √©l√©gante',
    'ü™ª 50‚Äì56 ‚Äî Lavande ‚Äî calme et constance',
    'üíê 57‚Äì64 ‚Äî Bouquet ‚Äî harmonie des savoirs',
    'üéã 65+ ‚Äî Bambou ‚Äî sagesse durable'
  ].join('<br>');
}
function formatNames(names,maxShown=3){
  if(names.length<=maxShown) return names.join(', ');
  const shown=names.slice(0,maxShown).join(', ');
  return `${shown}‚Ä¶ et ${names.length-maxShown} autres`;
}

/* ======= √âtat & espaces ======= */
let periodSetting='30';
const SPACES={
  'D0PWE3':{ emoji:'üë§', label:'üë§ Individu', type:'private', challenges:CHALLENGES, desc:'Espace personnel.' },
  'E8D3FS':{ emoji:'üè†', label:'üè† Colocation', type:'group', challenges:GROUP_CHALLENGES, desc:'Espace partag√© √† la maison.' },
  'WS32D7':{ emoji:'‚ù§Ô∏è', label:'‚ù§Ô∏è Famille', type:'group', challenges:FAMILY_CHALLENGES, desc:'Routines familiales au quotidien.' },
  'SR3S0D':{ emoji:'üè´', label:'üè´ Classe', type:'group', challenges:CLASS_CHALLENGES, desc:'Vie de classe et rituels p√©dagogiques.' },
  'PD03XZ':{ emoji:'üè¢', label:'üè¢ Bureau', type:'group', challenges:OFFICE_CHALLENGES, desc:'Rituels simples pour mieux travailler.' },
};
let currentSpaceId='D0PWE3';
let currentUserName='Moi';
let dayOffset=0;
let generatedThisSession=false;

/* Date bar */
function currentDate(){ const t=new Date(); t.setHours(0,0,0,0); t.setDate(t.getDate()+dayOffset); return t; }
function renderDateBar(){
  $("#dateLabel").textContent = fmtDate(currentDate());
  const seedsToday = $$('#cards .levelBtn').map(b=>Number(b.dataset.doneToday||0)).reduce((a,b)=>a+b,0);
  $("#todayCount").textContent = `üå±${seedsToday}`;
}
$("#prevDay").onclick=()=>{ dayOffset--; renderDateBar(); };
$("#nextDay").onclick=()=>{ dayOffset++; renderDateBar(); };

/* Heat bg */
function setHeat(pct){ $("#heat").style.height=`${Math.max(0,Math.min(100,pct))}%`; }

/* ======= Cartes ======= */
let activeCardId=null, refBtn=null;
function getSpace(){ return SPACES[currentSpaceId] || SPACES['D0PWE3']; }
function getChallengesForSpace(){ return getSpace().challenges; }

function renderCards(){
  const list=getChallengesForSpace();
  const isGroup=(getSpace().type==='group');
  const root=$("#cards"); root.innerHTML='';

  list.forEach(it=>{
    const card=document.createElement('article'); card.className='card';

    /* .content => ouvre d√©tail Amis */
    const cont=document.createElement('div'); cont.className='content';
    const title=document.createElement('div'); title.className='title';
    title.innerHTML=`<span style="font-size:24px">${it.emoji}</span> <span class="base">${it.titre}</span> <span class="hint" id="h-${it.id}"></span>`;

    const friends=document.createElement('div'); friends.className='friends';

    // Badges compact√©s
    if(isGroup){
      let seedNames=[];
      if(Math.random()<0.5){
        const nSeeds=randInt(1,2);
        seedNames=[...it.amis].sort(()=>Math.random()-0.5).slice(0,nSeeds);
        const b=document.createElement('div'); b.className='badge seed-badge';
        b.textContent=`üå± ${formatNames(seedNames)}`;
        friends.appendChild(b);
      }
      if(Math.random()<0.7){
        const nSuns=randInt(2,5);
        const sunNames=[...it.amis].sort(()=>Math.random()-0.5).slice(0,nSuns);
        const b=document.createElement('div'); b.className='badge sun-badge';
        b.textContent=`üåû ${formatNames(sunNames)}`;
        friends.appendChild(b);
      }
      card._seedNames = seedNames;
    }else{
      const zero = Math.random()<0.2;
      const n = zero ? 0 : randInt(1,5);
      const sunNames = n ? [...it.amis].sort(()=>Math.random()-0.5).slice(0,n) : [];
      const b=document.createElement('div'); b.className='badge sun-badge';
      b.textContent = n ? `üåû ${formatNames(sunNames)}` : `üåû`;
      friends.appendChild(b);
    }
    cont.append(title,friends);

    /* .levelCol => toggle r√©alis√©/non-r√©alis√© (s‚Äôapplique √† .levelBtn aussi) */
    const col=document.createElement('div'); col.className='levelCol';
    const btn=document.createElement('button'); btn.className='levelBtn'; btn.dataset.cid=it.id;

    const basePlants = Math.floor(Math.random()*65);
    const clapsMine = challengeClaps[it.id]?.['Moi'] ?? 0;
    btn.dataset.basePlants = String(basePlants);
    btn.dataset.plants = String(basePlants);
    btn.dataset.suns = String(clapsMine);
    btn.dataset.doneToday='0';

    const renderBtnVisual = ()=>{
      const plants=Number(btn.dataset.plants||0);
      const suns=Number(btn.dataset.suns||0);
      const total = plants + suns;
      const bigIcon = levelEmojiFromScore(total);
      btn.innerHTML = `<div class="big">${bigIcon}</div><div class="scoreText">${total}</div>`;
    };
    renderBtnVisual();

    const updateSeedBadgeText = ()=>{
      const sb = friends.querySelector('.seed-badge');
      if(!sb) return;
      const names = card._seedNames||[];
      if(names.length===0){ sb.remove(); return; }
      sb.textContent = `üå± ${formatNames(names)}`;
    };

    const toggleDone=()=>{
      const done = btn.dataset.doneToday==='1';
      const base = Number(btn.dataset.basePlants||0);
      if(!done){
        btn.dataset.doneToday='1';
        btn.dataset.plants = String(base + 1);
        card.classList.add('done');
        if(getSpace().type==='group'){
          if(!Array.isArray(card._seedNames)) card._seedNames=[];
          if(!card._seedNames.includes('Moi')) card._seedNames.push('Moi');
          if(!friends.querySelector('.seed-badge')){
            const seedBadge=document.createElement('div'); seedBadge.className='badge seed-badge';
            friends.prepend(seedBadge);
          }
          updateSeedBadgeText();
        }
      }else{
        btn.dataset.doneToday='0';
        btn.dataset.plants = String(base);
        card.classList.remove('done');
        if(getSpace().type==='group'){
          if(Array.isArray(card._seedNames)){
            const idx=card._seedNames.indexOf('Moi');
            if(idx>-1) card._seedNames.splice(idx,1);
            updateSeedBadgeText(); // supprime le badge si plus de noms
          }
        }
      }
      renderBtnVisual();
      renderDateBar();
      setHeat($$('.levelBtn').reduce((a,b)=>a+(b.dataset.doneToday==='1'?10:0),0));
    };

    col.onclick = toggleDone;           // r√®gle unique
    cont.onclick=()=>openDetail(it.id, btn);

    col.append(btn);
    card.append(cont,col);
    root.appendChild(card);
  });

  renderDateBar();
}

/* ======= D√©tail ======= */
function findByIdAnywhere(id){ return [...CHALLENGES,...GROUP_CHALLENGES,...FAMILY_CHALLENGES,...CLASS_CHALLENGES,...OFFICE_CHALLENGES].find(c=>c.id===id); }

function populateCalWho(){
  const wrap=$("#calWhoWrap"), sel=$("#calWho");
  if(getSpace().type!=='group'){ wrap.style.display='none'; return; }
  wrap.style.display='flex';
  sel.innerHTML='';
  const optAll=new Option('Tous','__all__'); sel.add(optAll);
  sel.add(new Option('Moi','Moi'));
  const it=findByIdAnywhere(activeCardId);
  (it?.amis||[]).forEach(n=> sel.add(new Option(n,n)));
  sel.value='__all__';
}

function openDetail(id, btnRef){
  activeCardId=id; refBtn=btnRef;
  $("#home").classList.remove('active'); $("#detail").classList.add('active');
  $("#daysWrap").style.display='none';

  $$('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector(`[data-tab="friends"]`).classList.add('active');
  $$('#detail .view').forEach(v=>v.classList.remove('active'));
  $('#tab-friends').classList.add('active');

  const it=findByIdAnywhere(id);
  $("#detailTitle").textContent=`${it.emoji} ${it.titre}`;
  renderRank();
  populateCalWho();
  renderCalendar();
}
$("#backHome").onclick=()=>{ $("#detail").classList.remove('active'); $("#home").classList.add('active'); $("#daysWrap").style.display='flex'; };
$("#brand").onclick=()=>{ $("#detail").classList.remove('active'); $("#home").classList.add('active'); $("#daysWrap").style.display='flex'; };

/* ======= Classement ======= */
function boundedRand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function renderRank(){
  const it=findByIdAnywhere(activeCardId);
  const period = periodSetting;
  const range = period==='30' ? [1,30] : [1,120];

  const rows = [
    ...it.amis.map(n=>{
      const plants = boundedRand(...range);
      const suns   = boundedRand(...range);
      const total  = plants + suns;
      return {n, plants, suns, total, me:false};
    }),
    (function meRow(){
      const plants = boundedRand(...range);
      const suns   = boundedRand(...range);
      const total  = plants + suns;
      return {n:currentUserName||'Moi', plants, suns, total, me:true};
    })()
  ].sort((a,b)=>b.total-a.total);

  const root=$("#rank"); root.innerHTML='';
  rows.forEach(({n,plants,suns,me})=>{
    const row=document.createElement('div'); row.className='row';
    const left=document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
    const bigScore=document.createElement('span'); bigScore.className='scoreEmoji';
    bigScore.textContent=`${levelEmojiFromScore(plants+suns)} ${plants+suns}`;
    const name=document.createElement('b'); name.textContent=`${n}${me?' (toi)':''}`;
    left.append(bigScore, name);

    const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='12px';
    const clapBtn=document.createElement('button'); clapBtn.className='clap navbtn'; clapBtn.dataset.liked='0'; clapBtn.dataset.base=String(suns);
    clapBtn.title='üåû'; clapBtn.textContent=`üåû ${suns}`;
    clapBtn.onclick=()=>{
      const base = Number(clapBtn.dataset.base||0);
      const liked = clapBtn.dataset.liked==='1';
      if(!liked){ clapBtn.dataset.liked='1'; clapBtn.textContent=`üåû ${base+1}`; clapBtn.style.outline=`2px solid var(--green)`; }
      else{ clapBtn.dataset.liked='0'; clapBtn.textContent=`üåû ${base}`; clapBtn.style.outline='none'; }
    };
    right.append(clapBtn);

    row.append(left, right);
    root.appendChild(row);
  });
}

/* P√©riode toggle (encadr√© vert) */
function updatePeriodButtons(){
  $$('#btnP30, #btnPAll, #modalSettings .btnToggle').forEach(b=>{
    const p=b.dataset.period;
    b.classList.toggle('active', p===periodSetting);
  });
}
$('#btnP30').onclick=()=>{ periodSetting='30'; updatePeriodButtons(); renderRank(); };
$('#btnPAll').onclick=()=>{ periodSetting='all'; updatePeriodButtons(); renderRank(); };

/* ======= Calendrier ======= */
let calMonthOffset=0;
function monthInfo(offset=0){
  const base=new Date(); base.setDate(1); base.setMonth(base.getMonth()+offset);
  const y=base.getFullYear(), m=base.getMonth();
  return {y,m, firstDay:(new Date(y,m,1).getDay()+6)%7, days:new Date(y,m+1,0).getDate()};
}
function renderCalendar(){
  const wrap=$("#cal"); wrap.innerHTML='';
  const {y,m,firstDay,days}=monthInfo(calMonthOffset);
  const monthNames=['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ª','Sep','Oct','Nov','D√©c'];

  let monthSeeds=0;

  for(let i=0;i<firstDay;i++){ const c=document.createElement('div'); c.className='cell'; c.style.opacity=.35; wrap.appendChild(c); }
  const today=new Date(); const isThisMonth=(calMonthOffset===0);

  const isGroup = (getSpace().type==='group');
  let prob = 0.5;
  if(isGroup){
    const who = $("#calWho").value || '__all__';
    prob = (who==='__all__') ? 0.35 : 0.15;
  }

  for(let d=1; d<=days; d++){
    const c=document.createElement('div'); c.className='cell';
    const dn=document.createElement('div'); dn.className='dayNum'; dn.textContent=String(d); c.appendChild(dn);

    if(Math.random()<prob){
      const seed=document.createElement('div'); seed.className='seedMark'; seed.textContent='üå±';
      c.appendChild(seed); monthSeeds++;
    }
    if(isThisMonth && d===today.getDate()){ c.style.outline=`2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--green')}`; }

    c.onclick=()=>{
      const base=new Date(); base.setDate(1); base.setMonth(base.getMonth()+calMonthOffset);
      const target=new Date(base.getFullYear(), base.getMonth(), d);
      const now=new Date(); now.setHours(0,0,0,0);
      dayOffset = Math.round((target - now)/86400000);
      $("#detail").classList.remove('active'); $("#home").classList.add('active'); $("#daysWrap").style.display='flex';
      renderDateBar();
      window.scrollTo({top:0,behavior:'smooth'});
    };
    wrap.appendChild(c);
  }

  $("#monthLabel").textContent=`${monthNames[m]} ${y} ¬∑ üå±${monthSeeds}`;
}
$("#prevMonth").onclick=()=>{ calMonthOffset--; renderCalendar(); };
$("#nextMonth").onclick=()=>{ calMonthOffset++; renderCalendar(); };
$("#calWho")?.addEventListener('change',renderCalendar);

/* ======= Tabs ======= */
$$('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const name=t.dataset.tab;
    $$('#detail .view').forEach(v=>v.classList.remove('active'));
    $('#tab-'+name).classList.add('active');
    if(name==='progress') renderCalendar();
  });
});

/* ======= Modals ======= */
const modalAdd=$("#modalAdd"), modalHabit=$("#modalHabit"), modalInvite=$("#modalInvite"),
      modalSettings=$("#modalSettings"), modalSpace=$("#modalSpace"), modalWizard=$("#modalWizard");
const open = m => m.classList.add('on');
const close = m => m.classList.remove('on');

/* Add menu */
$("#addBtn").onclick=()=>open(modalAdd);
$("#closeAdd").onclick=()=>close(modalAdd);
$("#addHabit").onclick=()=>{ close(modalAdd); open(modalHabit); renderStep1(); };
$("#inviteFriend").onclick=()=>{ close(modalAdd); openInvite(); };
$("#joinSpace").onclick=()=>{ close(modalAdd); open(modalSpace); };

function openInvite(){
  const code=currentSpaceId;
  $("#inviteLink").value=`https://habitu.be/?code=${code}`;
  open(modalInvite);
}
$("#closeInvite").onclick=()=>close(modalInvite);
$("#copyInvite").onclick=async ()=>{
  try{ await navigator.clipboard.writeText($("#inviteLink").value); alert("Lien copi√© !"); }catch(e){ alert("Impossible de copier automatiquement."); }
};

/* ======= INFO/PARAMS modal ======= */
function switchSView(id){
  $$('.stab').forEach(b=>b.classList.toggle('active', b.dataset.sview===id));
  $$('.sview').forEach(v=>v.classList.toggle('active', v.id===id));
}
$$('.stab').forEach(b=> b.onclick=()=> switchSView(b.dataset.sview));

$("#okSettings").onclick=()=>close(modalSettings);
$("#closeSettings").onclick=()=>close(modalSettings);

/* Edit in place (Description / Pr√©nom / Nom espace) */
function enableEdit(input, okBtn, editBtn){
  input.removeAttribute('readonly'); input.focus(); editBtn.style.display='none'; okBtn.style.display='inline';
}
function disableEdit(input, okBtn, editBtn){
  input.setAttribute('readonly',''); okBtn.style.display='none'; editBtn.style.display='inline';
}
function enableEditTA(textarea, okBtn, editBtn){
  textarea.removeAttribute('readonly'); textarea.focus(); editBtn.style.display='none'; okBtn.style.display='inline';
}
function disableEditTA(textarea, okBtn, editBtn){
  textarea.setAttribute('readonly',''); okBtn.style.display='none'; editBtn.style.display='inline';
}

$("#editDesc").onclick=()=>enableEditTA($("#spaceDesc"), $("#okDesc"), $("#editDesc"));
$("#okDesc").onclick=()=>{ SPACES[currentSpaceId].desc=$("#spaceDesc").value.trim(); disableEditTA($("#spaceDesc"), $("#okDesc"), $("#editDesc")); };

$("#editName").onclick=()=>enableEdit($("#paramName"), $("#okName"), $("#editName"));
$("#okName").onclick=()=>{ currentUserName=$("#paramName").value.trim()||'Moi'; disableEdit($("#paramName"), $("#okName"), $("#editName")); };

$("#editSpaceLabel").onclick=()=>enableEdit($("#paramSpaceLabel"), $("#okSpaceLabel"), $("#editSpaceLabel"));
$("#okSpaceLabel").onclick=()=>{ 
  const sp=SPACES[currentSpaceId];
  const txt=$("#paramSpaceLabel").value.trim()||sp.label;
  // conserve l‚Äôemoji d‚Äôorigine au d√©but si l‚Äôutilisateur ne le met pas
  const hasEmoji=/^\p{Emoji}/u.test(txt);
  sp.label = hasEmoji ? txt : `${sp.emoji} ${txt}`;
  disableEdit($("#paramSpaceLabel"), $("#okSpaceLabel"), $("#editSpaceLabel"));
  updateSpaceSelectOptions();
  updateSettingsTitle();
};

/* Bouton Quitter */
$("#quitSpaceBtn").onclick=()=>{
  const sp=SPACES[currentSpaceId];
  if(confirm(`Quitter ${sp.label} (${currentSpaceId}) ?`)){
    // d√©mo : on ne supprime pas les donn√©es, on revient √† Individu
    currentSpaceId='D0PWE3';
    updateSpaceSelectOptions();
    renderCards();
    close(modalSettings);
  }
};

/* Ouvrir la modale Info */
$("#settingsBtn").onclick=()=>{
  const sp=getSpace();
  updateSettingsTitle();
  $("#legendText").innerHTML = emojiScaleLegend();
  $("#spaceDesc").value = sp.desc || '';
  $("#paramName").value = currentUserName || 'Moi';
  $("#paramSpaceLabel").value = sp.label;
  // p√©riode buttons dans params
  $$('#modalSettings .btnToggle').forEach(b=>{
    b.classList.toggle('active', b.dataset.period===periodSetting);
    b.onclick=()=>{ periodSetting=b.dataset.period; updatePeriodButtons(); renderRank(); };
  });
  // bouton Quitter texte
  $("#quitSpaceBtn").textContent=`Quitter ${sp.label} (${currentSpaceId})`;
  // onglet par d√©faut = Info
  switchSView('sinfo');
  open(modalSettings);
};
function updateSettingsTitle(){
  const sp=getSpace();
  $("#spaceHeaderTitle").textContent = `${sp.label} (${currentSpaceId})`;
}

/* ======= Habit steps (sans niveaux) ======= */
let pickedCat=null;
function renderStep1(){
  $("#step1").style.display='grid'; $("#step2").style.display='none';
  const root=$("#step1"); root.innerHTML='';
  CATS.forEach(c=>{
    const el=document.createElement('div'); el.className='opt';
    el.innerHTML=`<div class="emoji">${c.emoji}</div><div><b>${c.nom}</b></div>`;
    el.onclick=()=>{ pickedCat=c.id; renderStep2(); };
    root.appendChild(el);
  });
}
function renderStep2(){
  $("#step1").style.display='none'; $("#step2").style.display='grid';
  const root=$("#step2"); root.innerHTML='';
  CHALLENGES.filter(x=>x.cat===pickedCat).forEach(x=>{
    const el=document.createElement('div'); el.className='opt';
    el.innerHTML=`<div class="emoji">${x.emoji}</div><div><b>${x.titre}</b></div>`;
    el.onclick=()=>{ alert("Habitude ajout√©e (d√©mo)"); close(modalHabit); };
    root.appendChild(el);
  });
}
$("#closeHabit").onclick=()=>close(modalHabit);

/* ======= Espace: cr√©er / rejoindre ======= */
$("#spaceGen").onclick=()=>{ $("#spaceCode").value=genCode(); generatedThisSession=true; };
$("#spaceCancel").onclick=()=>{ close(modalSpace); generatedThisSession=false; };
$("#closeSpace").onclick=()=>{ close(modalSpace); generatedThisSession=false; };
$("#spaceSave").onclick=()=>{
  const code = ($("#spaceCode").value||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,6);
  const name = ($("#spaceName").value||'').trim() || 'Moi';
  if(!code){ alert("Entre un code d‚Äôespace."); return; }
  if(generatedThisSession){
    close(modalSpace);
    launchWizard(code,name);
  }else{
    if(!SPACES[code]) SPACES[code]={emoji:'üë§', label:'üë§ Individu', type:'private', challenges:CHALLENGES, desc:''};
    currentSpaceId=code; currentUserName=name;
    updateSpaceSelectOptions();
    renderCards(); close(modalSpace);
  }
  generatedThisSession=false;
};

/* Wizard: type puis profil */
let wizState={code:'',name:'',type:'private',profile:'Autre'};
function launchWizard(code,name){
  wizState={code,name,type:'private',profile:'Autre'};
  open(modalWizard); renderWizardStepType();
}
function renderWizardStepType(){
  $("#wizTitle").textContent="Choisir le type d‚Äôespace";
  const root=$("#wizStep"); root.innerHTML='';
  [
    {id:'private',emoji:'üë§',title:'Priv√©',desc:'Espace personnel. Tu suis tes habitudes.'},
    {id:'group',emoji:'üë•',title:'Collectif',desc:'Espace partag√©. Badges üå± et üåû visibles.'}
  ].forEach(opt=>{
    const el=document.createElement('div'); el.className='opt';
    el.innerHTML=`<div class="emoji">${opt.emoji}</div><div><b>${opt.title}</b><div class="subtitle">${opt.desc}</div></div>`;
    el.onclick=()=>{ wizState.type=opt.id; renderWizardStepProfile(); };
    root.appendChild(el);
  });
}
function renderWizardStepProfile(){
  $("#wizTitle").textContent="Choisir un profil";
  const root=$("#wizStep"); root.innerHTML='';
  [
    {id:'Famille',emoji:'‚ù§Ô∏è',desc:'Routines familiales, t√¢ches partag√©es.'},
    {id:'Colocation',emoji:'üè†',desc:'Vie commune, propret√©, √©nergie.'},
    {id:'Bureau',emoji:'üè¢',desc:'Rituels d‚Äô√©quipe et focus.'},
    {id:'Autre',emoji:'‚ú®',desc:'Profil libre et personnalisable.'},
  ].forEach(opt=>{
    const el=document.createElement('div'); el.className='opt';
    el.innerHTML=`<div class="emoji">${opt.emoji}</div><div><b>${opt.id}</b><div class="subtitle">${opt.desc}</div></div>`;
    el.onclick=()=>{ wizState.profile=opt.id; finalizeSpaceFromWizard(); };
    root.appendChild(el);
  });
}
function finalizeSpaceFromWizard(){
  const code=wizState.code;
  let def={emoji:'üë§', label:'üë§ Individu', type:'private', challenges:CHALLENGES, desc:'Espace personnel.'};
  if(wizState.type==='group'){
    if(wizState.profile==='Famille') def={emoji:'‚ù§Ô∏è', label:'‚ù§Ô∏è Famille', type:'group', challenges:FAMILY_CHALLENGES, desc:'Routines familiales au quotidien.'};
    else if(wizState.profile==='Colocation') def={emoji:'üè†', label:'üè† Colocation', type:'group', challenges:GROUP_CHALLENGES, desc:'Espace partag√© √† la maison.'};
    else if(wizState.profile==='Bureau') def={emoji:'üè¢', label:'üè¢ Bureau', type:'group', challenges:OFFICE_CHALLENGES, desc:'Rituels simples pour mieux travailler.'};
    else def={emoji:'üë•', label:'üë• Collectif', type:'group', challenges:GROUP_CHALLENGES, desc:'Espace partag√©.'};
  }
  SPACES[code]=def;
  currentSpaceId=code; currentUserName=wizState.name;
  updateSpaceSelectOptions();
  close(modalWizard);
  renderCards();
}
$("#closeWizard").onclick=()=>close(modalWizard);

/* Met √† jour le select des espaces (affiche emoji) */
function updateSpaceSelectOptions(){
  const sel=$("#spaceSel");
  sel.innerHTML='';
  const order=['E8D3FS','D0PWE3','WS32D7','SR3S0D','PD03XZ'];
  order.forEach(id=>{
    if(SPACES[id]){
      const opt=document.createElement('option');
      opt.value=id; opt.textContent=`${SPACES[id].label} (${id})`;
      sel.appendChild(opt);
    }
  });
  Object.keys(SPACES).forEach(id=>{
    if(!order.includes(id)){
      const opt=document.createElement('option');
      opt.value=id; opt.textContent=`${SPACES[id].label} (${id})`;
      sel.appendChild(opt);
    }
  });
  sel.value=currentSpaceId;
}

/* S√©lecteur d‚Äôespace */
const sel=$("#spaceSel");
sel.addEventListener('change', ()=>{
  currentSpaceId = sel.value;
  renderCards();
  if($("#detail").classList.contains('active')){
    $("#detail").classList.remove('active'); $("#home").classList.add('active'); $("#daysWrap").style.display='flex';
  }
});

/* ======= Init ======= */
function renderCalendarAndKeepMonth(){ renderCalendar(); }
let dayInitRendered=false;
function renderDateOnce(){ if(!dayInitRendered){ dayOffset=0; renderDateBar(); dayInitRendered=true; } }

renderCards();
renderCalendarAndKeepMonth();
renderDateOnce();
updatePeriodButtons();
updateSpaceSelectOptions();

/* ESC to close modals */
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ [modalAdd,modalHabit,modalInvite,modalSettings,modalSpace,modalWizard].forEach(m=>m.classList.remove('on')); } });
</script>
</body>
</html>