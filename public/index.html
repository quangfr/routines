<!doctype html><html lang="fr"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/><title>Habitu.be ‚Äî Prototype (ultra-l√©ger)</title>
<style>
:root{--bg:#f7f3ea;--card:#fffdf8;--text:#1e1f1a;--green:#2a7a57;--border:#e6dfd2;--r:4px;--gap:8px;--fs:13px}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font:400 var(--fs)/1.35 system-ui,-apple-system,Roboto,sans-serif;color:var(--text);background:var(--bg)}
#app{max-width:480px;margin:0 auto;min-height:100%;display:flex;flex-direction:column;position:relative}
.heat{position:fixed;left:0;right:0;bottom:0;height:0;background:linear-gradient(0deg,#8ec5a8,transparent);opacity:.35;pointer-events:none;z-index:0}
button,.select,.tab,.stab,.btn,.btnToggle,.navbtn,.calBtn,.backMini{font:600 13px/1.2 system-ui,-apple-system,Roboto,sans-serif;padding:6px 10px;border-radius:var(--r);cursor:pointer;border:1px solid var(--border);background:var(--card)}
.btn.primary{background:var(--green);color:#fff;border-color:transparent}.btn.danger{border-color:#d99;color:#600;background:#fff5f5}
.btnToggle.active,.tab.active,.stab.active{outline:2px solid var(--green)}.select{appearance:none}
.top{position:sticky;top:0;background:var(--bg);z-index:6;border-bottom:1px solid var(--border);padding:6px var(--gap);display:flex;align-items:center;gap:8px}
.brand{font-weight:800;cursor:pointer;display:flex;align-items:center;gap:6px}.brand .logo{font-size:18px}.spacer{flex:1}
.daysWrap{position:sticky;top:44px;background:var(--bg);z-index:5;border-bottom:1px solid var(--border);padding:6px var(--gap);display:flex;align-items:center;gap:6px;justify-content:space-between}
.rightBtns{display:flex;flex-direction:row;gap:6px;align-items:flex-end} /* ‚Üí & Ôºã empil√©s √† droite */
.dateLabel,.todayCount{font-weight:700;padding:0;border:none;background:transparent}
.list{padding:var(--gap);display:grid;grid-template-columns:1fr;gap:var(--gap);position:relative;z-index:1}
.card{border:1px solid var(--border);background:var(--card);border-radius:var(--r);display:grid;grid-template-columns:1fr 64px;overflow:hidden}
.card.done{border:2px solid var(--green)}
.content{padding:4px;display:flex;flex-direction:column;gap:4px;cursor:pointer}
.title{font-weight:700;display:flex;align-items:center;gap:4px;font-size:13px;min-height:22px}.title .hint{color:#5b5b56;font-weight:500}
.friends{margin-top:auto;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.badge{display:flex;align-items:center;gap:6px;padding:4px 6px;border:1px solid var(--border);border-radius:var(--r);background:#fff;font-size:11px;line-height:1.2}
.levelCol{padding:0 6px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.levelBtn{width:100%;height:60px;border-radius:var(--r);border:1px solid var(--border);background:#f7f3ea;display:flex;flex-direction:column;align-items:center;justify-content:center;user-select:none;line-height:1.05;position:relative}
.levelBtn .big{position:absolute;top:4px;left:0;right:0;text-align:center;font-size:22px;font-weight:800}
.levelBtn .scoreText{position:absolute;bottom:2px;left:4px;right:4px;text-align:center;font-size:22px;font-weight:800;line-height:1}
.section{padding:var(--gap)}
.detailHead{display:flex;align-items:center;gap:8px;position:sticky;top:0;z-index:5;background:var(--bg);padding:6px var(--gap);border-bottom:1px solid var(--border)}
.detailTitle{font-weight:800;font-size:16px}
.tabs{display:flex;gap:6px;padding:var(--gap);border-bottom:1px solid var(--border);background:var(--bg);position:sticky;top:80px;z-index:4}
.tab{flex:1;text-align:center}.view{display:none}.view.active{display:block}
.rankHeader{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px}
.rank{display:grid;gap:8px;margin-top:8px}
.row{display:flex;justify-content:space-between;align-items:center;padding:6px;border:1px solid var(--border);background:var(--card);border-radius:var(--r)}
.scoreEmoji{font-size:26px;font-weight:900;margin-left:4px;white-space:pre-line}
.calendarWrap{padding:0 var(--gap) var(--gap)}
.calTop{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cell{height:55px;display:grid;place-items:center;border:1px dashed var(--border);background:var(--card);border-radius:var(--r);position:relative;overflow:hidden;cursor:pointer}
.dayNum{position:absolute;top:4px;right:6px;font-size:10px;color:#777}
.seedMark{position:absolute;top:18px;left:0;right:0;text-align:center;font-size:14px;line-height:1;font-weight:700}
.modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.2);padding:0;z-index:10}
.modal.on{display:flex;align-items:stretch;justify-content:stretch}
.sheet{position:absolute;inset:0;background:var(--card)}
.sheetHeader{position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px var(--gap);border-bottom:1px solid var(--border);background:var(--bg)}
.sheetBody{padding:var(--gap);height:calc(100% - 50px);overflow:auto}
.grid{display:grid;gap:8px}
.opt{border:1px solid var(--border);background:var(--card);border-radius:var(--r);padding:12px;display:flex;gap:8px;align-items:center;cursor:pointer}
.opt .emoji{font-size:20px}
.field{display:grid;gap:4px}
input[type="text"],textarea{padding:10px;border:1px solid var(--border);border-radius:var(--r);background:#fffdf8;font-size:13px}
textarea{min-height:72px}
.stabs{display:flex;gap:6px;padding:6px;position:sticky;top:52px;background:var(--bg);border-bottom:1px solid var(--border);z-index:2}
.stab{flex:1;text-align:center}
.sview{display:none}.sview.active{display:block}
.rowInline{display:flex;gap:8px;align-items:center}.rowInline input{flex:1}.rowInline .btn.copyOnly{padding:6px 10px}
</style>
</head><body>
<div class="heat" id="heat"></div>
<div id="app">
  <div class="top">
    <div class="brand" id="brand"><span class="logo">üå±</span>Habitu.be</div>
    <div class="spacer"></div>
    <select id="spaceSel" class="select" title="Changer d‚Äôespace"></select>
    <button class="navbtn" id="settingsBtn" title="Info">‚ìò</button>
  </div>

  <div class="daysWrap" id="daysWrap">
    <button class="navbtn" id="prevDay">‚Üê</button>
    <div style="display:flex;align-items:center;gap:6px">
      <div class="dateLabel" id="dateLabel">‚Äî</div>
      <div class="todayCount" id="todayCount">üå± 0</div>
    </div>
    <div class="rightBtns">
      <button class="navbtn" id="nextDay">‚Üí</button>
      <button class="navbtn" id="addBtn" title="Ajouter">Ôºã</button>
    </div>
  </div>

  <main id="home" class="view active"><div class="list" id="cards"></div></main>

  <section id="detail" class="view">
    <div class="detailHead"><button class="backMini" id="backHome">‚Üê</button><div class="detailTitle" id="detailTitle"></div></div>
    <div class="tabs">
      <button class="tab active" data-tab="friends">üë• Amis</button>
      <button class="tab" data-tab="progress">üìÖ Historique</button>
      <button class="tab" data-tab="settings">‚öôÔ∏è Param√®tres</button>
    </div>
    <div class="section">
      <div class="view active" id="tab-friends">
        <div class="rankHeader">
          <b>Classement</b>
          <div style="font-size:12px;display:flex;gap:8px;align-items:center">
            P√©riode:
            <div style="display:flex;gap:8px">
              <button class="btnToggle active" data-period="30" id="btnP30">30 jours</button>
              <button class="btnToggle" data-period="all" id="btnPAll">Total</button>
            </div>
          </div>
        </div>
        <div class="rank" id="rank"></div>
      </div>
      <div class="view" id="tab-progress">
        <div class="calendarWrap">
          <div class="calTop">
            <div style="display:flex;gap:6px;align-items:center">
              <button class="calBtn" id="prevMonth">‚Üê</button>
              <div id="monthLabel" style="font-weight:700"></div>
              <button class="calBtn" id="nextMonth">‚Üí</button>
            </div>
            <div id="calWhoWrap" style="display:none;gap:6px;align-items:center">
              <span style="font-size:12px">Voir :</span>
              <select id="calWho" class="select" style="padding:6px"></select>
            </div>
          </div>
          <div class="calendar" id="cal"></div>
        </div>
      </div>
      <div class="view" id="tab-settings">
        <div class="grid">
          <div class="field">
            <label><b>R√©gularit√©</b> <span class="subtitle"></span></label>
            <select id="freqSelect" class="select">
              <option value="1">Quotidien</option>
              <option value="2">Tous les 2 jours</option>
              <option value="3">Tous les 3 jours</option>
              <option value="4">Tous les 4 jours</option>
              <option value="5">Tous les 5 jours</option>
              <option value="6">Tous les 6 jours</option>
               <option value="7">Hebdomadaire</option>
            </select>
           
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="modal" id="modalAdd">
    <div class="sheet">
      <div class="sheetHeader"><div id="modalTitle">Ajouter</div><button class="closeX" id="closeAdd">‚®â</button></div>
      <div class="sheetBody">
        <div class="grid">
          <div class="opt" id="addHabit"><div class="emoji">üå±</div><div><b>Nouvelle habitude</b><div class="subtitle">Rejoindre un d√©fi</div></div></div>
          <div class="opt" id="inviteFriend"><div class="emoji">üåû</div><div><b>Inviter un ami</b><div class="subtitle">Lien √† partager</div></div></div>
          <div class="opt" id="joinSpace"><div class="emoji">ü§ù</div><div><b>Rejoindre un espace</b><div class="subtitle">Entrer un code</div></div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalInvite">
    <div class="sheet">
      <div class="sheetHeader"><div>Inviter un ami</div><button class="closeX" id="closeInvite">‚®â</button></div>
      <div class="sheetBody">
        <div class="grid">
          <div class="field">
            <label><b>Lien √† partager</b></label>
            <div class="rowInline"><input id="inviteLink" type="text" readonly/><button class="btn copyOnly" id="copyInvite" title="Copier">üîó</button></div>
            <div class="subtitle">Le lien contient le code de ton espace.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalHabit">
    <div class="sheet">
      <div class="sheetHeader"><div id="habitTitle">Nouvelle habitude</div><button class="closeX" id="closeHabit">‚®â</button></div>
      <div class="sheetBody"><div class="grid" id="step1"></div><div class="grid" id="step2" style="display:none"></div></div>
    </div>
  </div>

  <div class="modal" id="modalSpace">
    <div class="sheet">
      <div class="sheetHeader"><div>Cr√©er / Rejoindre un espace</div><button class="closeX" id="closeSpace">‚®â</button></div>
      <div class="sheetBody">
        <div class="grid">
          <div class="field"><label><b>Code (6 caract√®res alphanum√©riques)</b></label>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="spaceCode" type="text" placeholder="ABC123" maxlength="6" style="text-transform:uppercase"/>
              <button class="btn" id="spaceGen">Cr√©er</button>
            </div>
          </div>
          <div class="field"><label><b>Ton pr√©nom</b></label><input id="spaceName" type="text" placeholder="Pr√©nom"/></div>
          <div class="grid" style="grid-template-columns:1fr 1fr"><button class="btn" id="spaceCancel">Annuler</button><button class="btn primary" id="spaceSave">Rejoindre</button></div>
          <div class="subtitle">Prototype : si tu cr√©es un code, un mini-assistant te demande le type & le profil.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalWizard">
    <div class="sheet">
      <div class="sheetHeader"><div id="wizTitle">Configurer l‚Äôespace</div><button class="closeX" id="closeWizard">‚®â</button></div>
      <div class="sheetBody"><div class="grid" id="wizStep"></div></div>
    </div>
  </div>

  <div class="modal" id="modalSettings">
    <div class="sheet">
      <div class="sheetHeader"><div id="spaceHeaderTitle"></div><button class="closeX" id="closeSettings">‚®â</button></div>
      <div class="stabs"><button class="stab active" data-sview="sinfo">Info</button><button class="stab" data-sview="sparams">Param√®tres</button></div>
      <div class="sheetBody">
        <div class="sview active" id="sinfo">
          <div class="grid">
            <div class="field"><label><b>Description</b></label><textarea id="spaceDesc" placeholder="Description courte de l‚Äôespace‚Ä¶"></textarea></div>
            <div class="opt"><div><b>Bar√®me des plantes</b><div class="subtitle" id="legendText"></div></div></div>
          </div>
        </div>
        <div class="sview" id="sparams">
          <div class="grid">
            <div class="opt">
              <div><b>P√©riode affich√©e</b><div class="subtitle">Classements & badges</div>
                <div style="margin-top:6px;display:flex;gap:8px"><button class="btnToggle" data-period="30">30 jours</button><button class="btnToggle" data-period="all">Total</button></div>
              </div>
            </div>
            <div class="field"><label><b>Pr√©nom</b></label><input id="paramName" type="text" value="Moi"/></div>
            <div class="field"><label><b>Nom de l‚Äôespace</b></label><input id="paramSpaceLabel" type="text"/></div>
          </div>
          <div style="margin-top:12px"><button class="btn danger" id="quitSpaceBtn">Quitter</button></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const CATS=[{id:'sante',emoji:'ü©∫',nom:'Sant√©'},{id:'relations',emoji:'ü§ù',nom:'Relations'},{id:'esprit',emoji:'üß†',nom:'Esprit'},{id:'corps',emoji:'üí™',nom:'Corps'},{id:'vie',emoji:'üß∫',nom:'Vie'},{id:'loisirs',emoji:'üé®',nom:'Loisirs'},{id:'repos',emoji:'üòå',nom:'Repos'}];
const CHALLENGES=[{type:'private',id:'screenoff',cat:'sante',emoji:'üõå',titre:'Sans √©cran avant le coucher',amis:['Anna','Ben','Chlo√©','Marc','Marie']},{type:'private',id:'repas',cat:'sante',emoji:'ü•ó',titre:'Repas sain fait maison',amis:['Ben','Duc']},{type:'private',id:'lire',cat:'esprit',emoji:'üìñ',titre:'Lire un livre ou un roman',amis:['Chlo√©']},{type:'private',id:'etire',cat:'corps',emoji:'ü§∏',titre:'√âtirements corporels',amis:['Anna','Marc']},{type:'private',id:'ranger',cat:'vie',emoji:'üßΩ',titre:'Rangement ou m√©nage',amis:['Chlo√©']},{type:'private',id:'creer',cat:'loisirs',emoji:'üé∏',titre:'Cr√©er ou jouer',amis:['Ben','Pauline']},{type:'private',id:'respirer',cat:'repos',emoji:'üå¨Ô∏è',titre:'Respiration coh√©rence cardiaque',amis:['Anna','Marie']}];
const GROUP_CHALLENGES=[{type:'group',id:'silence_matin',cat:'coloc',emoji:'ü§´',titre:'Silence matinal',amis:['Anna','Ben','Chlo√©','Marc','Marie']},{type:'group',id:'poubelles',cat:'coloc',emoji:'üóëÔ∏è',titre:'Descendre les poubelles',amis:['Anna','Ben','Chlo√©','Marc','Marie']},{type:'group',id:'cuisine',cat:'coloc',emoji:'üßΩ',titre:'Nettoyer la cuisine',amis:['Anna','Ben','Chlo√©','Marc','Marie']},{type:'group',id:'communs',cat:'coloc',emoji:'üß∫',titre:'Ranger les communs',amis:['Anna','Ben','Chlo√©','Marc','Marie']},{type:'group',id:'apero_coloc',cat:'coloc',emoji:'üçù',titre:'Repas partag√©',amis:['Anna','Ben','Chlo√©','Marc','Marie']},{type:'group',id:'energie',cat:'coloc',emoji:'‚ö°',titre:'√âconomie d‚Äô√©nergie',amis:['Anna','Ben','Chlo√©','Marc','Marie']},{type:'group',id:'wc_sdb',cat:'coloc',emoji:'üöΩ',titre:'Nettoyer WC & SDB',amis:['Anna','Ben','Chlo√©','Marc','Marie']},{type:'group',id:'silence_nuit',cat:'coloc',emoji:'üåô',titre:'Silence nocturne',amis:['Anna','Ben','Chlo√©','Marc','Marie']}];
const FAMILY_CHALLENGES=[{type:'group',id:'planning_semaine',cat:'famille',emoji:'üìÖ',titre:'Planning familial mis √† jour',amis:['Maman','Papa','L√©a','Tom']},{type:'group',id:'courses_pretes',cat:'famille',emoji:'üõí',titre:'Liste de courses faite ensemble',amis:['Maman','Papa','L√©a','Tom']},{type:'group',id:'linge_pli√©',cat:'famille',emoji:'üëï',titre:'Linge lav√©, pli√©, rang√©',amis:['Maman','Papa','L√©a','Tom']},{type:'group',id:'repas_prevu',cat:'famille',emoji:'üç≤',titre:'Menus de la semaine planifi√©s',amis:['Maman','Papa','L√©a','Tom']},{type:'group',id:'rdv_prepares',cat:'famille',emoji:'üìã',titre:'Rendez-vous & trajets anticip√©s',amis:['Maman','Papa','L√©a','Tom']},{type:'group',id:'chambres_rangees',cat:'famille',emoji:'üß∫',titre:'Pi√®ces communes et chambres rang√©es',amis:['Maman','Papa','L√©a','Tom']},{type:'group',id:'tri_recyclage',cat:'famille',emoji:'‚ôªÔ∏è',titre:'Tri s√©lectif & poubelles sorties',amis:['Maman','Papa','L√©a','Tom']},{type:'group',id:'check_dimanche',cat:'famille',emoji:'üïí',titre:'Pr√©paration de la semaine le dimanche',amis:['Maman','Papa','L√©a','Tom']}];
const CLASS_CHALLENGES=[{type:'group',id:'materiel_commun',cat:'classe',emoji:'üì¶',titre:'Mat√©riel collectif en ordre',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']},{type:'group',id:'tableaux_prop',cat:'classe',emoji:'üßΩ',titre:'Tableau nettoy√© en fin de cours',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']},{type:'group',id:'affiches',cat:'classe',emoji:'üìú',titre:'Affichage clair et √† jour',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']},{type:'group',id:'projets_planifies',cat:'classe',emoji:'üóÇÔ∏è',titre:'Projets ou expos√©s planifi√©s',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']},{type:'group',id:'materiel_partage',cat:'classe',emoji:'‚úèÔ∏è',titre:'Outils partag√©s bien rang√©s',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']},{type:'group',id:'retard_groupe',cat:'classe',emoji:'‚è∞',titre:'Tous √† l‚Äôheure au d√©but du cours',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']},{type:'group',id:'bilan_vendredi',cat:'classe',emoji:'üìä',titre:'Bilan collectif du vendredi fait',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']},{type:'group',id:'gestion_roles',cat:'classe',emoji:'ü™ë',titre:'R√¥les (pr√©sident, secr√©taire...) r√©partis',amis:['M. Dupont','Emma','Lucas','Sarah','Yanis','Clara']}];
const OFFICE_CHALLENGES=[{type:'group',id:'planning_equipe',cat:'bureau',emoji:'üìÖ',titre:'Planning d‚Äô√©quipe synchronis√©',amis:['Alice','Bob','Carla','Dan']},{type:'group',id:'reunion_prete',cat:'bureau',emoji:'üóìÔ∏è',titre:'R√©union pr√©par√©e & document√©e',amis:['Alice','Bob','Carla','Dan']},{type:'group',id:'projets_suivis',cat:'bureau',emoji:'üìã',titre:'Suivi des projets mis √† jour',amis:['Alice','Bob','Carla','Dan']},{type:'group',id:'stock_rang√©',cat:'bureau',emoji:'üì¶',titre:'Mat√©riel ou fournitures en ordre',amis:['Alice','Bob','Carla','Dan']},{type:'group',id:'postes_propres',cat:'bureau',emoji:'üßΩ',titre:'Bureaux et espace commun rang√©s',amis:['Alice','Bob','Carla','Dan']},{type:'group',id:'checkin_lundi',cat:'bureau',emoji:'üß≠',titre:'Check-in collectif du lundi',amis:['Alice','Bob','Carla','Dan']},{type:'group',id:'docs_partages',cat:'bureau',emoji:'üíæ',titre:'Docs communs organis√©s et nomm√©s',amis:['Alice','Bob','Carla','Dan']},{type:'group',id:'cloture_vendredi',cat:'bureau',emoji:'üïî',titre:'Cl√¥ture de la semaine en √©quipe',amis:['Alice','Bob','Carla','Dan']}];

const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function fmtDate(d){const M=['01','02','03','04','05','06','07','08','09','10','11','12'][d.getMonth()];const j=String(d.getDate()).padStart(2,'0');const J=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'][d.getDay()];return `${J} ${j}/${M}`;}
function genCode(){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';let s='';for(let i=0;i<6;i++)s+=c[Math.floor(Math.random()*c.length)];return s;}
function rint(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function lvlEmoji(v){if(v<=7)return'üå∞';if(v<=14)return'üå±';if(v<=21)return'üçÄ';if(v<=28)return'üåº';if(v<=35)return'üåª';if(v<=42)return'üå∑';if(v<=49)return'üåπ';if(v<=56)return'ü™ª';if(v<=64)return'üíê';return'üéã';}
function legend(){return['üå∞ 0‚Äì7 ‚Äî Graine','üå± 8‚Äì14 ‚Äî Pousse','üçÄ 15‚Äì21 ‚Äî Tr√®fle','üåº 22‚Äì28 ‚Äî Bourgeon','üåª 29‚Äì35 ‚Äî Tournesol','üå∑ 36‚Äì42 ‚Äî Tulipe','üåπ 43‚Äì49 ‚Äî Rose','ü™ª 50‚Äì56 ‚Äî Lavande','üíê 57‚Äì64 ‚Äî Bouquet','üéã 65+ ‚Äî Bambou'].join('<br>');}
function names(xs,m=3){if(xs.length<=m)return xs.join(', ');const s=xs.slice(0,m).join(', ');return `${s}‚Ä¶ et ${xs.length-m} autres`;}

/* === Espace / √©tat === */
let period='30';
const SPACES={'D0PWE3':{emoji:'üë§',label:'üë§ Individu',type:'private',ch:CHALLENGES,desc:'Espace personnel.'},'E8D3FS':{emoji:'üè†',label:'üè† Colocation',type:'group',ch:GROUP_CHALLENGES,desc:'Espace partag√© √† la maison.'},'WS32D7':{emoji:'‚ù§Ô∏è',label:'‚ù§Ô∏è Famille',type:'group',ch:FAMILY_CHALLENGES,desc:'Routines familiales au quotidien.'},'SR3S0D':{emoji:'üè´',label:'üè´ Classe',type:'group',ch:CLASS_CHALLENGES,desc:'Vie de classe et rituels p√©dagogiques.'},'PD03XZ':{emoji:'üè¢',label:'üè¢ Bureau',type:'group',ch:OFFICE_CHALLENGES,desc:'Rituels simples pour mieux travailler.'}};
let spaceId='D0PWE3', userName='Moi', dayOff=0, genThis=false;

/* === Scores simul√©s === */
const claps={};(()=>{const all=[...CHALLENGES,...GROUP_CHALLENGES,...FAMILY_CHALLENGES,...CLASS_CHALLENGES,...OFFICE_CHALLENGES];all.forEach(c=>{claps[c.id]={};[...new Set([...c.amis,'Moi'])].forEach(n=>claps[c.id][n]=Math.floor(Math.random()*101));});})();

/* === Fr√©quences par habitude (1..5) ‚Äî 40% = 1/jour === */
const FREQ={};
function defaultFreq(){return Math.random()<0.4?1:rint(2,5)}
;[...CHALLENGES,...GROUP_CHALLENGES,...FAMILY_CHALLENGES,...CLASS_CHALLENGES,...OFFICE_CHALLENGES].forEach(h=>{FREQ[h.id]=FREQ[h.id]||defaultFreq()});

/* === Visibilit√© d√©terministe par jour (25% masqu√©) === */
function daySerial(d){return Math.floor(d.getTime()/86400000)} // jours depuis epoch
function randDay(id,serial){let h=0;const s=id+':'+serial;for(let i=0;i<s.length;i++)h=(h*31+s.charCodeAt(i))>>>0;return (h%100)/100}
function isVisibleToday(hid,d){const serial=daySerial(d);const f=FREQ[hid]||1;const due=(serial%f)===0;const hidden=(randDay(hid,serial)<0.25);return due && !hidden}

/* === Helpers date & UI === */
function curDate(){const t=new Date();t.setHours(0,0,0,0);t.setDate(t.getDate()+dayOff);return t;}
function setHeat(p){$("#heat").style.height=`${Math.max(0,Math.min(100,p))}%`;}
function getSpace(){return SPACES[spaceId]||SPACES['D0PWE3'];}
function listChallenges(){return getSpace().ch;}
function findAny(id){return [...CHALLENGES,...GROUP_CHALLENGES,...FAMILY_CHALLENGES,...CLASS_CHALLENGES,...OFFICE_CHALLENGES].find(c=>c.id===id);}

function renderDateBar(){$("#dateLabel").textContent=fmtDate(curDate());const s=$$('#cards .levelBtn').map(b=>+b.dataset.doneToday||0).reduce((a,b)=>a+b,0);$("#todayCount").textContent=`üå± ${s}`;}
$("#prevDay").onclick=()=>{dayOff--;renderCards();renderDateBar()};$("#nextDay").onclick=()=>{dayOff++;renderCards();renderDateBar()};

/* === Cartes (r√®gles collectivis√©es pour tous les espaces) === */
let activeId=null, refBtn=null;
function renderCards(){
  const root=$("#cards");root.innerHTML='';
  const d=curDate();
  listChallenges().forEach(it=>{
    if(!isVisibleToday(it.id,d)) return; // fr√©quence + 25% al√©atoire

    const card=document.createElement('article');card.className='card';
    const cont=document.createElement('div');cont.className='content';
    const title=document.createElement('div');title.className='title';title.innerHTML=`<span style="font-size:24px">${it.emoji}</span><span class="base">${it.titre}</span><span class="hint" id="h-${it.id}"></span>`;
    const friends=document.createElement('div');friends.className='friends';

    // Badges selon r√®gles "collectif" appliqu√©es partout
    let seedNames=[];
    if(Math.random()<.5){ // üå±
      const n=rint(1,2);seedNames=[...it.amis].sort(()=>Math.random()-.5).slice(0,n);
      const b=document.createElement('div');b.className='badge seed-badge';b.textContent=`üå± ${names(seedNames)}`;friends.appendChild(b);
    }
    if(Math.random()<.7){ // üåû
      const n=rint(2,5),sun=[...it.amis].sort(()=>Math.random()-.5).slice(0,n);
      const b=document.createElement('div');b.className='badge sun-badge';b.textContent=`üåû ${names(sun)}`;friends.appendChild(b);
    }

    cont.append(title,friends);

    const col=document.createElement('div');col.className='levelCol';
    const btn=document.createElement('button');btn.className='levelBtn';btn.dataset.cid=it.id;
    const base=Math.floor(Math.random()*65), suns=claps[it.id]?.['Moi']??0;
    btn.dataset.basePlants=String(base);btn.dataset.plants=String(base);btn.dataset.suns=String(suns);btn.dataset.doneToday='0';
    const draw=()=>{const p=+btn.dataset.plants||0;const s=+btn.dataset.suns||0;const tot=p+s;btn.innerHTML=`<div class="big">${lvlEmoji(tot)}</div><div class="scoreText">${tot}</div>`};draw();

    const updSeed=()=>{const sb=friends.querySelector('.seed-badge');if(!sb)return;const nm=seedNames||[];if(!nm.length){sb.remove();return}sb.textContent=`üå± ${names(nm)}`};

    const toggle=()=>{const done=btn.dataset.doneToday==='1', b=+btn.dataset.basePlants||0;
      if(!done){
        btn.dataset.doneToday='1';btn.dataset.plants=String(b+1);card.classList.add('done');
        if(!seedNames.includes('Moi'))seedNames=['Moi',...seedNames];
        if(!friends.querySelector('.seed-badge')){const sb=document.createElement('div');sb.className='badge seed-badge';friends.prepend(sb)}
        updSeed();
      }else{
        btn.dataset.doneToday='0';btn.dataset.plants=String(b);card.classList.remove('done');
        const i=seedNames.indexOf('Moi');if(i>-1)seedNames.splice(i,1);updSeed();
      }
      draw();renderDateBar();setHeat($$('.levelBtn').reduce((a,b)=>a+(b.dataset.doneToday==='1'?10:0),0));
    };
    col.onclick=toggle;cont.onclick=()=>openDetail(it.id,btn);

    col.append(btn);card.append(cont,col);root.appendChild(card);
  });
  renderDateBar();
}

function populateCalWho(){const wrap=$("#calWhoWrap"),sel=$("#calWho");if(getSpace().type!=='group'){wrap.style.display='none';return}wrap.style.display='flex';sel.innerHTML='';sel.add(new Option('Tous','__all__'));sel.add(new Option('Moi','Moi'));(findAny(activeId)?.amis||[]).forEach(n=>sel.add(new Option(n,n)));sel.value='__all__';}
function openDetail(id,btnRef){activeId=id;refBtn=btnRef;$("#home").classList.remove('active');$("#detail").classList.add('active');$("#daysWrap").style.display='none';$$('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="friends"]').classList.add('active');$$('#detail .view').forEach(v=>v.classList.remove('active'));$('#tab-friends').classList.add('active');const it=findAny(id);$("#detailTitle").textContent=`${it.emoji} ${it.titre}`;renderRank();populateCalWho();renderCalendar();renderHabitSettings();}
$("#backHome").onclick=$("#brand").onclick=()=>{$("#detail").classList.remove('active');$("#home").classList.add('active');$("#daysWrap").style.display='flex'};

function brnd(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function renderRank(){
  const it=findAny(activeId),range=period==='30'?[1,30]:[1,120];
  const rows=[...it.amis.map(n=>{const p=brnd(...range),s=brnd(...range);return{n,plants:p,suns:s,total:p+s,me:false}}),
    (()=>{const p=brnd(...range),s=brnd(...range);return{n:userName||'Moi',plants:p,suns:s,total:p+s,me:true}})()].sort((a,b)=>b.total-a.total);
  const root=$("#rank");root.innerHTML='';
  rows.forEach(({n,plants,suns,me})=>{
    const row=document.createElement('div');row.className='row';
    const left=document.createElement('div');left.style.display='flex';left.style.alignItems='center';left.style.gap='8px';
    const big=document.createElement('span');big.className='scoreEmoji';big.textContent=`${lvlEmoji(plants+suns)} ${plants+suns}`;
    const name=document.createElement('b');name.textContent=`${n}${me?' (toi)':''}`;left.append(big,name);
    const right=document.createElement('div');right.style.display='flex';right.style.alignItems='center';right.style.gap='12px';
    const clap=document.createElement('button');clap.className='navbtn';clap.dataset.liked='0';clap.dataset.base=String(suns);clap.title='üåû';clap.textContent=`üåû ${suns}`;
    clap.onclick=()=>{const base=+clap.dataset.base||0,liked=clap.dataset.liked==='1';clap.dataset.liked=liked?'0':'1';clap.textContent=`üåû ${liked?base:base+1}`;clap.style.outline=liked?'none':'2px solid var(--green)';};
    right.append(clap);row.append(left,right);root.appendChild(row);
  });
}
function updPeriodBtns(){$$('#btnP30,#btnPAll,#modalSettings .btnToggle').forEach(b=>b.classList.toggle('active',b.dataset.period===period))}
$('#btnP30').onclick=()=>{period='30';updPeriodBtns();renderRank()};$('#btnPAll').onclick=()=>{period='all';updPeriodBtns();renderRank()};

let calOff=0;
function minfo(off=0){const b=new Date();b.setDate(1);b.setMonth(b.getMonth()+off);const y=b.getFullYear(),m=b.getMonth();return{y,m,fd:(new Date(y,m,1).getDay()+6)%7,days:new Date(y,m+1,0).getDate()}}
function renderCalendar(){
  const wrap=$("#cal");wrap.innerHTML='';const {y,m,fd,days}=minfo(calOff);const months=['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ª','Sep','Oct','Nov','D√©c'];let monthSeeds=0;
  for(let i=0;i<fd;i++){const c=document.createElement('div');c.className='cell';c.style.opacity=.35;wrap.appendChild(c)}
  const today=new Date(),sameMonth=(calOff===0),isGroup=getSpace().type==='group';let prob=.5; if(isGroup){const who=$("#calWho").value||'__all__';prob=(who==='__all__')?.35:.15}
  for(let d=1;d<=days;d++){const c=document.createElement('div');c.className='cell';const dn=document.createElement('div');dn.className='dayNum';dn.textContent=String(d);c.appendChild(dn);
    if(Math.random()<prob){const seed=document.createElement('div');seed.className='seedMark';seed.textContent='üå±';c.appendChild(seed);monthSeeds++}
    if(sameMonth&&d===today.getDate()){c.style.outline=`2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--green')}`}
    c.onclick=()=>{const b=new Date();b.setDate(1);b.setMonth(b.getMonth()+calOff);const tgt=new Date(b.getFullYear(),b.getMonth(),d),now=new Date();now.setHours(0,0,0,0);dayOff=Math.round((tgt-now)/86400000);$("#detail").classList.remove('active');$("#home").classList.add('active');$("#daysWrap").style.display='flex';renderCards();renderDateBar();window.scrollTo({top:0,behavior:'smooth'})};
    wrap.appendChild(c)
  }
  $("#monthLabel").textContent=`${months[m]} ${y}  üå±${monthSeeds}`;
}
$("#prevMonth").onclick=()=>{calOff--;renderCalendar()};$("#nextMonth").onclick=()=>{calOff++;renderCalendar()};$("#calWho")?.addEventListener('change',renderCalendar);

/* Tabs d√©tail (incluant Param√®tres) */
$$('.tab').forEach(t=>t.addEventListener('click',()=>{$$('.tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');const n=t.dataset.tab;$$('#detail .view').forEach(v=>v.classList.remove('active'));$('#tab-'+n).classList.add('active');if(n==='progress')renderCalendar();if(n==='settings')renderHabitSettings()}));

/* Onglet Param√®tres d'une habitude */
function renderHabitSettings(){
  const sel=$("#freqSelect");if(!activeId||!sel)return;
  sel.value=String(FREQ[activeId]||1);
  sel.onchange=()=>{FREQ[activeId]=parseInt(sel.value||'1',10);renderCards();};
}

const mAdd=$("#modalAdd"),mHabit=$("#modalHabit"),mInvite=$("#modalInvite"),mSettings=$("#modalSettings"),mSpace=$("#modalSpace"),mWizard=$("#modalWizard");
const open=m=>m.classList.add('on'), close=m=>m.classList.remove('on');

$("#addBtn").onclick=()=>open(mAdd);$("#closeAdd").onclick=()=>close(mAdd);
$("#addHabit").onclick=()=>{close(mAdd);open(mHabit);step1()};$("#inviteFriend").onclick=()=>{close(mAdd);openInvite()};$("#joinSpace").onclick=()=>{close(mAdd);open(mSpace)};
function openInvite(){const code=spaceId;$("#inviteLink").value=`https://habitu.be/?code=${code}`;open(mInvite)}
$("#closeInvite").onclick=()=>close(mInvite);
$("#copyInvite").onclick=async()=>{try{await navigator.clipboard.writeText($("#inviteLink").value);alert("Lien copi√© !")}catch(e){alert("Copie impossible")}}

function switchS(id){$$('.stab').forEach(b=>b.classList.toggle('active',b.dataset.sview===id));$$('.sview').forEach(v=>v.classList.toggle('active',v.id===id))}
$$('.stab').forEach(b=>b.onclick=()=>switchS(b.dataset.sview));
$("#closeSettings").onclick=()=>{saveSettings();close(mSettings)};

function saveSettings(){
  const sp=getSpace();
  sp.desc=$("#spaceDesc").value.trim();
  userName=$("#paramName").value.trim()||'Moi';
  const txt=$("#paramSpaceLabel").value.trim()||sp.label;
  const hasEmoji=/^\p{Emoji}/u.test(txt);
  sp.label=hasEmoji?txt:`${sp.emoji} ${txt}`;
  updSel();updSettingsTitle();
}

$("#quitSpaceBtn").onclick=()=>{const sp=getSpace();if(confirm(`Quitter ${sp.label} (${spaceId}) ?`)){spaceId='D0PWE3';updSel();renderCards();close(mSettings)}};

$("#settingsBtn").onclick=()=>{
  const sp=getSpace();updSettingsTitle();$("#legendText").innerHTML=legend();$("#spaceDesc").value=sp.desc||'';$("#paramName").value=userName||'Moi';$("#paramSpaceLabel").value=sp.label;
  $$('#modalSettings .btnToggle').forEach(b=>{b.classList.toggle('active',b.dataset.period===period);b.onclick=()=>{period=b.dataset.period;updPeriodBtns();renderRank()}})
  $("#quitSpaceBtn").textContent=`Quitter ${sp.label} (${spaceId})`;switchS('sinfo');open(mSettings);
};
function updSettingsTitle(){const sp=getSpace();$("#spaceHeaderTitle").textContent=`${sp.label} (${spaceId})`}

let pickedCat=null;
function step1(){const root=$("#step1");$("#step1").style.display='grid';$("#step2").style.display='none';root.innerHTML='';CATS.forEach(c=>{const el=document.createElement('div');el.className='opt';el.innerHTML=`<div class="emoji">${c.emoji}</div><div><b>${c.nom}</b></div>`;el.onclick=()=>{pickedCat=c.id;step2()};root.appendChild(el)})}
function step2(){const root=$("#step2");$("#step1").style.display='none';$("#step2").style.display='grid';root.innerHTML='';CHALLENGES.filter(x=>x.cat===pickedCat).forEach(x=>{const el=document.createElement('div');el.className='opt';el.innerHTML=`<div class="emoji">${x.emoji}</div><div><b>${x.titre}</b></div>`;el.onclick=()=>{alert("Habitude ajout√©e (d√©mo)");close(mHabit)};root.appendChild(el)})}
$("#closeHabit").onclick=()=>close(mHabit);

$("#spaceGen").onclick=()=>{$("#spaceCode").value=genCode();genThis=true};$("#spaceCancel").onclick=()=>{close(mSpace);genThis=false};$("#closeSpace").onclick=()=>{close(mSpace);genThis=false};
$("#spaceSave").onclick=()=>{
  const code=($("#spaceCode").value||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,6), name=($("#spaceName").value||'').trim()||'Moi';
  if(!code){alert("Entre un code d‚Äôespace.");return}
  if(genThis){close(mSpace);launchWizard(code,name)}else{if(!SPACES[code])SPACES[code]={emoji:'üë§',label:'üë§ Individu',type:'private',ch:CHALLENGES,desc:''};spaceId=code;userName=name;updSel();renderCards();close(mSpace)}
  genThis=false;
};

let wiz={code:'',name:'',type:'private',profile:'Autre'};
function launchWizard(code,name){wiz={code,name,type:'private',profile:'Autre'};open(mWizard);wizType()}
function wizType(){$("#wizTitle").textContent="Choisir le type d‚Äôespace";const root=$("#wizStep");root.innerHTML='';[{id:'private',emoji:'üë§',title:'Priv√©',desc:'Espace personnel.'},{id:'group',emoji:'üë•',title:'Collectif',desc:'Badges visibles.'}].forEach(o=>{const el=document.createElement('div');el.className='opt';el.innerHTML=`<div class="emoji">${o.emoji}</div><div><b>${o.title}</b><div class="subtitle">${o.desc}</div></div>`;el.onclick=()=>{wiz.type=o.id;wizProfile()};root.appendChild(el)})}
function wizProfile(){$("#wizTitle").textContent="Choisir un profil";const root=$("#wizStep");root.innerHTML='';[{id:'Famille',emoji:'‚ù§Ô∏è',desc:'Routines familiales.'},{id:'Colocation',emoji:'üè†',desc:'Vie commune.'},{id:'Bureau',emoji:'üè¢',desc:'Rituels d‚Äô√©quipe.'},{id:'Autre',emoji:'‚ú®',desc:'Profil libre.'}].forEach(o=>{const el=document.createElement('div');el.className='opt';el.innerHTML=`<div class="emoji">${o.emoji}</div><div><b>${o.id}</b><div class="subtitle">${o.desc}</div></div>`;el.onclick=()=>{wiz.profile=o.id;wizFinalize()};root.appendChild(el)})}
function wizFinalize(){
  const code=wiz.code;let d={emoji:'üë§',label:'üë§ Individu',type:'private',ch:CHALLENGES,desc:'Espace personnel.'};
  if(wiz.type==='group'){if(wiz.profile==='Famille')d={emoji:'‚ù§Ô∏è',label:'‚ù§Ô∏è Famille',type:'group',ch:FAMILY_CHALLENGES,desc:'Routines familiales au quotidien.'};else if(wiz.profile==='Colocation')d={emoji:'üè†',label:'üè† Colocation',type:'group',ch:GROUP_CHALLENGES,desc:'Espace partag√© √† la maison.'};else if(wiz.profile==='Bureau')d={emoji:'üè¢',label:'üè¢ Bureau',type:'group',ch:OFFICE_CHALLENGES,desc:'Rituels simples pour mieux travailler.'};else d={emoji:'üë•',label:'üë• Collectif',type:'group',ch:GROUP_CHALLENGES,desc:'Espace partag√©.'}}
  SPACES[code]=d;spaceId=code;userName=wiz.name;updSel();close(mWizard);renderCards();
}
$("#closeWizard").onclick=()=>close(mWizard);

function updSel(){
  const sel=$("#spaceSel");sel.innerHTML='';
  const order=['E8D3FS','D0PWE3','WS32D7','SR3S0D','PD03XZ'];
  order.forEach(id=>{if(SPACES[id]){const o=document.createElement('option');o.value=id;o.textContent=`${SPACES[id].label} (${id})`;sel.appendChild(o)}})
  Object.keys(SPACES).forEach(id=>{if(!order.includes(id)){const o=document.createElement('option');o.value=id;o.textContent=`${SPACES[id].label} (${id})`;sel.appendChild(o)}})
  sel.value=spaceId;
}
const sel=$("#spaceSel");sel.addEventListener('change',()=>{spaceId=sel.value;renderCards();if($("#detail").classList.contains('active')){$("#detail").classList.remove('active');$("#home").classList.add('active');$("#daysWrap").style.display='flex'}});

function renderCalendarAndKeepMonth(){renderCalendar()}
let dayInit=false;function renderDateOnce(){if(!dayInit){dayOff=0;renderDateBar();dayInit=true}}
renderCards();renderCalendarAndKeepMonth();renderDateOnce();updPeriodBtns();updSel();
document.addEventListener('keydown',e=>{if(e.key==='Escape'){[mAdd,mHabit,mInvite,mSettings,mSpace,mWizard].forEach(m=>m.classList.remove('on'))}})
</script>
</body></html>
