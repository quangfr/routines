<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#f4f7fb" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <title>Habitube ‚Äî Les petites habitudes qui changent tout </title>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
  <script>
    const HABITU_FIREBASE_CONFIG = {
      apiKey: "AIzaSyD_dzzwWVEE0_aCMIbmbjPoYAj9Lzgb8J4",
      authDomain: "routine-buddy-2e6e5.firebaseapp.com",
      projectId: "routine-buddy-2e6e5",
      appId: "1:541875105784:web:cb5dc97a24afd05bae700d"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(HABITU_FIREBASE_CONFIG);
    }
    window.HABITU_FIREBASE_AUTH = firebase.auth();
    HABITU_FIREBASE_AUTH.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    window.HABITU_FIREBASE_DB = firebase.firestore();
  </script>
  <style>
    :root {
      --bg: #f7f3ea;
      --card: #fffdf8;
      --text: #1e1f1a;
      --green: #2a7a57;
      --border: #c6beae;
      --r: 4px;
      --gap: 8px;
      --fs: 13px
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font: 400 var(--fs)/1.35 system-ui, -apple-system, Roboto, sans-serif;
      color: var(--text);
      background: var(--bg)
    }

    body.no-space {
      background: var(--card);
    }

    body.no-space .top,
    body.no-space #daysWrap {
      display: none;
    }

    #app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100%;
      display: flex;
      flex-direction: column;
      position: relative
    }

    button,
    .select,
    .tab,
    .stab,
    .btn,
    .btnToggle,
    .navbtn,
    .calBtn,
    .backMini {
      font: 600 13px/1.2 system-ui, -apple-system, Roboto, sans-serif;
      padding: 6px 10px;
      border-radius: var(--r);
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--card)
    }

    .btn.primary {
      background: var(--green);
      color: #fff;
      border-color: transparent
    }

    .btn.danger {
      border-color: #d99;
      color: #600;
      background: #fff5f5
    }

    .btn.secondary {
      background: #fff;
      border-color: var(--border);
      color: var(--text);
    }

    .btnToggle.active,
    .tab.active,
    .stab.active {
      outline: 2px solid var(--green)
    }

    .select {
      appearance: none
    }

    .top {
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 6;
      border-bottom: 1px solid var(--border);
      padding: 6px var(--gap);
      display: flex;
      align-items: center;
      gap: 8px
    }

    .brand {
      font-weight: 800;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .brand .logo {
      font-size: 18px
    }

    .spacer {
      flex: 1
    }

    .empty-state {
      margin: 48px 16px;
      text-align: center;
      font-size: 14px;
      color: #5f5f5f;
      line-height: 1.6;
    }

    .auth-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20;
      padding: 16px
    }

    .loader-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px 16px 40px;
      z-index: 25;
    }

    .loader-overlay.hide {
      display: none;
    }

    .loader-title {
      font-size: 28px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .loader-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      text-align: center;
    }

    .loader-emoji {
      font-size: 82px;
      animation: loader-bounce 1.6s ease-in-out infinite;
    }

    .loader-tip {
      font-size: 14px;
      color: #4d4d4d;
      max-width: 260px;
      line-height: 1.35;
      font-weight: 500;
    }

    .loader-version {
      font-size: 12px;
      color: #7a4900;
      margin-top: auto;
      align-self: stretch;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    @keyframes loader-bounce {
      0% {
        transform: scale(1) translateY(0);
      }

      40% {
        transform: scale(1.05) translateY(-6px);
      }

      65% {
        transform: scale(0.98) translateY(2px);
      }

      100% {
        transform: scale(1) translateY(0);
      }
    }

    .auth-card {
      width: 320px;
      background: #fffdf8;
      border: 1px solid rgba(0, 0, 0, .08);
      border-radius: 14px;
      box-shadow: 0 30px 60px rgba(0, 0, 0, .12);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      text-align: center
    }

    .auth-card img {
      width: 80px;
      height: 80px;
      border-radius: 16px;
      margin: 0 auto
    }

    .auth-card form {
      display: flex;
      flex-direction: column;
      gap: 10px
    }

    .auth-card input {
      font: 400 14px/1.2 system-ui, -apple-system, Roboto, sans-serif;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #fff
    }

    .auth-card button {
      font: 600 14px/1.2 system-ui, -apple-system, Roboto, sans-serif;
      background: var(--green);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px;
      cursor: pointer
    }

    .auth-card .auth-actions {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: nowrap;
      margin-top: 0px;
      width: 100%;
    }

    .auth-card .auth-actions button {
      flex: 1;
      min-width: 0;
    }

    .auth-card .auth-actions button.text-btn {
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 8px;
    }

    .auth-card .auth-actions button.text-btn.secondary {
      background: var(--card);
      color: var(--green);
      border: 1px solid var(--green);
    }

    .auth-card .auth-guest-btn {
      margin-top: 12px;
      width: 100%;
      font-size: 12px;
      margin-bottom: 12px;
      background: var(--card);
      color: var(--green);
      border: 1px solid var(--green);
      padding: 6px 10px;
    }

    .auth-separator {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 18px 0px 12px;
      font-size: 10px;
      color: #8c8c8c;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .auth-separator span {
      flex: 1;
      height: 1px;
      background: #dcdcdc;
    }

    .auth-separator .label {
      padding: 0 8px;
      background: var(--card);
    }

    .auth-link-row {
      display: flex;
      justify-content: left;
      gap: 6px;
      margin-top: 0px;
    }

    .auth-link {
      font-size: 12px;
      color: var(--green);
      cursor: pointer;
      text-decoration: underline;
    }

    .auth-card .auth-error {
      font-size: 12px;
      color: #d33;
      min-height: 12px
    }

    .auth-helper {
      font-size: 12px;
      color: var(--green);
      min-height: 18px;
    }

    .auth-note {
      margin-top: 16px;
    }

    .auth-card .auth-note {
      font-size: 12px;
      color: #555;
      margin-top: 12px
    }

    .auth-space-desc {
      font-size: 13px;
      color: #5f5f5f;
      min-height: 20px;
    }

    .space-footer {
      margin-top: 16px;
      display: flex;
      gap: 8px;
      justify-content: space-between;
      align-items: center;
    }

    .space-footer .btn {
      flex: 1;
    }

    .auth-forms {
      position: relative
    }

    .auth-forms form {
      transition: opacity .2s ease
    }

    .auth-forms form.hide {
      opacity: 0;
      pointer-events: none;
      position: absolute;
      inset: 0
    }

    .garden-filter {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      max-width: 100%;
      margin-bottom: 12px
    }

    .garden-filter button {
      flex: 1 1 auto;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer
    }

    .garden-filter button.active {
      border-color: var(--green);
      color: var(--green);
      font-weight: 700
    }

    .garden-config {
      display: flex;
      gap: 8px;
      margin-bottom: 12px
    }

    .garden-config button {
      flex: 1;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer
    }

    .garden-config button.active {
      border-color: var(--green);
      color: var(--green);
      font-weight: 700
    }

    .garden-type {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      text-align: left;
      cursor: pointer
    }

    .garden-type .emoji {
      font-size: 22px
    }

    .garden-type.active {
      border-color: var(--green);
      box-shadow: 0 0 0 2px rgba(42, 122, 87, .2)
    }

    .auth-overlay.hide {
      display: none
    }

    .garden-form {
      display: flex;
      flex-direction: column;
      gap: 12px
    }

    .garden-form .field {
      display: flex;
      flex-direction: column;
      gap: 6px
    }

    .garden-form .field button {
      align-self: flex-start
    }

    .invite-row {
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      background: #fff;
      flex-wrap: wrap;
      justify-content: flex-start
    }

    .invite-name {
      font-weight: 600;
      white-space: nowrap;
    }

    .invite-link-row {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .invite-link-input {
      flex: 1;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 12px;
      background: #fffdf8;
      cursor: pointer;
    }

    .invite-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 260px;
      overflow: auto
    }

    .auth-message {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px
    }

    .garden-habit-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 320px;
      overflow: auto
    }

    .garden-habit {
      display: flex;
      gap: 8px;
      align-items: center;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 8px;
      background: #fff
    }

    .garden-habit label {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer
    }

    .garden-habit .emoji {
      font-size: 18px
    }

    .garden-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
      position: sticky;
      bottom: 0;
      background: linear-gradient(180deg, #fffdf8 80%, transparent);
      padding-top: 4px
    }

    .garden-footer button {
      min-width: 120px
    }

    .garden-steps {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      justify-content: center
    }

    .garden-steps span {
      flex: 1 1 auto;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, .2);
      font-size: 12px
    }

    .garden-steps span.active {
      border-color: var(--green);
      color: var(--green);
      font-weight: 700
    }

    .daysWrap {
      position: sticky;
      top: 44px;
      background: var(--bg);
      z-index: 5;
      border-bottom: 1px solid var(--border);
      padding: 6px var(--gap);
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: space-between
    }

    .rightBtns {
      display: flex;
      flex-direction: row;
      gap: 6px;
      align-items: flex-end
    }

    .dateLabel {
      font-weight: 700;
      padding: 0;
      border: none;
      background: transparent
    }

    .list {
      padding: var(--gap);
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--gap);
      position: relative;
      z-index: 1
    }

    .card {
      border: 1px solid var(--border);
      background: var(--bg);
      border-radius: var(--r);
      display: grid;
      grid-template-columns: 64px 1fr;
      overflow: hidden
    }

    /* Encadr√©s par √©tat + auteur + mode */
    .card.s0 {
      border: 2px solid #e05555
    }

    /* rouge = √Ä faire (Individuel) */
    .card.s0shared {
      border: 2px solid #bfb9ad
    }

    /* gris = √Ä faire (Partag√©) */
    .card.s1me,
    .card.s1help {
      border: 2px solid #e6c200
    }

    /* jaune = Je fais / J'aide */
    .card.s1other,
    .card.s2other {
      border: 2px solid #bfb9ad
    }

    /* gris = En cours (autre) / Fait (autre) */
    .card.s2me {
      border: 2px solid var(--green)
    }

    /* vert = Fait (moi) */

    .content {
      padding: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px
    }

    .title {
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      min-height: 22px;
      justify-content: space-between
    }

    .weekly-progress {
      display: none;
      gap: 2px;
      align-items: center;
      margin-top: 2px;
      flex-wrap: wrap;
    }

    .weekly-progress__block {
      width: 28px;
      height: 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #f4e0c7;
      transition: background .2s, border-color .2s;
    }

    .weekly-progress__block--done {
      background: var(--green);
      border-color: transparent;
    }

    .weekly-progress__block--active {
      background: #f3c44a;
      border-color: #f3c44a;
    }

    .weekly-progress__block--pending {
      background: #f7f3ea;
    }

    .title .left {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap
    }

    .title .base.strike {
      text-decoration: line-through;
      opacity: .75
    }

    .infoBtn {
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 4px 6px;
      border-radius: var(--r);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: inherit;
      cursor: pointer;
    }

    .desc {
      font-size: 11px;
      color: #8f8f8c;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      cursor: default
    }

    .desc.open {
      -webkit-line-clamp: unset;
      display: block;
      white-space: pre-line;
      overflow: visible
    }

    .desc.hidden {
      display: none
    }

    textarea#habitDesc {
      min-height: calc(1.35em*3.5);
      line-height: 1.35;
      resize: vertical;
      padding: 6px;
      border: 1px solid var(--border);
      border-radius: var(--r);
      font: 400 var(--fs)/1.35 system-ui, -apple-system, Roboto, sans-serif;
    }

    .weekSummary {
      position: absolute;
      left: -3px;
      right: -3px;
      height: 24px;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: var(--r);
      background: #f4e0c7;
      color: #5b3f21;
      font-weight: 600;
      font-size: 12px;
      border: 1px solid rgba(132, 98, 61, .35);
      z-index: 2;
      pointer-events: none;
    }

    /* Badges */
    .friends {
      margin-top: auto;
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
      min-height: 26px
    }

    .friends-badges {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .friends .card-edit {
      margin-left: auto;
      padding: 4px 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--r);
      border: 1px solid var(--border);
      background: var(--bg);
      cursor: pointer;
      font-size: 11px;
      color: inherit;
    }

    .badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px;
      border: 1px solid var(--border);
      border-radius: var(--r);
      background: #fff;
      font-size: 11px;
      line-height: 1.2
    }

    .badge.heart {
      border-color: #c6beae;
      background: #fff0fb
    }

    .badge.heart.liked {
      border-color: #f3b
    }

    /* Tag de mode ‚Äî supprim√© visuellement */
    .modeTag {
      display: none
    }

    .levelCol {
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer
    }

    .levelBtn {
      width: 100%;
      height: 100%;
      padding: 0;
      border-radius: 0;
      border: none;
      border-right: 1px solid var(--border);
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      user-select: none;
      line-height: 1.05;
      position: relative
    }

    .levelBtn.done {
      background: var(--bg);
    }

    .levelBtn .big {
      font-size: 28px;
      font-weight: 800;
      text-align: center;
    }

    .levelBtn .scoreText {
      display: none;
    }

    .freq-sub-jours {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    /* Sections & vues */
    .section {
      padding: var(--gap)
    }

    .detailHead {
      display: flex;
      align-items: center;
      gap: 8px;
      position: sticky;
      top: 0;
      z-index: 5;
      background: var(--bg);
      padding: 6px var(--gap);
      border-bottom: 1px solid var(--border)
    }

    .detailTitle {
      font-weight: 800;
      font-size: 16px
    }

    .tabs {
      display: flex;
      gap: 6px;
      padding: var(--gap);
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      position: sticky;
      top: 80px;
      z-index: 4
    }

    .tab {
      flex: 1;
      text-align: center
    }

    .view {
      display: none
    }

    .view.active {
      display: block
    }

    .rankHeader {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px
    }

    .rank {
      display: grid;
      gap: 8px;
      margin-top: 8px
    }

    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px;
      border: 1px solid var(--border);
      background: var(--bg);
      border-radius: var(--r)
    }

    .leftRank {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .scoreEmoji {
      font-size: 18px;
      font-weight: 900;
      margin-left: 4px;
      white-space: pre-line
    }

    .profile-link {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      font: inherit;
      color: inherit;
      cursor: pointer;
      text-align: left;
    }

    .profile-head {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: space-between;
    }

    .profile-head .detailTitle {
      margin: 0;
    }

    .profile-head .profile-meta {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
    }

    .profile-head-actions {
      display: flex;
      gap: 6px;
    }

    .profile-period-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      position: sticky;
      top: 54px;
      background: var(--bg);
      padding: 0 var(--gap);
      border-bottom: 1px solid var(--border);
      z-index: 4;
    }

    .profile-period-buttons {
      display: flex;
      gap: 6px;
    }

    .profile-habit-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }

    .profile-habit {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      border-radius: var(--r);
      gap: 12px;
      cursor: pointer;
    }

    .profile-habit .leftRank {
      gap: 8px;
    }

    .profile-habit-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      font-size: 14px;
    }

    .profile-habit-stats {
      display: grid;
      grid-template-columns: repeat(2, auto);
      gap: 8px;
      font-size: 12px;
      align-items: center;
      justify-content: flex-end;
    }

    .profile-habit .scoreEmoji {
      font-size: 12px;
      font-weight: 700;
      margin-left: 0;
    }

    .calendarWrap {
      padding: 0 var(--gap) var(--gap)
    }

    .calTop {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 8px
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      position: relative
    }

    .cell {
      height: 55px;
      display: grid;
      place-items: center;
      border: 1px dashed var(--border);
      background: var(--card);
      border-radius: var(--r);
      position: relative;
      overflow: hidden;
      cursor: pointer
    }

    .dayNum {
      position: absolute;
      top: 4px;
      right: 6px;
      font-size: 10px;
      color: #777
    }

    .seedMark {
      position: absolute;
      top: 18px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 14px;
      line-height: 1;
      font-weight: 700
    }

    .calendar.week-mode .seedMark {
      display: none;
    }

    .cell .dur {
      position: absolute;
      bottom: 2px;
      left: 4px;
      right: 4px;
      text-align: center;
      font: 800 12px/1 system-ui
    }

    /* Modales */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      background: rgba(0, 0, 0, .2);
      padding: 0;
      z-index: 10
    }

    .modal.on {
      display: flex;
      align-items: stretch;
      justify-content: stretch
    }

    .sheet {
      position: absolute;
      inset: 0;
      background: var(--card)
    }

    .sheetHeader {
      position: sticky;
      top: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 10px var(--gap);
      border-bottom: 1px solid var(--border);
      background: var(--bg)
    }

    .sheetHeader>div {
      flex: 1;
      text-align: center;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .closeX.locked {
      cursor: not-allowed;
      opacity: 0.4;
    }

    .sheetBody {
      padding: var(--gap);
      height: calc(100% - 50px);
      overflow: auto;
      background: var(--bg)
    }

    .modal-link-row {
      display: flex;
      justify-content: flex-end;
      margin-top: 12px;
    }

    .link-text {
      background: none;
      border: none;
      color: var(--green);
      font-size: 13px;
      font-weight: 600;
      text-decoration: underline;
      cursor: pointer;
      padding: 0;
    }

    .link-text:focus-visible {
      outline: 2px solid var(--green);
      border-radius: 4px;
    }

    @media (min-width: 720px) {
      .modal.on {
        align-items: center;
        justify-content: center;
      }

      .sheet {
        position: relative;
        inset: auto;
        width: min(520px, 96vw);
        max-width: 520px;
        max-height: 90vh;
        margin: 0 12px;
        border-radius: 16px;
        box-shadow: 0 24px 48px rgba(0, 0, 0, .25);
      }

      .sheetBody {
        height: auto;
        max-height: calc(90vh - 60px);
      }
    }

    .grid {
      display: grid;
      gap: 8px
    }

    .tag-section {
      display: grid;
      gap: 6px;
      padding: 4px 0;
    }

    .tag-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag {
      border: 1px solid var(--border);
      background: #fffdf8;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text);
      transition: border-color .2s, color .2s, background .2s;
    }

    .tag.active {
      border-color: var(--green);
      color: var(--green);
      background: #e6f4ea;
    }

    .habit-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .habit-btn {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      background: var(--card);
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: border-color .2s, color .2s, background .2s;
    }

    .habit-btn .emoji {
      font-size: 16px;
    }

    .habit-btn.selected {
      border-color: var(--green);
      color: var(--green);
      background: #eaf4ee;
    }

    .habit-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
      margin-top: 12px;
    }

    .habit-actions.footer-sticky {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      flex-wrap: wrap;
      padding: 10px var(--gap);
      margin-top: 0;
      background: var(--bg);
      border-top: 1px solid var(--border);
      z-index: 2;
      justify-content: space-between;
    }

    .habit-actions__info {
      flex: 1;
      text-align: left;
      font-size: 12px;
      color: #5f5f5f;
      align-self: center;
    }

    .opt {
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: var(--r);
      padding: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      cursor: pointer
    }

    .opt.disabled {
      opacity: 0.45;
      cursor: not-allowed;
      pointer-events: none;
      border-color: #ccc;
    }

    .opt.update-app {
      border-color: var(--green);
      background: #ecf6ef;
    }

    .opt .emoji {
      font-size: 20px
    }

    .field {
      display: grid;
      gap: 4px
    }

    .field .access-code-row {
      display: flex;
      gap: 6px;
      align-items: stretch;
    }

    .field .access-code-row input {
      flex: 1;
    }

    .btn.mini {
      padding: 4px 10px;
      font-size: 12px;
    }

    .access-code-row .refresh-btn {
      padding: 0 12px;
      min-width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      line-height: 1;
    }

    .org-mode-buttons {
      display: flex;
      gap: 6px;
    }

    .org-mode-btn {
      flex: 1;
      border: 1px solid var(--border);
      border-radius: var(--r);
      background: transparent;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
    }

    .org-mode-btn.active {
      background: var(--card);
    }

    input[type="text"],
    textarea,
    select {
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: var(--r);
      background: #fffdf8;
      font-size: 13px
    }

    .inputEmoji {
      position: relative;
      display: flex;
      align-items: center
    }

    .inputEmoji .emojiPrefix {
      position: absolute;
      left: 10px;
      font-size: 20px;
      pointer-events: none;
      line-height: 1
    }

    .inputEmoji input {
      width: 100%;
      padding-left: 42px
    }

    textarea.editing {
      background: #fff;
      border: 1px solid var(--border)
    }

    .stabs {
      display: flex;
      gap: 6px;
      padding: 6px;
      position: sticky;
      top: 52px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      z-index: 2
    }

    .stab {
      flex: 1;
      text-align: center
    }

    .sview {
      display: none
    }

    .sview.active {
      display: block
    }

    .rowInline {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .mode-toggle {
      display: flex;
      gap: 6px;
    }

    .mode-option {
      flex: 1;
      border: 1px solid var(--border);
      border-radius: var(--r);
      background: var(--card);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 6px 8px;
      color: inherit;
    }

    .mode-option.active {
      outline: 1px solid var(--green);
      background: #fff;
    }

    .mode-option .mode-emoji {
      font-size: 14px;
    }

    .rowInlineActions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .rowInlineActions .link-text {
      margin-left: auto;
    }

    .rowInline input {
      flex: 1
    }

    .rowInline .btn.copyOnly {
      padding: 6px 10px
    }

    .miniInfo {
      font-size: 12px;
      color: #555
    }

    .hide {
      display: none
    }

    /* Barre ajout habitude (filtre + bouton) sticky */
    .addBar {
      position: sticky;
      top: 0;
      z-index: 3;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: var(--bg);
      padding: 6px 0;
    }

    .toast-container {
      position: fixed;
      top: 14px;
      right: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 14;
      pointer-events: none;
    }

    .toast {
      padding: 10px 14px;
      border-radius: 999px;
      min-width: 180px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
      font-size: 13px;
      color: #111;
      background: #f4f4f4;
      opacity: 0;
      animation: toastIn 0.3s forwards;
    }

    .toast.toast-success {
      background: #def7ec;
      color: #1f824d;
    }

    .toast.toast-error {
      background: #ffe0e0;
      color: #a32020;
    }

    .toast.toast-info {
      background: #e1edff;
      color: #1a3e86;
    }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateY(-6px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .install-prompt {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 15;
      padding: 12px;
    }

    .install-prompt.visible {
      display: flex;
    }

    .install-card {
      background: #fff;
      border-radius: 20px;
      padding: 22px;
      width: min(420px, 90vw);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      gap: 14px;
      text-align: center;
    }

    .install-card h3 {
      margin: 0;
      font-size: 20px;
    }

    .install-card p {
      margin: 0;
      color: #404040;
    }

    .install-card .btn-row {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .install-card .btn-row .btn {
      flex: 1;
    }

    .install-card .learn-more {
      font-size: 12px;
      color: #5c6ac4;
      text-decoration: underline;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="loader-overlay hide" id="loaderOverlay">
    <div class="loader-content">
      <div class="loader-title">Habitube.com</div>
      <div class="loader-emoji" id="loaderEmoji">üå∞</div>
      <div class="loader-tip" id="loaderTip"></div>
    </div>
    <div class="loader-version" id="loaderVersion"></div>
  </div>
  <div class="toast-container" id="toastContainer"></div>
  <div class="install-prompt" id="installPromptCard">
    <div class="install-card">
      <h3>Installer Habitube</h3>
      <p>Ajoute Habitube √† ton √©cran d‚Äôaccueil et reste connect√© √† tes jardins partag√©s.</p>
      <div class="btn-row">
        <button class="btn primary" id="installPromptBtn">Installer</button>
        <button class="btn" id="installPromptClose">Plus tard</button>
      </div>
      <div class="learn-more" id="installPromptHelp">Pourquoi installer ?</div>
    </div>
  </div>
  <div class="auth-overlay hide" id="authOverlay">
    <div class="auth-card">
      <img src="icon-512.png" alt="Logo Habitube" />
      <div class="auth-message" id="authMessage">Connecte-toi pour retrouver tes habitudes</div>
      <div class="auth-space-desc" id="authSpaceDesc"></div>
      <div class="auth-forms">
        <form id="authForm">
          <input id="authEmail" type="email" required placeholder="Email" />
          <input id="authPassword" type="password" required placeholder="Mot de passe" />
          <div class="auth-link-row">
            <span id="forgotPasswordLink" class="auth-link">Mot de passe oubli√© ?</span>
          </div>
          <div class="auth-error" id="authError"></div>
          <div class="auth-actions">
            <button type="submit" id="authLoginBtn" data-action="login" class="text-btn primary">Se connecter</button>
            <button type="submit" id="authSignupBtn" data-action="signup" class="text-btn secondary">Cr√©er mon
              compte</button>
          </div>

        </form>
        <div class="auth-separator">
          <span class="label">ou</span>
        </div>
        <button type="button" class="auth-guest-btn text-btn secondary" id="authGuestBtn">Se connecter en mode
          anonyme</button>
        <div class="auth-note" id="authNote">Nous gardons tes jardins priv√©s.<br>Aucune donn√©e n‚Äôest transmise √† des
          tiers.</div>
      </div>
      <div class="auth-helper" id="resetNotice"></div>
    </div>
  </div>
  <div id="app">
    <div class="top">
      <div class="brand" id="brand"><span class="logo">üå±</span>Habitube</div>
      <div class="spacer"></div>
      <select id="spaceSel" class="select" title="Changer de jardin"></select>
      <button class="navbtn" id="addBtn" title="Menu">‚ò∞</button>
    </div>

    <div class="daysWrap" id="daysWrap">
      <button class="navbtn" id="prevDay">‚Üê</button>
      <div style="display:flex;align-items:center;gap:6px">
        <div class="dateLabel" id="dateLabel">‚Äî</div>
      </div>
      <div class="rightBtns">
        <button class="navbtn" id="nextDay">‚Üí</button>
        <button class="navbtn" id="openSpace" title="Jardin">‚õ≠</button>
      </div>
    </div>

    <main id="home" class="view active">
      <div class="list" id="cards"></div>
    </main>

    <section id="detail" class="view">
      <div class="detailHead">
        <button class="backMini" id="backHome">‚Üê</button>
        <div class="detailTitle" id="detailTitle"></div>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="members">üë®‚Äçüåæ Jardiniers</button>
        <button class="tab" data-tab="history">üìÖ Historique</button>
        <button class="tab" data-tab="settings">‚úèÔ∏è √âdition</button>
      </div>
      <div class="section">
        <div class="view active" id="tab-members">
          <div class="rankHeader">
            <b>Dur√©e</b>
            <div style="font-size:12px;display:flex;gap:8px;align-items:center">
              P√©riode:
              <div style="display:flex;gap:8px">
                <button class="btnToggle" id="btnP7">7 jours</button>
                <button class="btnToggle active" id="btnP30">30 jours</button>
                <button class="btnToggle" id="btnPAll">Total</button>
              </div>
            </div>
          </div>
          <div class="rank" id="rank"></div>
        </div>

        <div class="view" id="tab-history">
          <div class="calendarWrap">
            <div class="calTop">
              <div style="display:flex;gap:6px;align-items:center">
                <button class="calBtn" id="prevMonth">‚Üê</button>
                <div id="monthLabel" style="font-weight:700"></div>
                <button class="calBtn" id="nextMonth">‚Üí</button>
              </div>
              <div id="calWhoWrap" style="display:flex;gap:6px;align-items:center">
                <span style="font-size:12px">Voir :</span>
                <select id="calWho" class="select" style="padding:6px"></select>
              </div>
            </div>
            <div class="calendar" id="cal"></div>
          </div>
        </div>

        <div class="view" id="tab-settings">
          <div class="grid">
            <div class="field">
              <label><b>Nom personnalis√©</b></label>
              <div class="inputEmoji">
                <span class="emojiPrefix" id="habitTitleEmoji">üå±</span>
                <input id="habitTitleInput" type="text" placeholder="Nom de l'habitude" />
              </div>
            </div>

            <div class="field">
              <label><b>Note</b></label>
              <textarea id="habitDesc" placeholder="√âtapes, conseils, instructions sp√©cifiques..."></textarea>
            </div>

            <div class="field" id="freqField">
              <label><b>Fr√©quence</b></label>
              <div class="grid" style="gap:6px">
                <select id="freqType" class="select">
                  <option value="quotidien" selected>Quotidien</option>
                  <option value="ponctuelle">Ponctuelle</option>
                  <option value="jours">Jour(s) de la semaine</option>
                </select>
                <div id="freqSubPonctuelle" class="rowInline hide"><span>Date</span><input id="freqDate" type="text"
                    placeholder="JJ/MM/AAAA" /></div>
                <div id="freqSubJours" class="hide freq-sub-jours">
                  <label><input type="checkbox" value="1">Lu</label>
                  <label><input type="checkbox" value="2">Ma</label>
                  <label><input type="checkbox" value="3">Me</label>
                  <label><input type="checkbox" value="4">Je</label>
                  <label><input type="checkbox" value="5">Ve</label>
                  <label><input type="checkbox" value="6">Sa</label>
                  <label><input type="checkbox" value="0">Di</label>
                </div>
              </div>
            </div>

            <div class="field hide" id="weekFreqField">
              <label><b>Fr√©quence hebdomadaire</b></label>
              <select id="weekFreqSelect" class="select">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
              </select>
            </div>

            <div class="field">
              <label><b>Dur√©e par d√©faut</b></label>
              <select id="mockDefaultDur" class="select">
                <option value="15" selected>15 min</option>
                <option value="30">30 min</option>
                <option value="45">45 min</option>
                <option value="60">60 min</option>
              </select>
            </div>

            <div class="field">
              <label><b>Mode de r√©alisation</b></label>
              <div class="mode-toggle" id="modeToggle">
                <button type="button" class="btn mode-option" data-mode="libre">
                  <span>Individuel</span> <span class="mode-emoji">üë§</span>
                </button>
                <button type="button" class="btn mode-option" data-mode="commun">
                  <span>Partag√©</span> <span class="mode-emoji">üë•</span>
                </button>
              </div>
            </div>

            <div style="margin-top:14px;display:flex;justify-content:space-between;gap:8px">
              <button class="btn danger" id="deleteHabitBtn">Supprimer</button>
              <button class="btn primary" id="saveHabitBtn">Sauvegarder</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="profile" class="view">
      <div class="detailHead profile-head">
        <button class="backMini" id="backFromProfile">‚Üê</button>
        <div class="profile-meta">
          <div class="detailTitle" id="profileTitle"></div>
        </div>
        <div class="profile-head-actions">
          <button class="btn secondary hide" id="grantAccessBtn">üîó Redonner l'acc√®s</button>
          <button class="btn danger hide" id="removeFromGardenBtn">‚ùå Retirer</button>
        </div>
      </div>
      <div class="section">
        <div class="rankHeader profile-period-row">
          <b>P√©riode</b>
          <div class="profile-period-buttons">
            <button class="btnToggle" id="profilePeriod7">7 jours</button>
            <button class="btnToggle active" id="profilePeriod30">30 jours</button>
            <button class="btnToggle" id="profilePeriodAll">Total</button>
          </div>
        </div>
        <div id="profileHabits" class="profile-habit-list"></div>
        <div class="subtitle hide" id="profileEmpty">Pas encore d‚Äôactivit√© sur cette p√©riode.</div>
      </div>
    </section>

    <section id="space" class="view">
      <div class="detailHead">
        <button class="backMini" id="backFromSpace">‚Üê</button>
        <div class="detailTitle" id="spaceHeaderTitle"></div>
        <div class="spacer"></div>
      </div>
      <div class="tabs">
        <button class="tab active" data-stab="sprofile">üë®‚Äçüåæ Jardiniers</button>
        <button class="tab" data-stab="shistory">üìÖ Historique</button>
        <button class="tab" data-stab="sparams">‚öôÔ∏è R√©glages</button>
      </div>
      <div class="section">
        <div class="view active" id="sprofile">
          <div class="rankHeader">
            <b>Dur√©e</b>
            <div style="font-size:12px;display:flex;gap:8px;align-items:center">
              P√©riode:
              <div style="display:flex;gap:8px">
                <button class="btnToggle" id="sBtnP7">7 jours</button>
                <button class="btnToggle active" id="sBtnP30">30 jours</button>
                <button class="btnToggle" id="sBtnPAll">Total</button>
              </div>
            </div>
          </div>
          <div class="rank" id="spaceRank"></div>
        </div>
        <div class="view" id="shistory">
          <div class="calendarWrap">
            <div class="calTop">
              <div style="display:flex;gap:6px;align-items:center">
                <button class="calBtn" id="sPrevMonth">‚Üê</button>
                <div id="sMonthLabel" style="font-weight:700"></div>
                <button class="calBtn" id="sNextMonth">‚Üí</button>
              </div>
              <div style="display:flex;gap:6px;align-items:center">
                <span style="font-size:12px">Voir :</span>
                <select id="sCalWho" class="select" style="padding:6px"></select>
              </div>
            </div>
            <div class="calendar" id="sCal"></div>
          </div>
        </div>
        <div class="view" id="sparams">
          <div class="grid">
            <div class="field"><label><b>Mon pr√©nom</b></label><input id="paramName" type="text" value="Moi" /></div>
            <div class="field"><label><b>Nom du jardin</b></label><input id="paramSpaceLabel" type="text" /></div>
            <div class="field">
              <label><b>Texte d'introduction</b></label>
              <textarea id="spaceDescInfo"
                placeholder="Pr√©sentez le jardin, les r√®gles et l‚Äô√©tat d‚Äôesprit. Cliquez pour √©diter."></textarea>
            </div>
            <div class="field">
              <label><b>Affiche des notes</b></label>
              <select id="notesDisplayMode" class="select">
                <option value="dynamic" selected>Dynamique</option>
                <option value="info">Bouton d'info</option>
                <option value="show">Tout afficher</option>
                <option value="hide">Tout cacher</option>
              </select>
            </div>
            <div class="field">
              <label><b>Mode d'organisation</b></label>
              <div class="org-mode-buttons" id="spaceOrgButtons">
                <button type="button" class="org-mode-btn" data-mode="day">√Ä la journ√©e</button>
                <button type="button" class="org-mode-btn" data-mode="week">√Ä la semaine</button>
              </div>
              <select id="spaceOrgMode" class="select hide" disabled>
                <option value="day">√Ä la journ√©e</option>
                <option value="week">√Ä la semaine</option>
              </select>
            </div>
            <div class="field hide" id="autoWeekField">
              <label><b>Affection hebdomadaire automatique</b></label>
              <select id="autoWeekAffection" class="select">
                <option value="none" selected>Non (par d√©faut)</option>
                <option value="random">Al√©atoire</option>
                <option value="same">Identique</option>
              </select>
            </div>
            <div class="field">
              <label><b>Droits d'√©dition</b></label>
              <select id="spaceEditorRights" class="select">
                <option value="admin">Admin</option>
                <option value="registered">Utilisateurs enregistr√©s</option>
              </select>
            </div>
            <div class="field">
              <label><b>Mode d'√©dition</b></label>
              <select id="spaceEditButton" class="select">
                <option value="yes">Oui</option>
                <option value="no">Non</option>
              </select>
            </div>
            <div class="field owner-controls hide" id="ownerControls">
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn" id="transferSpaceBtn">Transf√©rer le jardin</button>
                <button class="btn danger" id="deleteSpaceBtn">Supprimer le jardin</button>
              </div>
              <div class="subtitle" id="ownerControlsHint"></div>
            </div>
            <div class="field owner-controls hide" id="guestQuitControls">
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn danger" id="quitSpaceBtn">Quitter le jardin</button>
              </div>
            </div>
            <div class="space-footer">
              <button class="btn primary" id="saveSpaceSettings">Sauvegarder</button>
            </div>
            <div class="subtitle" id="spaceSettingsNotice"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Menu -->
    <div class="modal" id="modalAdd">
      <div class="sheet">
        <div class="sheetHeader">
          <div id="modalTitle">Menu</div><button class="closeX" id="closeAdd">‚®â</button>
        </div>
        <div class="sheetBody">
          <div class="grid">
            <div class="opt" id="createGarden">
              <div class="emoji">üè°</div>
              <div><b>Cr√©er un jardin</b>
                <div class="subtitle">Nouvel espace partag√©</div>
              </div>
            </div>
            <div class="opt" id="addHabit">
              <div class="emoji">üå±</div>
              <div><b>Semer de nouvelles graines</b>
                <div class="subtitle">D√©marrer des nouvelles habitudes</div>
              </div>
            </div>
            <div class="opt" id="inviteFriend">
              <div class="emoji">üíå</div>
              <div><b>Inviter un jardinier</b>
                <div class="subtitle">Partager un code d'acc√®s ou un lien d'invitation</div>
              </div>
            </div>
            <div class="opt" id="joinGarden">
              <div class="emoji">üßë‚Äçüåæ</div>
              <div><b>Rejoindre un jardin</b>
                <div class="subtitle">Entrer un code d'acc√®s</div>
              </div>
            </div>
            <div class="opt" id="menuPrefs">
              <div class="emoji">‚ú®</div>
              <div>
                <b>Ajuster ton int√©rieur</b>
                <div class="subtitle">Personnalise tes pr√©f√©rences</div>
              </div>
            </div>
            <div class="opt" id="installApp">
              <div class="emoji">üì±</div>
              <div>
                <b>Installer l'application mobile</b>
                <div class="subtitle">Profite d'un acc√®s plus rapide et confortable</div>
              </div>
            </div>

            <div class="opt auth-action hide" id="menuLogin">
              <div class="emoji">üîê</div>
              <div>
                <b>Se connecter</b>
                <div class="subtitle">Partager l'acc√®s avec un autre appareil</div>
              </div>
            </div>
            <div class="opt auth-action hide" id="menuLogout">
              <div class="emoji">üîì</div>
              <div>
                <b>Se d√©connecter</b>
                <div class="subtitle">Changer de compte</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Inviter -->
    <div class="modal" id="modalInvite">
      <div class="sheet">
        <div class="sheetHeader">
          <button type="button" class="backMini menu-back">‚Üê</button>
          <div>Inviter</div><button class="closeX" id="closeInvite">‚®â</button>
        </div>
        <div class="sheetBody">
          <div class="grid">
            <div class="field">
              <label><b>Code d‚Äôacc√®s ‚øª</b></label>
              <div class="access-code-row">
                <input id="spaceAccessCode" type="text" readonly placeholder="‚Äî" />
                <button type="button" class="btn mini refresh-btn" id="regenerateSpaceCodeBtn"
                  title="R√©g√©n√©rer le code">
                  ‚ü≤
                </button>
              </div>
              <div class="subtitle" id="joinSpaceDesc"></div>
            </div>
            <div class="field">
              <label><b>Nouveau jardinier</b></label>
              <input id="inviteName" type="text" placeholder="Pr√©nom" />
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn primary" id="generateInvite">Inviter</button>
            </div>
            <div class="subtitle">Les invitations :</div>
            <div id="inviteList" class="invite-list"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Habitude (biblioth√®que multi-s√©lection) -->
    <div class="modal" id="modalHabit">
      <div class="sheet">
        <div class="sheetHeader">
          <button type="button" class="backMini menu-back">‚Üê</button>
          <div id="habitTitle">Nouvelle(s) habitude(s)</div><button class="closeX" id="closeHabit">‚®â</button>
        </div>
        <div class="sheetBody">
          <div class="grid" id="step1"></div>
          <div class="grid" id="step2" style="display:none"></div>
        </div>
      </div>
    </div>

    <!-- Cr√©ation de jardin -->
    <div class="modal garden" id="modalGarden">
      <div class="sheet">
        <div class="sheetHeader">
          <button type="button" class="backMini menu-back">‚Üê</button>
          <div>Cr√©er un jardin</div>
        </div>
        <div class="sheetBody">
          <div class="garden-form">
            <div class="field">
              <label><b>Nom du jardin</b></label>
              <input id="gardenNameInput" type="text" placeholder="Nom du jardin" />
            </div>
            <div class="field">
              <label><b>Mode d'organisation</b></label>
              <div class="org-mode-buttons" id="gardenModeButtons">
                <button type="button" class="org-mode-btn" data-mode="day">√Ä la journ√©e</button>
                <button type="button" class="org-mode-btn" data-mode="week">√Ä la semaine</button>
              </div>
              <select id="gardenModeSelect" class="select hide">
                <option value="week">√Ä la semaine</option>
                <option value="day">√Ä la journ√©e</option>
              </select>
              <div class="subtitle" id="gardenModeHint">5-30 routines √† organiser librement dans la semaine.
              </div>
            </div>
            <div class="field">
              <div class="rowInlineActions">
                <button class="btn primary" id="createGardenBtn">Suivant</button>
              </div>
              <div class="subtitle" id="gardenStatus"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pr√©f√©rences personnelles -->
    <div class="modal" id="modalPrefs">
      <div class="sheet">
        <div class="sheetHeader">
          <button type="button" class="backMini menu-back">‚Üê</button>
          <div>Pr√©f√©rences</div><button class="closeX" id="closePrefs">‚®â</button>
        </div>
        <div class="sheetBody">
          <div class="grid">
            <div class="field">
              <label><b>Afficher des notes</b></label>
              <select id="prefsNotesDisplayMode" class="select">
                <option value="dynamic">Dynamique</option>
                <option value="info">Bouton d'info</option>
                <option value="show">Tout afficher</option>
                <option value="hide">Tout cacher</option>
              </select>
            </div>
            <div class="field">
              <label><b>Afficher le bouton d'√©dition</b></label>
              <select id="prefsEditButtonMode" class="select">
                <option value="yes">Oui</option>
                <option value="no">Non</option>
                <option value="dynamic">Dynamique</option>
              </select>
              <div class="subtitle">En mode dynamique, le crayon n‚Äôappara√Æt que pour les habitudes en cours ou en
                soutien.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal join" id="modalJoin">
      <div class="sheet">
        <div class="sheetHeader">
          <button type="button" class="backMini menu-back">‚Üê</button>
          <div>Rejoindre un jardin</div>
        </div>
        <div class="sheetBody">
          <div class="grid">
            <div class="field">
              <label><b>Pr√©nom</b></label>
              <input id="joinName" type="text" placeholder="Ton pr√©nom" />
            </div>
            <div class="field">
              <label><b>Code d‚Äôacc√®s</b></label>
              <input id="joinCode" type="text" maxlength="7" placeholder="XXX-XXX" />
              <div class="subtitle" style="margin-top:4px;font-size:12px">Le code est fourni dans l‚Äôinvitation.</div>
            </div>
            <div class="field">
              <div class="rowInlineActions">
                <button class="btn primary" id="joinSpaceBtn">Rejoindre</button>
              </div>
              <div class="subtitle" id="joinStatus"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="modalTransfer">
      <div class="sheet">
        <div class="sheetHeader">
          <div>Transf√©rer le jardin</div><button class="closeX" id="closeTransfer">‚®â</button>
        </div>
        <div class="sheetBody">
          <div class="grid">
            <div class="field">
              <label><b>Nouveau propri√©taire</b></label>
              <select id="transferOwnerSelect" class="select"></select>
            </div>
            <div class="field">
              <button class="btn primary" id="confirmTransferBtn">Valider</button>
            </div>
            <div class="subtitle" id="transferStatus"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="modalQuit">
      <div class="sheet">
        <div class="sheetHeader">
          <div>Quitter le jardin</div><button class="closeX" id="closeQuit">‚®â</button>
        </div>
        <div class="sheetBody">
          <div class="subtitle" id="quitModalText">Tu quittes ce jardin.</div>
        </div>
        <div class="habit-actions">
          <button class="btn" id="quitModalCancel">Annuler</button>
          <button class="btn hide" id="quitModalTransfer">Transf√©rer le jardin</button>
          <button class="btn danger" id="quitModalDelete">Supprimer le jardin</button>
        </div>
      </div>
    </div>

    <script>
      /* ===== Donn√©es ===== */

      // Habitudes existantes (d√©mo) ‚Äî espace individuel
      const CHALLENGES = [];
      const GROUP_CHALLENGES = [];
      const FAMILY_CHALLENGES = [];
      const ASSOCIATION_CHALLENGES = [];
      const OFFICE_CHALLENGES = [];
      const CLASS_CHALLENGES = [];

      // Biblioth√®que logistique : 20 habitudes non num√©riques, organis√©es en 10 cat√©gories

      const LIBRARY_HABITS = [];
      const LIBRARY_CONTEXTS = [];
      const LIBRARY_NEEDS = [];

      /* √âtats / stock */
      const HABIT_DESC = {}, HABIT_TITLE_CUSTOM = {}, SPACE_DESC_TXT = {};
      const BASE_MINUTES = {}, HABIT_MODE = {}, LOCKED_COMMUN = {}, LOCKED_BY = {}, DONE_SETS = {};
      const HAS_DESC = {}, DELETED_HABITS = new Set();
      const FREQ_MODE = {}, HABIT_REC = {};

      /* Utils */
      const APP_VERSION = '0.0.2';
      const APP_TIPS = [
        'Planifie tes 3 habitudes cl√©s d√®s le matin pour garder le cap.',
        'Ajoute un c≈ìur pour f√©liciter les personnes qui t‚Äôinspirent.',
        'Utilise la note pour garder un souvenir de ta s√©ance.',
        'Passe en vue hebdo pour visualiser les routines d‚Äô√©quipe.',
        'Bascule sur "Je fais" avant de valider ton soutien collectif.',
        'Attribue une dur√©e r√©aliste √† chaque habitude et ajuste-la.',
        'V√©rifie le calendrier pour rep√©rer tes streaks les plus longs.',
        'Invite un proche pour cr√©er un jardin partag√© et motivant.',
        'Coche plusieurs fois le jour pour suivre tes habitudes flexibles.',
        'Touche l‚Äôemoji pour d√©couvrir la fiche d√©taill√©e de l‚Äôhabitude.'
      ];
      const DEFAULT_DURATION = 15;
      const TIP_ROTATION_MS = 3000;
      let tipRotationIndex = 0;
      let tipRotationTimer = null;
      let lastTipIndex = -1;
      const $ = s => document.querySelector(s), $$ = s => Array.from(document.querySelectorAll(s));
      const setLoaderVersion = () => {
        const versionEl = $('#loaderVersion');
        if (versionEl) {
          versionEl.textContent = `v${APP_VERSION}`;
        }
      };
      const rotateLoaderTip = () => {
        const tipEl = $('#loaderTip');
        if (!tipEl) return;
        let nextIndex = tipRotationIndex;
        if (APP_TIPS.length > 1) {
          do {
            nextIndex = Math.floor(Math.random() * APP_TIPS.length);
          } while (nextIndex === lastTipIndex);
        }
        lastTipIndex = nextIndex;
        tipRotationIndex = nextIndex;
        tipEl.textContent = `Astuce ${nextIndex + 1}: ${APP_TIPS[nextIndex]}`;
      };
      const startLoaderTips = () => {
        rotateLoaderTip();
        if (tipRotationTimer) {
          clearInterval(tipRotationTimer);
        }
        tipRotationTimer = setInterval(rotateLoaderTip, TIP_ROTATION_MS);
      };
      setLoaderVersion();
      startLoaderTips();
      window.addEventListener('beforeunload', () => {
        if (tipRotationTimer) {
          clearInterval(tipRotationTimer);
        }
      });
      function fmtDate(d) { const M = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'][d.getMonth()]; const j = String(d.getDate()).padStart(2, '0'); const J = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'][d.getDay()]; return `${J} ${j}/${M}`; }
      function weekLabel(d) {
        const day = d.getDay(); // 0=dim
        const monday = new Date(d); monday.setDate(d.getDate() - ((day + 6) % 7));
        const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
        const f = x => `${String(x.getDate()).padStart(2, '0')}/${String(x.getMonth() + 1).padStart(2, '0')}`;
        return `Du ${f(monday)} au ${f(sunday)}`;
      }
      function genCode() { const c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let s = ''; for (let i = 0; i < 6; i++)s += c[Math.floor(Math.random() * c.length)]; return s; }
      function generateSpaceId() {
        if (window.crypto?.randomUUID) {
          return crypto.randomUUID();
        }
        if (window.crypto?.getRandomValues) {
          const bytes = new Uint8Array(16);
          crypto.getRandomValues(bytes);
          const hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
          return `${hex.slice(0, 8)}-${hex.slice(8, 12)}-${hex.slice(12, 16)}-${hex.slice(16, 20)}-${hex.slice(20)}`;
        }
        return `G${genCode()}`;
      }
      function inviteBaseUrl() {
        const pathname = window.location.pathname.replace(/\/index\.html$/i, '/');
        return `${window.location.origin}${pathname}`;
      }
      function genInviteToken() {
        if (window.crypto?.randomUUID) {
          return crypto.randomUUID().replace(/-/g, '');
        }
        if (window.crypto?.getRandomValues) {
          const bytes = new Uint8Array(16);
          crypto.getRandomValues(bytes);
          return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        }
        return genCode();
      }
      const round15 = m => Math.round(m / 15) * 15;
      function lvlEmoji(v) { if (v <= 7) return 'üå∞'; if (v <= 14) return 'üå±'; if (v <= 21) return 'üçÄ'; if (v <= 28) return 'üåº'; if (v <= 35) return 'üåª'; if (v <= 42) return 'üå∑'; if (v <= 49) return 'üåπ'; if (v <= 56) return 'ü™ª'; if (v <= 64) return 'üíê'; return 'üéã'; }
      function names(xs, m = 3) { if (xs.length <= m) return xs.join(', '); const s = xs.slice(0, m).join(', '); return `${s}‚Ä¶ et ${xs.length - m} autres`; }
      function slugifyTag(text) {
        const base = (text || '').toString();
        const normalized = base.normalize ? base.normalize('NFD') : base;
        return normalized
          .replace(/[\u0300-\u036f]/g, '')
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)+/g, '') || 'habitude';
      }
      function prettifyTag(tag) {
        if (!tag) return '';
        return tag
          .split(/[-_ ]+/)
          .filter(Boolean)
          .map(part => part.charAt(0).toUpperCase() + part.slice(1))
          .join(' ');
      }

      const TAG_TRANSLATIONS = {
        affection: 'Affection',
        calm: 'Calme',
        cleanliness: 'Propret√©',
        comfort: 'Confort',
        communication: 'Communication',
        cooperation: 'Coop√©ration',
        curiosity: 'Curiosit√©',
        entertainment: 'Divertissement',
        equipment: 'Mat√©riel',
        expression: 'Expression',
        hygiene: 'Hygi√®ne',
        inclusion: 'Inclusion',
        joy: 'Joie',
        nature: 'Nature',
        nutrition: 'Nutrition',
        organization: 'Organisation',
        participation: 'Participation',
        privacy: 'Intimit√©',
        safety: 'S√©curit√©',
        school: '√âcole / Classe',
        sleep: 'Sommeil',
        slowness: 'Lenteur',
        social: 'Social / Groupe',
        family: 'Famille / Couple',
        home: 'Maison / Logement',
        office: 'Bureau / √âquipe'
      };

      const MODE_META = {
        libre: { label: 'Individuel', shortLabel: 'Moi üë§', emoji: 'üë§', target: 'individual' },
        commun: { label: 'Partag√©', shortLabel: 'Tout le monde üë•', emoji: 'üë•', target: 'group' }
      };

      const CONTEXT_EMOJIS = {
        family: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
        home: 'üè°',
        office: 'üè¢',
        school: 'üè´',
        social: 'üßë‚Äçü§ù‚Äçüßë'
      };

      const NEED_EMOJIS = {
        affection: '‚ù§Ô∏è',
        joy: 'üòÑ',
        joie: 'üòÑ',
        calme: 'üïäÔ∏è',
        calm: 'üïäÔ∏è',
        nature: 'üåø',
        nutrition: 'üçé',
        organization: 'üóÇÔ∏è',
        organisation: 'üóÇÔ∏è',
        movement: 'üèÉ',
        mouvement: 'üèÉ',
        lien: 'üîó',
        sens: 'üéØ',
        energie: '‚ö°',
        energy: '‚ö°',
        expression: 'üó£Ô∏è',
        communication: 'üó£Ô∏è',
        cooperation: 'ü§ù',
        participation: 'üôå',
        curiosity: 'üîç',
        curiosite: 'üîç',
        inclusion: 'üåà',
        equipment: 'üß∞',
        comfort: 'üõãÔ∏è',
        sleep: 'üò¥',
        sommeil: 'üò¥',
        entertainment: 'üé≠',
        cleaning: 'üßΩ',
        cleanliness: 'üßº',
        hygiene: 'üßº',
        privacy: 'üõ°Ô∏è',
        intimite: 'üõ°Ô∏è',
        slowness: 'üê¢',
        lenteur: 'üê¢'
      };

      function normalizeTagKey(tag) {
        if (!tag) return '';
        const value = tag.toString();
        const normalized = value.normalize ? value.normalize('NFD') : value;
        return normalized.replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
      }

      function translateTag(tag) {
        const key = normalizeTagKey(tag);
        return TAG_TRANSLATIONS[key] || prettifyTag(tag);
      }

      function getTagEmoji(tag, type) {
        if (!type) return '';
        const key = normalizeTagKey(tag);
        const emojiMap = type === 'context' ? CONTEXT_EMOJIS : type === 'need' ? NEED_EMOJIS : null;
        return emojiMap?.[key] || '';
      }

      function formatTagLabel(tag, type) {
        const label = translateTag(tag);
        const emoji = getTagEmoji(tag, type);
        return emoji ? `${emoji} ${label}` : label;
      }
      const SESSION_LOCK_KEY = 'habitu-primary-tab';
      const SESSION_LOCK_TTL = 15 * 1000;
      const SESSION_LOCK_PING = 4 * 1000;
      const SESSION_CONFLICT_MESSAGE = 'Un autre onglet Habitube est actif. Ferme-le ou attends qu\'il se lib√®re pour continuer.';
      const TAB_INSTANCE_ID = (window.crypto?.randomUUID ? crypto.randomUUID() : `tab-${Date.now()}-${Math.random().toString(36).slice(2)}`);
      const INSTALL_PROMPT_STORAGE_KEY = 'habitu-install-prompt-seen';
      const INSTALL_PROMPT_SUPPRESSION_MS = 15 * 24 * 60 * 60 * 1000;
      const INSTALL_PROMPT_FIRST_HABIT_KEY = 'habitu-install-first-habit';
      let sessionLockTimer;
      let isPrimaryTab = false;
      let sessionConflictHandled = false;
      let deferredInstallPrompt = null;
      let installPromptAutoShown = false;
      let toastContainerEl = null;

      function safeStorageGet(key) {
        try {
          return localStorage.getItem(key);
        } catch (e) {
          return null;
        }
      }
      function safeStorageSet(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (e) { }
      }
      function safeStorageRemove(key) {
        try {
          localStorage.removeItem(key);
        } catch (e) { }
      }
      function ensureToastContainer() {
        if (!toastContainerEl) {
          toastContainerEl = $("#toastContainer");
        }
        return toastContainerEl;
      }
      function showToast(message, { type = 'info', duration = 4000 } = {}) {
        if (!message) return;
        const container = ensureToastContainer();
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, duration);
      }
      function parseSessionLock(value) {
        if (!value) return null;
        try {
          return JSON.parse(value);
        } catch (e) {
          return null;
        }
      }
      async function handleSessionConflict() {
        if (sessionConflictHandled) return;
        sessionConflictHandled = true;
        showToast('Une autre session est active, r√©cup√©ration des donn√©es‚Ä¶', { type: 'info', duration: 5000 });
        clearLocalState();
        const email = currentProfile?.email;
        if (!email) return;
        showLoaderOverlay();
        try {
          await resetFirestoreState(email);
          showHome();
        } finally {
          hideLoaderOverlay();
        }
      }
      function isRunningAsPWA() {
        if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) return true;
        if (navigator.standalone) return true;
        return false;
      }
      function hasCreatedInitialHabits() {
        return safeStorageGet(INSTALL_PROMPT_FIRST_HABIT_KEY) === '1';
      }
      function markFirstHabitCreated() {
        if (hasCreatedInitialHabits()) return;
        safeStorageSet(INSTALL_PROMPT_FIRST_HABIT_KEY, '1');
        maybeShowInstallPrompt(false);
      }
      function getInstallPromptTimestamp() {
        const value = safeStorageGet(INSTALL_PROMPT_STORAGE_KEY);
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      }
      function hasSeenInstallPrompt() {
        const timestamp = getInstallPromptTimestamp();
        if (!timestamp) return false;
        return (Date.now() - timestamp) < INSTALL_PROMPT_SUPPRESSION_MS;
      }
      function markInstallPromptSeen() {
        safeStorageSet(INSTALL_PROMPT_STORAGE_KEY, String(Date.now()));
      }
      function showInstallPromptCard() {
        const card = $("#installPromptCard");
        if (card) card.classList.add('visible');
      }
      function closeInstallPromptCard() {
        const card = $("#installPromptCard");
        if (card) card.classList.remove('visible');
      }
      function updateInstallOptionVisibility() {
        const opt = $("#installApp");
        if (!opt) return;
        const hidden = !deferredInstallPrompt || isRunningAsPWA();
        opt.classList.toggle('hide', hidden);
      }
      function triggerInstallPrompt(source = 'manual') {
        if (!deferredInstallPrompt) {
          showToast('Installation indisponible pour le moment.', { type: 'error' });
          return;
        }
        deferredInstallPrompt.prompt();
        deferredInstallPrompt.userChoice.then(choice => {
          if (choice && choice.outcome === 'accepted') {
            showToast('Habitube est install√© !', { type: 'success' });
          } else if (source === 'auto') {
            showToast('Tu peux installer Habitube depuis ce bouton.', { type: 'info' });
          } else {
            showToast('Installation annul√©e.', { type: 'error' });
          }
          markInstallPromptSeen();
          deferredInstallPrompt = null;
          closeInstallPromptCard();
          updateInstallOptionVisibility();
        }).catch(err => {
          console.warn('triggerInstallPrompt', err);
          showToast('Impossible d‚Äôinstaller pour l‚Äôinstant.', { type: 'error' });
        });
      }
      function maybeShowInstallPrompt(auto = true) {
        if (!hasCreatedInitialHabits()) return;
        if (isRunningAsPWA() || installPromptAutoShown || hasSeenInstallPrompt()) return;
        if (!deferredInstallPrompt) return;
        showInstallPromptCard();
        installPromptAutoShown = true;
      }
      function readSessionLock() {
        return parseSessionLock(safeStorageGet(SESSION_LOCK_KEY));
      }
      function refreshSessionLock() {
        const now = Date.now();
        const current = readSessionLock();
        const otherActive = current && current.tabId !== TAB_INSTANCE_ID && (now - (current.ts || 0) < SESSION_LOCK_TTL);
        if (otherActive) {
          isPrimaryTab = false;
          handleSessionConflict();
          return;
        }
        safeStorageSet(SESSION_LOCK_KEY, JSON.stringify({ tabId: TAB_INSTANCE_ID, ts: now }));
        if (!isPrimaryTab) {
          isPrimaryTab = true;
        }
        sessionConflictHandled = false;
      }
      function startSessionLockHeartbeat() {
        refreshSessionLock();
        if (!sessionLockTimer) {
          sessionLockTimer = setInterval(refreshSessionLock, SESSION_LOCK_PING);
        }
      }
      function stopSessionLockHeartbeat() {
        if (sessionLockTimer) {
          clearInterval(sessionLockTimer);
          sessionLockTimer = null;
        }
      }
      function releaseSessionLock() {
        const current = readSessionLock();
        if (current && current.tabId === TAB_INSTANCE_ID) {
          safeStorageRemove(SESSION_LOCK_KEY);
        }
      }
      function ensureSingleSessionActive() {
        if (isPrimaryTab) return true;
        handleSessionConflict();
        return false;
      }
      startSessionLockHeartbeat();
      window.addEventListener('storage', event => {
        if (event.key === SESSION_LOCK_KEY) {
          refreshSessionLock();
        }
      });
      window.addEventListener('focus', refreshSessionLock);
      const teardownSessionLock = () => {
        stopSessionLockHeartbeat();
        releaseSessionLock();
      };
      window.addEventListener('beforeunload', teardownSessionLock);
      window.addEventListener('pagehide', teardownSessionLock);
      window.addEventListener('beforeinstallprompt', (event) => {
        if (isRunningAsPWA()) return;
        event.preventDefault();
        deferredInstallPrompt = event;
        updateInstallOptionVisibility();
        maybeShowInstallPrompt(false);
      });
      const MIN_DAY_OFF = -3650;
      function getWeekStart(date = new Date()) {
        const copy = new Date(date);
        copy.setHours(0, 0, 0, 0);
        const diff = (copy.getDay() + 6) % 7;
        copy.setDate(copy.getDate() - diff);
        return copy;
      }
      function getWeekDaysForFrequency(count) {
        const week = [1, 2, 3, 4, 5, 6, 0];
        if (count >= week.length) return week.slice();
        if (count === 3) return [1, 3, 5];
        if (count === 1) return [1];
        const step = week.length / count;
        const days = [];
        for (let i = 0; i < count; i++) {
          days.push(week[Math.floor(i * step) % week.length]);
        }
        return days;
      }
      function getDayUsage(spaceId) {
        const usage = Array(7).fill(0);
        if (!spaceId) return usage;
        const events = SPACE_ACTIVITIES[spaceId] || [];
        events.forEach(ev => {
          const recorded = ev?.recordedAt;
          if (!recorded) return;
          const date = recorded instanceof Date ? recorded : (recorded?.toDate ? recorded.toDate() : new Date(recorded));
          if (!date || Number.isNaN(date.getTime())) return;
          const day = date.getDay();
          usage[day] += 1;
        });
        return usage;
      }

      function chooseDayModeDays(spaceId, count) {
        if (!count) return [];
        const usage = getDayUsage(spaceId);
        const weekOrder = [1, 2, 3, 4, 5, 6, 0];
        const sorted = [...weekOrder].sort((a, b) => (usage[a] - usage[b]) || (a - b));
        const start = sorted[0];
        const days = [];
        for (let i = 0; i < count; i++) {
          let day = (start + Math.round((7 / count) * i)) % 7;
          while (days.includes(day)) {
            day = (day + 1) % 7;
          }
          days.push(day);
        }
        if (days.length < count) {
          const fallback = getWeekDaysForFrequency(count);
          return fallback;
        }
        return days;
      }

      function buildHabitFrequencyInfo(space, frequencyValue) {
        const recurrence = Math.max(1, Math.min(7, Number(frequencyValue) || 1));
        const isWeek = space?.orgMode === 'week';
        const info = {
          recurrence,
          freqDefault: isWeek ? 'hebdo' : (recurrence === 7 ? 'quotidien' : 'jours')
        };
        if (!isWeek) {
          const targetId = space?.id;
          info.freqDays = chooseDayModeDays(targetId, recurrence);
        }
        return info;
      }
      function buildHabitPayload(space, source = {}, overrides = {}) {
        const freqValue = overrides.frequency ?? source.frequency ?? 1;
        const frequencyInfo = buildHabitFrequencyInfo(space, freqValue);
        const defaultMode = space?.type === 'private' ? { type: 'libre', n: 2 } : { type: 'commun', n: 2 };
        const durationCandidate = overrides.baseMin ?? source.baseMin ?? source.duration;
        const parsedDuration = Number(durationCandidate);
        const baseMin = Number.isFinite(parsedDuration) ? parsedDuration : 15;
        return {
          id: overrides.id || source.id,
          titre: overrides.titre || source.titre || source.title || '',
          emoji: overrides.emoji || source.emoji || 'üå±',
          desc: (overrides.desc ?? source.desc ?? source.note ?? '').trim(),
          note: source.note || overrides.note || '',
          duration: overrides.duration ?? source.duration ?? baseMin,
          baseMin,
          frequency: String(freqValue),
          contexts: overrides.contexts || source.contexts || [],
          needs: overrides.needs || source.needs || [],
          spaces: overrides.spaces || source.spaces || [],
          ...frequencyInfo,
          mode: overrides.mode || source.mode || defaultMode,
          addedAt: overrides.addedAt || getWeekStart(new Date())
        };
      }
      function refreshLibraryTags() {
        const contexts = new Set();
        const needs = new Set();
        LIBRARY_HABITS.forEach(habit => {
          (habit.contexts || []).forEach(c => contexts.add(c));
          (habit.needs || []).forEach(n => needs.add(n));
        });
        LIBRARY_CONTEXTS.length = 0;
        LIBRARY_CONTEXTS.push(...Array.from(contexts).sort((a, b) => a.localeCompare(b, 'fr')));
        LIBRARY_NEEDS.length = 0;
        LIBRARY_NEEDS.push(...Array.from(needs).sort((a, b) => a.localeCompare(b, 'fr')));
      }
      function m2txt(m) {
        if (!m) return '0h00';
        const h = Math.floor(m / 60), mn = m % 60;
        if (h) {
          return mn ? `${h}h${String(mn).padStart(2, '0')}` : `${h}h`;
        }
        return `0h${String(mn).padStart(2, '0')}`;
      }
      function m2txtShort(m) {
        if (!m) return '0m';
        const h = (m / 60) | 0, mn = m % 60;
        if (h) {
          return mn ? `${h}h${String(mn).padStart(2, '0')}` : `${h}h`;
        }
        return `${mn}m`;
      }
      function oneLiner(s) { return (s || '').replace(/\s*\n\s*/g, ' ¬∑ ') }

      /* Global */
      let period = '30d', spaceId = 'D0PWE3', userName = 'Moi', dayOff = 0;
      let profilePeriod = '30d', activeProfileName = null, activeProfileEmail = null, profileReturnView = 'detail';

      /* Spaces (orgMode: day ou week) */
      const SPACES = {};
      const SPACE_ACTIVITIES = {};
      const INVITE_CACHE = {};
      const STORAGE_USER_PROFILE = 'habitu-user-profile';
      const STORAGE_GUEST_SPACES = 'habitu-guest-spaces';
      const GARDEN_TYPES = [
        { emoji: 'üë§', label: 'üë§ Individu', type: 'private', orgMode: 'day', desc: 'Jardin solo pour prendre soin de soi.' },
        { emoji: 'üè†', label: 'üè† Colocation', type: 'group', orgMode: 'day', desc: 'Petites routines partag√©es √† la maison.' },
        { emoji: 'üåû', label: 'üåû Famille', type: 'group', orgMode: 'day', desc: 'Rituels doux pour toute la famille.' },
        { emoji: 'üèõÔ∏è', label: 'üèõÔ∏è Association', type: 'group', orgMode: 'week', desc: 'Moments d‚Äô√©quipe r√©guliers.' },
        { emoji: 'üè´', label: '√âcole / Classe', type: 'group', orgMode: 'week', desc: 'Rituels p√©dagogiques simples.' },
        { emoji: 'üè¢', label: 'üè¢ Bureau', type: 'group', orgMode: 'week', desc: 'Rituels collaboratifs pro.' }
      ];
      let allowedSpaces = [];
      let currentProfile = loadStoredProfile();
      let guestSpaces = loadGuestSpaces();
      let pendingSpaceCreation = null;
      let pendingInviteToken = new URLSearchParams(window.location.search).get('invite');
      let pendingInviteInfo = null;
      const HABITU_FIREBASE_DB = window.HABITU_FIREBASE_DB;
      const ACTIVITY_BUFFER_MS = 3e3;
      const IS_LOCAL_FILE_URL = window.location.protocol === 'file:';
      const activityQueue = new Map();
      const SESSION_COOKIE_NAME = 'habitube-session';
      const SESSION_COOKIE_MAX_AGE = 365 * 24 * 60 * 60 * 1000;
      function loadStoredProfile() { try { return JSON.parse(localStorage.getItem(STORAGE_USER_PROFILE) || 'null') } catch (e) { return null } }
      function loadGuestSpaces() {
        try {
          const stored = JSON.parse(localStorage.getItem(STORAGE_GUEST_SPACES) || '[]');
          return new Set(Array.isArray(stored) ? stored.filter(Boolean) : []);
        } catch (e) {
          return new Set();
        }
      }
      function persistGuestSpaces() {
        try {
          localStorage.setItem(STORAGE_GUEST_SPACES, JSON.stringify(Array.from(guestSpaces)));
        } catch (e) {
          console.warn('persistGuestSpaces', e);
        }
      }
      function addGuestSpace(spaceId) {
        if (!spaceId) return;
        guestSpaces.add(spaceId);
        persistGuestSpaces();
      }
      function clearGuestSpaces() {
        if (guestSpaces.size === 0) return;
        guestSpaces.clear();
        persistGuestSpaces();
      }
      function setSessionCookie() {
        const expires = new Date(Date.now() + SESSION_COOKIE_MAX_AGE).toUTCString();
        document.cookie = `${SESSION_COOKIE_NAME}=1; expires=${expires}; path=/; SameSite=Lax`;
      }
      function clearSessionCookie() {
        document.cookie = `${SESSION_COOKIE_NAME}=; expires=${new Date(0).toUTCString()}; path=/; SameSite=Lax`;
      }
      function hasSessionCookie() {
        return document.cookie.split('; ').some(pair => pair.startsWith(`${SESSION_COOKIE_NAME}=`));
      }
      function persistProfile(profile) {
        if (!profile) {
          localStorage.removeItem(STORAGE_USER_PROFILE);
          currentProfile = null;
          clearSessionCookie();
          updateAddModalOptions();
          return;
        }
        localStorage.setItem(STORAGE_USER_PROFILE, JSON.stringify(profile));
        currentProfile = profile;
        setSessionCookie();
        updateAddModalOptions();
      }

      function clearObject(obj) { Object.keys(obj).forEach(k => delete obj[k]); }
      function clearLocalState() {
        clearObject(HABIT_DESC);
        clearObject(HABIT_TITLE_CUSTOM);
        clearObject(SPACE_DESC_TXT);
        clearObject(BASE_MINUTES);
        clearObject(HABIT_MODE);
        clearObject(LOCKED_COMMUN);
        clearObject(LOCKED_BY);
        clearObject(DONE_SETS);
        clearObject(HAS_DESC);
        clearObject(HABIT_REC);
        clearObject(FREQ_MODE);
        DELETED_HABITS.clear();
        allowedSpaces = [];
        Object.keys(SPACE_ACTIVITIES).forEach(k => delete SPACE_ACTIVITIES[k]);
        Object.keys(INVITE_CACHE).forEach(k => delete INVITE_CACHE[k]);
        Object.keys(SPACES).forEach(k => delete SPACES[k]);
        spaceId = null;
      }
      function normalizeEmail(email) {
        return String(email || '').trim().toLowerCase();
      }
      async function refreshOwnedSpaces(email) {
        if (!email) return [];
        try {
          const spaces = await fetchSpacesForEmail(email);
          spaces.forEach(space => {
            SPACES[space.id] = { ...(SPACES[space.id] || {}), ...space, members: space.members || [], ch: space.ch || [] };
          });
          const collected = spaces.map(space => space.id);
          allowedSpaces = [...new Set([...allowedSpaces, ...collected])];
          return spaces;
        } catch (err) {
          console.warn('refreshOwnedSpaces', err);
          return [];
        }
      }
      function countOwnedGardens(email) {
        if (currentProfile?.guest) {
          return guestSpaces.size;
        }
        if (!email) return 0;
        const normalized = normalizeEmail(email);
        if (!normalized) return 0;
        return Object.values(SPACES).filter(space => normalizeEmail(space.ownerEmail) === normalized).length;
      }
      function displayNameFromEmail(email) {
        const normalized = normalizeEmail(email);
        if (!normalized) return '';
        if (currentProfile && normalizeEmail(currentProfile.email) === normalized) {
          return currentProfile.name || 'Moi';
        }
        const candidate = (email || '').trim();
        return candidate.includes('@') ? candidate.split('@')[0] : candidate;
      }
      function getCurrentOwnerLabel() {
        const candidate = (userName || '').trim();
        return candidate || 'Moi';
      }
      function normalizeOwnerLabel(label) {
        return ((label || '').trim() || '').toLowerCase();
      }
      function isCurrentUserLabel(label) {
        const normalized = normalizeOwnerLabel(label);
        if (!normalized) return false;
        const canonical = normalizeOwnerLabel(getCurrentOwnerLabel());
        return normalized === canonical || normalized === 'moi';
      }
      function timestampToDate(value) {
        if (!value) return null;
        if (value?.toDate) return value.toDate();
        return new Date(value);
      }
      function dayKeyFromDate(date) {
        return `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
      }
      function upsertLocalHabitActivity(event) {
        if (!event || !event.spaceId || !event.habitId) return;
        const owner = event.owner || getOwnerNameFromEvent(event);
        if (!owner) return;
        const recordedAt = timestampToDate(event.recordedAt) || new Date();
        const key = `${owner}:${event.habitId}:${dayKeyFromDate(recordedAt)}`;
        const bucket = SPACE_ACTIVITIES[event.spaceId] || [];
        const idx = bucket.findIndex(ev => {
          const existingOwner = ev.owner || getOwnerNameFromEvent(ev);
          if (!existingOwner) return false;
          return `${existingOwner}:${ev.habitId}:${dayKeyFromDate(timestampToDate(ev.recordedAt) || new Date(0))}` === key;
        });
        const stored = { ...event, recordedAt };
        if (idx === -1) {
          bucket.push(stored);
        } else {
          const prev = timestampToDate(bucket[idx].recordedAt) || new Date(0);
          if (recordedAt >= prev) {
            bucket[idx] = stored;
          }
        }
        SPACE_ACTIVITIES[event.spaceId] = bucket;
      }
      function refreshActivityViews() {
        renderRank();
        renderCalendar();
        renderProfileStats();
      }
      function getSpaceOwnerEmail(spaceId) {
        return normalizeEmail(SPACES[spaceId]?.ownerEmail || '');
      }
      function isCurrentSpaceAdmin() {
        if (!currentProfile?.email) return false;
        const ownerEmail = getSpaceOwnerEmail(spaceId);
        return ownerEmail && ownerEmail === normalizeEmail(currentProfile.email);
      }
      function getEditorRights(space) {
        const mode = (space?.editorRights || 'admin').toString().toLowerCase();
        return mode === 'registered' ? 'registered' : 'admin';
      }
      function hasEditPermission() {
        const sp = getSpace();
        if (!sp) return false;
        const rights = getEditorRights(sp);
        if (rights === 'registered') {
          return !!currentProfile?.email;
        }
        return isCurrentSpaceAdmin();
      }
      function requireAdmin(action = 'modifier') {
        if (!hasEditPermission()) {
          alert(`Seuls les jardiniers autoris√©s peuvent ${action}.`);
          return false;
        }
        return true;
      }
      function persistUserProfile(profile) {
        if (!HABITU_FIREBASE_DB || !profile?.uid) return Promise.resolve();
        return HABITU_FIREBASE_DB.collection('users').doc(profile.uid)
          .set({ name: profile.name, email: profile.email, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true })
          .catch(e => console.warn('persistUserProfile', e));
      }
      function persistSpaceDoc(spaceId, data = {}) {
        if (!HABITU_FIREBASE_DB || !spaceId) return Promise.resolve();
        const space = SPACES[spaceId] || {};
        const payload = {
          ownerEmail: normalizeEmail(space.ownerEmail),
          members: Array.isArray(space.members) ? [...new Set(space.members.map(normalizeEmail))] : [],
          ...space,
          ...data,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        return HABITU_FIREBASE_DB.collection('spaces').doc(spaceId).set(payload, { merge: true }).catch(e => console.warn('persistSpaceDoc', e));
      }

      function collectSpaceCodes() {
        return new Set(Object.values(SPACES)
          .map(space => (space?.code || '').toUpperCase())
          .filter(Boolean));
      }

      function normalizeAccessCode(value) {
        return ((value || '').toUpperCase().replace(/[^A-Z0-9]/g, '')).slice(0, 6);
      }

      function formatAccessCode(code) {
        const normalized = normalizeAccessCode(code);
        if (!normalized) return '';
        if (normalized.length <= 3) return normalized;
        return `${normalized.slice(0, 3)}-${normalized.slice(3)}`;
      }

      function generateSpaceAccessCode() {
        const taken = collectSpaceCodes();
        let code;
        do {
          code = genCode();
        } while (taken.has(code));
        return code;
      }

      async function ensureSpaceHasCode(spaceId) {
        if (!spaceId) return null;
        const space = SPACES[spaceId];
        if (!space) return null;
        const normalized = (space.code || '').toUpperCase();
        if (normalized) {
          space.code = normalized;
          return normalized;
        }
        const newCode = generateSpaceAccessCode();
        space.code = newCode;
        await persistSpaceDoc(spaceId, { code: newCode });
        return newCode;
      }
      function persistHabit(spaceId, habitData) {
        if (!HABITU_FIREBASE_DB || !spaceId || !habitData?.id) return Promise.resolve();
        ensureHabitMetadata(habitData);
        return HABITU_FIREBASE_DB.collection('spaces').doc(spaceId).collection('habits').doc(habitData.id)
          .set({ ...habitData, spaceId, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true })
          .then(() => {
            markFirstHabitCreated();
          })
          .catch(e => console.warn('persistHabit', e));
      }
      function persistInviteDoc(token, payload) {
        if (!HABITU_FIREBASE_DB || !token) return Promise.resolve();
        const ownerEmail = normalizeEmail(payload.ownerEmail || currentProfile?.email);
        return HABITU_FIREBASE_DB.collection('invites').doc(token)
          .set({ ...payload, ownerEmail, token, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true })
          .catch(e => console.warn('persistInvite', e));
      }
      function deleteInviteDoc(token) {
        if (!HABITU_FIREBASE_DB || !token) return Promise.resolve();
        delete INVITE_CACHE[token];
        return HABITU_FIREBASE_DB.collection('invites').doc(token).delete().catch(e => console.warn('deleteInvite', e));
      }
      function sendActivityToServer(payload) {
        if (!HABITU_FIREBASE_DB || IS_LOCAL_FILE_URL) return Promise.resolve();
        return HABITU_FIREBASE_DB.collection('activities').add(payload).catch(e => console.warn('sendActivity', e));
      }
      function scheduleHabitActivity(habitId, payload) {
        if (!habitId) return;
        if (IS_LOCAL_FILE_URL) {
          console.warn('Skipping Firestore activity log while running from file://');
          return;
        }
        const key = `${habitId}:${payload.type}`;
        if (activityQueue.has(key)) {
          clearTimeout(activityQueue.get(key));
        }
        const actorName = currentProfile?.name || 'Moi';
        const localRecordedAt = new Date();
        const eventData = {
          ...payload,
          habitId,
          spaceId,
          userEmail: currentProfile?.email || null,
          userId: currentProfile?.uid || null,
          actorName,
          recordedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        const localEvent = { ...eventData, recordedAt: localRecordedAt };
        if (payload.type === 'realization') {
          upsertLocalHabitActivity(localEvent);
          refreshActivityViews();
        }
        const timer = setTimeout(() => {
          sendActivityToServer(eventData);
          activityQueue.delete(key);
        }, ACTIVITY_BUFFER_MS);
        activityQueue.set(key, timer);
      }
      function ensureHabitMetadata(habit) {
        if (!habit?.id) return;
        if (habit.baseMin) BASE_MINUTES[habit.id] = habit.baseMin;
        if (habit.desc || habit.note) HABIT_DESC[habit.id] = habit.desc || habit.note || '';
        if (habit.customTitle) HABIT_TITLE_CUSTOM[habit.id] = habit.customTitle;
        if (habit.mode) HABIT_MODE[habit.id] = habit.mode;
        if (habit.recurrence) HABIT_REC[habit.id] = habit.recurrence;
        if (habit.freqDefault) FREQ_MODE[habit.id] = { type: habit.freqDefault };
      }
      async function fetchSpacesForEmail(email) {
        if (!HABITU_FIREBASE_DB || !email) return [];
        const normalized = normalizeEmail(email);
        try {
          const snapshot = await HABITU_FIREBASE_DB.collection('spaces').get();
          const spaces = [];
          snapshot.forEach(doc => {
            const raw = doc.data() || {};
            const code = (raw.code || '').toUpperCase();
            const data = { id: doc.id, ...raw, createdAt: timestampToDate(raw.createdAt), code };
            const ownerEmail = normalizeEmail(data.ownerEmail);
            const members = Array.isArray(data.members) ? [...new Set(data.members.map(normalizeEmail))] : [];
            if (ownerEmail === normalized || members.includes(normalized)) {
              const enabledEditButton = raw.editButton !== false;
              spaces.push({ ...data, members, editButton: enabledEditButton });
            }
          });
          return spaces;
        } catch (err) {
          console.warn('fetchSpacesForEmail', err);
          return [];
        }
      }
      async function loadHabitsForSpace(spaceId) {
        if (!HABITU_FIREBASE_DB || !spaceId) return [];
        try {
          const snapshot = await HABITU_FIREBASE_DB.collection('spaces').doc(spaceId).collection('habits').get();
          const habits = snapshot.docs.map(doc => {
            const habit = { id: doc.id, ...doc.data() };
            if (habit.addedAt) habit.addedAt = timestampToDate(habit.addedAt);
            return habit;
          });
          habits.forEach(ensureHabitMetadata);
          if (habits.length > 0) {
            markFirstHabitCreated();
          }
          SPACES[spaceId] = { ...(SPACES[spaceId] || {}), ch: habits };
          return habits;
        } catch (err) {
          console.warn('loadHabitsForSpace', err);
          return SPACES[spaceId]?.ch || [];
        }
      }
      async function loadActivitiesForSpace(spaceId, days = 120) {
        if (!HABITU_FIREBASE_DB || !spaceId) return [];
        const since = new Date();
        since.setDate(since.getDate() - days);
        try {
          const snapshot = await HABITU_FIREBASE_DB.collection('activities')
            .where('spaceId', '==', spaceId)
            .where('recordedAt', '>=', since)
            .orderBy('recordedAt', 'desc')
            .get();
          const events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          SPACE_ACTIVITIES[spaceId] = events;
          return events;
        } catch (err) {
          console.warn('loadActivitiesForSpace', err);
          SPACE_ACTIVITIES[spaceId] = SPACE_ACTIVITIES[spaceId] || [];
          return SPACE_ACTIVITIES[spaceId];
        }
      }
      async function loadInvitesForOwner(email) {
        if (!HABITU_FIREBASE_DB || !email) return;
        const normalized = normalizeEmail(email);
        try {
          const snapshot = await HABITU_FIREBASE_DB.collection('invites').where('ownerEmail', '==', normalized).get();
          Object.keys(INVITE_CACHE).forEach(key => delete INVITE_CACHE[key]);
          snapshot.forEach(doc => { INVITE_CACHE[doc.id] = { token: doc.id, ...doc.data() }; });
        } catch (err) {
          console.warn('loadInvitesForOwner', err);
        }
      }
      async function refreshPendingInviteInfo() {
        if (!pendingInviteToken || !HABITU_FIREBASE_DB) {
          pendingInviteInfo = null;
          return null;
        }
        try {
          const doc = await HABITU_FIREBASE_DB.collection('invites').doc(pendingInviteToken).get();
          pendingInviteInfo = doc.exists ? { token: doc.id, ...doc.data() } : null;
        } catch (err) {
          console.warn('refreshPendingInviteInfo', err);
          pendingInviteInfo = null;
        }
        return pendingInviteInfo;
      }
      async function acceptPendingInvite(email) {
        if (!pendingInviteToken || !email) return null;
        const invite = await refreshPendingInviteInfo();
        if (!invite) return null;
        await joinSpace(invite.spaceId, email);
        await deleteInviteDoc(invite.token);
        pendingInviteToken = null;
        if (window.history.replaceState) {
          const url = new URL(window.location);
          url.searchParams.delete('invite');
          window.history.replaceState({}, '', url.pathname);
        }
        pendingInviteInfo = null;
        if (INVITE_CACHE[invite.token]) {
          delete INVITE_CACHE[invite.token];
          if (typeof renderInviteList === 'function') renderInviteList();
        }
        updateAuthMessage();
        return invite;
      }
      async function joinSpace(spaceId, email) {
        if (!HABITU_FIREBASE_DB || !spaceId || !email) return;
        const normalized = normalizeEmail(email);
        try {
          await HABITU_FIREBASE_DB.collection('spaces').doc(spaceId)
            .update({ members: firebase.firestore.FieldValue.arrayUnion(normalized) });
        } catch (err) {
          if (err?.code === 'not-found') {
            console.warn('joinSpace space not found', spaceId);
          } else {
            console.warn('joinSpace', err);
          }
        }
        if (SPACES[spaceId]) {
          const members = new Set([...(SPACES[spaceId].members || []).map(normalizeEmail)]);
          members.add(normalized);
          SPACES[spaceId].members = Array.from(members);
        }
      }
      async function loadLibraryData() {
        async function loadFromStatic() {
          const libraryUrl = new URL('library.json', window.location);
          const response = await fetch(libraryUrl.href, { cache: 'no-store' });
          if (!response.ok) throw new Error('library.json unavailable');
          const data = await response.json();
          if (!Array.isArray(data)) throw new Error('library.json malform√©');
          LIBRARY_HABITS.length = 0;
          data.forEach((habit, index) => {
            const slug = slugifyTag(habit.title || habit.titre || `habitude-${index}`);
            const safeSlug = slug || `habitude-${index}`;
            const id = habit.id || `lib-${safeSlug}-${index}`;
            const descText = (habit.note || habit.desc || '').trim();
            const candidateDuration = habit.baseMin ?? habit.duration;
            const parsedDuration = Number(candidateDuration);
            const baseMinVal = Number.isFinite(parsedDuration) ? Math.max(DEFAULT_DURATION, parsedDuration) : DEFAULT_DURATION;
            LIBRARY_HABITS.push({
              id,
              ...habit,
              desc: descText,
              titre: habit.titre || habit.title || '',
              baseMin: baseMinVal
            });
          });
        }

        try {
          if (!HABITU_FIREBASE_DB) throw new Error('firestore unavailable');
          const snapshot = await HABITU_FIREBASE_DB.collection('libraryHabits').get();
          LIBRARY_HABITS.length = 0;
          snapshot.docs.forEach(doc => LIBRARY_HABITS.push({ id: doc.id, ...doc.data() }));
        } catch (err) {
          console.warn('loadLibraryData (firestore)', err);
          try {
            await loadFromStatic();
          } catch (staticErr) {
            console.warn('loadLibraryData (static)', staticErr);
            LIBRARY_HABITS.length = 0;
          }
        } finally {
          refreshLibraryTags();
        }
      }
      let libraryDataPromise = null;
      function ensureLibraryData(force = false) {
        if (force || !libraryDataPromise) {
          libraryDataPromise = loadLibraryData();
        }
        return libraryDataPromise;
      }
      async function resetFirestoreState(email) {
        clearLocalState();
        if (!email) { return; }
        await ensureLibraryData(true);
        const spaces = await fetchSpacesForEmail(email);
        allowedSpaces = spaces.map(space => space.id);
        spaces.forEach(space => { SPACES[space.id] = { ...space, members: space.members || [], ch: [] }; });
        await Promise.all(spaces.map(space => loadHabitsForSpace(space.id)));
        await Promise.all(spaces.map(space => loadActivitiesForSpace(space.id)));
        await loadInvitesForOwner(email);
        renderInviteList();
        await Promise.all(allowedSpaces.map(id => ensureSpaceHasCode(id)));
        if (!spaceId && allowedSpaces.length) { spaceId = allowedSpaces[0]; }
        if (spaceId && !allowedSpaces.includes(spaceId)) { spaceId = allowedSpaces[0] || null; }
        updateSpaceAccessCodeDisplay();
      }
      const HABIT_TITLE_IS_CUSTOM = {};

      /* Fr√©quence : tout = quotidien par d√©faut (UI conserv√©e) */
      function defaultFreqMode() { return { type: 'quotidien' } }
      function isVisibleToday() { return true }

      /* ===== Helpers visuels encadr√©s ===== */
      function applyCardClass(card, st, owner, helping, modeType) {
        card.className = card.className.replace(/\bs0shared\b|\bs0\b|\bs1me\b|\bs1help\b|\bs1other\b|\bs2me\b|\bs2other\b/g, '').trim();
        if (st === 0) {
          if (modeType === 'commun') card.classList.add('s0shared'); else card.classList.add('s0');
        } else if (st === 1) {
          if (isCurrentUserLabel(owner)) card.classList.add('s1me');
          else if (helping) card.classList.add('s1help');
          else card.classList.add('s1other');
        } else if (st === 2) {
          if (isCurrentUserLabel(owner)) card.classList.add('s2me');
          else card.classList.add('s2other');
        }
      }

      /* Utils cartes */
      function formatOwnerBadgeText(ownerNames) {
        const sanitized = Array.from(new Set((ownerNames || []).map(name => (name || '').trim()).filter(Boolean)));
        if (!sanitized.length) return '';
        const hasCurrentUser = sanitized.some(isCurrentUserLabel);
        const orderedNames = [];
        if (hasCurrentUser) orderedNames.push('Moi');
        sanitized.forEach(name => {
          if (!isCurrentUserLabel(name)) orderedNames.push(name);
        });
        const maxDisplay = 3;
        const displayed = orderedNames.slice(0, maxDisplay);
        const remaining = orderedNames.length - displayed.length;
        const joinNames = arr => {
          if (arr.length === 1) return arr[0];
          if (arr.length === 2) return `${arr[0]} et ${arr[1]}`;
          const last = arr[arr.length - 1];
          return `${arr.slice(0, -1).join(', ')} et ${last}`;
        };
        const baseText = remaining > 0 ? displayed.join(', ') : joinNames(displayed);
        if (remaining > 0) {
          return `${baseText} et ${remaining} autre${remaining > 1 ? 's' : ''}`;
        }
        return baseText;
      }
      function ensureOwnerBadges(badges, owners, it, btn) {
        badges.querySelectorAll('.owner-badge').forEach(el => el.remove());
        const text = formatOwnerBadgeText(Array.isArray(owners) ? owners : []);
        if (!text) return;
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'badge owner-badge';
        b.textContent = `üßë‚Äçüåæ ${text}`;
        b.addEventListener('click', (e) => {
          e.stopPropagation();
          openDetail(it.id, btn);
          selectDetailTab('members');
        });
        badges.appendChild(b);
      }
      function ensureHelperBadge(badges, helpers) {
        helpers = [...new Set(helpers || [])];
        let b = badges.querySelector('.helper-badge');
        if (helpers.length === 0) { if (b) b.remove(); return; }
        if (!b) {
          b = document.createElement('div');
          b.className = 'badge helper-badge';
          const heart = badges.querySelector('.heart-badge');
          if (heart) badges.insertBefore(b, heart);
          else badges.appendChild(b);
        }
        b.textContent = `ü§ù ${names(helpers, 3)}`;
      }
      function ensureHeartBadge(badges, shouldShow, namesList, btnRef, habitId) {
        let b = badges.querySelector('.heart-badge');
        if (!shouldShow) {
          if (b) b.remove();
          return;
        }
        if (!b) {
          b = document.createElement('button');
          b.type = 'button';
          b.className = 'badge heart heart-badge';
          badges.appendChild(b);
          b.addEventListener('click', (e) => {
            e.stopPropagation();
            const list = JSON.parse(btnRef.dataset.heartList || '[]');
            const canonicalName = getCurrentOwnerLabel();
            let updated;
            const currentlyLiked = list.some(isCurrentUserLabel);
            if (currentlyLiked) {
              updated = list.filter(name => !isCurrentUserLabel(name));
            } else {
              updated = [canonicalName, ...list.filter(name => !isCurrentUserLabel(name))];
            }
            btnRef.dataset.heartList = JSON.stringify(updated);
            const liked = updated.some(isCurrentUserLabel);
            b.textContent = `‚ù§Ô∏è ${updated.length ? updated.join(', ') : ' '}`;
            b.classList.toggle('liked', liked);
            scheduleHabitActivity(habitId, { type: 'like', liked, recipients: updated });
          });
        }
        b.textContent = `‚ù§Ô∏è ${namesList.length ? namesList.join(', ') : ' '}`;
        b.classList.toggle('liked', namesList.some(isCurrentUserLabel));
      }

      /* Tag "Individuel" ‚Äî supprim√© */
      function ensureModeTag() { /* no-op */ }

      /* Description open/close */
      let openCard = null;
      function collapseOpenDesc() {
        if (!openCard) return;
        const d = openCard.querySelector('.desc');
        if (d) { d.classList.remove('open'); d.classList.add('hidden'); d.textContent = d.dataset.short || ''; }
        openCard.classList.remove('ready'); openCard = null;
      }
      document.addEventListener('click', e => { if (openCard && !e.target.closest('.card')) collapseOpenDesc(); }, { capture: true })
      function setupDesc(desc, hid) {
        const stored = HABIT_DESC[hid] || '';
        desc.dataset.full = stored;
        desc.dataset.short = oneLiner(stored);
        desc.dataset.has = stored.trim() ? '1' : '0';
        desc.textContent = desc.dataset.short;
        desc.classList.add('hidden');
        desc.classList.remove('open');
      }

      function getNotesDisplayMode() {
        const sp = getSpace();
        return (sp?.notesDisplayMode || 'dynamic');
      }

      function applyNoteDisplayMode(desc, infoBtn, { state = 0 } = {}) {
        if (!desc) return;
        const mode = getNotesDisplayMode();
        const hasNote = desc.dataset.has === '1';
        const fullText = desc.dataset.full || '';
        const shortText = desc.dataset.short || '';
        const numericState = Number(state) || 0;
        const showFull = () => {
          desc.textContent = fullText;
          desc.classList.remove('hidden');
          desc.classList.add('open');
        };
        const hideShort = () => {
          desc.classList.remove('open');
          desc.classList.add('hidden');
          desc.textContent = shortText;
        };
        if (mode === 'show') {
          if (infoBtn) infoBtn.style.display = 'none';
          showFull();
          return;
        }
        if (mode === 'hide') {
          if (infoBtn) infoBtn.style.display = 'none';
          desc.textContent = '';
          desc.classList.remove('open');
          desc.classList.add('hidden');
          return;
        }
        if (mode === 'dynamic') {
          if (infoBtn) infoBtn.style.display = 'none';
          if (numericState === 1 && hasNote) {
            showFull();
          } else {
            hideShort();
          }
          return;
        }
        if (infoBtn) {
          infoBtn.style.display = hasNote ? 'inline-flex' : 'none';
        }
        if (!hasNote) {
          hideShort();
        }
      }

      /* Global helpers */
      function curDate() { const t = new Date(); t.setHours(0, 0, 0, 0); t.setDate(t.getDate() + dayOff); return t; }
      function getSpace() { return (spaceId && SPACES[spaceId]) || null; }
      function isWeekMode() { return getSpace()?.orgMode === 'week'; }
      function shouldShowEditButton(state = 0) {
        const sp = getSpace();
        if (!sp) return false;
        const mode = (sp.editButtonMode || 'dynamic').toString();
        if (mode === 'yes') return true;
        if (mode === 'no') return false;
        return state === 1;
      }
      function getSpaceEarliestDate() {
        const sp = getSpace();
        if (!sp) return null;
        const created = timestampToDate(sp.createdAt);
        if (!created) return null;
        created.setHours(0, 0, 0, 0);
        return sp.orgMode === 'week' ? getWeekStart(created) : created;
      }
      function getEarliestDayOff() {
        const earliest = getSpaceEarliestDate();
        if (!earliest) return MIN_DAY_OFF;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return Math.round((earliest - today) / 86400000);
      }
      function clampDayOff(value) {
        return Math.max(value, getEarliestDayOff());
      }
      function listChallenges() { return getSpace()?.ch || []; }
      function findAny(id) {
        const map = new Map();
        Object.values(SPACES).forEach(space => { (space.ch || []).forEach(h => { if (h?.id) map.set(h.id, h); }); });
        if (map.has(id)) return map.get(id);
        return LIBRARY_HABITS.find(h => h.id === id);
      }
      function habitLabel(it) {
        if (!it) return '';
        const custom = HABIT_TITLE_CUSTOM[it.id];
        if (custom && custom.trim()) return custom.trim();
        return it.titre || it.title || '';
      }

      function renderDateBar() {
        const d = curDate();
        if (isWeekMode()) {
          $("#dateLabel").textContent = weekLabel(d);
        } else {
          $("#dateLabel").textContent = fmtDate(d);
        }
      }

      function getOwnerNameFromEvent(event) {
        return event.owner || event.actorName || event.ownerName || displayNameFromEmail(event.userEmail) || 'Moi';
      }
      function getSpaceEvents(spaceId, since = null) {
        if (!spaceId) return [];
        return (SPACE_ACTIVITIES[spaceId] || []).map(evt => {
          const recordedAt = timestampToDate(evt.recordedAt);
          if (!recordedAt) return null;
          return { ...evt, recordedAt };
        }).filter(evt => !!evt && (!since || evt.recordedAt >= since));
      }
      function getHabitRecords(spaceId, habitId, since = null, ownerFilter = '__all__') {
        if (!habitId) return [];
        const events = getSpaceEvents(spaceId, since).filter(ev => ev.type === 'realization' && ev.habitId === habitId);
        const map = new Map();
        events.forEach(event => {
          const owner = getOwnerNameFromEvent(event);
          if (ownerFilter !== '__all__' && owner !== ownerFilter) return;
          const key = `${owner}:${event.habitId}:${dayKeyFromDate(event.recordedAt)}`;
          const prev = map.get(key);
          if (!prev || event.recordedAt > prev.recordedAt) {
            map.set(key, { ...event, owner });
          }
        });
        return Array.from(map.values());
      }
      function getSpaceRecords(spaceId, since = null) {
        const events = getSpaceEvents(spaceId, since).filter(ev => ev.type === 'realization');
        const map = new Map();
        events.forEach(event => {
          const owner = getOwnerNameFromEvent(event);
          const key = `${owner}:${event.habitId}:${dayKeyFromDate(event.recordedAt)}`;
          const prev = map.get(key);
          if (!prev || event.recordedAt > prev.recordedAt) {
            map.set(key, { ...event, owner });
          }
        });
        return Array.from(map.values());
      }
      function summarizeSocials(spaceId, since = null, until = null) {
        let events = getSpaceEvents(spaceId, since);
        if (until) {
          events = events.filter(ev => ev.recordedAt <= until);
        }
        const likes = new Map();
        const helps = new Map();
        events.forEach(event => {
          const actor = getOwnerNameFromEvent(event);
          if (event.type === 'like' && event.liked) {
            likes.set(actor, (likes.get(actor) || 0) + 1);
          }
          if (event.type === 'support') {
            (event.helpers || []).forEach(helper => {
              helps.set(helper, (helps.get(helper) || 0) + 1);
            });
          }
        });
        return { likes, helps };
      }
      function getLikeListForHabit(habitId) {
        if (!spaceId) return [];
        const events = getSpaceEvents(spaceId).filter(ev => ev.type === 'like' && ev.habitId === habitId && ev.liked);
        if (!events.length) return [];
        const latest = events.reduce((best, event) => (!best || event.recordedAt > best.recordedAt) ? event : best, null);
        return Array.isArray(latest?.recipients) ? latest.recipients : [];
      }

      /* Emojis & bouton */
      function currentBigEmoji(btn, tot) { return btn.dataset.override || (tot <= 7 ? 'üå∞' : tot <= 14 ? 'üå±' : tot <= 21 ? 'üçÄ' : tot <= 28 ? 'üåº' : tot <= 35 ? 'üåª' : tot <= 42 ? 'üå∑' : tot <= 49 ? 'üåπ' : tot <= 56 ? 'ü™ª' : tot <= 64 ? 'üíê' : 'üéã'); }
      function drawBtn(btn) {
        const p = +btn.dataset.plants || 0;
        const s = +btn.dataset.suns || 0;
        const tot = p + s;
        const st = +btn.dataset.state || 0;
        const habitEmoji = btn.dataset.habitEmoji || 'üå±';
        const bigEmoji = (st === 2) ? currentBigEmoji(btn, tot) : habitEmoji;
        btn.innerHTML = `<div class="big">${bigEmoji}</div>`;
        btn.classList.toggle('done', st === 2);
      }

      /* Init per habit */
      function ensureHabit(hid) {
        const def = findAny(hid) || {};
        if (!BASE_MINUTES[hid]) BASE_MINUTES[hid] = def.baseMin || 15;
        if (HABIT_DESC[hid] === undefined) { HABIT_DESC[hid] = def.desc || ''; }
        if (!HABIT_MODE[hid]) {
          if (def.modeDefault) {
            HABIT_MODE[hid] = { type: (def.modeDefault === 'commun' ? 'commun' : (def.modeDefault === 'partage' ? 'commun' : 'libre')), n: 2 };
          } else {
            const sp = getSpace();
            const fallbackType = sp?.type === 'private' ? 'libre' : 'commun';
            HABIT_MODE[hid] = { type: fallbackType, n: 2 };
          }
        }
        if (!DONE_SETS[hid]) DONE_SETS[hid] = new Set();
        if (LOCKED_COMMUN[hid] === undefined) { LOCKED_COMMUN[hid] = false; LOCKED_BY[hid] = null; }
        if (!HABIT_REC[hid]) {
          const recurrence = def.recurrence || 1;
          HABIT_REC[hid] = Math.max(1, Math.min(7, recurrence));
        }
      }

      /* S√©lection quotidienne 4‚Äì9 habitudes par espace (d√©terministe par jour) */
      function dayKey() { const d = curDate(); return `${spaceId}:${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`; }
      function hashStr(s) { let h = 0; for (let i = 0; i < s.length; i++) { h = (h * 31 + s.charCodeAt(i)) >>> 0; } return h >>> 0; }
      function rngSeed(seed) { let x = seed >>> 0; return () => { x = (x * 1664525 + 1013904223) >>> 0; return (x >>> 0) / 4294967296; }; }
      function pickVisibleList(arr) {
        const seed = hashStr(dayKey());
        const rand = rngSeed(seed);
        const count = Math.min(arr.length, 4 + Math.floor(rand() * 6)); // 4..9
        const a = arr.slice();
        for (let i = 0; i < a.length - 1; i++) { const j = Math.floor(rand() * (i + 1));[a[i], a[j]] = [a[j], a[i]]; }
        return a.slice(0, count);
      }

      /* Cartes */
      function renderCards() {
        collapseOpenDesc();
        const root = $("#cards");
        root.innerHTML = '';
        if (!spaceId) return;
        const today = curDate();
        today.setHours(0, 0, 0, 0);
        const items = pickVisibleList(listChallenges());
        items.sort((a, b) => {
          const aMode = (HABIT_MODE[a.id] || {}).type;
          const bMode = (HABIT_MODE[b.id] || {}).type;
          const aIndividual = aMode === 'libre';
          const bIndividual = bMode === 'libre';
          if (aIndividual === bIndividual) return 0;
          return aIndividual ? -1 : 1;
        });
        if (lastRenderedSpaceId !== spaceId) {
          autoOpenedHabitModalForEmptySpace = false;
          lastRenderedSpaceId = spaceId;
        }
        if (!items.length) {
          const emptyState = document.createElement('div');
          emptyState.className = 'empty-state';
          emptyState.innerHTML = '<strong>Ton jardin est encore vide.</strong><p>Ajoute quelques habitudes via ¬´ Nouvelle(s) habitude(s) ¬ª pour commencer √† les cultiver.</p>';
          root.appendChild(emptyState);
          maybePromptAddHabitsForEmptySpace();
        } else {
          autoOpenedHabitModalForEmptySpace = false;
          items.forEach(it => {
            if (DELETED_HABITS.has(it.id)) return;
            if (!isVisibleToday(it.id, today)) return;
            ensureHabit(it.id);

            const card = document.createElement('article');
            card.className = 'card';
            const cont = document.createElement('div');
            cont.className = 'content';
            const title = document.createElement('div');
            title.className = 'title';
            const left = document.createElement('div');
            left.className = 'left';
            const mode = HABIT_MODE[it.id] || { type: 'libre' };
            const displayTitle = habitLabel(it);
            left.innerHTML = `<span class="base">${displayTitle}</span>`;
            title.append(left);

            const desc = document.createElement('div');
            desc.className = 'desc';
            setupDesc(desc, it.id);
            const infoBtn = document.createElement('button');
            infoBtn.type = 'button';
            infoBtn.className = 'infoBtn';
            infoBtn.textContent = '‚ÑπÔ∏è';
            const hasNote = desc.dataset.has === '1';
            infoBtn.title = hasNote ? 'Afficher la note' : '';
            title.appendChild(infoBtn);

            const friends = document.createElement('div');
            friends.className = 'friends';
            const friendsBadges = document.createElement('div');
            friendsBadges.className = 'friends-badges';
            friends.appendChild(friendsBadges);
            const progressRow = document.createElement('div');
            progressRow.className = 'weekly-progress';
            cont.append(progressRow, title, desc, friends);

            const col = document.createElement('div');
            col.className = 'levelCol';
            const btn = document.createElement('button');
            btn.className = 'levelBtn';
            btn.dataset.cid = it.id;
            btn.dataset.habitEmoji = it.emoji || 'üå±';

            const windowStart = isWeekMode() ? getWeekStart(today) : today;
            const records = getHabitRecords(spaceId, it.id, windowStart);
            const freqWeekly = HABIT_REC[it.id] || 1;
            let userRecord = records.find(r => isCurrentUserLabel(r.owner)) || null;
            const doneRecord = records.find(r => (r.state || 0) >= 1) || null;
            let ownerRecord = null;
            if (mode.type === 'commun') {
              ownerRecord = doneRecord || records[0] || null;
            } else {
              ownerRecord = userRecord || doneRecord || null;
            }
            const ownerFreq = Math.max(1, Number(ownerRecord?.frequency ?? freqWeekly));
            const ownerModeType = ownerRecord?.modeType || mode.type;
            const resetProgress = (isWeekMode() && ownerRecord && ownerFreq !== freqWeekly) || (ownerRecord && ownerModeType !== mode.type);
            if (resetProgress) {
              ownerRecord = null;
              userRecord = null;
            }
            const ownerNames = Array.from(new Set(records
              .filter(r => (r.state || 0) >= 1)
              .map(r => (r.owner || '').trim())
              .filter(Boolean)
            ));
            btn.dataset.ownerList = JSON.stringify(ownerNames);
            const baseMin = BASE_MINUTES[it.id] || 15;
            const ownerState = ownerRecord?.state ?? 0;
            const owner = ownerState > 0 ? (ownerRecord?.owner || '') : '';
            const helpers = ownerState > 0 ? (ownerRecord?.helpers || []) : [];
            const helping = ownerState > 0 && ownerRecord?.helping ? '1' : '0';
            const userState = userRecord?.state ?? 0;
            const storedCount = Number(userRecord?.count ?? 0) || 0;
            const computedCount = storedCount || (userState === 2 ? freqWeekly + 1 : 0);
            const countValue = isWeekMode() ? Math.min(Math.max(computedCount, 0), freqWeekly + 1) : 0;
            const state = userState;
            const vipList = getLikeListForHabit(it.id);
            btn.dataset.state = String(state);
            btn.dataset.owner = owner;
            btn.dataset.helping = helping;
            btn.dataset.helpers = JSON.stringify(helpers);
            btn.dataset.count = state === 0 ? '0' : String(countValue);
            btn.dataset.baseMin = String(baseMin);
            btn.dataset.recur = String(freqWeekly);
            btn.dataset.week = isWeekMode() ? '1' : '0';
            btn.dataset.basePlants = String(state >= 1 ? baseMin : 0);
            btn.dataset.plants = btn.dataset.basePlants;
            btn.dataset.suns = String(vipList.length);
            btn.dataset.heartList = JSON.stringify(vipList);

            const setVisualFromState = stNow => {
              const baseEl = title.querySelector('.base');
              const ownerNow = btn.dataset.owner || '';
              const helpingNow = btn.dataset.helping === '1';
              applyCardClass(card, stNow, ownerNow, helpingNow, (HABIT_MODE[it.id] || { type: 'libre' }).type);
              baseEl.classList.toggle('strike', stNow === 2 && isCurrentUserLabel(ownerNow));
              ensureModeTag();
            };

            const parseOwnerList = () => {
              try {
                const parsed = JSON.parse(btn.dataset.ownerList || '[]');
                return Array.isArray(parsed) ? parsed : [];
              } catch (err) {
                console.warn('parseOwnerList', err);
                return [];
              }
            };
            const syncOwnerListFromState = (prevOwner) => {
              const owners = new Set(parseOwnerList().filter(Boolean));
              const activeOwner = (btn.dataset.owner || '').trim();
              if ((+btn.dataset.state || 0) >= 1 && activeOwner) {
                owners.add(activeOwner);
              }
              if ((+btn.dataset.state || 0) === 0 && prevOwner) {
                owners.delete(prevOwner);
              }
              btn.dataset.ownerList = JSON.stringify(Array.from(owners));
            };
            const renderBadges = () => {
              const stNow = +btn.dataset.state || 0;
              const ownerNow = btn.dataset.owner || '';
              const ownersNow = parseOwnerList();
              ensureOwnerBadges(friendsBadges, ownersNow, it, btn);
              const showHelpers = mode.type === 'commun' && stNow === 2;
              if (showHelpers) {
                const hlist = (btn.dataset.helpers ? JSON.parse(btn.dataset.helpers) : []) || [];
                ensureHelperBadge(friendsBadges, hlist);
              } else {
                ensureHelperBadge(friendsBadges, []);
              }
              const ownerIsMe = isCurrentUserLabel(ownerNow);
              const shouldHeart = (stNow === 1 && !ownerIsMe) || (stNow === 2 && !ownerIsMe);
              const arr = JSON.parse(btn.dataset.heartList || '[]');
              ensureHeartBadge(friendsBadges, shouldHeart, arr, btn, it.id);
            };

            const renderWeeklyProgress = () => {
              const isWeek = btn.dataset.week === '1';
              const recur = Math.max(1, +btn.dataset.recur || 1);
              const freqType = FREQ_MODE[it.id]?.type || (isWeek ? 'hebdo' : 'quotidien');
              const freqDays = Array.isArray(it.freqDays) ? it.freqDays : [];
              const showDayProgress = !isWeek && (freqType === 'quotidien' || (freqDays.length > 1));
              const shouldShow = (isWeek && recur > 1) || showDayProgress;
              progressRow.style.display = shouldShow ? 'flex' : 'none';
              progressRow.innerHTML = '';
              if (!shouldShow) return;
              const totalBlocks = isWeek ? recur : (freqType === 'jours' && freqDays.length ? freqDays.length : 7);
              const stateNow = +btn.dataset.state || 0;
              const rawCount = Math.max(0, Math.min(totalBlocks, +btn.dataset.count || 0));
              let doneCount = rawCount;
              let activeIndex = -1;
              if (stateNow === 1) {
                activeIndex = rawCount;
                doneCount = Math.max(0, rawCount - 1);
              } else if (stateNow === 2) {
                doneCount = totalBlocks;
                activeIndex = -1;
              } else {
                doneCount = 0;
                activeIndex = -1;
              }
              const dayOrder = (!isWeek && freqType === 'jours' && freqDays.length) ? freqDays.slice() : (isWeek ? null : [1, 2, 3, 4, 5, 6, 0]);
              for (let idx = 0; idx < totalBlocks; idx++) {
                const block = document.createElement('span');
                block.className = 'weekly-progress__block';
                const position = idx + 1;
                if (position <= doneCount) {
                  block.classList.add('weekly-progress__block--done');
                } else if (position === activeIndex) {
                  block.classList.add('weekly-progress__block--active');
                } else {
                  block.classList.add('weekly-progress__block--pending');
                }
                if (dayOrder && idx < dayOrder.length) {
                  block.dataset.day = dayOrder[idx];
                }
                progressRow.appendChild(block);
              }
            };

            const ensureOpenDesc = () => {
              if (getNotesDisplayMode() !== 'info') return;
              if (openCard !== card) {
                collapseOpenDesc();
                openCard = card;
              }
              if (!desc.classList.contains('open')) {
                desc.classList.remove('hidden');
                desc.classList.add('open');
                desc.textContent = desc.dataset.full || '';
              }
            };
            const hideDescNow = () => {
              desc.classList.remove('open');
              desc.classList.add('hidden');
              desc.textContent = desc.dataset.short || '';
              if (openCard === card) openCard = null;
              if (desc.dataset.has === '1') {
                infoBtn.title = 'Afficher la note';
              }
            };
            const toggleNote = () => {
              if (desc.dataset.has !== '1') return;
              if (desc.classList.contains('open')) {
                hideDescNow();
              } else {
                ensureOpenDesc();
                infoBtn.title = 'Masquer la note';
              }
            };
            infoBtn.addEventListener('click', e => {
              if (getNotesDisplayMode() !== 'info') return;
              e.stopPropagation();
              toggleNote();
            });

            const applyState = (nst, { keepOwner = false } = {}) => {
              btn.dataset.state = String(nst);
              const previousOwner = (btn.dataset.owner || '').trim();
              if (!keepOwner && nst === 0) {
                btn.dataset.owner = '';
                btn.dataset.helping = '0';
                btn.dataset.helpers = '[]';
                btn.dataset.count = '0';
              }
              if (nst >= 1 && !btn.dataset.owner) {
                btn.dataset.owner = getCurrentOwnerLabel();
              }
              syncOwnerListFromState(previousOwner);
              drawBtn(btn);
              setVisualFromState(nst);
              renderBadges();
              renderWeeklyProgress();
              applyNoteDisplayMode(desc, infoBtn, { state: nst });
              manageEditButton();
              scheduleHabitActivity(it.id, {
                type: 'realization',
                state: nst,
                owner: btn.dataset.owner,
                helping: btn.dataset.helping === '1',
                count: +btn.dataset.count || 0,
                frequency: freqWeekly,
                modeType: mode.type
              });
              renderDateBar();
            };

            const clickWeekly = () => {
              let st = +btn.dataset.state || 0;
              let count = +btn.dataset.count || 0;
              const R = Math.max(1, +btn.dataset.recur || 1);
              if (st === 0) {
                st = 1;
                count = 1;
                btn.dataset.owner = getCurrentOwnerLabel();
              } else if (st === 1) {
                if (count < R) {
                  count++;
                } else if (count === R) {
                  st = 2;
                }
              } else if (st === 2) {
                st = 0;
                count = 0;
                btn.dataset.owner = '';
              }
              if (st === 2) {
                count = R;
              }
              btn.dataset.count = String(count);
              applyState(st, { keepOwner: st !== 0 });
            };

            const clickCommon = () => {
              if (isWeekMode()) { clickWeekly(); return; }
              const st = +btn.dataset.state || 0;
              const ownerNow = btn.dataset.owner || '';
              if (st === 0) {
                btn.dataset.owner = getCurrentOwnerLabel();
                applyState(1);
                return;
              }
              if (st === 1) {
                if (isCurrentUserLabel(ownerNow)) {
                  applyState(2, { keepOwner: true });
                } else {
                  const helping = btn.dataset.helping === '1';
                  btn.dataset.helping = helping ? '0' : '1';
                  let hs = JSON.parse(btn.dataset.helpers || '[]');
                  if (helping) {
                    hs = hs.filter(n => !isCurrentUserLabel(n));
                  } else {
                    if (!hs.some(isCurrentUserLabel)) hs.push(getCurrentOwnerLabel());
                  }
                  btn.dataset.helpers = JSON.stringify(hs);
                  drawBtn(btn);
                  setVisualFromState(1);
                  renderBadges();
                  renderDateBar();
                  scheduleHabitActivity(it.id, { type: 'support', helping: btn.dataset.helping === '1', helpers: hs });
                }
                return;
              }
              if (st === 2) {
                if (isCurrentUserLabel(ownerNow)) {
                  applyState(0);
                }
                return;
              }
            };

            const clickLibre = () => {
              if (isWeekMode()) { clickWeekly(); return; }
              const st = +btn.dataset.state || 0;
              if (st === 0) {
                btn.dataset.owner = getCurrentOwnerLabel();
                applyState(2);
                return;
              }
              if (st === 2) {
                applyState(0);
              }
            };

            const handleClick = () => {
              if (!ensureSingleSessionActive()) return;
              (mode.type === 'commun') ? clickCommon() : clickLibre();
            };

            drawBtn(btn);
            setVisualFromState(state);
            renderBadges();
            renderWeeklyProgress();
            applyNoteDisplayMode(desc, infoBtn, { state });
            const manageEditButton = () => {
              const currentState = +btn.dataset.state || 0;
              const enabled = shouldShowEditButton(currentState);
              const existing = friends.querySelector('.card-edit');
              if (!enabled) {
                if (existing) existing.remove();
                return;
              }
              if (existing) return;
              const editBtn = document.createElement('button');
              editBtn.type = 'button';
              editBtn.className = 'card-edit';
              editBtn.textContent = '‚úèÔ∏è';
              editBtn.title = 'Modifier cette habitude';
              editBtn.addEventListener('click', e => {
                e.stopPropagation();
                openDetail(it.id, btn);
                selectDetailTab('settings');
              });
              friends.appendChild(editBtn);
            };
            manageEditButton();
            col.addEventListener('click', handleClick);
            cont.addEventListener('click', (e) => { if (e.target.closest('.badge')) return; handleClick(); });
            col.append(btn);
            card.append(col, cont);
            root.appendChild(card);
          });
        }
        renderDateBar();
        updateAddModalOptions();
      }

      /* ===== Calendriers ===== */
      let calOff = 0;
      function minfo(off = 0) { const b = new Date(); b.setDate(1); b.setMonth(b.getMonth() + off); const y = b.getFullYear(), m = b.getMonth(); return { y, m, fd: (new Date(y, m, 1).getDay() + 6) % 7, days: new Date(y, m + 1, 0).getDate() } }
      function populateCalWho() {
        const sel = $("#calWho");
        sel.innerHTML = '';
        sel.add(new Option('Tous', '__all__'));
        allMembersOfSpace().forEach(name => {
          if (!name || name === '__all__') return;
          const option = new Option(name, name);
          sel.add(option);
        });
        sel.value = '__all__';
      }
      function renderCalendar() {
        const wrap = $("#cal");
        wrap.innerHTML = '';
        if (!spaceId || !activeId) return;
        const { y, m, fd, days } = minfo(calOff);
        const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];
        const ownerFilter = $("#calWho")?.value || '__all__';
        const records = getHabitRecords(spaceId, activeId, null, ownerFilter);
        const dayMap = new Map();
        records.forEach(rec => {
          if (rec.recordedAt.getFullYear() !== y || rec.recordedAt.getMonth() !== m) return;
          const day = rec.recordedAt.getDate();
          const current = dayMap.get(day);
          if (!current || rec.state > current.state || rec.recordedAt > current.recordedAt) {
            dayMap.set(day, rec);
          }
        });
        const isWeekModeNow = isWeekMode();
        wrap.classList.toggle('week-mode', isWeekModeNow);
        const today = new Date();
        const sameMonth = calOff === 0;
        let monthMinutes = 0;
        const totalCells = fd + days;
        const rows = Math.max(1, Math.ceil(totalCells / 7));
        const weekTotals = Array(rows).fill(0);
        for (let i = 0; i < fd; i++) {
          const c = document.createElement('div');
          c.className = 'cell';
          c.style.opacity = .35;
          wrap.appendChild(c);
        }
        for (let d = 1; d <= days; d++) {
          const c = document.createElement('div');
          c.className = 'cell';
          const dn = document.createElement('div');
          dn.className = 'dayNum';
          dn.textContent = String(d);
          c.appendChild(dn);
          const rec = dayMap.get(d);
          if (rec && rec.state >= 1) {
            const mark = document.createElement('div');
            mark.className = 'seedMark';
            mark.textContent = 'üßë‚Äçüåæ';
            c.appendChild(mark);
            const dur = document.createElement('div');
            dur.className = 'dur';
            const minutes = BASE_MINUTES[rec.habitId] || 15;
            dur.textContent = m2txtShort(minutes);
            c.appendChild(dur);
            monthMinutes += minutes;
            const dayIndex = Math.floor((fd + d - 1) / 7);
            if (dayIndex >= 0 && dayIndex < rows) {
              weekTotals[dayIndex] += minutes;
            }
          }
          if (sameMonth && d === today.getDate()) {
            c.style.outline = `2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--green')}`;
          }
          c.onclick = () => {
            const b = new Date();
            b.setDate(1);
            b.setMonth(b.getMonth() + calOff);
            const tgt = new Date(b.getFullYear(), b.getMonth(), d);
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            const targetOff = Math.round((tgt - now) / 86400000);
            dayOff = clampDayOff(targetOff);
            showHome();
            renderCards();
            renderDateBar();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };
          wrap.appendChild(c);
        }
        if (isWeekModeNow) {
          const cellHeight = 55;
          const gap = 6;
          const summaryHeight = 24;
          for (let row = 0; row < rows; row++) {
            const summaryMinutes = weekTotals[row];
            const summary = document.createElement('div');
            summary.className = 'weekSummary';
            summary.textContent = `üßë‚Äçüåæ ${m2txt(summaryMinutes)}`;
            const rowTop = row * (cellHeight + gap);
            const top = rowTop + cellHeight - summaryHeight - 2;
            summary.style.top = `${top}px`;
            wrap.appendChild(summary);
          }
        }
        $("#monthLabel").textContent = `${months[m]} ${y}  üßë‚Äçüåæ${m2txt(round15(monthMinutes))}`;
      }
      $("#prevMonth").onclick = () => { calOff--; renderCalendar() }; $("#nextMonth").onclick = () => { calOff++; renderCalendar() }; $("#calWho")?.addEventListener('change', renderCalendar);

      /* ===== Navigation vues ===== */
      function showHome() { hideAll(); $("#home").classList.add('active'); $("#daysWrap").classList.remove('hide') }
      function hideAll() { $$('#home,#detail,#space,#profile').forEach(v => v.classList.remove('active')) }
      $("#backHome").onclick = showHome;

      /* ===== Classement (texte simple ‚ù§Ô∏èü§ù) ===== */
      const DETAIL_PERIOD_BUTTONS = [
        { selector: '#btnP7', day: { key: '7d', label: '7 jours' }, week: { key: '1w', label: '1 sem' } },
        { selector: '#btnP30', day: { key: '30d', label: '30 jours' }, week: { key: '4w', label: '4 sem' } },
        { selector: '#btnPAll', day: { key: 'all', label: 'Total' }, week: { key: 'all', label: 'Total' } }
      ];
      const PROFILE_PERIOD_BUTTONS = [
        { selector: '#profilePeriod7', day: { key: '7d', label: '7 jours' }, week: { key: '1w', label: '1 sem' } },
        { selector: '#profilePeriod30', day: { key: '30d', label: '30 jours' }, week: { key: '4w', label: '4 sem' } },
        { selector: '#profilePeriodAll', day: { key: 'all', label: 'Total' }, week: { key: 'all', label: 'Total' } }
      ];
      const SPACE_PERIOD_BUTTONS = [
        { selector: '#sBtnP7', day: { key: '7d', label: '7 jours' }, week: { key: '1w', label: '1 sem' } },
        { selector: '#sBtnP30', day: { key: '30d', label: '30 jours' }, week: { key: '4w', label: '4 sem' } },
        { selector: '#sBtnPAll', day: { key: 'all', label: 'Total' }, week: { key: 'all', label: 'Total' } }
      ];
      function applyPeriodButtonLayout(buttons, mode) {
        const allowed = [];
        let defaultKey = null;
        buttons.forEach(item => {
          const btn = $(item.selector);
          if (!btn) return;
          const info = item[mode];
          if (!info) return;
          btn.dataset.period = info.key;
          btn.textContent = info.label;
          allowed.push(info.key);
          if (!defaultKey) defaultKey = info.key;
        });
        return { allowed, defaultKey };
      }
      function updateDetailPeriodControls() {
        const mode = isWeekMode() ? 'week' : 'day';
        const { allowed, defaultKey } = applyPeriodButtonLayout(DETAIL_PERIOD_BUTTONS, mode);
        if (!allowed.includes(period)) {
          period = defaultKey || 'all';
        }
        updPeriodBtns();
      }
      function updateProfilePeriodButtons() {
        const mode = isWeekMode() ? 'week' : 'day';
        const { allowed, defaultKey } = applyPeriodButtonLayout(PROFILE_PERIOD_BUTTONS, mode);
        if (!allowed.includes(profilePeriod)) {
          profilePeriod = defaultKey || 'all';
        }
        PROFILE_PERIOD_BUTTONS.forEach(item => {
          const btn = $(item.selector);
          if (!btn) return;
          btn.classList.toggle('active', btn.dataset.period === profilePeriod);
        });
      }
      function updateSpacePeriodButtons() {
        const mode = isWeekMode() ? 'week' : 'day';
        const { allowed, defaultKey } = applyPeriodButtonLayout(SPACE_PERIOD_BUTTONS, mode);
        if (!allowed.includes(sPeriod)) {
          sPeriod = defaultKey || 'all';
        }
        SPACE_PERIOD_BUTTONS.forEach(item => {
          const btn = $(item.selector);
          if (!btn) return;
          btn.classList.toggle('active', btn.dataset.period === sPeriod);
        });
      }
      function getWeekRange(count) {
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        const currentWeekStart = getWeekStart(now);
        const lastWeekEnd = new Date(currentWeekStart);
        lastWeekEnd.setDate(lastWeekEnd.getDate() - 1);
        const since = new Date(lastWeekEnd);
        since.setDate(since.getDate() - (7 * count) + 1);
        since.setHours(0, 0, 0, 0);
        return { since, until: lastWeekEnd };
      }
      function resolvePeriodRange(key) {
        if (!key || key === 'all') return { since: null, until: null };
        if (key === '1w') return getWeekRange(1);
        if (key === '4w') return getWeekRange(4);
        if (key === '7d' || key === '30d') {
          const days = Number(key.replace('d', '')) || 0;
          if (!days) return { since: null, until: null };
          const since = new Date();
          since.setHours(0, 0, 0, 0);
          since.setDate(since.getDate() - days);
          return { since };
        }
        return { since: null, until: null };
      }
      function renderRank() {
        updateDetailPeriodControls();
        const root = $("#rank");
        root.innerHTML = '';
        if (!spaceId || !activeId) return;
        const range = resolvePeriodRange(period);
        const records = getHabitRecords(spaceId, activeId, range.since);
        const filtered = range.until ? records.filter(rec => rec.recordedAt <= range.until) : records;
        const totals = new Map();
        filtered.forEach(rec => {
          if ((rec.state || 0) >= 1) {
            const minutes = BASE_MINUTES[activeId] || 15;
            totals.set(rec.owner, (totals.get(rec.owner) || 0) + minutes);
          }
        });
        const { likes, helps } = summarizeSocials(spaceId, range.since, range.until);
        const members = new Set(allMembersOfSpace());
        members.add(userName || 'Moi');
        const rows = Array.from(members).map(name => ({
          n: name,
          me: name === (userName || 'Moi'),
          totalMin: totals.get(name) || 0,
          likes: likes.get(name) || 0,
          help: Math.round(((helps.get(name) || 0) * 15) / 60),
          txt: m2txt(totals.get(name) || 0)
        })).sort((a, b) => b.totalMin - a.totalMin);
        rows.forEach(({ n, totalMin, txt, me, likes, help }) => {
          const row = document.createElement('div');
          row.className = 'row';
          const left = document.createElement('div');
          left.className = 'leftRank';
          const big = document.createElement('span');
          big.className = 'scoreEmoji';
          big.textContent = `${lvlEmoji(Math.min(65, Math.round(totalMin / 60)))} ${txt}`;
          const nameBtn = document.createElement('button');
          nameBtn.type = 'button';
          nameBtn.className = 'profile-link';
          nameBtn.textContent = `${n}${me ? ' (toi)' : ''}`;
          nameBtn.addEventListener('click', () => openProfileView(n, 'detail'));
          left.append(big, nameBtn);
          const right = document.createElement('div');
          right.style.display = 'flex';
          right.style.gap = '8px';
          const helpTxt = document.createElement('span');
          helpTxt.textContent = `ü§ù ${help}h`;
          const likeTxt = document.createElement('span');
          likeTxt.textContent = `‚ù§Ô∏è ${likes}`;
          right.append(helpTxt, likeTxt);
          row.append(left, right);
          root.appendChild(row);
        });
        renderProfileStats();
      }
      function updPeriodBtns() { $$('#btnP7,#btnP30,#btnPAll').forEach(b => b.classList.toggle('active', b.dataset.period === period)) }
      $('#btnP7').onclick = () => {
        const btn = $("#btnP7");
        period = btn?.dataset.period || period;
        renderRank();
      };
      $('#btnP30').onclick = () => {
        const btn = $("#btnP30");
        period = btn?.dataset.period || period;
        renderRank();
      };
      $('#btnPAll').onclick = () => {
        const btn = $("#btnPAll");
        period = btn?.dataset.period || period;
        renderRank();
      };
      function showDetailView() { hideAll(); $("#detail").classList.add('active'); $("#daysWrap").classList.add('hide') }
      function getProfileSinceDate() {
        if (!spaceId) return null;
        const range = resolvePeriodRange(profilePeriod);
        return range.since;
      }
      function renderProfileStats() {
        updateProfilePeriodButtons();
        const root = $("#profileHabits");
        const empty = $("#profileEmpty");
        if (root) root.innerHTML = '';
        if (!spaceId || !activeProfileName) {
          if (empty) empty.classList.remove('hide');
          return;
        }
        const normalized = normalizeOwnerLabel(activeProfileName);
        const range = resolvePeriodRange(profilePeriod);
        let records = getSpaceRecords(spaceId, range.since);
        if (range.until) {
          records = records.filter(rec => rec.recordedAt <= range.until);
        }
        records = records.filter(rec => normalizeOwnerLabel(rec.owner) === normalized);
        const minutesPerHabit = new Map();
        records.forEach(rec => {
          if ((rec.state || 0) >= 1) {
            const minutes = BASE_MINUTES[rec.habitId] || 15;
            minutesPerHabit.set(rec.habitId, (minutesPerHabit.get(rec.habitId) || 0) + minutes);
          }
        });
        let events = getSpaceEvents(spaceId, range.since);
        if (range.until) {
          events = events.filter(ev => ev.recordedAt <= range.until);
        }
        const supportCounts = new Map();
        const likeCounts = new Map();
        events.forEach(event => {
          const actor = getOwnerNameFromEvent(event);
          if (!actor || normalizeOwnerLabel(actor) !== normalized) return;
          if (!event.habitId) return;
          if (event.type === 'support') {
            supportCounts.set(event.habitId, (supportCounts.get(event.habitId) || 0) + 1);
          }
          if (event.type === 'like' && event.liked) {
            likeCounts.set(event.habitId, (likeCounts.get(event.habitId) || 0) + 1);
          }
        });
        const habitIds = new Set([...minutesPerHabit.keys(), ...supportCounts.keys(), ...likeCounts.keys()]);
        if (!habitIds.size) {
          if (empty) empty.classList.remove('hide');
          return;
        }
        if (empty) empty.classList.add('hide');
        const entries = Array.from(habitIds).map(hid => ({
          habit: findAny(hid),
          minutes: minutesPerHabit.get(hid) || 0,
          supports: supportCounts.get(hid) || 0,
          likes: likeCounts.get(hid) || 0,
          id: hid
        })).sort((a, b) => b.minutes - a.minutes);
        entries.forEach(item => {
          const name = habitLabel(item.habit) || 'Habitude';
          const row = document.createElement('div');
          row.className = 'row profile-habit';
          const left = document.createElement('div');
          left.className = 'leftRank profile-habit-left';
          const durationScore = document.createElement('span');
          durationScore.className = 'scoreEmoji';
          const totalMinutes = item.minutes || 0;
          durationScore.textContent = `${lvlEmoji(Math.min(65, Math.round(totalMinutes / 60)))} ${m2txt(totalMinutes)}`;
          const title = document.createElement('div');
          title.className = 'profile-habit-title';
          const emoji = document.createElement('span');
          emoji.textContent = item.habit?.emoji || 'üåø';
          const text = document.createElement('span');
          text.textContent = name;
          title.append(emoji, text);
          left.append(durationScore, title);
          const stats = document.createElement('div');
          stats.className = 'profile-habit-stats';
          const supports = document.createElement('span');
          supports.textContent = `ü§ù ${item.supports}`;
          const likes = document.createElement('span');
          likes.textContent = `‚ù§Ô∏è ${item.likes}`;
          stats.append(supports, likes);
          row.append(left, stats);
          row.addEventListener('click', () => {
            openDetail(item.id, row);
          });
          root.appendChild(row);
        });
      }
      function resolveProfileEmail(name) {
        const normalizedTarget = normalizeOwnerLabel(name);
        if (!normalizedTarget) return null;
        if (currentProfile && normalizeOwnerLabel(getCurrentOwnerLabel()) === normalizedTarget) {
          return currentProfile.email || null;
        }
        const sp = getSpace();
        if (!sp) return null;
        const ownerName = displayNameFromEmail(sp.ownerEmail);
        if (normalizeOwnerLabel(ownerName) === normalizedTarget) return sp.ownerEmail;
        for (const email of sp.members || []) {
          if (normalizeOwnerLabel(displayNameFromEmail(email)) === normalizedTarget) {
            return email;
          }
        }
        return null;
      }
      function updateProfileRemoveButton() {
        const removeBtn = $("#removeFromGardenBtn");
        const grantBtn = $("#grantAccessBtn");
        if (!activeProfileName) {
          if (removeBtn) removeBtn.classList.add('hide');
          if (grantBtn) grantBtn.classList.add('hide');
          return;
        }
        const sp = getSpace();
        const ownerName = sp ? displayNameFromEmail(sp.ownerEmail) : '';
        const isOwner = normalizeOwnerLabel(activeProfileName) === normalizeOwnerLabel(ownerName);
        const isSelf = normalizeOwnerLabel(activeProfileName) === normalizeOwnerLabel(getCurrentOwnerLabel());
        const shouldShow = isCurrentSpaceAdmin() && !isOwner && !isSelf;
        if (removeBtn) removeBtn.classList.toggle('hide', !shouldShow);
        if (grantBtn) grantBtn.classList.toggle('hide', !shouldShow);
      }
      function openProfileView(name, returnView = 'detail') {
        if (!name) return;
        activeProfileName = name;
        profileReturnView = returnView || 'detail';
        activeProfileEmail = resolveProfileEmail(name);
        updateProfilePeriodButtons();
        hideAll();
        $("#profile").classList.add('active');
        $("#daysWrap").classList.add('hide');
        $("#profileTitle").textContent = name;
        updateProfileRemoveButton();
        renderProfileStats();
      }
      function closeProfileView() {
        const target = profileReturnView;
        profileReturnView = 'detail';
        activeProfileName = null;
        activeProfileEmail = null;
        hideAll();
        if (target === 'space') {
          openSpacePage();
        } else if (activeId) {
          showDetailView();
        } else {
          showHome();
        }
      }
      async function removeActiveProfileMember() {
        if (!activeProfileEmail || !spaceId) return;
        if (!confirm('Retirer ce jardinier du jardin ?')) return;
        const normalized = normalizeEmail(activeProfileEmail);
        const sp = getSpace();
        if (!sp) return;
        sp.members = (sp.members || []).filter(email => normalizeEmail(email) !== normalized);
        await persistSpaceDoc(spaceId, { members: sp.members });
        renderSpaceRank();
        renderRank();
        renderCards();
        closeProfileView();
      }

      async function grantActiveProfileAccess() {
        if (!activeProfileName || !spaceId) return;
        if (!isCurrentSpaceAdmin()) return;
        const sp = getSpace();
        if (!sp) return;
        const token = genInviteToken();
        const link = `${inviteBaseUrl()}?invite=${token}`;
        const ownerName = displayNameFromEmail(sp.ownerEmail);
        const inviteData = {
          ownerName,
          invitedName: activeProfileName,
          spaceId,
          spaceCode: sp.code || '',
          spaceDesc: (sp.desc || '').trim(),
          gardenLabel: sp.label || 'ton jardin',
          created: Date.now(),
          ownerEmail: sp.ownerEmail
        };
        await persistInviteDoc(token, inviteData);
        INVITE_CACHE[token] = { token, ...inviteData };
        if (typeof renderInviteList === 'function') renderInviteList();
        showToast('Lien g√©n√©r√© !', { type: 'success' });
        copyText(link);
      }

      /* ===== Param√®tres habitude ===== */
      let activeId = null, refBtn = null;
      function openDetail(id, btnRef) {
        activeId = id; refBtn = btnRef; hideAll(); $("#detail").classList.add('active'); $("#daysWrap").classList.add('hide');
        $$('.tab').forEach(t => t.classList.remove('active')); document.querySelector('[data-tab="members"]').classList.add('active');
        $$('#detail .view').forEach(v => v.classList.remove('active')); $('#tab-members').classList.add('active');
        const it = findAny(id); $("#detailTitle").textContent = `${it.emoji} ${habitLabel(it)}`;
        renderRank(); populateCalWho(); renderCalendar(); renderHabitSettings();
      }
      function selectDetailTab(key) {
        const b = [...document.querySelectorAll('#detail .tabs [data-tab]')].find(x => x.dataset.tab === key); if (!b) return;
        document.querySelectorAll('#detail .tabs [data-tab]').forEach(x => x.classList.remove('active')); b.classList.add('active');
        document.querySelectorAll('#detail .section .view').forEach(v => v.classList.remove('active'));
        document.querySelector(`#detail #${'tab-' + key}`)?.classList.add('active');
      }

      function renderHabitSettings() {
        if (!activeId) return; ensureHabit(activeId);
        const it = findAny(activeId);
        const isAdmin = isCurrentSpaceAdmin();

        const titleInput = $("#habitTitleInput"), emojiEl = $("#habitTitleEmoji");
        if (it && titleInput && emojiEl) {
          emojiEl.textContent = it.emoji || 'üå±';
          if (document.activeElement !== titleInput) titleInput.value = habitLabel(it);
          titleInput.disabled = !isAdmin;
          if (!titleInput.dataset.bound) {
            titleInput.addEventListener('input', () => { const raw = titleInput.value; if (raw.trim()) { HABIT_TITLE_CUSTOM[activeId] = raw; } else { delete HABIT_TITLE_CUSTOM[activeId]; } $("#detailTitle").textContent = `${it.emoji} ${habitLabel(it)}`; renderCards(); });
            titleInput.dataset.bound = '1';
          }
        }
        const desc = $("#habitDesc");
        if (desc) {
          desc.value = HABIT_DESC[activeId] || '';
          desc.disabled = !isAdmin;
          if (!desc.dataset.bound) {
            desc.addEventListener('input', () => { HABIT_DESC[activeId] = desc.value; HAS_DESC[activeId] = !!desc.value.trim(); renderCards(); });
            desc.dataset.bound = '1';
          }
        }

        const currentMode = (HABIT_MODE[activeId]?.type === 'commun') ? 'commun' : 'libre';
        syncHabitModeButtons(currentMode, !isAdmin);

        const freqWrapper = $("#freqField");
        const weekFreqWrapper = $("#weekFreqField");
        const weekFreqSelect = $("#weekFreqSelect");
        const weekMode = isWeekMode();
        if (freqWrapper) freqWrapper.classList.toggle('hide', weekMode);
        if (weekFreqWrapper) weekFreqWrapper.classList.toggle('hide', !weekMode);
        if (weekFreqSelect) {
          const currentRecurrence = HABIT_REC[activeId] || 1;
          weekFreqSelect.value = String(currentRecurrence);
          weekFreqSelect.disabled = !isAdmin;
          if (!weekFreqSelect.dataset.bound) {
            weekFreqSelect.dataset.bound = '1';
          }
          if (!weekFreqSelect.dataset.handlerBound) {
            weekFreqSelect.addEventListener('change', () => {
              const next = Math.max(1, Math.min(7, Number(weekFreqSelect.value) || 1));
              weekFreqSelect.value = String(next);
              HABIT_REC[activeId] = next;
              if (spaceId) {
                persistHabit(spaceId, { id: activeId, recurrence: next, frequency: String(next) });
              }
              renderCards();
            });
            weekFreqSelect.dataset.handlerBound = '1';
          }
        }

        const ft = $("#freqType"), fJ = $("#freqSubJours"), fPon = $("#freqSubPonctuelle");
        const adjustFreqSubs = () => {
          if (!ft) return;
          const val = ft.value;
          fJ?.classList.toggle('hide', val !== 'jours');
          fPon?.classList.toggle('hide', val !== 'ponctuelle');
        };
        if (ft) {
          ft.addEventListener('change', adjustFreqSubs);
          adjustFreqSubs();
        }

        const defaultDurSel = $("#mockDefaultDur");
        if (defaultDurSel && !defaultDurSel.dataset.bound) {
          defaultDurSel.dataset.bound = '1';
          defaultDurSel.addEventListener('change', () => {
            const selected = Number(defaultDurSel.value);
            const mins = Number.isFinite(selected) && selected > 0 ? selected : DEFAULT_DURATION;
            BASE_MINUTES[activeId] = mins;
            renderCards();
          });
        }

        const del = $("#deleteHabitBtn");
        if (del && !del.dataset.bound) {
          del.onclick = () => { if (!requireAdmin('supprimer une habitude')) return; if (confirm('Supprimer cette habitude ?')) { DELETED_HABITS.add(activeId); persistHabit(spaceId, { id: activeId, deleted: true }); showHome(); renderCards(); } };
          del.dataset.bound = '1';
        }
        if (del) {
          del.disabled = !isAdmin;
        }

        const save = $("#saveHabitBtn");
        if (save && !save.dataset.bound) {
          save.onclick = async () => {
            if (!requireAdmin('modifier une habitude')) return;
            const payload = {
              id: activeId,
              customTitle: HABIT_TITLE_CUSTOM[activeId] || '',
              desc: HABIT_DESC[activeId] || '',
              note: HABIT_DESC[activeId] || '',
              mode: HABIT_MODE[activeId] || null
            };
            await persistHabit(spaceId, payload);
            activeId = null;
            renderCards();
            showHome();
          };
          save.dataset.bound = '1';
        }
        if (save) {
          save.disabled = !isAdmin;
        }
      }

      /* ===== Espace ===== */
      function openSpacePage() { hideAll(); $("#space").classList.add('active'); $("#daysWrap").classList.add('hide'); updSpaceHeader(); renderSpaceRank(); setupSpaceInfo(); populateSpaceWho(); renderSpaceCalendar(); maybeTogglePrivateAdd(); }
      function updSpaceHeader() {
        const sp = getSpace();
        $("#spaceHeaderTitle").textContent = sp.label;
        $("#paramSpaceLabel").value = sp.label;
        $("#paramName").value = userName || 'Moi';
        const orgSel = $("#spaceOrgMode");
        if (orgSel) orgSel.value = sp.orgMode || 'day';
        const autoWeekField = $("#autoWeekField");
        if (autoWeekField) autoWeekField.classList.toggle('hide', sp.orgMode !== 'week');
        updateSpaceOrgButtons();
      }
      function setupSpaceInfo() {
        const sp = getSpace(); const t = $("#spaceDescInfo");
        t.value = SPACE_DESC_TXT[spaceId] ?? (sp.desc || ''); t.classList.add('editing');
        t.oninput = () => { SPACE_DESC_TXT[spaceId] = t.value; sp.desc = t.value; persistSpaceDoc(spaceId, { desc: t.value }) }
        const autoWeekSelect = $("#autoWeekAffection");
        if (autoWeekSelect && !autoWeekSelect.dataset.bound) {
          autoWeekSelect.value = 'none';
          autoWeekSelect.dataset.bound = '1';
        }
        updateSpaceOrgButtons();
        const rightsSelect = $("#spaceEditorRights");
        if (rightsSelect) {
          rightsSelect.value = getEditorRights(sp);
          if (!rightsSelect.dataset.bound) {
            rightsSelect.addEventListener('change', () => {
              if (!spaceId) return;
              const mode = rightsSelect.value === 'registered' ? 'registered' : 'admin';
              sp.editorRights = mode;
              persistSpaceDoc(spaceId, { editorRights: mode });
            });
            rightsSelect.dataset.bound = '1';
          }
        }
        refreshOwnerPanel();
        const quitBtn = $("#quitSpaceBtn");
        if (quitBtn && !quitBtn.dataset.bound) {
          quitBtn.onclick = () => showQuitModal();
          quitBtn.dataset.bound = '1';
        }
        const saveSettingsBtn = $("#saveSpaceSettings");
        if (saveSettingsBtn && !saveSettingsBtn.dataset.bound) {
          saveSettingsBtn.onclick = async () => {
            if (!spaceId) return;
            await persistSpaceDoc(spaceId);
            showToast('R√©glages sauvegard√©s.', { type: 'success' });
          };
          saveSettingsBtn.dataset.bound = '1';
        }
      }

      function getTransferCandidates() {
        const sp = getSpace();
        if (!sp) return [];
        const owner = getSpaceOwnerEmail(spaceId);
        const normalizedMembers = Array.from(new Set((sp.members || []).map(normalizeEmail)));
        return normalizedMembers.filter(email => email && email !== owner);
      }

      function refreshOwnerPanel() {
        const ownerControls = $("#ownerControls");
        const ownerHint = $("#ownerControlsHint");
        const transferBtn = $("#transferSpaceBtn");
        const deleteBtn = $("#deleteSpaceBtn");
        const guestQuitControls = $("#guestQuitControls");
        const isOwner = isCurrentSpaceAdmin();
        if (ownerControls) ownerControls.classList.toggle('hide', !isOwner);
        if (guestQuitControls) guestQuitControls.classList.toggle('hide', isOwner);
        const candidates = isOwner ? getTransferCandidates() : [];
        if (transferBtn) transferBtn.disabled = !candidates.length;
        if (deleteBtn) deleteBtn.disabled = !isOwner;
        if (ownerHint) {
          ownerHint.textContent = '';
        }
      }

      function populateTransferSelect() {
        const select = $("#transferOwnerSelect");
        if (!select) return;
        const candidates = getTransferCandidates();
        select.innerHTML = '';
        if (!candidates.length) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'Aucun autre jardinier disponible';
          select.appendChild(opt);
          select.disabled = true;
        } else {
          select.disabled = false;
          candidates.forEach(email => {
            const opt = document.createElement('option');
            opt.value = email;
            opt.textContent = displayNameFromEmail(email) || email;
            select.appendChild(opt);
          });
        }
        if (confirmTransferBtn) confirmTransferBtn.disabled = !candidates.length;
      }

      async function leaveCurrentSpace() {
        if (!spaceId || !currentProfile?.email) return;
        const email = currentProfile.email;
        await removeMemberFromSpace(spaceId, email);
        await deleteMemberActivities(spaceId, email);
        allowedSpaces = allowedSpaces.filter(id => id !== spaceId);
        const nextSpace = allowedSpaces[0] || null;
        spaceId = nextSpace;
        updSel();
        skipMenuAutoOpen = true;
        renderCards();
        skipMenuAutoOpen = false;
        if (spaceId) {
          openSpacePage();
        } else {
          showHome();
        }
      }

      async function removeMemberFromSpace(spaceIdArg, email) {
        if (!spaceIdArg || !email) return;
        const normalized = normalizeEmail(email);
        try {
          if (HABITU_FIREBASE_DB) {
            await HABITU_FIREBASE_DB.collection('spaces').doc(spaceIdArg)
              .update({ members: firebase.firestore.FieldValue.arrayRemove(normalized) });
          }
        } catch (err) {
          console.warn('removeMemberFromSpace', err);
        }
        const sp = SPACES[spaceIdArg];
        if (sp) {
          sp.members = (sp.members || []).filter(mail => normalizeEmail(mail) !== normalized);
        }
      }

      async function deleteMemberActivities(spaceIdArg, email) {
        if (!spaceIdArg || !email) return;
        const normalized = normalizeEmail(email);
        if (SPACE_ACTIVITIES[spaceIdArg]) {
          SPACE_ACTIVITIES[spaceIdArg] = (SPACE_ACTIVITIES[spaceIdArg] || []).filter(ev => normalizeEmail(ev.userEmail || '') !== normalized);
        }
        if (!HABITU_FIREBASE_DB) return;
        try {
          const snapshot = await HABITU_FIREBASE_DB.collection('activities')
            .where('spaceId', '==', spaceIdArg)
            .where('userEmail', '==', normalized)
            .get();
          if (snapshot.empty) return;
          const batch = HABITU_FIREBASE_DB.batch();
          snapshot.docs.forEach(doc => batch.delete(doc.ref));
          await batch.commit();
        } catch (err) {
          console.warn('deleteMemberActivities', err);
        }
      }

      async function updateSpaceOwner(spaceIdArg, email) {
        if (!spaceIdArg || !email) return;
        const sp = SPACES[spaceIdArg];
        if (!sp) return;
        const normalized = normalizeEmail(email);
        sp.ownerEmail = normalized;
        await persistSpaceDoc(spaceIdArg);
        refreshOwnerPanel();
        updSpaceHeader();
        renderSpaceRank();
        setupSpaceInfo();
      }


      async function deleteCurrentSpace() {
        if (!spaceId) return;
        const target = spaceId;
        try {
          if (HABITU_FIREBASE_DB) {
            const spaceRef = HABITU_FIREBASE_DB.collection('spaces').doc(target);
            const [habitsSnap, activitiesSnap] = await Promise.all([
              spaceRef.collection('habits').get(),
              HABITU_FIREBASE_DB.collection('activities').where('spaceId', '==', target).get()
            ]);
            const batch = HABITU_FIREBASE_DB.batch();
            habitsSnap.docs.forEach(doc => batch.delete(doc.ref));
            activitiesSnap.docs.forEach(doc => batch.delete(doc.ref));
            batch.delete(spaceRef);
            await batch.commit();
          }
        } catch (err) {
          console.warn('deleteSpace', err);
        }
        delete SPACES[target];
        delete SPACE_ACTIVITIES[target];
        allowedSpaces = allowedSpaces.filter(id => id !== target);
        const nextSpace = allowedSpaces[0] || null;
        spaceId = nextSpace;
        updSel();
        renderCards();
        if (spaceId) {
          openSpacePage();
        } else {
          showHome();
        }
      }

      function allMembersOfSpace() {
        const sp = getSpace();
        const members = new Set(['Moi']);
        (sp?.members || []).forEach(email => {
          const name = displayNameFromEmail(email);
          if (name) members.add(name);
        });
        return Array.from(members);
      }
      function renderSpaceRank() {
        updateSpacePeriodButtons();
        const root = $("#spaceRank");
        root.innerHTML = '';
        if (!spaceId) return;
        const range = resolvePeriodRange(sPeriod);
        const records = getSpaceRecords(spaceId, range.since);
        const filtered = range.until ? records.filter(rec => rec.recordedAt <= range.until) : records;
        const totals = new Map();
        filtered.forEach(rec => {
          if ((rec.state || 0) >= 1) {
            const minutes = BASE_MINUTES[rec.habitId] || 15;
            totals.set(rec.owner, (totals.get(rec.owner) || 0) + minutes);
          }
        });
        const { likes, helps } = summarizeSocials(spaceId, range.since, range.until);
        const members = new Set(allMembersOfSpace());
        members.add(userName || 'Moi');
        const rows = Array.from(members).map(name => ({
          n: name,
          me: name === (userName || 'Moi'),
          totalMin: totals.get(name) || 0,
          likes: likes.get(name) || 0,
          help: Math.round(((helps.get(name) || 0) * 15) / 60),
          txt: m2txt(totals.get(name) || 0)
        })).sort((a, b) => b.totalMin - a.totalMin);
        rows.forEach(({ n, totalMin, txt, me, likes, help }) => {
          const row = document.createElement('div');
          row.className = 'row';
          const left = document.createElement('div');
          left.className = 'leftRank';
          const big = document.createElement('span');
          big.className = 'scoreEmoji';
          big.textContent = `${lvlEmoji(Math.min(65, Math.round(totalMin / 60)))} ${txt}`;
          const nameBtn = document.createElement('button');
          nameBtn.type = 'button';
          nameBtn.className = 'profile-link';
          nameBtn.textContent = `${n}${me ? ' (toi)' : ''}`;
          nameBtn.addEventListener('click', () => openProfileView(n, 'space'));
          left.append(big, nameBtn);
          const right = document.createElement('div');
          right.style.display = 'flex';
          right.style.gap = '8px';
          const helpTxt = document.createElement('span');
          helpTxt.textContent = `ü§ù ${help}h`;
          const likeTxt = document.createElement('span');
          likeTxt.textContent = `‚ù§Ô∏è ${likes}`;
          right.append(helpTxt, likeTxt);
          row.append(left, right);
          root.appendChild(row);
        });
        renderProfileStats();
      }
      let sPeriod = '30d';
      $('#sBtnP7').onclick = () => {
        const btn = $("#sBtnP7");
        sPeriod = btn?.dataset.period || sPeriod;
        renderSpaceRank();
      };
      $('#sBtnP30').onclick = () => {
        const btn = $("#sBtnP30");
        sPeriod = btn?.dataset.period || sPeriod;
        renderSpaceRank();
      };
      $('#sBtnPAll').onclick = () => {
        const btn = $("#sBtnPAll");
        sPeriod = btn?.dataset.period || sPeriod;
        renderSpaceRank();
      };
      $('#profilePeriod7').onclick = () => {
        const btn = $("#profilePeriod7");
        profilePeriod = btn?.dataset.period || profilePeriod;
        renderProfileStats();
      };
      $('#profilePeriod30').onclick = () => {
        const btn = $("#profilePeriod30");
        profilePeriod = btn?.dataset.period || profilePeriod;
        renderProfileStats();
      };
      $('#profilePeriodAll').onclick = () => {
        const btn = $("#profilePeriodAll");
        profilePeriod = btn?.dataset.period || profilePeriod;
        renderProfileStats();
      };
      $('#backFromProfile').onclick = closeProfileView;
      $('#removeFromGardenBtn').onclick = removeActiveProfileMember;
      $('#grantAccessBtn').onclick = grantActiveProfileAccess;

      let sCalOff = 0;
      function populateSpaceWho() { const sel = $("#sCalWho"); sel.innerHTML = ''; sel.add(new Option('Tous', '__all__')); allMembersOfSpace().forEach(n => sel.add(new Option(n, n))); sel.value = '__all__'; }
      function renderSpaceCalendar() {
        const wrap = $("#sCal");
        wrap.innerHTML = '';
        if (!spaceId) return;
        const space = getSpace();
        const isWeekSpace = space?.orgMode === 'week';
        wrap.classList.toggle('week-mode', isWeekSpace);
        const { y, m, fd, days } = minfo(sCalOff);
        const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];
        const cellHeight = 55;
        const gap = 6;
        const totalCells = fd + days;
        const rows = Math.max(1, Math.ceil(totalCells / 7));
        wrap.style.position = 'relative';
        wrap.style.minHeight = `${rows * (cellHeight + gap) - gap}px`;
        const ownerFilter = $("#sCalWho")?.value || '__all__';
        const weekTotals = Array(rows).fill(0);
        const records = getSpaceRecords(spaceId);
        const monthMap = new Map();
        records.forEach(rec => {
          if (rec.recordedAt.getFullYear() !== y || rec.recordedAt.getMonth() !== m) return;
          if (ownerFilter !== '__all__' && ownerFilter !== rec.owner) return;
          const day = rec.recordedAt.getDate();
          const minutes = BASE_MINUTES[rec.habitId] || 15;
          monthMap.set(day, (monthMap.get(day) || 0) + minutes);
          const dayIndex = Math.floor((fd + day - 1) / 7);
          if (dayIndex >= 0 && dayIndex < rows) {
            weekTotals[dayIndex] += minutes;
          }
        });
        const today = new Date();
        const sameMonth = sCalOff === 0;
        let monthMinutes = 0;
        for (let i = 0; i < fd; i++) {
          const c = document.createElement('div');
          c.className = 'cell';
          c.style.opacity = .35;
          wrap.appendChild(c);
        }
        for (let d = 1; d <= days; d++) {
          const c = document.createElement('div');
          c.className = 'cell';
          const dn = document.createElement('div');
          dn.className = 'dayNum';
          dn.textContent = String(d);
          c.appendChild(dn);
          const minutes = monthMap.get(d) || 0;
          if (minutes > 0) {
            const mark = document.createElement('div');
            mark.className = 'seedMark';
            mark.textContent = 'üßë‚Äçüåæ';
            c.appendChild(mark);
            const dur = document.createElement('div');
            dur.className = 'dur';
            dur.textContent = m2txtShort(minutes);
            c.appendChild(dur);
            monthMinutes += minutes;
          }
          if (sameMonth && d === today.getDate()) {
            c.style.outline = `2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--green')}`;
          }
          c.onclick = () => {
            const b = new Date();
            b.setDate(1);
            b.setMonth(b.getMonth() + sCalOff);
            const tgt = new Date(b.getFullYear(), b.getMonth(), d);
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            const targetOff = Math.round((tgt - now) / 86400000);
            dayOff = clampDayOff(targetOff);
            showHome();
            renderCards();
            renderDateBar();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };
          wrap.appendChild(c);
        }
        if (isWeekSpace) {
          const summaryHeight = 24;
          for (let row = 0; row < rows; row++) {
            const summaryMinutes = weekTotals[row];
            const summary = document.createElement('div');
            summary.className = 'weekSummary';
            summary.textContent = `üßë‚Äçüåæ ${m2txt(summaryMinutes)}`;
            const rowTop = row * (cellHeight + gap);
            const top = rowTop + cellHeight - summaryHeight - 2;
            summary.style.top = `${top}px`;
            wrap.appendChild(summary);
          }
        }
        $("#sMonthLabel").textContent = `${months[m]} ${y}  üßë‚Äçüåæ${m2txt(round15(monthMinutes))}`;
      }
      $("#sPrevMonth").onclick = () => { sCalOff--; renderSpaceCalendar() }; $("#sNextMonth").onclick = () => { sCalOff++; renderSpaceCalendar() }; $("#sCalWho").addEventListener('change', renderSpaceCalendar);

      function getVisibleSpaces() {
        const base = allowedSpaces.length ? allowedSpaces : Object.keys(SPACES);
        const order = ['E8D3FS', 'AS50CI', 'D0PWE3', 'WS32D7', 'SR3S0D', 'PD03XZ'];
        const list = [];
        order.forEach(id => { if (base.includes(id) && !list.includes(id)) list.push(id) });
        base.forEach(id => { if (!list.includes(id)) list.push(id) });
        return list;
      }

      /* S√©lecteur d‚Äôespace */
      function updSel() {
        const sel = $("#spaceSel"); sel.innerHTML = '';
        const ordered = getVisibleSpaces();
        if (ordered.length === 0) {
          const placeholder = document.createElement('option');
          placeholder.value = ''; placeholder.textContent = '‚Äî Aucun jardin';
          sel.appendChild(placeholder);
          sel.disabled = true;
          return;
        }
        sel.disabled = false;
        ordered.forEach(id => {
          const o = document.createElement('option');
          o.value = id;
          o.textContent = SPACES[id].label;
          sel.appendChild(o);
        });
        if (!ordered.includes(spaceId) || !SPACES[spaceId]) spaceId = ordered[0];
        sel.value = spaceId;
        updateSpaceAccessCodeDisplay();
      }
      const selSpace = $("#spaceSel"); selSpace.addEventListener('change', () => { spaceId = selSpace.value; renderCards(); showHome(); updateSpaceAccessCodeDisplay(); });
      $("#openSpace").onclick = openSpacePage; $("#backFromSpace").onclick = showHome;

      /* Modales */
      const mAdd = $("#modalAdd"), mHabit = $("#modalHabit"), mInvite = $("#modalInvite"), mGarden = $("#modalGarden"), mJoin = $("#modalJoin"), mTransfer = $("#modalTransfer");
      const mQuit = $("#modalQuit");
      const quitModalText = $("#quitModalText");
      const quitModalTransferBtn = $("#quitModalTransfer");
      const quitModalDeleteBtn = $("#quitModalDelete");
      const quitModalCancelBtn = $("#quitModalCancel");
      const joinNameInput = $("#joinName");
      const joinCodeInput = $("#joinCode");
      const joinStatus = $("#joinStatus");
      const joinSpaceBtn = $("#joinSpaceBtn");
      const spaceAccessCodeEl = $("#spaceAccessCode");
      const regenerateSpaceCodeBtn = $("#regenerateSpaceCodeBtn");
      const habitBackBtn = mHabit?.querySelector('.menu-back');
      const closeHabitBtn = $("#closeHabit");
      let habitModalContext = 'menu';
      let autoOpenedHabitModalForEmptySpace = false;
      let lastRenderedSpaceId = null;
      const open = m => m.classList.add('on'), close = m => m.classList.remove('on');
      let skipMenuAutoOpen = false;
      let menuAutoOpenSuppressed = false;
      let habitWizardStep = 1;
      const mPrefs = $("#modalPrefs");
      const prefsNotesSelect = $("#prefsNotesDisplayMode");
      const prefsEditSelect = $("#prefsEditButtonMode");
      const closePrefsBtn = $("#closePrefs");
      function updateHabitModalControls() {
        const hasHabits = (getSpace()?.ch?.length || 0) > 0;
        if (habitBackBtn) {
          habitBackBtn.classList.toggle('hide', habitModalContext !== 'creation');
        }
        if (closeHabitBtn) {
          closeHabitBtn.classList.toggle('hide', !hasHabits);
          closeHabitBtn.disabled = !hasHabits;
        }
      }
      function openHabitFlow(context = 'menu') {
        habitModalContext = context;
        updateHabitModalControls();
        step1();
        open(mHabit);
      }
      function maybePromptAddHabitsForEmptySpace() {
        if (!spaceId) return;
        if (autoOpenedHabitModalForEmptySpace) return;
        if (mHabit?.classList.contains('on')) return;
        openHabitFlow('menu');
        autoOpenedHabitModalForEmptySpace = true;
      }
      spaceAccessCodeEl?.addEventListener('click', () => {
        if (!spaceAccessCodeEl.value) return;
        spaceAccessCodeEl.select();
        copyText(spaceAccessCodeEl.value);
      });
      regenerateSpaceCodeBtn?.addEventListener('click', async () => {
        if (!spaceId || !spaceAccessCodeEl) return;
        if (!isCurrentSpaceAdmin()) {
          showToast('Seul le cr√©ateur peut r√©g√©n√©rer le code.', { type: 'error' });
          return;
        }
        const newCode = generateSpaceAccessCode();
        SPACES[spaceId].code = newCode;
        await persistSpaceDoc(spaceId, { code: newCode });
        spaceAccessCodeEl.value = newCode;
        showToast('Code d‚Äôacc√®s r√©g√©n√©r√©.', { type: 'success' });
      });
      $("#addBtn").onclick = () => { maybeTogglePrivateAdd(true); };
      $("#closeAdd").onclick = () => {
        if (allowedSpaces.length === 0) return;
        pendingAddModalTarget = null;
        menuAutoOpenSuppressed = true;
        close(mAdd);
      };
      async function maybeTogglePrivateAdd(forceOpen = false) {
        if (currentProfile?.email && !currentProfile?.guest) {
          await refreshOwnedSpaces(normalizeEmail(currentProfile.email));
        }
        const locked = allowedSpaces.length === 0;
        const shouldOpen = (locked && !skipMenuAutoOpen && !menuAutoOpenSuppressed) || forceOpen;
        if (shouldOpen) {
          open(mAdd);
        }
        if (!locked) {
          menuAutoOpenSuppressed = false;
        }
        updateAddModalOptions();
      }
      document.querySelectorAll('.menu-back').forEach(btn => {
        btn.addEventListener('click', () => {
          const modal = btn.closest('.modal');
          if (modal === mHabit) {
            if (habitWizardStep === 2) {
              step1();
              return;
            }
            if (habitModalContext === 'creation') {
              close(mHabit);
              open(mGarden);
              return;
            }
          }
          if (modal) close(modal);
          maybeTogglePrivateAdd(true);
        });
      });
      function showQuitModal() {
        const sp = getSpace();
        if (!sp) return;
        const isOwner = isCurrentSpaceAdmin();
        const candidates = getTransferCandidates();
        const hasCandidates = candidates.length > 0;
        if (quitModalText) {
          if (isOwner && hasCandidates) {
            quitModalText.textContent = 'Transf√®re la propri√©t√© ou supprime le jardin.';
          } else if (isOwner) {
            quitModalText.textContent = 'Supprimer ce jardin fermera l‚Äôespace pour tout le monde.';
          } else {
            quitModalText.textContent = 'Quitter le jardin supprime tes activit√©s personnelles.';
          }
        }
        if (quitModalTransferBtn) {
          quitModalTransferBtn.classList.toggle('hide', !(isOwner && hasCandidates));
        }
        if (quitModalDeleteBtn) {
          const action = (isOwner && !hasCandidates) ? 'delete' : (isOwner && hasCandidates ? 'delete' : 'leave');
          quitModalDeleteBtn.dataset.action = action;
          quitModalDeleteBtn.textContent = isOwner ? 'Supprimer le jardin' : 'Supprimer ma participation';
        }
        open(mQuit);
      }
      quitModalCancelBtn?.addEventListener('click', () => close(mQuit));
      quitModalTransferBtn?.addEventListener('click', () => {
        close(mQuit);
        openTransferModal();
      });
      quitModalDeleteBtn?.addEventListener('click', async () => {
        close(mQuit);
        if (quitModalDeleteBtn.dataset.action === 'leave') {
          await leaveCurrentSpace();
        } else {
          await deleteCurrentSpace();
        }
      });
      $("#addHabit").onclick = () => { close(mAdd); openHabitFlow('menu'); }
      $("#inviteFriend").onclick = () => {
        if (!requireAdmin('inviter un jardinier')) return;
        close(mAdd);
        openInvite();
      };
      function openInvite() { updateSpaceAccessCodeDisplay(); renderInviteList(); open(mInvite) }
      function openJoinModal() {
        setJoinStatus('', false);
        const defaultName = pendingInviteInfo?.invitedName || currentProfile?.name || userName || 'Moi';
        if (joinNameInput) joinNameInput.value = defaultName;
        if (joinCodeInput) joinCodeInput.value = '';
        setJoinDescription('');
        lastPreviewedCode = '';
        open(mJoin);
      }
      function openUserPreferences() {
        const sp = getSpace();
        if (!sp || !mPrefs) return;
        if (prefsNotesSelect) {
          prefsNotesSelect.value = sp.notesDisplayMode || 'dynamic';
        }
        if (prefsEditSelect) {
          prefsEditSelect.value = sp.editButtonMode || 'dynamic';
        }
        open(mPrefs);
      }
      prefsNotesSelect?.addEventListener('change', async () => {
        if (!spaceId) return;
        const mode = prefsNotesSelect.value || 'dynamic';
        const current = getSpace();
        if (current) current.notesDisplayMode = mode;
        await persistSpaceDoc(spaceId, { notesDisplayMode: mode });
        renderCards();
      });
      prefsEditSelect?.addEventListener('change', async () => {
        if (!spaceId) return;
        const mode = prefsEditSelect.value || 'dynamic';
        const current = getSpace();
        if (current) current.editButtonMode = mode;
        await persistSpaceDoc(spaceId, { editButtonMode: mode });
        renderCards();
      });
      closePrefsBtn?.addEventListener('click', () => close(mPrefs));
      function setJoinStatus(message, isError = true) {
        if (!joinStatus) return;
        joinStatus.textContent = message;
        joinStatus.style.color = isError ? '#d33' : '#2a7a57';
      }
      function setJoinDescription(text) {
        if (!joinSpaceDesc) return;
        joinSpaceDesc.textContent = text || '';
      }
      let lastPreviewedCode = '';
      async function previewJoinSpace(code) {
        if (!code || code.length < 6) {
          setJoinDescription('');
          return;
        }
        lastPreviewedCode = code;
        const data = await findSpaceByAccessCode(code);
        if (lastPreviewedCode !== code) return;
        setJoinDescription((data?.desc || data?.description || '').trim());
      }
      function updateSpaceAccessCodeDisplay() {
        if (!spaceAccessCodeEl) return;
        const current = spaceId;
        const code = SPACES[current]?.code;
        if (regenerateSpaceCodeBtn) {
          regenerateSpaceCodeBtn.disabled = !isCurrentSpaceAdmin();
        }
        if (code) {
          spaceAccessCodeEl.value = formatAccessCode(code);
          return;
        }
        spaceAccessCodeEl.value = '‚Äî';
        if (!current) return;
        ensureSpaceHasCode(current).then(newCode => {
          if (newCode && spaceId === current) {
            spaceAccessCodeEl.value = formatAccessCode(newCode);
          }
        });
      }
      let pendingAddModalTarget = null;
      const finishPendingAddModal = (target) => {
        if (pendingAddModalTarget !== target) return;
        pendingAddModalTarget = null;
        if (target === 'join') {
          openJoinModal();
        } else if (target === 'create') {
          openGardenFlow();
        }
      };
      const requestAddModalTransition = (target) => {
        pendingAddModalTarget = target;
        close(mAdd);
        setTimeout(() => finishPendingAddModal(target), 20);
      };
      const addModal = $("#modalAdd");
      addModal?.addEventListener('click', async (event) => {
        const opt = event.target.closest('.opt');
        if (!opt || opt.dataset.disabled === '1') return;
        pendingAddModalTarget = null;
        if (opt.id === 'menuLogin') {
          close(mAdd);
          showAuthOverlay(true);
          return;
        }
        if (opt.id === 'menuLogout') {
          if (!currentProfile?.email) return;
          await HABITU_FIREBASE_AUTH.signOut();
          close(mAdd);
          return;
        }
        if (opt.id === 'createGarden') {
          requestAddModalTransition('create');
          return;
        }
        if (opt.id === 'joinGarden') {
          requestAddModalTransition('join');
        }
        if (opt.id === 'menuPrefs') {
          close(mAdd);
          openUserPreferences();
          return;
        }
      });
      const gardenNameInput = $("#gardenNameInput");
      const gardenModeSelect = $("#gardenModeSelect");
      const gardenModeHint = $("#gardenModeHint");
      const createGardenBtn = $("#createGardenBtn");
      const gardenStatus = $("#gardenStatus");
      const authMessage = $("#authMessage");
      const inviteName = $("#inviteName");
      const inviteList = $("#inviteList");
      const authSpaceDesc = $("#authSpaceDesc");
      const joinSpaceDesc = $("#joinSpaceDesc");
      const installAppOpt = $("#installApp");
      const menuAddHabit = $("#addHabit");
      const menuInviteFriend = $("#inviteFriend");
      const menuCreateGarden = $("#createGarden");
      const menuLoginOpt = $("#menuLogin");
      const menuPrefsOpt = $("#menuPrefs");
      const menuLogoutOpt = $("#menuLogout");
      function updateAddModalOptions() {
        const hasSpaces = allowedSpaces.length > 0;
        const isAuthenticated = !!currentProfile?.email;
        const ownedCount = countOwnedGardens(currentProfile?.email);
        const showSupportOptions = hasSpaces;
        if (menuCreateGarden) {
          const subtitle = menuCreateGarden.querySelector('.subtitle');
          if (subtitle) {
            subtitle.textContent = 'Nouvel espace partag√©';
          }
        }
        if (menuAddHabit) {
          menuAddHabit.classList.toggle('hide', !showSupportOptions);
        }
        if (menuInviteFriend) {
          menuInviteFriend.classList.toggle('hide', !showSupportOptions);
        }
        if (menuLoginOpt) {
          menuLoginOpt.classList.toggle('hide', isAuthenticated);
        }
        if (menuPrefsOpt) {
          menuPrefsOpt.classList.toggle('hide', !hasSpaces);
        }
        if (menuLogoutOpt) {
          menuLogoutOpt.classList.toggle('hide', !isAuthenticated);
        }
        const locked = !hasSpaces;
        document.body.classList.toggle('no-space', locked);
        const closeAddBtnLocal = $("#closeAdd");
        if (closeAddBtnLocal) {
          closeAddBtnLocal.classList.toggle('hide', locked);
        }
        const menuModal = $("#modalAdd");
        if (locked && menuModal && !menuModal.classList.contains('on')) {
          open(mAdd);
        }
      }
      const installPromptBtn = $("#installPromptBtn");
      const installPromptClose = $("#installPromptClose");
      const installPromptHelp = $("#installPromptHelp");
      const generateInviteBtn = $("#generateInvite");
      const habitModeToggle = $("#modeToggle");
      const habitModeButtons = habitModeToggle ? Array.from(habitModeToggle.querySelectorAll('.mode-option')) : [];
      const confirmTransferBtn = $("#confirmTransferBtn");
      const transferStatus = $("#transferStatus");
      const transferSpaceBtn = $("#transferSpaceBtn");
      const deleteSpaceBtn = $("#deleteSpaceBtn");
      createGardenBtn.onclick = createGarden;
      joinCodeInput?.addEventListener('input', () => {
        if (!joinCodeInput) return;
        const normalized = normalizeAccessCode(joinCodeInput.value);
        const formatted = formatAccessCode(normalized);
        if (joinCodeInput.value !== formatted) {
          joinCodeInput.value = formatted;
        }
        if (normalized.length === 6) {
          previewJoinSpace(normalized);
        } else {
          setJoinDescription('');
        }
      });
      joinSpaceBtn?.addEventListener('click', joinGardenByCode);
      generateInviteBtn.onclick = generateInviteLink;
      transferSpaceBtn?.addEventListener('click', () => openTransferModal());
      deleteSpaceBtn?.addEventListener('click', () => deleteCurrentSpace());
      confirmTransferBtn?.addEventListener('click', async () => {
        if (!spaceId) return;
        const select = $("#transferOwnerSelect");
        if (!select || !select.value) {
          if (transferStatus) transferStatus.textContent = 'Choisis un jardinier.';
          return;
        }
        await updateSpaceOwner(spaceId, select.value);
        if (transferStatus) transferStatus.textContent = 'Propri√©t√© transf√©r√©e !';
        close(mTransfer);
      });
      $("#closeTransfer").onclick = () => close(mTransfer);
      installAppOpt?.addEventListener('click', () => {
        close(mAdd);
        triggerInstallPrompt('manual');
      });
      installPromptBtn?.addEventListener('click', () => triggerInstallPrompt('manual'));
      installPromptClose?.addEventListener('click', () => {
        markInstallPromptSeen();
        closeInstallPromptCard();
      });
      installPromptHelp?.addEventListener('click', () => {
        showToast('Installer donne un acc√®s rapide sur ton √©cran d‚Äôaccueil.', { type: 'info', duration: 5000 });
      });
      updateInstallOptionVisibility();

      function updateGardenModeHint() {
        if (!gardenModeHint || !gardenModeSelect) return;
        if (gardenModeSelect.value === 'day') {
          gardenModeHint.textContent = "Des routines diff√©rentes chaque jour";
        } else {
          gardenModeHint.textContent = "5 √† 30 routines √† organiser librement sur la semaine.";
        }
      }
      gardenModeSelect?.addEventListener('change', () => {
        updateGardenModeHint();
        syncGardenModeButtons();
      });

      function syncGardenModeButtons() {
        const container = $("#gardenModeButtons");
        if (!container || !gardenModeSelect) return;
        const buttons = Array.from(container.querySelectorAll('.org-mode-btn'));
        buttons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.mode === gardenModeSelect.value);
          if (!btn.dataset.bound) {
            btn.dataset.bound = '1';
            btn.addEventListener('click', () => {
              const mode = btn.dataset.mode || 'week';
              gardenModeSelect.value = mode;
              buttons.forEach(b => b.classList.toggle('active', b === btn));
              updateGardenModeHint();
            });
          }
        });
      }

      function updateSpaceOrgButtons() {
        const container = $("#spaceOrgButtons");
        const select = $("#spaceOrgMode");
        if (!container || !select) return;
        container.querySelectorAll('.org-mode-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.mode === select.value);
        });
      }

      function updateAuthMessage() {
        if (pendingInviteInfo) {
          const spaceName = pendingInviteInfo.gardenLabel || pendingInviteInfo.label || 'ton jardin';
          const ownerName = pendingInviteInfo.ownerName || pendingInviteInfo.ownerEmail || 'un jardinier';
          authMessage.textContent = `Connecte-toi pour retrouver le jardin "${spaceName}" de ${ownerName}.`;
          if (authSpaceDesc) {
            authSpaceDesc.textContent = (pendingInviteInfo.spaceDesc || '').trim();
          }
        } else {
          authMessage.textContent = 'Connecte-toi pour retrouver tes habitudes';
          if (authSpaceDesc) {
            authSpaceDesc.textContent = '';
          }
        }
        updateAuthFormState();
      }
      refreshPendingInviteInfo().then(updateAuthMessage);

      function syncHabitModeButtons(mode, disabled = false) {
        habitModeButtons.forEach(btn => {
          const isActive = mode && btn.dataset.mode === mode;
          btn.classList.toggle('active', isActive);
          btn.disabled = disabled;
        });
      }
      habitModeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          if (!activeId || !isCurrentSpaceAdmin()) return;
          const mode = btn.dataset.mode;
          HABIT_MODE[activeId] = { type: mode, n: 2 };
          renderCards();
          syncHabitModeButtons(mode);
        });
      });

      function openGardenFlow() {
        gardenModeSelect.value = 'week';
        gardenNameInput.value = '';
        gardenStatus.textContent = '';
        updateGardenModeHint();
        syncGardenModeButtons();
        open(mGarden);
      }

      async function createGarden() {
        if (!currentProfile) {
          persistProfile({ name: userName || 'Moi', guest: true });
        }
        if (!currentProfile?.guest) {
          const normalizedEmail = normalizeEmail(currentProfile?.email);
          await refreshOwnedSpaces(normalizedEmail);
        }
        const profile = GARDEN_TYPES[0];
        const title = (gardenNameInput.value || profile.label).trim() || profile.label;
        const mode = gardenModeSelect.value || profile.orgMode;
        const accessCode = generateSpaceAccessCode();
        const id = generateSpaceId();
        const ownerEmail = normalizeEmail(currentProfile?.email || '');
        SPACES[id] = {
          emoji: profile.emoji,
          label: title,
          type: profile.type,
          orgMode: mode,
          code: accessCode,
          ch: [],
          ownerEmail,
          members: [ownerEmail],
          createdAt: new Date(),
          editButton: true,
          editorRights: 'admin',
          editButtonMode: 'dynamic',
          notesDisplayMode: 'dynamic'
        };
        spaceId = id;
        userName = currentProfile.name;
        allowedSpaces = [...new Set([...allowedSpaces, id])];
        if (currentProfile?.guest) {
          addGuestSpace(id);
        }
        pendingSpaceCreation = {
          spaceId: id,
          payload: {
            createdBy: currentProfile?.email || null,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            editButton: true,
            editButtonMode: 'dynamic',
            notesDisplayMode: 'dynamic'
          }
        };
        gardenStatus.textContent = 'Ajoute quelques habitudes pour d√©marrer ton jardin.';
        updSel();
        renderCards();
        close(mGarden);
        openHabitFlow('creation');
      }
      async function finalizePendingSpaceCreation() {
        if (!pendingSpaceCreation) return;
        const { spaceId: pendingId, payload } = pendingSpaceCreation;
        pendingSpaceCreation = null;
        try {
          await persistSpaceDoc(pendingId, payload);
          await loadActivitiesForSpace(pendingId);
        } catch (err) {
          console.warn('finalizePendingSpaceCreation', err);
        }
      }

      function renderInviteList() {
        inviteList.innerHTML = '';
        const entries = Object.values(INVITE_CACHE).sort((a, b) => (b.created || 0) - (a.created || 0));
        if (!entries.length) {
          const help = document.createElement('div');
          help.className = 'miniInfo';
          help.textContent = 'Aucune invitation active pour l‚Äôinstant.';
          inviteList.appendChild(help);
          return;
        }
        entries.forEach((invite) => {
          const token = invite.token;
          const row = document.createElement('div');
          row.className = 'invite-row';
          const nameEl = document.createElement('div');
          nameEl.className = 'invite-name';
          nameEl.textContent = invite.invitedName;
          const link = `${inviteBaseUrl()}?invite=${token}`;
          const linkWrapper = document.createElement('div');
          linkWrapper.className = 'invite-link-row';
          const icon = document.createElement('span');
          icon.textContent = 'üîó';
          icon.style.userSelect = 'none';
          icon.style.cursor = 'pointer';
          const linkInput = document.createElement('input');
          linkInput.type = 'text';
          linkInput.value = link;
          linkInput.readOnly = true;
          linkInput.className = 'invite-link-input';
          linkInput.addEventListener('click', () => {
            linkInput.select();
            copyText(link);
          });
          linkInput.addEventListener('focus', () => linkInput.select());
          icon.addEventListener('click', () => {
            linkInput.select();
            copyText(link);
          });
          const removeBtn = document.createElement('button');
          removeBtn.className = 'btn copyOnly';
          removeBtn.title = 'Supprimer';
          removeBtn.textContent = 'üóëÔ∏è';
          removeBtn.onclick = async () => {
            await deleteInviteDoc(token);
            renderInviteList();
            showToast('Invitation supprim√©e.', { type: 'info' });
          };
          linkWrapper.append(icon, linkInput, removeBtn);
          row.append(nameEl, linkWrapper);
          inviteList.appendChild(row);
        });
      }

      async function generateInviteLink() {
        if (!requireAdmin('g√©n√©rer une invitation')) return;
        const name = (inviteName.value || '').trim();
        if (!name) { showToast('Entre un pr√©nom.', { type: 'error' }); return; }
        if (!spaceId) { showToast('S√©lectionne d‚Äôabord un jardin.', { type: 'error' }); return; }
        if (Object.values(INVITE_CACHE).some(inv => (inv.invitedName || '').toLowerCase() === name.toLowerCase())) {
          showToast('Ce pr√©nom est d√©j√† utilis√© pour une invitation.', { type: 'error' });
          return;
        }
        await ensureSpaceHasCode(spaceId);
        const token = genInviteToken();
        const link = `${inviteBaseUrl()}?invite=${token}`;
        const ownerName = currentProfile?.name || userName || 'Un jardinier';
        const inviteData = {
          ownerName,
          invitedName: name,
          spaceId,
          spaceCode: SPACES[spaceId]?.code || '',
          spaceDesc: (SPACES[spaceId]?.desc || '').trim(),
          gardenLabel: SPACES[spaceId]?.label || 'ton jardin',
          created: Date.now(),
          ownerEmail: currentProfile?.email
        };
        await persistInviteDoc(token, inviteData);
        INVITE_CACHE[token] = { token, ...inviteData };
        showToast('Lien g√©n√©r√© !', { type: 'success' });
        renderInviteList();
        copyText(link);
      }

      async function findSpaceByAccessCode(code) {
        if (!HABITU_FIREBASE_DB || !code) return null;
        try {
          const normalizedCode = code.toUpperCase();
          const snapshot = await HABITU_FIREBASE_DB.collection('spaces')
            .where('code', '==', normalizedCode)
            .limit(1)
            .get();
          if (snapshot.empty) return null;
          const doc = snapshot.docs[0];
          const raw = doc.data() || {};
          const members = Array.isArray(raw.members) ? raw.members : [];
          return { id: doc.id, ...raw, members, code: normalizedCode };
        } catch (err) {
          console.warn('findSpaceByAccessCode', err);
          return null;
        }
      }

      async function joinGardenByCode() {
        if (!joinSpaceBtn) return;
        const name = (joinNameInput?.value || '').trim();
        if (!name) { setJoinStatus('Entre ton pr√©nom.', true); return; }
        const code = normalizeAccessCode(joinCodeInput?.value || '');
        if (code.length !== 6) { setJoinStatus('Code invalide (6 caract√®res).', true); return; }
        joinSpaceBtn.disabled = true;
        try {
          const spaceData = await findSpaceByAccessCode(code);
          if (!spaceData) { setJoinStatus('Aucun jardin ne correspond √† ce code.', true); return; }
          if (allowedSpaces.includes(spaceData.id)) { setJoinStatus('Tu fais d√©j√† partie de ce jardin.', true); return; }
          SPACES[spaceData.id] = { ...(SPACES[spaceData.id] || {}), ...spaceData, members: spaceData.members || [] };
          if (currentProfile?.email) {
            await joinSpace(spaceData.id, currentProfile.email);
          } else {
            addGuestSpace(spaceData.id);
          }
          allowedSpaces = [...new Set([...allowedSpaces, spaceData.id])];
          spaceId = spaceData.id;
          await Promise.all([loadHabitsForSpace(spaceId), loadActivitiesForSpace(spaceId)]);
          await ensureSpaceHasCode(spaceId);
          updateSpaceAccessCodeDisplay();
          updAll();
          showHome();
          setJoinStatus('Jardin rejoint !', false);
          setJoinDescription((spaceData.desc || spaceData.description || '').trim());
          close(mJoin);
        } catch (err) {
          console.warn('joinGardenByCode', err);
          setJoinStatus('Impossible de rejoindre ce jardin pour l‚Äôinstant.', true);
        } finally {
          joinSpaceBtn.disabled = false;
        }
      }

      function copyText(value) {
        if (!value) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(value).then(() => {
            showToast('Lien copi√© !', { type: 'success' });
          }).catch(() => {
            showToast('Copie manuelle : s√©lectionne et copie.', { type: 'error' });
          });
        } else {
          showToast('Copie manuelle : s√©lectionne et copie.', { type: 'error' });
        }
      }

      renderInviteList();

      /* Wizard biblioth√®que multi-s√©lection */
      function matchesHabitContext(habit, contextTags) {
        if (!contextTags || !contextTags.length) return true;
        return (habit.contexts || []).some(ctx => contextTags.includes(ctx));
      }
      function matchesHabitMode(habit, modeKey) {
        if (!modeKey) return true;
        const modeInfo = MODE_META[modeKey];
        if (!modeInfo) return true;
        const habitTarget = (habit.target || 'group').toString().toLowerCase();
        return habitTarget === (modeInfo.target || 'group').toLowerCase();
      }
      function countMatchingHabits(contextTags, modeKey) {
        return LIBRARY_HABITS.filter(habit => matchesHabitContext(habit, contextTags) && matchesHabitMode(habit, modeKey)).length;
      }
      function countPreselectedHabits(contextTags, needTags, modeKey) {
        if (!needTags || !needTags.length) return 0;
        return LIBRARY_HABITS.filter(habit =>
          matchesHabitContext(habit, contextTags) &&
          matchesHabitMode(habit, modeKey) &&
          (habit.needs || []).some(need => needTags.includes(need))
        ).length;
      }
      function step1() {
        const root = $("#step1");
        const step2 = $("#step2");
        $("#habitTitle").textContent = "Nouvelle(s) habitude(s)";
        if (step2) step2.style.display = 'none';
        if (!root) return;
        root.style.display = 'grid';
        root.innerHTML = '';

        habitWizardStep = 1;
        if (!LIBRARY_HABITS.length) {
          const empty = document.createElement('div');
          empty.className = 'miniInfo';
          empty.textContent = "La biblioth√®que d'habitudes est momentan√©ment indisponible.";
          root.appendChild(empty);
          return;
        }

        const actions = document.createElement('div');
        actions.className = 'habit-actions';
        const nextBtn = document.createElement('button');
        nextBtn.type = 'button';
        nextBtn.className = 'btn primary';
        nextBtn.textContent = 'Voir les 0 sur 0 habitudes';

        const modeSection = document.createElement('div');
        modeSection.className = 'tag-section';
        const modeLabelEl = document.createElement('label');
        modeLabelEl.innerHTML = `<b>Qui ?</b>`;
        const modeGrid = document.createElement('div');
        modeGrid.className = 'tag-grid';
        modeSection.append(modeLabelEl, modeGrid);
        let selectedMode = 'libre';
        const modeButtons = {};
        const setMode = (value) => {
          if (selectedMode === value) {
            selectedMode = null;
          } else {
            selectedMode = value;
          }
          Object.entries(modeButtons).forEach(([key, btn]) => {
            btn.classList.toggle('active', key === selectedMode);
          });
          updateNextLabel();
        };
        Object.entries(MODE_META).forEach(([key, info]) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'tag';
          btn.textContent = info.shortLabel || `${info.emoji} ${info.label}`;
          btn.addEventListener('click', () => setMode(key));
          modeButtons[key] = btn;
          modeGrid.appendChild(btn);
        });

        let contextSection;
        let needSection;
        function updateNextLabel() {
          const ctxCount = contextSection?.selected.length || 0;
          const needCount = needSection?.selected.length || 0;
          const totalMatching = countMatchingHabits(contextSection?.selected || [], selectedMode);
          const preselected = countPreselectedHabits(contextSection?.selected || [], needSection?.selected || [], selectedMode);
          nextBtn.textContent = `Voir les ${preselected} sur ${totalMatching} habitudes`;
        }

        contextSection = buildTagSection('O√π ?', LIBRARY_CONTEXTS, updateNextLabel, 'context');
        needSection = buildTagSection('Pourquoi ?', LIBRARY_NEEDS, updateNextLabel, 'need');
        setMode(selectedMode);

        nextBtn.addEventListener('click', () => {
          renderHabitSuggestions([...contextSection.selected], [...needSection.selected], selectedMode);
        });

        actions.appendChild(nextBtn);
        root.appendChild(modeSection);
        root.appendChild(contextSection.container);
        root.appendChild(needSection.container);
        root.appendChild(actions);
        updateNextLabel();
      }

      function buildTagSection(title, tags, onUpdate, type) {
        const container = document.createElement('div');
        container.className = 'tag-section';
        const titleRow = document.createElement('div');
        titleRow.className = 'field';
        const labelEl = document.createElement('label');
        labelEl.innerHTML = `<b>${title}</b>`;
        titleRow.appendChild(labelEl);
        container.appendChild(titleRow);

        if (!tags.length) {
          const empty = document.createElement('div');
          empty.className = 'miniInfo';
          empty.textContent = `Aucune suggestion de ${title.toLowerCase()} pour l'instant.`;
          container.appendChild(empty);
          return { container, selected: [] };
        }

        const grid = document.createElement('div');
        grid.className = 'tag-grid';
        container.appendChild(grid);

        const selected = [];
        tags.forEach(tag => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'tag';
          btn.textContent = formatTagLabel(tag, type);
          btn.addEventListener('click', () => {
            const idx = selected.indexOf(tag);
            if (idx >= 0) {
              selected.splice(idx, 1);
              btn.classList.remove('active');
              if (typeof onUpdate === 'function') onUpdate();
              return;
            }
            selected.push(tag);
            btn.classList.add('active');
            if (typeof onUpdate === 'function') onUpdate();
          });
          grid.appendChild(btn);
        });

        return { container, selected };
      }

      function renderHabitSuggestions(contextTags, needTags, modeFilter = null) {
        const step1El = $("#step1");
        const root = $("#step2");
        if (!root) return;
        $("#habitTitle").textContent = "Habitudes sugg√©r√©es";
        if (step1El) step1El.style.display = 'none';
        root.style.display = 'grid';
        root.innerHTML = '';
        habitWizardStep = 2;

        const modeInfo = modeFilter ? MODE_META[modeFilter] : null;
        const matchingHabits = LIBRARY_HABITS
          .filter(habit => matchesHabitContext(habit, contextTags))
          .filter(habit => matchesHabitMode(habit, modeFilter))
          .sort((a, b) => (a.title || '').localeCompare(b.title || '', 'fr'));
        const grid = document.createElement('div');
        grid.className = 'habit-grid';
        const selection = new Set();
        matchingHabits.forEach(habit => {
          const matchesNeed = (habit.needs || []).some(need => needTags.includes(need));
          if (matchesNeed) selection.add(habit.id);
        });
        const suggestionMap = new Map(matchingHabits.map(habit => [habit.id, habit]));
        let addBtn;
        let infoLabel = null;
        const updateAddLabel = () => {
          if (!addBtn) return;
          if (infoLabel) {
            infoLabel.textContent = `${selection.size} habitude${selection.size > 1 ? 's' : ''}`;
          }
          addBtn.textContent = `Ajouter ${selection.size}`;
          addBtn.disabled = selection.size === 0;
        };

        if (!matchingHabits.length) {
          const info = document.createElement('div');
          info.className = 'miniInfo';
          info.textContent = "Aucune habitude ne correspond aux contextes s√©lectionn√©s.";
          root.appendChild(info);
        } else {
          matchingHabits.forEach(habit => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'habit-btn';
            btn.dataset.id = habit.id;
            if (selection.has(habit.id)) {
              btn.classList.add('selected');
            }
            btn.innerHTML = `<span class="emoji">${habit.emoji || 'üå±'}</span><span class="label">${habit.title}</span>`;
            btn.addEventListener('click', () => {
              const active = btn.classList.toggle('selected');
              if (active) selection.add(habit.id);
              else selection.delete(habit.id);
              updateAddLabel();
            });
            grid.appendChild(btn);
          });
          root.appendChild(grid);
          addBtn = document.createElement('button');
          addBtn.type = 'button';
          addBtn.className = 'btn primary';
          addBtn.textContent = 'Cr√©er le jardin';
          infoLabel = document.createElement('div');
          infoLabel.className = 'habit-actions__info';
          infoLabel.textContent = '0 habitudes';
          addBtn.addEventListener('click', async () => {
            if (!selection.size) return;
            const sp = getSpace();
            const persistPromises = [];
            selection.forEach(hid => {
              if (!sp) return;
              if ((sp.ch || []).some(x => x.id === hid)) return;
              const habitSource = suggestionMap.get(hid) || LIBRARY_HABITS.find(x => x.id === hid);
              if (!habitSource) return;
              const payload = buildHabitPayload(sp, habitSource);
              (sp.ch || (sp.ch = [])).push(payload);
              ensureHabit(hid);
              persistPromises.push(persistHabit(spaceId, payload));
            });
            if (persistPromises.length) {
              await Promise.all(persistPromises);
            }
            if (pendingSpaceCreation?.spaceId === spaceId) {
              await finalizePendingSpaceCreation();
            }
            close(mHabit);
            renderCards();
          });
          updateAddLabel();
          const controls = document.createElement('div');
          controls.className = 'habit-actions footer-sticky';
          controls.appendChild(infoLabel);
          controls.appendChild(addBtn);
          root.appendChild(controls);
        }

        if (addBtn) {
          const controls = document.createElement('div');
          controls.className = 'habit-actions footer-sticky';
          controls.appendChild(addBtn);
          root.appendChild(controls);
        }
      }

      closeHabitBtn?.addEventListener('click', () => {
        if ((getSpace()?.ch?.length || 0) === 0) return;
        close(mHabit);
      });
      $("#closeInvite").onclick = () => close(mInvite);
      $("#closeQuit").onclick = () => close(mQuit);

      /* Jour +/- */
      $("#prevDay").onclick = () => { dayOff = clampDayOff(dayOff + (isWeekMode() ? -7 : -1)); renderCards(); renderDateBar(); };
      $("#nextDay").onclick = () => { dayOff = clampDayOff(dayOff + (isWeekMode() ? 7 : 1)); renderCards(); renderDateBar(); };

      /* Lancement */
      function renderCalendarAndKeepMonth() { renderCalendar() }
      let dayInit = false; function renderDateOnce() { if (!dayInit) { dayOff = 0; renderDateBar(); dayInit = true } }
      function updAll() { renderCards(); renderCalendarAndKeepMonth(); renderDateOnce(); updSel(); maybeTogglePrivateAdd(); updSpaceHeader() }
      const loaderOverlay = $("#loaderOverlay");
      const loaderEmojiEl = $("#loaderEmoji");
      const authOverlay = $("#authOverlay");
      const brand = $("#brand");
      const forgotPasswordLink = $("#forgotPasswordLink");
      const authForm = $("#authForm");
      const authEmailInput = $("#authEmail");
      const authPasswordInput = $("#authPassword");
      const authLoginBtn = $("#authLoginBtn");
      const authSignupBtn = $("#authSignupBtn");
      const authGuestBtn = $("#authGuestBtn");
      const resetNotice = $("#resetNotice");
      const authError = $("#authError");
      const LOADER_EMOJIS = ['üå∞', 'üå±', 'üçÄ', 'üåº', 'üåª', 'üå∑', 'üåπ', 'ü™ª', 'üíê', 'üéã'];
      let loaderIndex = 0;
      let loaderTimer = null;
      authLoginBtn?.addEventListener('click', () => { if (authForm) authForm.dataset.intent = 'login'; });
      authSignupBtn?.addEventListener('click', () => { if (authForm) authForm.dataset.intent = 'signup'; });
      authGuestBtn?.addEventListener('click', () => startGuestSession());
      authForm?.addEventListener('submit', handleAuthSubmit);
      updateAuthFormState();
      updateAuthMessage();
      showLoaderOverlay();

      brand?.addEventListener('click', () => {
        dayOff = 0;
        showHome();
        renderCards();
        renderDateBar();
      });

      function clearResetNotice() {
        if (resetNotice) resetNotice.textContent = '';
      }

      function isEmailValid(input) {
        if (!input) return false;
        return input.checkValidity();
      }

      function updateAuthFormState() {
        const forceSignup = !!pendingInviteInfo;
        if (authLoginBtn) {
          authLoginBtn.disabled = forceSignup;
          authLoginBtn.title = forceSignup ? 'Tu dois cr√©er un compte pour accepter cette invitation.' : '';
        }
      }

      async function handleAuthSubmit(event) {
        if (!authForm) return;
        event.preventDefault();
        authError.textContent = '';
        clearResetNotice();
        const forceSignup = !!pendingInviteInfo;
        const submitterAction = event.submitter?.dataset?.action;
        const fallbackIntent = authForm.dataset.intent;
        const rawIntent = submitterAction || fallbackIntent || 'login';
        const intent = forceSignup ? 'signup' : rawIntent;
        authForm.dataset.intent = '';

        if (!authEmailInput || !isEmailValid(authEmailInput)) {
          authError.textContent = 'Entre un email valide.';
          return;
        }
        const email = (authEmailInput.value || '').trim().toLowerCase();
        const password = (authPasswordInput?.value || '').trim();
        if (!password) {
          authError.textContent = intent === 'signup' ? 'Choisis un mot de passe.' : 'Entre ton mot de passe.';
          return;
        }
        if (intent === 'signup') {
          try {
            await HABITU_FIREBASE_AUTH.createUserWithEmailAndPassword(email, password);
          } catch (err) {
            authError.textContent = err.message || 'Impossible de cr√©er le compte.';
          }
          return;
        }
        try {
          await HABITU_FIREBASE_AUTH.signInWithEmailAndPassword(email, password);
        } catch (err) {
          authError.textContent = 'Mot de passe erron√©.';
        }
      }

      function animateLoaderEmoji() {
        if (!loaderEmojiEl) return;
        loaderEmojiEl.textContent = LOADER_EMOJIS[loaderIndex];
        loaderIndex = (loaderIndex + 1) % LOADER_EMOJIS.length;
      }
      function startLoaderAnimation() {
        if (!loaderOverlay || loaderTimer) return;
        animateLoaderEmoji();
        loaderTimer = setInterval(animateLoaderEmoji, 200);
      }
      function stopLoaderAnimation() {
        if (loaderTimer) {
          clearInterval(loaderTimer);
          loaderTimer = null;
        }
      }
      function showLoaderOverlay() {
        if (!loaderOverlay) return;
        loaderOverlay.classList.remove('hide');
        startLoaderAnimation();
      }
      function hideLoaderOverlay() {
        if (!loaderOverlay) return;
        loaderOverlay.classList.add('hide');
        stopLoaderAnimation();
      }

      forgotPasswordLink?.addEventListener('click', async (e) => {
        e.preventDefault();
        if (!authEmailInput || !isEmailValid(authEmailInput)) {
          resetNotice.textContent = 'Entre un email valide.';
          return;
        }
        const email = (authEmailInput.value || '').trim().toLowerCase();
        try {
          await HABITU_FIREBASE_AUTH.sendPasswordResetEmail(email);
        } catch (err) {
          // Do not surface whether the account exists.
        } finally {
          resetNotice.textContent = 'Lien de r√©initialisation envoy√© !';
        }
      });

      function hideAuthOverlay() { authOverlay.classList.add('hide') }
      function showAuthOverlay(force = false) {
        hideLoaderOverlay();
        clearResetNotice();
        if (authError) authError.textContent = '';
        authOverlay.classList.remove('hide');
      }

      async function startGuestSession() {
        if (currentProfile?.guest && HABITU_FIREBASE_AUTH?.currentUser?.isAnonymous) {
          hideAuthOverlay();
          updateAddModalOptions();
          showLoaderOverlay();
          try {
            await ensureLibraryData();
          } finally {
            hideLoaderOverlay();
          }
          showHome();
          return;
        }
        try {
          await HABITU_FIREBASE_AUTH.signInAnonymously();
        } catch (err) {
          showToast('Impossible de d√©marrer une session invit√©.', { type: 'error' });
        }
      }

      async function linkGuestSpacesToEmail(email) {
        if (!email || guestSpaces.size === 0) return;
        const spaces = Array.from(guestSpaces);
        await Promise.all(spaces.map(id => joinSpace(id, email)));
        clearGuestSpaces();
      }

      async function ensureProfileName(defaultName = '') {
        const existing = (currentProfile?.name || '').trim();
        if (existing) return existing;
        const candidate = window.prompt('Quel est ton pr√©nom ?', defaultName || 'Moi');
        const finalName = (candidate || '').trim() || defaultName || 'Moi';
        if (!finalName) return null;
        const updated = { ...(currentProfile || {}), name: finalName };
        persistProfile(updated);
        if (HABITU_FIREBASE_AUTH.currentUser) {
          try {
            await HABITU_FIREBASE_AUTH.currentUser.updateProfile({ displayName: finalName });
          } catch (err) {
            console.warn('ensureProfileName updateProfile', err);
          }
        }
        if (updated.uid) {
          await persistUserProfile({ uid: updated.uid, email: updated.email, name: finalName });
        }
        return finalName;
      }

      HABITU_FIREBASE_AUTH.onAuthStateChanged(async user => {
        if (!user) {
          if (currentProfile?.guest) {
            hideLoaderOverlay();
            hideAuthOverlay();
            updateAddModalOptions();
            showLoaderOverlay();
            try {
              await ensureLibraryData();
            } finally {
              hideLoaderOverlay();
            }
            showHome();
            return;
          }
          persistProfile(null);
          clearLocalState();
          showAuthOverlay();
          clearResetNotice();
          updateAuthMessage();
          return;
        }
        const isGuest = user.isAnonymous;
        const email = (user.email || '').toLowerCase();
        const inviteName = pendingInviteInfo?.invitedName || '';
        const name = user.displayName || currentProfile?.name || inviteName || userName || 'Moi';
        persistProfile({ uid: user.uid, email, name, guest: isGuest });
        await persistUserProfile({ uid: user.uid, email, name });
        if (!isGuest) {
          await linkGuestSpacesToEmail(email);
          await acceptPendingInvite(email);
          hideAuthOverlay();
          showLoaderOverlay();
          try {
            await resetFirestoreState(email);
          } finally {
            hideLoaderOverlay();
          }
          await ensureProfileName(inviteName || name);
          userName = currentProfile?.name || name;
          updateAddModalOptions();
          if (allowedSpaces.length === 0) { openGardenFlow(); return; }
          updAll();
          showHome();
        } else {
          hideAuthOverlay();
          updateAddModalOptions();
          showLoaderOverlay();
          try {
            await ensureLibraryData();
          } finally {
            hideLoaderOverlay();
          }
          showHome();
        }
      });

      /* Tabs util */
      function switchViews(btn, groupAttr, prefix) {
        const key = btn.getAttribute(groupAttr);
        document.querySelectorAll(`.tabs [${groupAttr}]`).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll(`#${prefix} .view`).forEach(v => v.classList.remove('active'));
        const target = document.querySelector(`#${prefix} #${(groupAttr === 'data-tab' ? 'tab-' : '')}${key}`);
        if (target) target.classList.add('active');
        if (key === 'history') { populateCalWho?.(); renderCalendar?.() }
        if (key === 'shistory') { populateSpaceWho?.(); renderSpaceCalendar?.() }
      }
      document.querySelectorAll('#detail .tabs [data-tab]').forEach(btn => { btn.addEventListener('click', () => switchViews(btn, 'data-tab', 'detail')) });
      document.querySelectorAll('#space .tabs [data-stab]').forEach(btn => { btn.addEventListener('click', () => switchViews(btn, 'data-stab', 'space')) });
      let swRegistration = null;
      let updateRequestInProgress = false;
      async function ensureSwRegistration() {
        if (!('serviceWorker' in navigator)) return null;
        if (swRegistration) return swRegistration;
        try {
          swRegistration = await navigator.serviceWorker.ready;
          return swRegistration;
        } catch (err) {
          console.warn('ensureSwRegistration', err);
          return null;
        }
      }
      async function clearAppCaches() {
        if (!('caches' in window)) return;
        try {
          const keys = await caches.keys();
          await Promise.all(keys.map(key => caches.delete(key)));
        } catch (err) {
          console.warn('clearAppCaches', err);
        }
      }
      async function handleAppUpdateRequest({ auto = false } = {}) {
        if (updateRequestInProgress) {
          showToast('Une mise √† jour est d√©j√† en cours.', { type: 'info' });
          return;
        }
        if (!('serviceWorker' in navigator)) {
          showToast('Service worker indisponible.', { type: 'error' });
          return;
        }
        updateRequestInProgress = true;
        showToast(auto ? 'Recherche automatique des nouveaut√©s‚Ä¶' : 'V√©rification des nouveaut√©s‚Ä¶', { type: 'info', duration: 5000 });
        try {
          await clearAppCaches();
          const registration = await ensureSwRegistration();
          if (!registration) {
            showToast('Service worker introuvable.', { type: 'error' });
            return;
          }
          await registration.update();
          if (registration.waiting) {
            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
            showToast('Nouvelle version pr√™te, le navigateur recharge‚Ä¶', { type: 'success' });
          } else {
            showToast('L‚Äôapplication est d√©j√† √† jour.', { type: 'info' });
          }
        } catch (err) {
          console.warn('handleAppUpdateRequest', err);
          showToast('Impossible de v√©rifier les mises √† jour.', { type: 'error' });
        } finally {
          updateRequestInProgress = false;
        }
      }
      async function initAutoUpdater() {
        const registration = await ensureSwRegistration();
        if (!registration) return;
        registration.addEventListener('updatefound', () => handleAppUpdateRequest({ auto: true }));
        await handleAppUpdateRequest({ auto: true });
      }
      initAutoUpdater();
      if ('serviceWorker' in navigator) {
        const registerServiceWorker = async () => {
          try {
            const registration = await navigator.serviceWorker.register('/service-worker.js', { scope: './' });
            swRegistration = registration;
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              if (!newWorker) return;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  newWorker.postMessage({ type: 'SKIP_WAITING' });
                }
              });
            });
          } catch (err) {
            console.warn('SW registration failed', err);
          }
        };

        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (refreshing) return;
          refreshing = true;
          window.location.reload();
        });

        window.addEventListener('load', registerServiceWorker);
      }
    </script>
</body>

</html>