<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Habitu.be ‚Äî Prototype (drops v2)</title>
<style>
  :root{
    --bg:#f7f3ea; --card:#fffdf8; --text:#1e1f1a;
    --green:#2a7a57; --greenL:#8ec5a8; --border:#e6dfd2;
    --r:4px; --gap:8px; --shadow:0 1px 0 rgba(0,0,0,.03);
    --fs:13px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:400 var(--fs)/1.35 system-ui,-apple-system,Roboto,sans-serif; color:var(--text); background:var(--bg);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  #app{max-width:480px;margin:0 auto;min-height:100%;display:flex;flex-direction:column;position:relative}
  /* Heat background */
  .heat{position:fixed;left:0;right:0;bottom:0;height:0;background:linear-gradient(0deg,var(--greenL),transparent);opacity:.35;pointer-events:none;z-index:0}

  /* Top bar */
  .top{position:sticky; top:0; background:var(--bg); z-index:6; border-bottom:1px solid var(--border);
       padding:6px var(--gap); display:flex; align-items:center; gap:8px}
  .brand{font-weight:800; cursor:pointer; display:flex; align-items:center; gap:6px}
  .brand .logo{font-size:18px}
  .navbtn{font-size:14px;border:1px solid var(--border); background:var(--card); border-radius:var(--r); padding:6px 10px; box-shadow:var(--shadow); cursor:pointer}
  .spacer{flex:1}

  /* Day bar (‚Üê [date] Ajd ‚Üí  |  compteur du jour) */
  .daysWrap{position:sticky; top:44px; background:var(--bg); z-index:5; border-bottom:1px solid var(--border);
            padding:6px var(--gap); display:flex; align-items:center; gap:6px; justify-content:space-between}
  .dateLabel{padding:8px 12px; border:1px solid var(--border); background:var(--card); border-radius:4px; box-shadow:var(--shadow);font-weight:700;
             font-variant-numeric:tabular-nums}
  .todayCount{padding:8px 12px; border:1px solid var(--border); background:var(--card); border-radius:4px; box-shadow:var(--shadow); font-weight:700}

  /* Home list */
  .list{padding:var(--gap); display:grid; grid-template-columns:1fr; gap:var(--gap); position:relative; z-index:1}
  .card{border:1px solid var(--border); background:var(--card); border-radius:var(--r); box-shadow:var(--shadow);
        display:grid; grid-template-columns:1fr 64px; overflow:hidden; transition:outline .15s ease}
  .card.done{outline:3px solid var(--green)}
  .content{padding:6px; display:flex; flex-direction:column; gap:4px}
  .title{font-weight:700; display:flex; align-items:center; gap:8px; font-size:15px}
  .subtitle{color:#5b5b56; font-size:14px; min-height:18px}
  .friends{margin-top:auto; display:flex; gap:6px; align-items:center; flex-wrap:wrap}
  .badge{display:flex; align-items:center; gap:0px; padding:2px 4px; border:1px solid var(--border); border-radius:var(--r); background:var(--bg); font-size:11px}
  .badge .streak{font-size:11px}

  /* Level column (√† DROITE) */
  .levelCol{border-left:1px solid var(--border); display:flex; align-items:stretch; justify-content:stretch; padding:0}
  .levelBtn{
    width:100%; height:100%; border-radius:var(--r); border:1px solid var(--border); background:var(--bg);
    display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; user-select:none; line-height:1.05; position:relative
  }
  /* ‚¨áÔ∏è niveau du jour en bas */
  .levelBtn .mini{
    font-size:17px; letter-spacing:-4px; position:absolute; bottom:4px; left:0; right:0; text-align:center; pointer-events:none
  }
  /* ‚¨ÜÔ∏è avatar (emoji) utilisateur issu du score total (üíß + ‚òÄÔ∏è) */
  .levelBtn .self{
    font-size:24px; letter-spacing:-4px; position:absolute; top:4px; left:0; right:0; text-align:center; pointer-events:none
  }
  .levelBtn .big{font-size:22px; font-weight:800; margin-top:8px}
  .levelBtn .num{font-variant-numeric:tabular-nums}

  /* Detail */
  .section{padding:var(--gap)}
  .detailHead{display:flex; align-items:center; gap:8px; position:sticky; top:0px; z-index:5; background:var(--bg); padding:6px var(--gap); border-bottom:1px solid var(--border)}
  .detailTitle{font-weight:800; font-size:16px}
  .backMini{border:1px solid var(--border); background:var(--card); border-radius:var(--r); padding:6px 10px; cursor:pointer}

  /* Tabs + views */
  .tabs{display:flex; gap:6px; padding:var(--gap); border-bottom:1px solid var(--border); background:var(--bg); position:sticky; top:80px; z-index:4}
  .tab{flex:1; text-align:center; padding:8px; border:1px solid var(--border); background:var(--card); border-radius:var(--r); cursor:pointer}
  .tab.active{outline:2px solid var(--green); font-weight:700}
  .view{display:none}
  .view.active{display:block}

  /* Rank */
  .rankHeader{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:8px}
  .rank{display:grid; gap:8px; margin-top:8px}
  .row{display:flex; justify-content:space-between; align-items:center; padding:6px; border:1px solid var(--border); background:var(--card); border-radius:var(--r)}
  .clap{cursor:pointer; user-select:none}
  .row .avatar{width:32px; height:32px; font-size:24px; display:grid; place-items:center}
  .scoreEmoji{font-size:26px; font-weight:900; margin-left:4px; white-space:pre-line}

  /* Calendar */
  .calendarWrap{padding:0 var(--gap) var(--gap)}
  .calTop{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
  .calBtn{border:1px solid var(--border); background:var(--card); border-radius:var(--r); padding:6px 10px; cursor:pointer}
  .calendar{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
  .cell{
    height:55px; display:grid; place-items:center; 
    border:1px dashed var(--border); background:var(--card); border-radius:var(--r);
    position:relative; overflow:hidden; cursor:pointer
  }
  .dayNum{position:absolute; top:4px; right:6px; font-size:10px; color:#777}
  .clapMark{position:absolute; top:18px; left:0; right:0; text-align:center; font-size:12px; line-height:1; font-weight:700}
  .dropMark{position:absolute; bottom:3px; left:0; right:0; text-align:center; font-size:12px; line-height:1; font-weight:700}

  /* Modals full-screen */
  .modal{position:fixed; inset:0; display:none; background:rgba(0,0,0,.2); padding:0; z-index:10}
  .modal.on{display:block}
  .sheet{position:absolute; inset:0; background:var(--card); border-radius:0}
  .sheetHeader{position:sticky; top:0; display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px var(--gap); border-bottom:1px solid var(--border); background:var(--bg)}
  .closeX{border:1px solid var(--border); background:var(--card); border-radius:var(--r); padding:6px 10px; cursor:pointer}
  .sheetBody{padding:var(--gap); height:calc(100% - 50px); overflow:auto}
  .grid{display:grid; gap:8px}
  .opt{border:1px solid var(--border); background:var(--card); border-radius:var(--r); padding:12px; display:flex; gap:8px; align-items:center; cursor:pointer}
  .opt .emoji{font-size:20px}
  .qr{width:160px; height:160px; background:repeating-linear-gradient(45deg,#000 0 6px,#fff 6px 12px); image-rendering:pixelated; border-radius:var(--r)}
  .field{display:grid; gap:4px}
  input[type="text"]{padding:10px; border:1px solid var(--border); border-radius:var(--r); background:#fffdf8; font-size:13px}
  .btn{border:1px solid var(--border); background:var(--card); border-radius:var(--r); padding:10px 12px; cursor:pointer; text-align:center}
  .btn.primary{background:var(--green); color:#fff; border-color:transparent}

  @media(min-width:481px){ .list{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>
<div class="heat" id="heat"></div>
<div id="app">

  <!-- Top -->
  <div class="top">
    <div class="brand" id="brand"><span class="logo">üå±</span>Habitu.be</div>
    <div class="spacer"></div>
    <!-- Renomm√© en ‚ìò Info -->
    <button class="navbtn" id="settingsBtn" title="Info">‚ìò</button>
    <button class="navbtn" id="addBtn" title="Ajouter">Ôºã</button>
  </div>

  <!-- Day bar (‚Üê [date] Ajd ‚Üí | üíß/‚òÄÔ∏è d'aujourd'hui) -->
  <div class="daysWrap" id="daysWrap">
    <button class="navbtn" id="prevDay">‚Üê</button>
    <div style="display:flex; align-items:center; gap:6px">
      <div class="dateLabel" id="dateLabel">‚Äî</div>
      <div class="todayCount" id="todayCount">üíß0 ‚òÄÔ∏è0</div>
    </div>
    <div style="display:flex; gap:6px">
      <button class="navbtn" id="todayBtn">Ajd</button>
      <button class="navbtn" id="nextDay">‚Üí</button>
    </div>
  </div>

  <!-- Home -->
  <main id="home" class="view active">
    <div class="list" id="cards"></div>
  </main>

  <!-- Detail -->
  <section id="detail" class="view">
    <!-- Ent√™te d√©tail -->
    <div class="detailHead">
      <button class="backMini" id="backHome">‚Üê</button>
      <div class="detailTitle" id="detailTitle"></div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="friends">üë• Amis</button>
      <button class="tab" data-tab="progress">üìà Progression</button>
    </div>

    <div class="section">
      <!-- Amis -->
      <div class="view active" id="tab-friends">
        <div class="rankHeader">
          <div><b>Classement</b></div>
          <label style="font-size:12px;display:flex;gap:6px;align-items:center">
            P√©riode:
            <select id="periodSel" style="padding:6px;border:1px solid var(--border);border-radius:var(--r);background:var(--card)">
              <option value="30" selected>30 derniers jours</option>
              <option value="all">Total</option>
            </select>
          </label>
        </div>
        <div class="rank" id="rank"></div>
      </div>

      <!-- Progression -->
      <div class="view" id="tab-progress">
        <div class="calendarWrap">
          <div class="calTop">
            <button class="calBtn" id="prevMonth">‚Üê</button>
            <div id="monthLabel" style="font-weight:700"></div>
            <button class="calBtn" id="nextMonth">‚Üí</button>
          </div>
          <div class="calendar" id="cal"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal: Add root -->
  <div class="modal" id="modalAdd">
    <div class="sheet">
      <div class="sheetHeader">
        <div id="modalTitle">Ajouter</div>
        <button class="closeX" id="closeAdd">‚®â</button>
      </div>
      <div class="sheetBody">
        <div class="grid">
          <div class="opt" id="addHabit"><div class="emoji">üå±</div><div><b>Nouvelle habitude</b><div class="subtitle">Rejoindre un d√©fi</div></div></div>
          <div class="opt" id="addFriend"><div class="emoji">‚òÄÔ∏è</div><div><b>Ajouter un ami</b><div class="subtitle">Rejoindre via code</div></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Habit -->
  <div class="modal" id="modalHabit">
    <div class="sheet">
      <div class="sheetHeader">
        <div id="habitTitle">Nouvelle habitude</div>
        <button class="closeX" id="closeHabit">‚®â</button>
      </div>
      <div class="sheetBody">
        <div class="grid" id="step1"></div>
        <div class="grid" id="step2" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- Modal: Friend -->
  <div class="modal" id="modalFriend">
    <div class="sheet">
      <div class="sheetHeader">
        <div>Ajouter un ami</div>
        <button class="closeX" id="closeFriend">‚®â</button>
      </div>
      <div class="sheetBody">
        <div class="grid">
          <div class="qr" aria-label="QR factice"></div>
          <div class="field">
            <label><b>Entrer le code de l‚Äôami</b></label>
            <input id="friendCode" type="text" placeholder="ABCDE1" maxlength="6" style="text-transform:uppercase"/>
          </div>
          <div class="field">
            <label><b>Ton code</b></label>
            <div style="display:flex; gap:8px; align-items:center">
              <input id="myCode" type="text" readonly/>
              <button class="btn" id="regenCode">R√©g√©n√©rer</button>
            </div>
          </div>
          <div class="grid" style="grid-template-columns:1fr 1fr">
            <button class="btn" id="cancelFriend">Annuler</button>
            <button class="btn primary" id="validateFriend">Valider</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Info (ex-Param√®tres) -->
  <div class="modal" id="modalSettings">
    <div class="sheet">
      <div class="sheetHeader">
        <div>Info</div>
        <button class="closeX" id="closeSettings">‚®â</button>
      </div>
      <div class="sheetBody">
        <div class="grid">
          <div class="opt">
            <div><b>P√©riode affich√©e</b>
              <div class="subtitle">Classements & badges amis</div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button class="btn" data-period="30">30 jours</button>
                <button class="btn" data-period="all">Total</button>
              </div>
            </div>
          </div>
          <!-- L√©gende bar√®me emoji score -->
          <div class="opt">
            <div>
              <b>Bar√®me des scores </b>
              <div class="subtitle" id="legendText"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
/* ======= Donn√©es ======= */
const CATS=[
  {id:'sante',emoji:'ü©∫',nom:'Sant√©'},
  {id:'relations',emoji:'ü§ù',nom:'Relations'},
  {id:'esprit',emoji:'üß†',nom:'Esprit'},
  {id:'corps',emoji:'üí™',nom:'Corps'},
  {id:'vie',emoji:'üß∫',nom:'Vie'},
  {id:'loisirs',emoji:'üé®',nom:'Loisirs'},
  {id:'repos',emoji:'üòå',nom:'Repos'}
];
const CHALLENGES=[
  {id:'screenoff',cat:'sante',emoji:'üìµ',titre:'√âcran coup√© avant lit',levels:['10 min','30 min','1 h'],amis:['Anna','Ben','Chlo√©']},
  {id:'repas',cat:'sante',emoji:'ü•ó',titre:'Repas sain',levels:['1 repas','2 repas','3 repas'],amis:['Ben','Duc']},
  {id:'lire',cat:'esprit',emoji:'üìñ',titre:'Lire',levels:['5 min','15 min','30 min'],amis:['Chlo√©']},
  {id:'etire',cat:'corps',emoji:'ü§∏',titre:'√âtirements',levels:['3 min','10 min','20 min'],amis:['Anna']},
  {id:'ranger',cat:'vie',emoji:'üßΩ',titre:'Rangement express',levels:['5 min','10 min','20 min'],amis:['Chlo√©']},
  {id:'creer',cat:'loisirs',emoji:'üé∏',titre:'Cr√©er / Jouer',levels:['5 min','15 min','30 min'],amis:['Ben']},
  {id:'respirer',cat:'repos',emoji:'üå¨Ô∏è',titre:'Respiration',levels:['2 min','5 min','10 min'],amis:['Anna']}
];
const HOME_SELECTION=['screenoff','repas','lire','etire','ranger','creer','respirer'];

const levelTxt2={0:'',1:'üíß1',2:'üíß2',3:'üíß3'};
const levelTxt={0:'',1:'üíß',2:'üíßüíß',3:'üíßüíßüíß'};
const levelPts={0:0,1:1,2:2,3:3};

/* ======= Amis / √©v√©nements (60 j) ======= */
const FRIENDS=['Anna','Ben','Chlo√©','Duc'];
const friendEvents={};
(function seedFriendEvents(){
  const now=Date.now();
  FRIENDS.forEach(n=>{
    friendEvents[n]=[];
    for(let d=0; d<60; d++){
      if(Math.random()<0.45){
        const lvl=[1,1,2,3][Math.floor(Math.random()*4)];
        friendEvents[n].push({ts: now - d*864e5, pts: levelPts[lvl]});
      }
    }
  });
})();

/* ======= Claps totaux par d√©fi et par utilisateur (0‚Äì100, fix√©s al√©atoirement) ======= */
const challengeClaps={}; // {challengeId:{ 'Anna':42, ..., 'Moi':73 }}
(function seedClaps(){
  CHALLENGES.forEach(c=>{
    challengeClaps[c.id]={};
    [...new Set([...c.amis,'Moi'])].forEach(n=>{
      challengeClaps[c.id][n]=Math.floor(Math.random()*101); // 0..100
    });
  });
})();

/* ======= Helpers ======= */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const sumPeriod=(arr,period)=> period==='all' ? arr.reduce((a,e)=>a+e.pts,0)
                                             : arr.filter(e=>e.ts>=Date.now()-30*864e5).reduce((a,e)=>a+e.pts,0);
function fmtDate(d){const m=['01','02','03','04','05','06','07','08','09','10','11','12'][d.getMonth()];const j=String(d.getDate()).padStart(2,'0');const J=['Di','Lu','Ma','Me','Je','Ve','Sa'][d.getDay()];return `${J} ${j}/${m}`;}

/* === Bar√®me des niveaux (tooltips) === */
function levelEmojiFromScore(v){
  if(v<=9) return 'üå∞'; if(v<=99) return 'üå±'; if(v<=199) return 'üçÄ'; if(v<=299) return 'üåº';
  if(v<=399) return 'üåª'; if(v<=499) return 'üå∑'; if(v<=599) return 'üåπ'; if(v<=699) return 'ü™ª';
  if(v<=799) return 'üíê'; return 'üéã';
}
function emojiScaleLegend() {
  return [
    'üå∞ 0‚Äì9 ‚Äî Graine ‚Äî d√©but du chemin',
    'üå± 10‚Äì99 ‚Äî Pousse ‚Äî premiers pas',
    'üçÄ 100‚Äì199 ‚Äî Tr√®fle ‚Äî petites victoires',
    'üåº 200‚Äì299 ‚Äî Bourgeon ‚Äî r√©gularit√© naissante',
    'üåª 300‚Äì399 ‚Äî Tournesol ‚Äî confiance qui grandit',
    'üå∑ 400‚Äì499 ‚Äî Tulipe ‚Äî curiosit√© √©panouie',
    'üåπ 500‚Äì599 ‚Äî Rose ‚Äî ma√Ætrise √©l√©gante',
    'ü™ª 600‚Äì699 ‚Äî Lavande ‚Äî calme et constance',
    'üíê 700‚Äì799 ‚Äî Bouquet ‚Äî harmonie des savoirs',
    'üéã 800+ ‚Äî Bambou ‚Äî sagesse durable'
  ].join('<br>');
}
function scoreBreakdownTitle(drops,claps){
  const total=drops+claps;
  return `${levelEmojiFromScore(total)} ${total}`;
}

/* ======= Score = üíß(d√©fi) + ‚òÄÔ∏è(claps totaux) ======= */
function scoreFor(challengeId, name, drops){
  const cl=challengeClaps[challengeId]?.[name] ?? 0;
  return {total:(drops+cl), claps:cl, drops};
}

/* ======= P√©riode globale (param√®tres) ======= */
let periodSetting='30';

/* ======= S√©lecteur de date ======= */
let dayOffset=0;
function currentDate(){ const t=new Date(); t.setHours(0,0,0,0); t.setDate(t.getDate()+dayOffset); return t; }
function renderDateBar(){
  $("#dateLabel").textContent = fmtDate(currentDate());
  const dropsToday = $$('#cards .levelBtn').map(b=>levelPts[Number(b.dataset.level||0)]).reduce((a,b)=>a+b,0);
  const sunsToday = Math.floor(Math.random()*11); // 0..10 (d√©mo)
  $("#todayCount").textContent = `üíß${dropsToday}  ‚òÄÔ∏è${sunsToday}`;
}
$("#prevDay").onclick=()=>{ dayOffset--; renderDateBar(); };
$("#nextDay").onclick=()=>{ dayOffset++; renderDateBar(); };
$("#todayBtn").onclick=()=>{ dayOffset=0; renderDateBar(); };

/* ======= Heat background ======= */
function setHeat(pct){ $("#heat").style.height=`${Math.max(0,Math.min(100,pct))}%`; }
function computeGlobalDrops(){ return $$('#cards .levelBtn .num').map(n=>Number(n.textContent||0)).reduce((a,b)=>a+b,0); }

/* ======= Cartes ======= */
let activeCardId=null, refBtn=null;
function findById(id){ return CHALLENGES.find(c=>c.id===id); }

function renderCards(){
  const root=$("#cards"); root.innerHTML='';
  HOME_SELECTION.forEach(id=>{
    const it=findById(id);
    const card=document.createElement('article'); card.className='card';

    // Contenu (√† gauche)
    const cont=document.createElement('div'); cont.className='content';
    const title=document.createElement('div'); title.className='title';
    title.innerHTML=`<span style="font-size:18px">${it.emoji}</span> <span>${it.titre}</span>`;
    const sub=document.createElement('div'); sub.className='subtitle'; sub.textContent='';

    const friends=document.createElement('div'); friends.className='friends';
    friends.addEventListener('click', (e) => {
      if (e.target && e.target.nodeType === 3) return;
      const badge = e.target.closest('.badge');
      if (badge) {
        openDetail(it.id, btn, 'friends');
        e.stopPropagation();
      }
    });

    it.amis.forEach(n=>{
      const drops=sumPeriod(friendEvents[n]||[], periodSetting);
      const {total,claps} = scoreFor(it.id, n, drops);

      const b=document.createElement('div'); b.className='badge';
      const name=document.createElement('span'); name.className='name'; name.textContent=n;
      const maybeSun = (Math.random()>=0.5) ? (()=>{ const s=document.createElement('span'); s.className='sun'; s.textContent='‚òÄÔ∏è'; s.title = `${claps} claps (d√©mo)`; return s; })() : null;
      const hot=document.createElement('div'); hot.className='streak'; 
      const todayLvl = 1 + Math.floor(Math.random()*3);
      hot.textContent = levelTxt2[todayLvl];
      hot.setAttribute('title','Niveau de r√©alisation du jour');

      if(maybeSun){ b.append(name, maybeSun, hot); } else { b.append(name, hot); }
      friends.appendChild(b);
    });
    cont.append(title,sub,friends);

    // Colonne niveau (√† DROITE)
    const col=document.createElement('div'); col.className='levelCol';
    const btn=document.createElement('button'); btn.className='levelBtn';
    const startTotal = Math.floor(Math.random()*200)+1;
    btn.dataset.level='0'; 
    btn.dataset.total=String(startTotal);
    btn.dataset.cid=it.id;
    btn.innerHTML=`<div class="self" title=""></div><div class="mini"></div><div class="big"><span class="num">${startTotal}</span></div>`;

    const updateMini = ()=>{ const L=Number(btn.dataset.level); btn.querySelector('.mini').textContent = levelTxt[L]; };
    const updateSelf = ()=>{ 
      const drops = Number(btn.dataset.total||0); 
      const claps = challengeClaps[btn.dataset.cid]?.['Moi'] ?? 0;
      const score = drops + claps;
      const el = btn.querySelector('.self');
      el.textContent = levelEmojiFromScore(score); 
      el.setAttribute('title', scoreBreakdownTitle(drops,claps));
    };
    updateMini(); updateSelf();

    btn.onclick=()=>{
      const prev=Number(btn.dataset.level);
      const next=(prev+1)%4; btn.dataset.level=String(next);
      const delta = next===0 ? -levelPts[prev] : (levelPts[next]-levelPts[prev]);
      const newDrops = Math.max(0, Number(btn.dataset.total) + delta);
      btn.dataset.total=String(newDrops);
      btn.querySelector('.num').textContent=String(newDrops);
      updateMini(); updateSelf();
      if(next>0){ card.classList.add('done'); sub.textContent = `${it.levels[next-1]}`; } else { card.classList.remove('done'); sub.textContent=''; }
      setHeat(Math.min(100, computeGlobalDrops()));
      renderDateBar();
    };

    col.append(btn);

    // Clics carte : ailleurs que sur amis => onglet Progression
    card.addEventListener('click',(ev)=>{
      if(ev.target.closest('.levelBtn')) return;
      if(ev.target.closest('.friends')) return;
      openDetail(it.id, btn, 'progress');
    });

    card.append(cont,col);
    root.appendChild(card);
  });

  setHeat(Math.min(100, computeGlobalDrops()));
  renderDateBar();
}

/* ======= Detail ======= */
function openDetail(id, btnRef, tab='friends'){
  activeCardId=id; refBtn=btnRef;
  $("#home").classList.remove('active'); $("#detail").classList.add('active');
  $("#daysWrap").style.display='none';

  $$('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
  $$('#detail .view').forEach(v=>v.classList.remove('active'));
  $(`#tab-${tab}`).classList.add('active');

  const it=findById(id);
  // üíß retir√© du titre
  $("#detailTitle").textContent=`${it.emoji} ${it.titre}`;
  renderRank();
  renderCalendar();
}
$("#backHome").onclick=()=>{ $("#detail").classList.remove('active'); $("#home").classList.add('active'); $("#daysWrap").style.display='flex'; };
$("#brand").onclick=()=>{ $("#detail").classList.remove('active'); $("#home").classList.add('active'); $("#daysWrap").style.display='flex'; };

/* Classement (scoreEmoji = scoreBreakdownTitle) */
function renderRank(){
  const it=findById(activeCardId);
  const period=$("#periodSel").value;

  const rows = [
    ...it.amis.map(n=>{
      const drops = sumPeriod(friendEvents[n]||[],period);
      const claps = challengeClaps[it.id]?.[n] ?? 0;
      const total = drops + claps;
      return {n, drops, claps, total, me:false};
    }),
    (function meRow(){
      const drops = Number(refBtn?.dataset.total||0);
      const claps = challengeClaps[it.id]?.['Moi'] ?? 0;
      const total = drops + claps;
      return {n:'Moi', drops, claps, total, me:true};
    })()
  ].sort((a,b)=>b.total-a.total);

  const root=$("#rank"); root.innerHTML='';
  rows.forEach(({n,drops,claps,total,me})=>{
    const row=document.createElement('div'); row.className='row';

    const left=document.createElement('div');
    left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';

    const av=document.createElement('span');
    av.title=scoreBreakdownTitle(drops,claps);

    const bigScore=document.createElement('span');
    bigScore.className='scoreEmoji';
    bigScore.textContent=scoreBreakdownTitle(drops,claps); 

    const name=document.createElement('b');
    name.textContent=`${n}${me?' (toi)':''}`;

    left.append(av, bigScore, name);

    const right=document.createElement('div');
    right.style.display='flex'; right.style.alignItems='center'; right.style.gap='12px';

    const dropsSpan=document.createElement('span');
    dropsSpan.style.fontWeight='700';
    dropsSpan.title='üíß sur la p√©riode';
    dropsSpan.textContent=`üíß${drops}`;

    const clapBtn=document.createElement('button');
    clapBtn.className='clap navbtn';
    clapBtn.dataset.liked='0';
    clapBtn.title='‚òÄÔ∏è claps';
    clapBtn.textContent=`‚òÄÔ∏è ${claps}`;

    clapBtn.onclick=()=>{
      if(clapBtn.dataset.liked==='1') return;
      clapBtn.dataset.liked='1'; 
      const cur=parseInt(clapBtn.textContent.replace(/[^\d]/g,''))||0;
      clapBtn.textContent=`‚òÄÔ∏è ${cur+1}`; 
      clapBtn.style.opacity=.7;
    };

    right.append(dropsSpan, clapBtn);

    row.append(left, right);
    root.appendChild(row);
  });
}
$("#periodSel").addEventListener('change',renderRank);

/* Calendrier (‚òÄÔ∏è en haut, üíß en bas, totaux mois dans label) */
let calMonthOffset=0;
function monthInfo(offset=0){
  const base=new Date(); base.setDate(1); base.setMonth(base.getMonth()+offset);
  const y=base.getFullYear(), m=base.getMonth();
  return {y,m, firstDay:(new Date(y,m,1).getDay()+6)%7, days:new Date(y,m+1,0).getDate()};
}
function renderCalendar(){
  const wrap=$("#cal"); wrap.innerHTML='';
  const {y,m,firstDay,days}=monthInfo(calMonthOffset);
  const monthNames=['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ª','Sep','Oct','Nov','D√©c'];

  let monthClaps=0, monthDrops=0;

  for(let i=0;i<firstDay;i++){ const c=document.createElement('div'); c.className='cell'; c.style.opacity=.35; wrap.appendChild(c); }
  const today=new Date(); const isThisMonth=(calMonthOffset===0);

  for(let d=1; d<=days; d++){
    const c=document.createElement('div'); c.className='cell';

    // num√©ro du jour
    const dn=document.createElement('div'); dn.className='dayNum'; dn.textContent=String(d); c.appendChild(dn);

    // üíß niveau du jour (d√©mo)
    const lvl=[0,1,1,2,3,0][Math.floor(Math.random()*6)];
    const drops = lvl;
    const dropEl=document.createElement('div'); dropEl.className='dropMark'; dropEl.textContent=levelTxt2[lvl]||''; c.appendChild(dropEl);
    monthDrops += drops;

    // ‚òÄÔ∏è claps du jour : 50% -> 0, sinon 1..4
    let claps=0;
    if(Math.random()>=0.5){ claps = 1 + Math.floor(Math.random()*4); }
    const clapEl=document.createElement('div'); clapEl.className='clapMark'; clapEl.textContent=claps?`‚òÄÔ∏è${claps}`:''; c.appendChild(clapEl);
    monthClaps += claps;

    if(isThisMonth && d===today.getDate()){ c.style.outline=`2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--green')}`; }

    // clic jour => aller √† ce jour dans l'accueil
    c.onclick=()=>{
      const base=new Date(); base.setDate(1); base.setMonth(base.getMonth()+calMonthOffset);
      const target=new Date(base.getFullYear(), base.getMonth(), d);
      const now=new Date(); now.setHours(0,0,0,0);
      dayOffset = Math.round((target - now)/86400000);
      $("#detail").classList.remove('active'); $("#home").classList.add('active'); $("#daysWrap").style.display='flex';
      renderDateBar();
      window.scrollTo({top:0,behavior:'smooth'});
    };
    wrap.appendChild(c);
  }

  // Label mois + totaux
  $("#monthLabel").textContent=`${monthNames[m]} ${y} ¬∑ ‚òÄÔ∏è${monthClaps} üíß${monthDrops}`;
}
$("#prevMonth").onclick=()=>{ calMonthOffset--; renderCalendar(); };
$("#nextMonth").onclick=()=>{ calMonthOffset++; renderCalendar(); };

/* Tabs */
$$('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const name=t.dataset.tab;
    $$('#detail .view').forEach(v=>v.classList.remove('active'));
    $('#tab-'+name).classList.add('active');
  });
});

/* ======= Modals ======= */
const modalAdd=$("#modalAdd"), modalHabit=$("#modalHabit"), modalFriend=$("#modalFriend"), modalSettings=$("#modalSettings");
const open = m => m.classList.add('on');
const close = m => m.classList.remove('on');

$("#addBtn").onclick=()=>open(modalAdd);
$("#closeAdd").onclick=()=>close(modalAdd);
$("#addHabit").onclick=()=>{ close(modalAdd); open(modalHabit); renderStep1(); };
$("#addFriend").onclick=()=>{ close(modalAdd); open(modalFriend); };
// Bouton Info (ex-Param√®tres)
$("#settingsBtn").onclick=()=>{
  open(modalSettings);
  // Remplir la l√©gende au vol
  $("#legendText").innerHTML = emojiScaleLegend();
};
$("#closeSettings").onclick=()=>close(modalSettings);

$("#closeHabit").onclick=()=>close(modalHabit);
$("#closeFriend").onclick=()=>close(modalFriend);
$("#cancelFriend").onclick=()=>close(modalFriend);
$("#validateFriend").onclick=()=>{ alert("Ami ajout√© (d√©mo)"); close(modalFriend); };

function genCode(){ const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let s=''; for(let i=0;i<6;i++){ s+=chars[Math.floor(Math.random()*chars.length)]; } return s; }
$("#myCode").value=genCode();
$("#regenCode").onclick=()=>{ $("#myCode").value=genCode(); };

/* Habit steps (sans niveau) */
let pickedCat=null, pickedItem=null;
function renderStep1(){
  $("#step1").style.display='grid'; $("#step2").style.display='none';
  const root=$("#step1"); root.innerHTML='';
  CATS.forEach(c=>{
    const el=document.createElement('div'); el.className='opt';
    el.innerHTML=`<div class="emoji">${c.emoji}</div><div><b>${c.nom}</b></div>`;
    el.onclick=()=>{ pickedCat=c.id; renderStep2(); };
    root.appendChild(el);
  });
}
function renderStep2(){
  $("#step1").style.display='none'; $("#step2").style.display='grid';
  const root=$("#step2"); root.innerHTML='';
  CHALLENGES.filter(x=>x.cat===pickedCat).forEach(x=>{
    const el=document.createElement('div'); el.className='opt';
    el.innerHTML=`<div class="emoji">${x.emoji}</div><div><b>${x.titre}</b><div class="subtitle">${x.levels.join(' ¬∑ ')}</div></div>`;
    el.onclick=()=>{ pickedItem=x; alert("Habitude ajout√©e (d√©mo)"); close(modalHabit); };
    root.appendChild(el);
  });
}

/* Param√®tres: choix p√©riode globale */
$$('#modalSettings .btn[data-period]').forEach(b=>{
  b.onclick=()=>{ periodSetting=b.dataset.period; close(modalSettings); renderCards(); if($("#detail").classList.contains('active')) renderRank(); };
});

/* ======= Init ======= */
function renderCalendarAndKeepMonth(){ renderCalendar(); }
renderDateBar();
renderCards();
renderCalendarAndKeepMonth();
</script>
</body>
</html>