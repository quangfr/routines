<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Habitu.be â€” Les petites habitudes qui changent tout </title>
<style>
:root{--bg:#f7f3ea;--card:#fffdf8;--text:#1e1f1a;--green:#2a7a57;--border:#c6beae;--r:4px;--gap:8px;--fs:13px}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font:400 var(--fs)/1.35 system-ui,-apple-system,Roboto,sans-serif;color:var(--text);background:var(--bg)}
#app{max-width:480px;margin:0 auto;min-height:100%;display:flex;flex-direction:column;position:relative}

button,.select,.tab,.stab,.btn,.btnToggle,.navbtn,.calBtn,.backMini{
  font:600 13px/1.2 system-ui,-apple-system,Roboto,sans-serif;padding:6px 10px;border-radius:var(--r);
  cursor:pointer;border:1px solid var(--border);background:var(--card)
}
.btn.primary{background:var(--green);color:#fff;border-color:transparent}
.btn.danger{border-color:#d99;color:#600;background:#fff5f5}
.btnToggle.active,.tab.active,.stab.active{outline:2px solid var(--green)}
.select{appearance:none}

.top{position:sticky;top:0;background:var(--bg);z-index:6;border-bottom:1px solid var(--border);padding:6px var(--gap);display:flex;align-items:center;gap:8px}
.brand{font-weight:800;cursor:pointer;display:flex;align-items:center;gap:6px}.brand .logo{font-size:18px}.spacer{flex:1}

.daysWrap{position:sticky;top:44px;background:var(--bg);z-index:5;border-bottom:1px solid var(--border);padding:6px var(--gap);display:flex;align-items:center;gap:6px;justify-content:space-between}
.rightBtns{display:flex;flex-direction:row;gap:6px;align-items:flex-end}
.dateLabel,.todayCount{font-weight:700;padding:0;border:none;background:transparent}

.list{padding:var(--gap);display:grid;grid-template-columns:1fr;gap:var(--gap);position:relative;z-index:1}
.card{border:1px solid var(--border);background:var(--bg);border-radius:var(--r);display:grid;grid-template-columns:64px 1fr;overflow:hidden}

/* EncadrÃ©s par Ã©tat + auteur + mode */
.card.s0{border:2px solid #e05555}                 /* rouge = Ã€ faire (Chacun) */
.card.s0shared{border:2px solid #bfb9ad}           /* gris = Ã€ faire (PartagÃ©) */
.card.s1me,.card.s1help{border:2px solid #e6c200}  /* jaune = Je fais / J'aide */
.card.s1other,.card.s2other{border:2px solid #bfb9ad} /* gris = En cours (autre) / Fait (autre) */
.card.s2me{border:2px solid var(--green)}          /* vert = Fait (moi) */

.content{padding:4px;display:flex;flex-direction:column;gap:4px}
.title{font-weight:700;display:flex;align-items:center;gap:4px;font-size:14px;min-height:22px;justify-content:space-between}
.title .left{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.title .base.strike{text-decoration:line-through;opacity:.75}
.editPen{background-color:transparent;border-color:var(--border);padding:4px;}
.desc{font-size:11px;color:#8f8f8c;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;cursor:default}
.desc.open{-webkit-line-clamp:unset;display:block;white-space:pre-line;overflow:visible}
.desc.hidden{display:none}

/* Badges */
.friends{margin-top:auto;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.badge{display:flex;align-items:center;gap:6px;padding:4px 6px;border:1px solid var(--border);border-radius:var(--r);background:#fff;font-size:11px;line-height:1.2}
.badge.heart{border-color:#c6beae;background:#fff0fb}
.badge.heart.liked{border-color:#f3b}

/* Tag de mode â€” supprimÃ© visuellement */
.modeTag{display:none}

.levelCol{padding:0 6px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.levelBtn{width:100%;height:60px;border-radius:var(--r);border:1px solid var(--border);background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;user-select:none;line-height:1.05;position:relative}
.levelBtn .big{position:absolute;top:4px;left:0;right:0;text-align:center;font-size:22px;font-weight:800}
.levelBtn .scoreText{position:absolute;bottom:2px;left:4px;right:4px;text-align:center;font-size:12px;font-weight:800;line-height:1}

/* Sections & vues */
.section{padding:var(--gap)}
.detailHead{display:flex;align-items:center;gap:8px;position:sticky;top:0;z-index:5;background:var(--bg);padding:6px var(--gap);border-bottom:1px solid var(--border)}
.detailTitle{font-weight:800;font-size:16px}
.tabs{display:flex;gap:6px;padding:var(--gap);border-bottom:1px solid var(--border);background:var(--bg);position:sticky;top:80px;z-index:4}
.tab{flex:1;text-align:center}.view{display:none}.view.active{display:block}

.rankHeader{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px}
.rank{display:grid;gap:8px;margin-top:8px}
.row{display:flex;justify-content:space-between;align-items:center;padding:6px;border:1px solid var(--border);background:var(--bg);border-radius:var(--r)}
.leftRank{display:flex;align-items:center;gap:8px}
.scoreEmoji{font-size:18px;font-weight:900;margin-left:4px;white-space:pre-line}

.calendarWrap{padding:0 var(--gap) var(--gap)}
.calTop{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cell{height:55px;display:grid;place-items:center;border:1px dashed var(--border);background:var(--card);border-radius:var(--r);position:relative;overflow:hidden;cursor:pointer}
.dayNum{position:absolute;top:4px;right:6px;font-size:10px;color:#777}
.seedMark{position:absolute;top:18px;left:0;right:0;text-align:center;font-size:14px;line-height:1;font-weight:700}
.cell .dur{position:absolute;bottom:2px;left:4px;right:4px;text-align:center;font:800 12px/1 system-ui}

/* Modales */
.modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.2);padding:0;z-index:10}
.modal.on{display:flex;align-items:stretch;justify-content:stretch}
.sheet{position:absolute;inset:0;background:var(--card)}
.sheetHeader{position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px var(--gap);border-bottom:1px solid var(--border);background:var(--bg)}
.sheetBody{padding:var(--gap);height:calc(100% - 50px);overflow:auto;background:var(--bg)}
.grid{display:grid;gap:8px}
.opt{border:1px solid var(--border);background:var(--card);border-radius:var(--r);padding:12px;display:flex;gap:8px;align-items:center;cursor:pointer}
.opt .emoji{font-size:20px}
.field{display:grid;gap:4px}
input[type="text"],textarea,select{padding:10px;border:1px solid var(--border);border-radius:var(--r);background:#fffdf8;font-size:13px}
.inputEmoji{position:relative;display:flex;align-items:center}
.inputEmoji .emojiPrefix{position:absolute;left:10px;font-size:20px;pointer-events:none;line-height:1}
.inputEmoji input{width:100%;padding-left:42px}
textarea.editing{background:#fff;border:1px solid var(--border)}

.stabs{display:flex;gap:6px;padding:6px;position:sticky;top:52px;background:var(--bg);border-bottom:1px solid var(--border);z-index:2}
.stab{flex:1;text-align:center}
.sview{display:none}.sview.active{display:block}
.rowInline{display:flex;gap:8px;align-items:center}.rowInline input{flex:1}.rowInline .btn.copyOnly{padding:6px 10px}
.miniInfo{font-size:12px;color:#555}
.hide{display:none}

/* Barre ajout habitude (filtre + bouton) sticky */
.addBar{
  position:sticky;
  top:0;
  z-index:3;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  background:var(--bg);
  padding:6px 0;
}
</style>
</head>
<body>
<div id="app">
  <div class="top">
    <div class="brand" id="brand"><span class="logo">ğŸŒ±</span>Habitu.be</div>
    <div class="spacer"></div>
    <select id="spaceSel" class="select" title="Changer de jardin"></select>
    <button class="navbtn" id="openSpace" title="Jardin">â“˜</button>
  </div>

  <div class="daysWrap" id="daysWrap">
    <button class="navbtn" id="prevDay">â†</button>
    <div style="display:flex;align-items:center;gap:6px">
      <div class="dateLabel" id="dateLabel">â€”</div>
      <div class="todayCount" id="todayCount">0h00</div>
    </div>
    <div class="rightBtns">
      <button class="navbtn" id="nextDay">â†’</button>
      <button class="navbtn" id="addBtn" title="Ajouter">ï¼‹</button>
    </div>
  </div>

  <main id="home" class="view active">
    <div class="list" id="cards"></div>
  </main>

  <section id="detail" class="view">
    <div class="detailHead">
      <button class="backMini" id="backHome">â†</button>
      <div class="detailTitle" id="detailTitle"></div>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="members">ğŸ‘¨â€ğŸŒ¾ Jardiniers</button>
      <button class="tab" data-tab="history">ğŸ“… Historique</button>
      <button class="tab" data-tab="settings">âœï¸ Ã‰dition</button>
    </div>
    <div class="section">
      <div class="view active" id="tab-members">
        <div class="rankHeader">
          <b>DurÃ©e</b>
          <div style="font-size:12px;display:flex;gap:8px;align-items:center">
            PÃ©riode:
            <div style="display:flex;gap:8px">
              <button class="btnToggle" data-period="7" id="btnP7">7 jours</button>
              <button class="btnToggle active" data-period="30" id="btnP30">30 jours</button>
              <button class="btnToggle" data-period="all" id="btnPAll">Total</button>
            </div>
          </div>
        </div>
        <div class="rank" id="rank"></div>
      </div>

      <div class="view" id="tab-history">
        <div class="calendarWrap">
          <div class="calTop">
            <div style="display:flex;gap:6px;align-items:center">
              <button class="calBtn" id="prevMonth">â†</button>
              <div id="monthLabel" style="font-weight:700"></div>
              <button class="calBtn" id="nextMonth">â†’</button>
            </div>
            <div id="calWhoWrap" style="display:flex;gap:6px;align-items:center">
              <span style="font-size:12px">Voir :</span>
              <select id="calWho" class="select" style="padding:6px"></select>
            </div>
          </div>
          <div class="calendar" id="cal"></div>
        </div>
      </div>

      <div class="view" id="tab-settings">
        <div class="grid">
          <div class="field">
            <label><b>Nom personnalisÃ©</b></label>
            <div class="inputEmoji">
              <span class="emojiPrefix" id="habitTitleEmoji">ğŸŒ±</span>
              <input id="habitTitleInput" type="text" placeholder="Nom de l'habitude"/>
            </div>
          </div>

          <div class="field">
            <label><b>Description</b></label>
            <textarea id="habitDesc" placeholder="DÃ©cris ton habitude (objectif, contexte, tips). Clique pour Ã©diter."></textarea>
          </div>

          <div class="field">
            <label><b>FrÃ©quence</b></label>
            <div class="grid" style="gap:6px">
              <select id="freqType" class="select">
                <option value="quotidien" selected>Quotidien</option>
                <option value="tousx">Tous les X jours</option>
                <option value="hebdo">Hebdomadaire</option>
                <option value="ponctuelle">Ponctuelle</option>
                <option value="jours">Jour(s) de la semaine</option>
              </select>
              <div id="freqSubTousx" class="rowInline"><span>X=</span><select id="freqX" class="select"><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
              <div id="freqSubPonctuelle" class="rowInline hide"><span>Date</span><input id="freqDate" type="text" placeholder="JJ/MM/AAAA"/></div>
              <div id="freqSubJours" class="hide" style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px">
                <label><input type="checkbox" value="1">Lu</label>
                <label><input type="checkbox" value="2">Ma</label>
                <label><input type="checkbox" value="3">Me</label>
                <label><input type="checkbox" value="4">Je</label>
                <label><input type="checkbox" value="5">Ve</label>
                <label><input type="checkbox" value="6">Sa</label>
                <label><input type="checkbox" value="0">Di</label>
              </div>
            </div>
          </div>

          <div class="field">
            <label><b>DurÃ©e par dÃ©faut</b></label>
            <select id="mockDefaultDur" class="select">
              <option>5 min</option>
              <option>15 min</option>
              <option>30 min</option>
              <option>45 min</option>
              <option>60 min</option>
            </select>
          </div>

          <div class="field">
            <label><b>Mode de rÃ©alisation</b></label>
            <div class="rowInline">
              <select id="modeSelect" class="select">
                <option value="libre">Chacun</option>
                <option value="commun">PartagÃ©</option>
              </select>
            </div>
            <div class="miniInfo">Chacun (toi) Â· PartagÃ© (1 personne suffit).</div>
          </div>

          <div style="margin-top:14px;display:flex;justify-content:space-between;gap:8px">
            <button class="btn danger" id="deleteHabitBtn">Supprimer</button>
            <button class="btn primary" id="saveHabitBtn">Sauvegarder</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="space" class="view">
    <div class="detailHead">
      <button class="backMini" id="backFromSpace">â†</button>
      <div class="detailTitle" id="spaceHeaderTitle"></div>
      <div class="spacer"></div>
      <button class="btn" id="spaceAccountBtn">ğŸ‘¤ Mon compte</button>
    </div>
    <div class="tabs">
      <button class="tab active" data-stab="sprofile">ğŸ‘¨â€ğŸŒ¾ Jardiniers</button>
      <button class="tab" data-stab="shistory">ğŸ“… Historique</button>
      <button class="tab" data-stab="sparams">âœï¸ Ã‰dition</button>
    </div>
    <div class="section">
      <div class="view active" id="sprofile">
        <div class="rankHeader">
          <b>DurÃ©e</b>
          <div style="font-size:12px;display:flex;gap:8px;align-items:center">
            PÃ©riode:
            <div style="display:flex;gap:8px">
              <button class="btnToggle" data-speriod="7" id="sBtnP7">7 jours</button>
              <button class="btnToggle active" data-speriod="30" id="sBtnP30">30 jours</button>
              <button class="btnToggle" data-speriod="all" id="sBtnPAll">Total</button>
            </div>
          </div>
        </div>
        <div class="rank" id="spaceRank"></div>
      </div>
      <div class="view" id="shistory">
        <div class="calendarWrap">
          <div class="calTop">
            <div style="display:flex;gap:6px;align-items:center">
              <button class="calBtn" id="sPrevMonth">â†</button>
              <div id="sMonthLabel" style="font-weight:700"></div>
              <button class="calBtn" id="sNextMonth">â†’</button>
            </div>
            <div style="display:flex;gap:6px;align-items:center">
              <span style="font-size:12px">Voir :</span>
              <select id="sCalWho" class="select" style="padding:6px"></select>
            </div>
          </div>
          <div class="calendar" id="sCal"></div>
        </div>
      </div>
      <div class="view" id="sparams">
        <div class="grid">
          <div class="field">
            <label><b>Description</b></label>
            <textarea id="spaceDescInfo" placeholder="PrÃ©sentez le jardin, les rÃ¨gles et lâ€™Ã©tat dâ€™esprit. Cliquez pour Ã©diter."></textarea>
          </div>
          <div class="field"><label><b>Mon pseudo</b></label><input id="paramName" type="text" value="Moi"/></div>
          <div class="field"><label><b>Nom du jardin</b></label><input id="paramSpaceLabel" type="text"/></div>
          <div class="field">
            <label><b>Mode d'organisation</b></label>
            <select id="spaceOrgMode" class="select" disabled>
              <option value="day">Ã€ la journÃ©e</option>
              <option value="week">Ã€ la semaine</option>
            </select>
          </div>
          <div class="field"><label><b>AccÃ¨s</b></label><select class="select"><option>Public</option><option>Sur invitation</option></select></div>
          <div class="field"><label><b>Droits d'Ã©dition</b></label><select class="select"><option>Admin</option><option>Tous</option></select></div>
          <div style="margin-top:12px"><button class="btn danger" id="quitSpaceBtn">Quitter le jardin</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Ajouter -->
  <div class="modal" id="modalAdd">
    <div class="sheet">
      <div class="sheetHeader"><div id="modalTitle">Ajouter</div><button class="closeX" id="closeAdd">â¨‰</button></div>
      <div class="sheetBody">
        <div class="grid">
          <div class="opt" id="addHabit"><div class="emoji">ğŸŒ±</div><div><b>Nouvelle(s) habitude(s)</b><div class="subtitle">Rejoindre un dÃ©fi</div></div></div>
          <div class="opt hide" id="addPrivateHabit"><div class="emoji">âœ¨</div><div><b>Nouvelle habitude privÃ©e</b><div class="subtitle">EntiÃ¨rement personnalisable</div></div></div>
          <div class="opt" id="inviteFriend"><div class="emoji">â¤ï¸</div><div><b>Inviter un jardinier</b><div class="subtitle">Lien Ã  partager</div></div></div>
          <div class="opt" id="joinSpace"><div class="emoji">ğŸ¤</div><div><b>Rejoindre un jardin</b><div class="subtitle">Entrer un code</div></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Inviter -->
  <div class="modal" id="modalInvite">
    <div class="sheet">
      <div class="sheetHeader"><div>Inviter</div><button class="closeX" id="closeInvite">â¨‰</button></div>
      <div class="sheetBody">
        <div class="grid">
          <div class="field">
            <label><b>Lien Ã  partager</b></label>
            <div class="rowInline"><input id="inviteLink" type="text" readonly/><button class="btn copyOnly" id="copyInvite" title="Copier">ğŸ”—</button></div>
            <div class="subtitle">Le lien contient le code de ton jardin.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Habitude (bibliothÃ¨que multi-sÃ©lection) -->
  <div class="modal" id="modalHabit">
    <div class="sheet">
      <div class="sheetHeader"><div id="habitTitle">Nouvelle(s) habitude(s)</div><button class="closeX" id="closeHabit">â¨‰</button></div>
      <div class="sheetBody">
        <div class="grid" id="step1"></div>
        <div class="grid" id="step2" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- Espace -->
  <div class="modal" id="modalSpace">
    <div class="sheet">
      <div class="sheetHeader"><div>CrÃ©er / Rejoindre un jardin</div><button class="closeX" id="closeSpace">â¨‰</button></div>
      <div class="sheetBody">
        <div class="grid">
          <div class="field"><label><b>Code (6 caractÃ¨res alphanumÃ©riques)</b></label>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="spaceCode" type="text" placeholder="ABC123" maxlength="6" style="text-transform:uppercase"/>
              <button class="btn" id="spaceGen">CrÃ©er</button>
            </div>
          </div>
          <div class="field"><label><b>Ton prÃ©nom</b></label><input id="spaceName" type="text" placeholder="PrÃ©nom"/></div>
          <div class="grid" style="grid-template-columns:1fr 1fr"><button class="btn" id="spaceCancel">Annuler</button><button class="btn primary" id="spaceSave">Rejoindre</button></div>
          <div class="subtitle">Prototype : entre le code & ton prÃ©nom, puis choisis le type de profil.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Wizard profil -->
  <div class="modal" id="modalWizard">
    <div class="sheet">
      <div class="sheetHeader"><div id="wizTitle">Type de profil</div><button class="closeX" id="closeWizard">â¨‰</button></div>
      <div class="sheetBody"><div class="grid" id="wizStep"></div></div>
    </div>
  </div>
</div>

<script>
/* ===== DonnÃ©es ===== */

// Habitudes existantes (dÃ©mo) â€” espace individuel
const CHALLENGES = [
  {type:'private',id:'screenoff',cat:'sante',emoji:'ğŸ›Œ',titre:'Sans Ã©cran avant le coucher',
   amis:['Anna','Ben','ChloÃ©','Nicolas','Marie','David','Jonas','Julie','Alicia','Franck']},
  {type:'private',id:'repas',cat:'sante',emoji:'ğŸ¥—',titre:'Repas sain fait maison',
   amis:['Ben','Duc','Nicolas','David','Jonas','Julie','Alicia','Franck']},
  {type:'private',id:'lire',cat:'esprit',emoji:'ğŸ“–',titre:'Lire un livre ou un roman',
   amis:['ChloÃ©','Nicolas','David','Jonas','Julie','Alicia','Franck']},
  {type:'private',id:'etire',cat:'corps',emoji:'ğŸ¤¸',titre:'Ã‰tirements corporels',
   amis:['Anna','Nicolas','David','Jonas','Julie','Alicia','Franck']},
  {type:'private',id:'ranger',cat:'vie',emoji:'ğŸ§½',titre:'Rangement ou mÃ©nage',
   amis:['ChloÃ©','Nicolas','David','Jonas','Julie','Alicia','Franck']},
  {type:'private',id:'creer',cat:'loisirs',emoji:'ğŸ¸',titre:'CrÃ©er ou jouer',
   amis:['Ben','Pauline','Nicolas','David','Jonas','Julie','Alicia','Franck']},
  {type:'private',id:'respirer',cat:'repos',emoji:'ğŸŒ¬ï¸',titre:'Respiration cohÃ©rence cardiaque',
   amis:['Anna','Marie','Nicolas','David','Jonas','Julie','Alicia','Franck']}
];

// Colocation
const GROUP_CHALLENGES = [
  {type:'group',id:'coloc_lv_range',cat:'coloc',emoji:'ğŸ½ï¸',titre:'Lave-vaisselle vidÃ© & rangÃ©',
   amis:['Anna','Ben','ChloÃ©','Nicolas','Marie','Franck','Alexandra']},
  {type:'group',id:'coloc_poubelles',cat:'coloc',emoji:'ğŸ—‘ï¸',titre:'Poubelles & tri sortis',
   amis:['Anna','Ben','ChloÃ©','Nicolas','Marie','Franck','Alexandra']},
  {type:'group',id:'coloc_plantes',cat:'coloc',emoji:'ğŸª´',titre:'Arrosage des plantes',
   amis:['Anna','Ben','ChloÃ©','Nicolas','Marie','Franck','Alexandra']}
];

// Famille (7 jardiniers dont Papa, Maman, Papi, Mami)
const FAMILY_JARDINIERS = ['Papa','Maman','Papi','Mami','David','Jonas','Julie'];
const FAMILY_CHALLENGES = [
  {type:'group',id:'fam_linge',cat:'famille',emoji:'ğŸ‘•',titre:'Linge lavÃ©, sÃ©chÃ©, pliÃ©',
   amis:[...FAMILY_JARDINIERS]},
  {type:'group',id:'fam_poubelles',cat:'famille',emoji:'â™»ï¸',titre:'Tri & poubelles sorties',
   amis:[...FAMILY_JARDINIERS]}
];

// Association (15â€“20 jardiniers, sans Papa/Maman)
const ASSO_JARDINIERS = ['Alice','Bruno','Camille','Dina','Mehdi','Sarah','Youssef','LÃ©a','Tom','Nina','Quentin','Samir','Eva','Rania','Paul','Julie','Hugo','Clara'];
const ASSOCIATION_CHALLENGES = [
  {type:'group',id:'asso_salle',cat:'asso',emoji:'ğŸŸï¸',titre:'Salle prÃªte (chaises, sono)',
   amis:[...ASSO_JARDINIERS]}
];

// Bureau (15â€“20 jardiniers)
const OFFICE_JARDINIERS = ['Alice','Bob','Carla','Dan','Emma','Lucas','Sophie','Mehdi','Julie','Quentin','LÃ©a','Thomas','InÃ¨s','Nicolas','Sarah','Paul','Camille','Hugo'];
const OFFICE_CHALLENGES = [
  {type:'group',id:'bureau_plantes',cat:'bureau',emoji:'ğŸª´',titre:'Plantes arrosÃ©es',
   amis:[...OFFICE_JARDINIERS]},
  {type:'group',id:'bureau_salle_reu',cat:'bureau',emoji:'ğŸ¢',titre:'Salle de rÃ©union remise en ordre',
   amis:[...OFFICE_JARDINIERS]}
];

// Classe (15â€“20 jardiniers)
const CLASS_JARDINIERS = ['M. Dupont','Emma','Lucas','Lucie','Yanis','Clara','Noa','Lina','Hugo','Manon','Elias','ZoÃ©','MattÃ©o','Sarah','Nolan','InÃ¨s','LÃ©o','Jade'];
const CLASS_CHALLENGES = [
  {type:'group',id:'classe_tri',cat:'classe',emoji:'â™»ï¸',titre:'Tri & poubelles sorties',
   amis:[...CLASS_JARDINIERS]}
];

// BibliothÃ¨que logistique : 20 habitudes non numÃ©riques, organisÃ©es en 10 catÃ©gories
const LIBRARY_HABITS = [
  /* =========================
   * INDIVIDUEL (10)
   * ========================= */
  {
    id:'lib_indiv_lit',
    cat:'individuel',
    emoji:'ğŸ›ï¸',
    titre:'Lit fait au rÃ©veil',
    type:'private',
    scope:'indiv',
    modeDefault:'libre',
    freqDefault:'quotidien',
    baseMin:5,
    recurrence:7,
    desc:"Commence par lisser la couette et aligner les oreillers.\nRÃ¨gle-toi une mini rÃ¨gle : lit fait avant de sortir de la chambre.\nObserve la diffÃ©rence de sensation le soir en revenant te coucher."
  },
  {
    id:'lib_indiv_sac',
    cat:'individuel',
    emoji:'ğŸ’',
    titre:'Sac / affaires pour demain prÃ©parÃ©s',
    type:'private',
    scope:'indiv',
    modeDefault:'libre',
    freqDefault:'quotidien',
    baseMin:10,
    recurrence:5,
    desc:"PrÃ©pare ton sac toujours au mÃªme endroit (entrÃ©e, bureau...).\nVÃ©rifie les 3 essentiels : documents, clÃ©s, bouteille dâ€™eau.\nTermine en posant le sac lÃ  oÃ¹ tu ne pourras pas lâ€™oublier."
  },
  {
    id:'lib_indiv_tenue',
    cat:'individuel',
    emoji:'ğŸ‘•',
    titre:'Tenue du lendemain prÃªte',
    type:'private',
    scope:'indiv',
    modeDefault:'libre',
    freqDefault:'quotidien',
    baseMin:8,
    recurrence:5,
    desc:"Choisis une tenue adaptÃ©e Ã  la mÃ©tÃ©o et Ã  ton agenda.\nPose les vÃªtements Ã  un endroit visible, prÃªts Ã  Ãªtre enfilÃ©s.\nDÃ©cide une fois pour toutes pour Ã©viter de rÃ©flÃ©chir le matin."
  },
  {
    id:'lib_indiv_rangement_10',
    cat:'individuel',
    emoji:'ğŸ§¹',
    titre:'10 minutes de rangement perso',
    type:'private',
    scope:'individuel',
    modeDefault:'libre',
    freqDefault:'quotidien',
    baseMin:10,
    recurrence:5,
    desc:"Choisis une mini-zone : bureau, table de chevet, commode.\nMets un timer de 10 minutes et ne fais quâ€™une seule catÃ©gorie dâ€™objets.\nArrÃªte-toi Ã  la sonnerie mÃªme si ce nâ€™est pas parfait."
  },
  {
    id:'lib_indiv_lavabo',
    cat:'individuel',
    emoji:'ğŸš¿',
    titre:'Lavabo et miroir propres',
    type:'private',
    scope:'individuel',
    modeDefault:'libre',
    freqDefault:'hebdo',
    baseMin:8,
    recurrence:2,
    desc:"Passe un coup dâ€™Ã©ponge rapide sur le lavabo aprÃ¨s la douche.\nEssuie les projections sur le miroir avec un chiffon microfibre.\nGarde un produit et un chiffon visibles pour diminuer la friction."
  },
  {
    id:'lib_indiv_papiers',
    cat:'individuel',
    emoji:'ğŸ“‚',
    titre:'Tri express des papiers perso',
    type:'private',
    scope:'individuel',
    modeDefault:'libre',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"SÃ©pare en trois piles : Ã  garder, Ã  traiter, Ã  jeter.\nRange uniquement la pile Â« Ã  garder Â» dans un classeur simple.\nNote sur un post-it ce quâ€™il reste Ã  faire pour les papiers Â« Ã  traiter Â»."
  },
  {
    id:'lib_indiv_lavage_main',
    cat:'individuel',
    emoji:'ğŸ§º',
    titre:'Petite lessive rapide Ã  la main',
    type:'private',
    scope:'individuel',
    modeDefault:'libre',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"RepÃ¨re 2â€“3 piÃ¨ces lÃ©gÃ¨res Ã  laver (chaussettes, sous-vÃªtements).\nRemplis un lavabo avec un peu de lessive et de lâ€™eau tiÃ¨de.\nEssore doucement et suspends tout de suite sur un cintre ou un sÃ©choir."
  },
  {
    id:'lib_indiv_vidange_sac',
    cat:'individuel',
    emoji:'ğŸ‘œ',
    titre:'Sac vidÃ© et rÃ©organisÃ©',
    type:'private',
    scope:'individuel',
    modeDefault:'libre',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"Vide tout le contenu sur une table.\nJette tickets et papiers inutiles, range les objets par thÃ¨me.\nDÃ©cide dâ€™un emplacement fixe pour clÃ©s, portefeuille et tÃ©lÃ©phone."
  },
  {
    id:'lib_indiv_tiroir',
    cat:'individuel',
    emoji:'ğŸ—„ï¸',
    titre:'Un tiroir mis en ordre',
    type:'private',
    scope:'individuel',
    modeDefault:'libre',
    freqDefault:'mensuel',
    baseMin:20,
    recurrence:1,
    desc:"Choisis un seul tiroir et engage-toi Ã  nâ€™en faire quâ€™un.\nRegroupe les objets par usage (bureau, salle de bain, cuisineâ€¦).\nGarde une petite boÃ®te ou pot pour les petits Ã©lÃ©ments qui se perdent."
  },
  {
    id:'lib_indiv_don',
    cat:'individuel',
    emoji:'ğŸ',
    titre:'Un sac pour donner / recycler',
    type:'private',
    scope:'individuel',
    modeDefault:'libre',
    freqDefault:'mensuel',
    baseMin:15,
    recurrence:1,
    desc:"Prends un sac dÃ©diÃ© aux objets Ã  donner.\nChoisis 5 Ã  10 objets que tu nâ€™utilises plus mais encore en bon Ã©tat.\nNote un jour prÃ©cis pour dÃ©poser le sac en point de collecte ou association."
  },

  /* =========================
   * COLOCATION (10)
   * ========================= */
  {
    id:'lib_coloc_plan_cuisine',
    cat:'coloc',
    emoji:'ğŸ²',
    titre:'Plan rapide de la cuisine partagÃ©e',
    type:'group',
    scope:'coloc',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Ensemble, regardez lâ€™Ã©tat du plan de travail, de lâ€™Ã©vier et du frigo.\nNotez 3 actions simples pour que la cuisine soit Â« prÃªte Ã  vivre Â».\nRÃ©partissez les actions entre vous pour que Ã§a reste lÃ©ger."
  },
  {
    id:'lib_coloc_entree',
    cat:'coloc',
    emoji:'ğŸšª',
    titre:'EntrÃ©e dÃ©gagÃ©e (chaussures, colis)',
    type:'group',
    scope:'coloc',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"Ramenez toutes les chaussures Ã  un endroit dÃ©fini.\nEmpilez ou rangez les colis pour libÃ©rer lâ€™espace au sol.\nTerminez en vÃ©rifiant que la porte sâ€™ouvre sans obstacle."
  },
  {
    id:'lib_coloc_poubelles',
    cat:'coloc',
    emoji:'ğŸ—‘ï¸',
    titre:'Tour des poubelles et tri',
    type:'group',
    scope:'coloc',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:2,
    desc:"VÃ©rifiez toutes les poubelles de lâ€™appartement en une fois.\nSÃ©parez bien recyclables, verre et ordures mÃ©nagÃ¨res.\nDÃ©signez Ã  lâ€™avance qui sort quoi pour Ã©viter les malentendus."
  },
  {
    id:'lib_coloc_lv',
    cat:'coloc',
    emoji:'ğŸ½ï¸',
    titre:'Lave-vaisselle lancÃ© ou vidÃ©',
    type:'group',
    scope:'coloc',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:10,
    recurrence:5,
    desc:"DÃ©cidez une rÃ¨gle simple : lancer ou vider avant de se coucher.\nRangez la vaisselle propre Ã  un endroit cohÃ©rent pour tous.\nUtilisez un petit magnet Â« propre / sale Â» pour Ã©viter les doutes."
  },
  {
    id:'lib_coloc_plantes',
    cat:'coloc',
    emoji:'ğŸª´',
    titre:'Plantes de la coloc arrosÃ©es',
    type:'group',
    scope:'coloc',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"Faites un tour rapide de toutes les plantes visibles.\nTouchez la terre pour dÃ©cider si un arrosage est nÃ©cessaire.\nNotez sur un post-it la date du dernier arrosage pour la prochaine fois."
  },
  {
    id:'lib_coloc_surface_salon',
    cat:'coloc',
    emoji:'ğŸ›‹ï¸',
    titre:'Surfaces du salon dÃ©gagÃ©es',
    type:'group',
    scope:'coloc',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Videz la table basse et les accoudoirs de canapÃ©.\nRangez livres, consoles et cÃ¢bles chacun Ã  leur place.\nFinissez par un coup de chiffon rapide sur la table principale."
  },
  {
    id:'lib_coloc_frigo_commun',
    cat:'coloc',
    emoji:'ğŸ¥«',
    titre:'Zone Â« commun Â» du frigo rangÃ©e',
    type:'group',
    scope:'coloc',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"RepÃ©rez la partie du frigo dÃ©diÃ©e aux produits partagÃ©s.\nJetez ce qui est clairement pÃ©rimÃ© et regroupez par type.\nCollez un petit papier pour noter les produits Ã  racheter bientÃ´t."
  },
  {
    id:'lib_coloc_calendrier',
    cat:'coloc',
    emoji:'ğŸ“…',
    titre:'Point calendrier coloc de la semaine',
    type:'group',
    scope:'coloc',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"En 10 minutes, partagez vos gros Ã©vÃ©nements de la semaine.\nNotez les moments oÃ¹ lâ€™appart sera trÃ¨s occupÃ© ou trÃ¨s calme.\nDÃ©cidez dâ€™un soir Â« calme Â» pour mÃ©nage ou temps commun."
  },
  {
    id:'lib_coloc_coin_depot',
    cat:'coloc',
    emoji:'ğŸ“¦',
    titre:'Coin dÃ©pÃ´t organisÃ© (livres, colis, prÃªts)',
    type:'group',
    scope:'coloc',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"Choisissez un coin unique pour tout ce qui doit Â« repartir Â».\nSÃ©parez ce qui est Ã  rendre, Ã  renvoyer, Ã  donner.\nNotez un jour cible pour vider ce coin toutes les 1â€“2 semaines."
  },
  {
    id:'lib_coloc_bain',
    cat:'coloc',
    emoji:'ğŸ§´',
    titre:'Salle de bain prÃªte pour le suivant',
    type:'group',
    scope:'coloc',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:8,
    recurrence:5,
    desc:"Ramassez cheveux, serviettes et vÃªtements laissÃ©s au sol.\nEssuyez rapidement le lavabo ou la douche sâ€™ils sont trÃ¨s mouillÃ©s.\nGardez une Ã©ponge ou un chiffon toujours accessible dans la salle de bain."
  },

  /* =========================
   * FAMILLE (10)
   * ========================= */
  {
    id:'lib_fam_table',
    cat:'famille',
    emoji:'ğŸ½ï¸',
    titre:'Table mise / dÃ©barrassÃ©e ensemble',
    type:'group',
    scope:'famille',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:15,
    recurrence:7,
    desc:"Attribuez Ã  chacun un rÃ´le simple : couverts, assiettes, eau.\nUtilisez toujours le mÃªme ordre : mettre, manger, dÃ©barrasser, essuyer.\nTerminez par un petit Â« merci Ã  tous Â» pour ancrer le rituel."
  },
  {
    id:'lib_fam_cartable',
    cat:'famille',
    emoji:'ğŸ’',
    titre:'Cartables et manteaux Ã  leur place',
    type:'group',
    scope:'famille',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:10,
    recurrence:5,
    desc:"Fixez une zone dâ€™accrochage unique pour manteaux et sacs.\nVÃ©rifiez chaque soir si le cartable est prÃªt pour le lendemain.\nLaissez les enfants cocher eux-mÃªmes leur mini check-list."
  },
  {
    id:'lib_fam_pyjama_dent',
    cat:'famille',
    emoji:'ğŸª¥',
    titre:'Routine du soir enfants coordonnÃ©e',
    type:'group',
    scope:'famille',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:15,
    recurrence:7,
    desc:"EnchaÃ®nez toujours dans le mÃªme ordre : douche, pyjama, dents.\nUtilisez un minuteur ludique pour le brossage.\nTerminez par un moment calme pour Ã©viter les allers-retours."
  },
  {
    id:'lib_fam_jouets',
    cat:'famille',
    emoji:'ğŸ§¸',
    titre:'Jouets rangÃ©s dans leur Â« maison Â»',
    type:'group',
    scope:'famille',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:10,
    recurrence:6,
    desc:"Donnez Ã  chaque type de jouet une boÃ®te ou un panier dÃ©diÃ©.\nInstallez un jeu : tout doit Â« rentrer Ã  la maison Â» avant le dÃ®ner.\nValorisez les efforts plutÃ´t que le rÃ©sultat parfait."
  },
  {
    id:'lib_fam_course_rapide',
    cat:'famille',
    emoji:'ğŸ›’',
    titre:'Petite liste de courses en famille',
    type:'group',
    scope:'famille',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Parcourez le frigo et les placards avec un carnet.\nDemandez aux enfants de nommer ce quâ€™ils veulent garder comme habitude saine.\nSÃ©parez clairement Â« indispensable Â» et Â« bonus Â» sur la liste."
  },
  {
    id:'lib_fam_linge',
    cat:'famille',
    emoji:'ğŸ‘•',
    titre:'Panier Ã  linge vidÃ© ensemble',
    type:'group',
    scope:'famille',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:20,
    recurrence:1,
    desc:"Choisissez un moment fixe pour lancer les machines en famille.\nLaissez les enfants trier clair / foncÃ© avec votre supervision.\nTransformez le pliage en activitÃ© courte avec musique ou histoire."
  },
  {
    id:'lib_fam_frigo',
    cat:'famille',
    emoji:'ğŸ¥¦',
    titre:'Frigo triÃ© et prÃªt pour la semaine',
    type:'group',
    scope:'famille',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:20,
    recurrence:1,
    desc:"Regroupez ensemble les restes Ã  finir en prioritÃ©.\nJetez ce qui nâ€™est plus consommable sans culpabiliser.\nImaginez un ou deux repas simples Ã  partir de ce qui reste."
  },
  {
    id:'lib_fam_papiers_ecole',
    cat:'famille',
    emoji:'ğŸ“‘',
    titre:'Papiers dâ€™Ã©cole traitÃ©s et rangÃ©s',
    type:'group',
    scope:'famille',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Ouvrez tous les cahiers de liaison en une seule fois.\nRemplissez immÃ©diatement ce qui prend moins de 2 minutes.\nPrÃ©parez une chemise dÃ©diÃ©e aux papiers Ã  traiter plus tard."
  },
  {
    id:'lib_fam_point_agenda',
    cat:'famille',
    emoji:'ğŸ“†',
    titre:'Mini point agenda familial',
    type:'group',
    scope:'famille',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Notez sur un tableau les grandes activitÃ©s de la semaine.\nRepÃ©rez les soirs chargÃ©s pour organiser repas ou trajets.\nLaissez un espace pour que chacun ajoute un souhait ou un besoin."
  },
  {
    id:'lib_fam_dimanche_rgt',
    cat:'famille',
    emoji:'ğŸ¡',
    titre:'15 minutes Â« maison prÃªte pour lundi Â»',
    type:'group',
    scope:'famille',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Choisissez 2 Ã  3 zones prioritaires : entrÃ©e, salon, cuisine.\nMettez un timer et gardez une ambiance lÃ©gÃ¨re.\nLâ€™objectif est de rendre le lundi matin plus fluide, pas dâ€™Ãªtre parfait."
  },

  /* =========================
   * ASSOCIATION (10)
   * ========================= */
  {
    id:'lib_asso_stock',
    cat:'asso',
    emoji:'ğŸ“¦',
    titre:'VÃ©rification rapide du stock matÃ©riel',
    type:'group',
    scope:'asso',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:20,
    recurrence:1,
    desc:"Listez les 5 familles dâ€™objets clÃ©s (gobelets, feuilles, cÃ¢blesâ€¦).\nComptez de maniÃ¨re approximative et notez ce qui descend vite.\nMettez Ã  jour une liste partagÃ©e pour les prochains achats."
  },
  {
    id:'lib_asso_salle_plan',
    cat:'asso',
    emoji:'ğŸª‘',
    titre:'Salle remise selon le plan prÃ©vu',
    type:'group',
    scope:'asso',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:20,
    recurrence:1,
    desc:"Gardez une photo ou un schÃ©ma de la salle Â« en ordre Â».\nReplacez les chaises et tables comme sur la rÃ©fÃ©rence.\nVÃ©rifiez sol, tableau et poubelles avant de quitter la salle."
  },
  {
    id:'lib_asso_accueil',
    cat:'asso',
    emoji:'ğŸ¤',
    titre:'Zone dâ€™accueil prÃªte pour les membres',
    type:'group',
    scope:'asso',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"PrÃ©parez une table claire pour lâ€™Ã©margement ou lâ€™accueil.\nRangez sacs et cartons derriÃ¨re un mÃªme repÃ¨re.\nAffichez clairement les infos essentielles de la sÃ©ance."
  },
  {
    id:'lib_asso_buvette',
    cat:'asso',
    emoji:'â˜•',
    titre:'Coin boisson / buvette rangÃ©',
    type:'group',
    scope:'asso',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Essuyez les surfaces collantes ou tachÃ©es.\nRangez gobelets, verres et boissons dans un ordre logique.\nJetez les restes clairement impropres Ã  la consommation."
  },
  {
    id:'lib_asso_com',
    cat:'asso',
    emoji:'ğŸ“£',
    titre:'Point communication de la semaine',
    type:'group',
    scope:'asso',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:20,
    recurrence:1,
    desc:"Listez les infos Ã  transmettre aux membres cette semaine.\nDÃ©cidez de 1 ou 2 canaux seulement (mail, groupe, affiche).\nNotez qui est responsable dâ€™envoyer chaque message."
  },
  {
    id:'lib_asso_rangement_casier',
    cat:'asso',
    emoji:'ğŸ—ƒï¸',
    titre:'Casier de lâ€™association triÃ©',
    type:'group',
    scope:'asso',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:25,
    recurrence:1,
    desc:"Videz le casier sur une table pour tout voir.\nJetez ou recyclez les documents pÃ©rimÃ©s ou inutiles.\nClassez le reste en 3 pochettes : administratif, com, matÃ©riel."
  },
  {
    id:'lib_asso_suivi_event',
    cat:'asso',
    emoji:'ğŸ“',
    titre:'Mini dÃ©brief matÃ©riel aprÃ¨s Ã©vÃ©nement',
    type:'group',
    scope:'asso',
    modeDefault:'commun',
    freqDefault:'ponctuelle',
    baseMin:15,
    recurrence:1,
    desc:"Notez Ã  chaud ce qui a manquÃ© ou Ã©tÃ© en surplus.\nAjoutez ces remarques dans un document partagÃ©.\nDÃ©cidez dâ€™un point Ã  tester ou amÃ©liorer pour le prochain Ã©vÃ©nement."
  },
  {
    id:'lib_asso_affichage',
    cat:'asso',
    emoji:'ğŸ§¾',
    titre:'Panneau dâ€™affichage mis Ã  jour',
    type:'group',
    scope:'asso',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Retirez les annonces obsolÃ¨tes ou passÃ©es.\nPlacez les infos essentielles Ã  hauteur de regard.\nLaissez un espace clair pour les prochaines affiches."
  },
  {
    id:'lib_asso_clefs',
    cat:'asso',
    emoji:'ğŸ”‘',
    titre:'ClÃ©s et accÃ¨s contrÃ´lÃ©s',
    type:'group',
    scope:'asso',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:10,
    recurrence:1,
    desc:"Listez qui possÃ¨de quelles clÃ©s ou codes dâ€™accÃ¨s.\nVÃ©rifiez si certaines personnes nâ€™en ont plus besoin.\nNotez un rappel pour rÃ©cupÃ©rer ou changer les accÃ¨s si nÃ©cessaire."
  },
  {
    id:'lib_asso_securite',
    cat:'asso',
    emoji:'ğŸ§¯',
    titre:'Petit check sÃ©curitÃ© de la salle',
    type:'group',
    scope:'asso',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:15,
    recurrence:1,
    desc:"VÃ©rifiez que les issues de secours sont dÃ©gagÃ©es.\nRepÃ©rez lâ€™emplacement de lâ€™extincteur et de la trousse de secours.\nNotez toute anomalie Ã  signaler au gestionnaire du lieu."
  },

  /* =========================
   * CLASSE (10)
   * ========================= */
  {
    id:'lib_classe_tableau',
    cat:'classe',
    emoji:'ğŸ§½',
    titre:'Tableau nettoyÃ© et lisible',
    type:'group',
    scope:'classe',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:5,
    recurrence:5,
    desc:"Effacez complÃ¨tement le tableau Ã  la fin du cours.\nRangez feutres ou craies Ã  un endroit unique.\nÃ‰crivez dÃ©jÃ  un titre ou la date pour la sÃ©ance suivante si besoin."
  },
  {
    id:'lib_classe_coin_doc',
    cat:'classe',
    emoji:'ğŸ“š',
    titre:'Coin documents triÃ©',
    type:'group',
    scope:'classe',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:20,
    recurrence:1,
    desc:"SÃ©parez documents pour les Ã©lÃ¨ves et pour lâ€™enseignant.\nJetez les photocopies inutiles ou trop abÃ®mÃ©es.\nRangez les polycopiÃ©s dans des dossiers clairement Ã©tiquetÃ©s."
  },
  {
    id:'lib_classe_bancs',
    cat:'classe',
    emoji:'ğŸª‘',
    titre:'Tables et chaises alignÃ©es',
    type:'group',
    scope:'classe',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:5,
    recurrence:5,
    desc:"Demandez Ã  chaque Ã©lÃ¨ve de remettre sa chaise bien en place.\nVÃ©rifiez que les tables permettent de circuler facilement.\nFaites un dernier tour pour dÃ©gager les sacs des passages."
  },
  {
    id:'lib_classe_materiel_eleve',
    cat:'classe',
    emoji:'âœï¸',
    titre:'MatÃ©riel dâ€™Ã©lÃ¨ve prÃªt pour le prochain cours',
    type:'group',
    scope:'classe',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:8,
    recurrence:5,
    desc:"Prenez 2 minutes pour vÃ©rifier stylos, cahiers, trousse.\nRangez ce qui traÃ®ne au fond du sac dans un seul cahier.\nEncouragez les Ã©lÃ¨ves Ã  cocher une mini check-list de matÃ©riel."
  },
  {
    id:'lib_classe_etageres',
    cat:'classe',
    emoji:'ğŸ“¦',
    titre:'Ã‰tagÃ¨res de classe rangÃ©es',
    type:'group',
    scope:'classe',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Assignez Ã  quelques Ã©lÃ¨ves la responsabilitÃ© dâ€™une Ã©tagÃ¨re.\nRangez les manuels et cahiers par niveau ou matiÃ¨re.\nGardez une zone Â« Ã  ranger plus tard Â» clairement identifiÃ©e."
  },
  {
    id:'lib_classe_tech',
    cat:'classe',
    emoji:'ğŸ’»',
    titre:'MatÃ©riel numÃ©rique prÃªt',
    type:'group',
    scope:'classe',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Testez rapidement lâ€™ordinateur, le vidÃ©oprojecteur ou les enceintes.\nPrÃ©parez le fichier ou le diaporama du dÃ©but de sÃ©ance.\nNotez les Ã©ventuels soucis techniques dans un carnet."
  },
  {
    id:'lib_classe_affichage',
    cat:'classe',
    emoji:'ğŸ–¼ï¸',
    titre:'Affichages muraux actualisÃ©s',
    type:'group',
    scope:'classe',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:20,
    recurrence:1,
    desc:"Retirez les affiches qui ne servent plus ou sont abÃ®mÃ©es.\nMettez en avant les productions rÃ©centes des Ã©lÃ¨ves.\nLaissez un espace libre pour les prochains projets."
  },
  {
    id:'lib_classe_coin_calme',
    cat:'classe',
    emoji:'ğŸ§˜â€â™€ï¸',
    titre:'Petit coin calme rangÃ©',
    type:'group',
    scope:'classe',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"DÃ©finissez une zone fixe pour le coin calme ou lecture.\nRangez coussins, livres et jeux Ã  un endroit clair.\nRappelez en dÃ©but de semaine Ã  quoi sert cet espace."
  },
  {
    id:'lib_classe_retu',
    cat:'classe',
    emoji:'ğŸ“¬',
    titre:'Pochettes de retours / devoirs organisÃ©es',
    type:'group',
    scope:'classe',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"SÃ©parez clairement devoirs Ã  rendre, devoirs corrigÃ©s et Ã  distribuer.\nCollez une Ã©tiquette simple sur chaque pochette.\nVÃ©rifiez quâ€™aucune copie ne reste coincÃ©e dans le fond dâ€™un sac."
  },
  {
    id:'lib_classe_couloir',
    cat:'classe',
    emoji:'ğŸš¶â€â™‚ï¸',
    titre:'Couloir devant la classe dÃ©gagÃ©',
    type:'group',
    scope:'classe',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:5,
    recurrence:1,
    desc:"VÃ©rifiez quâ€™aucun cartable ou banc ne bloque lâ€™entrÃ©e.\nRangez le matÃ©riel de sport ou dâ€™arts plastiques Ã  lâ€™intÃ©rieur.\nAssurez-vous que les issues restent faciles Ã  utiliser."
  },

  /* =========================
   * BUREAU (10)
   * ========================= */
  {
    id:'lib_bureau_postes',
    cat:'bureau',
    emoji:'ğŸ§¹',
    titre:'Postes de travail dÃ©gagÃ©s',
    type:'group',
    scope:'bureau',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Videz les surfaces des bureaux des papiers inutiles.\nRegroupez cÃ¢bles et chargeurs dans une boÃ®te ou un tiroir.\nGardez au moins un coin de table totalement libre par poste."
  },
  {
    id:'lib_bureau_salle_reu',
    cat:'bureau',
    emoji:'ğŸ¢',
    titre:'Salle de rÃ©union remise en ordre',
    type:'group',
    scope:'bureau',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:20,
    recurrence:1,
    desc:"Rangez chaises et tables comme sur la configuration de base.\nÃ‰vacuez gobelets, papiers et marqueurs usÃ©s.\nLaissez le support de prÃ©sentation prÃªt pour la prochaine rÃ©union."
  },
  {
    id:'lib_bureau_inbox',
    cat:'bureau',
    emoji:'ğŸ“¥',
    titre:'Inbox papier triÃ©e',
    type:'group',
    scope:'bureau',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Rassemblez toutes les feuilles qui traÃ®nent dans une bannette.\nClassez-les en trois piles : Ã  traiter, Ã  archiver, Ã  jeter.\nRangez immÃ©diatement ce qui est Ã  archiver."
  },
  {
    id:'lib_bureau_point_agenda',
    cat:'bureau',
    emoji:'ğŸ—“ï¸',
    titre:'Point agenda dâ€™Ã©quipe rapide',
    type:'group',
    scope:'bureau',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Passez les 10 prochaines journÃ©es en revue avec lâ€™Ã©quipe.\nRepÃ©rez les pÃ©riodes de forte charge ou de rÃ©unions serrÃ©es.\nDÃ©cidez dâ€™une prioritÃ© claire pour la semaine."
  },
  {
    id:'lib_bureau_print',
    cat:'bureau',
    emoji:'ğŸ–¨ï¸',
    titre:'Coin imprimante rangÃ©',
    type:'group',
    scope:'bureau',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"Rangez ramettes de papier, toners et bacs de sortie.\nSupprimez les impressions oubliÃ©es et confidentielles.\nAffichez une petite consigne pour Ã©viter le gÃ¢chis de papier."
  },
  {
    id:'lib_bureau_snack',
    cat:'bureau',
    emoji:'ğŸ',
    titre:'Zone snack / cafÃ© propre',
    type:'group',
    scope:'bureau',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"Essuyez la machine Ã  cafÃ©, la table et les taches visibles.\nJetez les emballages vides et capsules usagÃ©es.\nRangez sucre, thÃ© et tasses dans un ordre simple."
  },
  {
    id:'lib_bureau_casiers',
    cat:'bureau',
    emoji:'ğŸ—„ï¸',
    titre:'Casiers ou placards dâ€™Ã©quipe triÃ©s',
    type:'group',
    scope:'bureau',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:25,
    recurrence:1,
    desc:"Videz un casier Ã  la fois pour Ã©viter le chaos.\nDÃ©cidez ce qui sert vraiment encore Ã  lâ€™Ã©quipe.\nRangez par thÃ©matique : papeterie, informatique, archives."
  },
  {
    id:'lib_bureau_todolist',
    cat:'bureau',
    emoji:'âœ…',
    titre:'To-do physique mise Ã  jour',
    type:'group',
    scope:'bureau',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"Passez en revue les tÃ¢ches affichÃ©es au mur ou sur un tableau.\nBarrez clairement ce qui est terminÃ©.\nChoisissez 3 tÃ¢ches maximum Ã  mettre en avant pour la semaine."
  },
  {
    id:'lib_bureau_zone_repos',
    cat:'bureau',
    emoji:'ğŸ›‹ï¸',
    titre:'Coin pause agrÃ©able',
    type:'group',
    scope:'bureau',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"Rassemblez magazines, jeux, coussins ou plantes dans la zone.\nEnlevez les dossiers de travail pour limiter la pollution visuelle.\nAjoutez un petit rappel pour garder lâ€™espace propre aprÃ¨s usage."
  },
  {
    id:'lib_bureau_sortie_jour',
    cat:'bureau',
    emoji:'ğŸšª',
    titre:'Bureau prÃªt pour le lendemain en partant',
    type:'group',
    scope:'bureau',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:5,
    recurrence:5,
    desc:"Avant de partir, libÃ©rez la moitiÃ© de votre surface de travail.\nRangez le dossier en cours dans une chemise unique.\nNotez la toute prochaine action sur un post-it visible."
  },

  /* =========================
   * CUISINE (10)
   * ========================= */
  {
    id:'lib_cuisine_plan',
    cat:'cuisine',
    emoji:'ğŸ§½',
    titre:'Plan de travail vidÃ© & essuyÃ©',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:10,
    recurrence:7,
    desc:"Rangez tout ce qui nâ€™a rien Ã  faire sur le plan de travail.\nPassez une Ã©ponge ou un chiffon rapidement aprÃ¨s le repas.\nGardez un petit panier pour les objets Â« Ã  ranger plus tard Â»."
  },
  {
    id:'lib_cuisine_frigo',
    cat:'cuisine',
    emoji:'ğŸ¥¦',
    titre:'Frigo triÃ© (rapide)',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Regroupez devant ce qui est Ã  consommer rapidement.\nJetez ce qui est clairement pÃ©rimÃ©.\nProfitez-en pour essuyer une Ã©tagÃ¨re si elle est collante."
  },
  {
    id:'lib_cuisine_vaisselle',
    cat:'cuisine',
    emoji:'ğŸ½ï¸',
    titre:'Ã‰vier vidÃ© avant de se coucher',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:10,
    recurrence:7,
    desc:"Rincez ou lavez la vaisselle avant dâ€™aller dormir.\nRangez ce qui sÃ¨che dÃ¨s que possible pour libÃ©rer la place.\nLâ€™objectif : se rÃ©veiller avec un Ã©vier confortable."
  },
  {
    id:'lib_cuisine_hot',
    cat:'cuisine',
    emoji:'ğŸ”¥',
    titre:'Plaques et hotte essuyÃ©es',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"AprÃ¨s une cuisson, laissez refroidir puis essuyez projections et graisse.\nConcentrez-vous sur les zones les plus visibles.\nGardez une Ã©ponge dÃ©diÃ©e pour Ã©viter dâ€™abÃ®mer la surface."
  },
  {
    id:'lib_cuisine_tiroir_couverts',
    cat:'cuisine',
    emoji:'ğŸ´',
    titre:'Tiroir Ã  couverts organisÃ©',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:15,
    recurrence:1,
    desc:"Videz le tiroir et nettoyez le fond si besoin.\nTriez les couverts par type et retirez les doublons inutiles.\nAjoutez un sÃ©parateur simple si tout se mÃ©lange."
  },
  {
    id:'lib_cuisine_epices',
    cat:'cuisine',
    emoji:'ğŸŒ¶ï¸',
    titre:'Ã‰pices et condiments triÃ©s',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:20,
    recurrence:1,
    desc:"Regroupez les Ã©pices au mÃªme endroit pour mieux les voir.\nNotez celles que vous utilisez vraiment.\nJetez ou recyclez les anciens pots vides ou cassÃ©s."
  },
  {
    id:'lib_cuisine_reserve_seche',
    cat:'cuisine',
    emoji:'ğŸ¥«',
    titre:'RÃ©serves sÃ¨ches rangÃ©es',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:25,
    recurrence:1,
    desc:"Rassemblez pÃ¢tes, riz, lÃ©gumineuses et conserves.\nPlacez devant ce qui est dÃ©jÃ  entamÃ© ou Ã  finir.\nCollez une petite note avec 2â€“3 idÃ©es de repas simples."
  },
  {
    id:'lib_cuisine_poubelle',
    cat:'cuisine',
    emoji:'â™»ï¸',
    titre:'Poubelles cuisine propres et triÃ©es',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Videz toutes les poubelles de la cuisine en une seule fois.\nNettoyez rapidement bac et couvercle si odeur ou traces.\nCollez un rappel des consignes de tri Ã  proximitÃ©."
  },
  {
    id:'lib_cuisine_table',
    cat:'cuisine',
    emoji:'ğŸ½',
    titre:'Table de repas prÃªte',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:5,
    recurrence:7,
    desc:"DÃ©gagez complÃ¨tement la table avant de mettre la nourriture.\nPosez couverts, verres et serviettes avant dâ€™appeler tout le monde.\nRangez immÃ©diatement ce qui nâ€™est pas liÃ© au repas."
  },
  {
    id:'lib_cuisine_machine',
    cat:'cuisine',
    emoji:'ğŸ§¼',
    titre:'Machine (lave-vaisselle ou lave-linge) programmÃ©e',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:2,
    desc:"Regroupez ce que vous voulez laver ou nettoyer.\nLancez ou programmez la machine Ã  un horaire pertinent.\nNotez mentalement un moment pour vider dÃ¨s la fin du cycle."
  },

  /* =========================
   * LINGE (10)
   * ========================= */
  {
    id:'lib_linge_panier',
    cat:'linge',
    emoji:'ğŸ§º',
    titre:'Panier Ã  linge vidÃ©',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:25,
    recurrence:1,
    desc:"Choisissez un crÃ©neau fixe pour lancer les machines.\nRemplissez la machine sans trop la surcharger.\nLâ€™objectif : repartir chaque semaine dâ€™un panier presque vide."
  },
  {
    id:'lib_linge_rangement',
    cat:'linge',
    emoji:'ğŸ‘”',
    titre:'Linge propre pliÃ© et rangÃ©',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:25,
    recurrence:1,
    desc:"Regroupez les vÃªtements par personne ou par type.\nPliez tout de suite ce qui est sec pour Ã©viter le froissage.\nRangez dans les placards sans laisser de panier plein Ã  cÃ´tÃ©."
  },
  {
    id:'lib_linge_lit',
    cat:'linge',
    emoji:'ğŸ›ï¸',
    titre:'Draps changÃ©s',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:20,
    recurrence:1,
    desc:"Choisissez un jour dÃ©diÃ© au changement des draps.\nPrÃ©parez le nouveau jeu de linge avant de retirer lâ€™ancien.\nProfitez du lit nu pour secouer oreillers et matelas rapidement."
  },
  {
    id:'lib_linge_serviettes',
    cat:'linge',
    emoji:'ğŸ§»',
    titre:'Serviettes de toilette renouvelÃ©es',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"RÃ©cupÃ©rez toutes les serviettes humides dans la maison.\nLancez une machine dÃ©diÃ©e si possible.\nAccrochez tout de suite les serviettes propres pour quâ€™elles sÃ¨chent bien."
  },
  {
    id:'lib_linge_garde_robe',
    cat:'linge',
    emoji:'ğŸ‘—',
    titre:'VÃªtements peu portÃ©s remis en avant',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:20,
    recurrence:1,
    desc:"Recherchez les vÃªtements oubliÃ©s au fond du placard.\nMettez-en quelques-uns en premiÃ¨re ligne pour les porter.\nNotez ce que vous ne mettez vraiment plus pour un futur don."
  },
  {
    id:'lib_linge_cintres',
    cat:'linge',
    emoji:'ğŸª',
    titre:'Cintres libÃ©rÃ©s et ordonnÃ©s',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:10,
    recurrence:1,
    desc:"Enlevez les cintres inutilisÃ©s des portes et dossiers de chaise.\nRegroupez-les prÃ¨s du sÃ©choir ou du placard principal.\nGardez un nombre rÃ©aliste selon vos habitudes."
  },
  {
    id:'lib_linge_taches',
    cat:'linge',
    emoji:'ğŸ§´',
    titre:'Taches traitÃ©es avant lavage',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"RepÃ©rez rapidement les vÃªtements avec des taches voyantes.\nPassez un dÃ©tachant simple sur les zones critiques.\nLancez ensuite la machine pour amÃ©liorer le rÃ©sultat."
  },
  {
    id:'lib_linge_paires_chaussettes',
    cat:'linge',
    emoji:'ğŸ§¦',
    titre:'Chaussettes appairÃ©es',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"Regroupez toutes les chaussettes propres au mÃªme endroit.\nFaites des paires et mettez de cÃ´tÃ© les Â« solitaires Â».\nDÃ©cidez aprÃ¨s quelques semaines quoi faire des orphelines."
  },
  {
    id:'lib_linge_produits',
    cat:'linge',
    emoji:'ğŸ§´',
    titre:'Produits de lessive vÃ©rifiÃ©s',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:10,
    recurrence:1,
    desc:"VÃ©rifiez le niveau de lessive, adoucissant et dÃ©tachant.\nNotez ce quâ€™il faudra racheter avant de tomber Ã  zÃ©ro.\nRepÃ©rez les bidons vides ou presque pour les recycler."
  },
  {
    id:'lib_linge_planning',
    cat:'linge',
    emoji:'ğŸ“†',
    titre:'Planning lessive posÃ©',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:15,
    recurrence:1,
    desc:"DÃ©cidez des jours Â« machines Â» en fonction de vos rythmes.\nRÃ©partissez qui lance et qui Ã©tend.\nAffichez le planning prÃ¨s du panier ou de la machine."
  },

  /* =========================
   * RANGEMENT (10)
   * ========================= */
  {
    id:'lib_rgt_15',
    cat:'rangement',
    emoji:'ğŸ§¹',
    titre:'15 minutes de rangement ciblÃ©',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Choisissez une seule zone : bureau, Ã©tagÃ¨re, entrÃ©e.\nMettez un timer de 15 minutes pour rester concentrÃ©.\nLâ€™objectif est de Â« mieux quâ€™avant Â», pas de finir la piÃ¨ce."
  },
  {
    id:'lib_rgt_papiers',
    cat:'rangement',
    emoji:'ğŸ“‚',
    titre:'Papiers triÃ©s dans un classeur',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:25,
    recurrence:1,
    desc:"Rassemblez tous les papiers dispersÃ©s dans la maison.\nClassez-les par grand thÃ¨me : maison, santÃ©, travail.\nRangez-les dans un classeur simple avec des intercalaires."
  },
  {
    id:'lib_rgt_chaos_tiroir',
    cat:'rangement',
    emoji:'ğŸ§°',
    titre:'Tiroir Â« fourre-tout Â» domptÃ©',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:20,
    recurrence:1,
    desc:"Videz entiÃ¨rement le tiroir sur une surface.\nJetez ce qui est clairement inutile ou cassÃ©.\nRangez par petites boÃ®tes ou pots pour retrouver facilement."
  },
  {
    id:'lib_rgt_entree',
    cat:'rangement',
    emoji:'ğŸšª',
    titre:'EntrÃ©e dÃ©sencombrÃ©e',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Rangez chaussures, sacs et manteaux Ã  des places dÃ©diÃ©es.\nLibÃ©rez le chemin jusquâ€™Ã  la porte.\nAjoutez un panier pour les objets Ã  emporter lors de la prochaine sortie."
  },
  {
    id:'lib_rgt_salon',
    cat:'rangement',
    emoji:'ğŸ›‹ï¸',
    titre:'Salon visuellement apaisÃ©',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"DÃ©gagez la table basse et les surfaces principales.\nRangez cÃ¢bles, chargeurs et objets Ã©lectroniques.\nLaissez quelques Ã©lÃ©ments dÃ©coratifs que vous aimez vraiment."
  },
  {
    id:'lib_rgt_placard',
    cat:'rangement',
    emoji:'ğŸšª',
    titre:'Un placard passÃ© en revue',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:25,
    recurrence:1,
    desc:"Choisissez un placard prÃ©cis et Ã©vitez dâ€™en ouvrir dâ€™autres.\nRegroupez les objets par fonction.\nPrÃ©parez un sac pour ce qui peut Ãªtre donnÃ© ou vendu."
  },
  {
    id:'lib_rgt_jouets_communs',
    cat:'rangement',
    emoji:'ğŸ§¸',
    titre:'Coin jeux commun rangÃ©',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Mettez les jeux de sociÃ©tÃ© complets dans des boÃ®tes fermÃ©es.\nRangez les piÃ¨ces mÃ©langÃ©es dans des sachets transparents.\nLaissez les jeux les plus utilisÃ©s accessibles en premier."
  },
  {
    id:'lib_rgt_bureau_papier',
    cat:'rangement',
    emoji:'ğŸ“',
    titre:'Surface de bureau libÃ©rÃ©e',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"Faites un tas unique avec tout ce qui traÃ®ne sur le bureau.\nRangez dans des dossiers ou jetez ce qui ne sert plus.\nGardez seulement les 2â€“3 choses utiles pour la journÃ©e."
  },
  {
    id:'lib_rgt_coins_invisibles',
    cat:'rangement',
    emoji:'ğŸ§º',
    titre:'Un coin Â« quâ€™on ne voit jamais Â» traitÃ©',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:20,
    recurrence:1,
    desc:"Choisissez un coin discret : dessus dâ€™armoire, dessous de lit.\nDÃ©poussiÃ©rez et triez ce qui y est stockÃ©.\nDÃ©cidez ce qui mÃ©rite vraiment dâ€™y rester."
  },
  {
    id:'lib_rgt_don_regulier',
    cat:'rangement',
    emoji:'ğŸ“¦',
    titre:'Sac de dons rempli et sorti',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:20,
    recurrence:1,
    desc:"Gardez un sac dÃ©diÃ© aux objets Ã  donner.\nAjoutez-y rÃ©guliÃ¨rement vÃªtements ou objets en bon Ã©tat.\nPlanifiez un trajet pour le dÃ©poser dans un point de collecte."
  },

  /* =========================
   * PLANNING / ORGANISATION (10)
   * ========================= */
  {
    id:'lib_org_agenda',
    cat:'planning',
    emoji:'ğŸ—“ï¸',
    titre:'Mini point agenda de la semaine',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Passez ensemble les gros rendez-vous de la semaine.\nRepÃ©rez les jours les plus chargÃ©s.\nChoisissez une seule prioritÃ© par jour au lieu de tout faire."
  },
  {
    id:'lib_org_liste_courses',
    cat:'planning',
    emoji:'ğŸ§¾',
    titre:'Liste de courses commune Ã  jour',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"Regardez frigo et placards avec la liste sous la main.\nAjoutez les produits qui manquent vraiment.\nNotez un symbole pour ce quâ€™il faut acheter en urgence."
  },
  {
    id:'lib_org_retro',
    cat:'planning',
    emoji:'ğŸ”',
    titre:'Petit bilan de la semaine',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:15,
    recurrence:1,
    desc:"Notez 3 choses qui ont bien fonctionnÃ© cette semaine.\nRepÃ©rez 1 point Ã  allÃ©ger ou simplifier.\nChoisissez une petite expÃ©rimentation pour la semaine suivante."
  },
  {
    id:'lib_org_tache_critique',
    cat:'planning',
    emoji:'âš ï¸',
    titre:'TÃ¢che critique identifiÃ©e et planifiÃ©e',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"RepÃ©rez la tÃ¢che qui aura le plus dâ€™impact si elle est faite.\nBloquez un crÃ©neau rÃ©el dans lâ€™agenda pour la traiter.\nDÃ©coupez-la si nÃ©cessaire en deux sous-Ã©tapes."
  },
  {
    id:'lib_org_vision_mois',
    cat:'planning',
    emoji:'ğŸ“†',
    titre:'Vue globale du mois',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:20,
    recurrence:1,
    desc:"Affichez votre calendrier sur 4 semaines.\nSurvolez les pÃ©riodes chargÃ©es pour anticiper.\nDÃ©cidez dâ€™un week-end ou dâ€™une soirÃ©e plus Â« off Â»."
  },
  {
    id:'lib_org_recurrences',
    cat:'planning',
    emoji:'â™»ï¸',
    titre:'Rituels fixÃ©s dans le calendrier',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'mensuel',
    baseMin:20,
    recurrence:1,
    desc:"Listez les habitudes ou rencontres que vous voulez voir revenir.\nProgrammez-les comme Ã©vÃ©nements rÃ©currents.\nVÃ©rifiez quâ€™il reste encore des plages libres."
  },
  {
    id:'lib_org_point_5min',
    cat:'planning',
    emoji:'â±ï¸',
    titre:'Point 5 minutes en dÃ©but de journÃ©e',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:5,
    recurrence:5,
    desc:"Regardez rapidement la journÃ©e qui arrive.\nChoisissez une seule chose Ã  absolument terminer.\nNotez-la sur un post-it ou en haut de votre to-do."
  },
  {
    id:'lib_org_mail_batch',
    cat:'planning',
    emoji:'ğŸ“§',
    titre:'Bloc mails groupÃ©s',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:15,
    recurrence:5,
    desc:"Choisissez deux crÃ©neaux pour traiter les mails plutÃ´t quâ€™en continu.\nCommencez par supprimer et archiver ce qui nâ€™a pas besoin de rÃ©ponse.\nRÃ©pondez dâ€™abord aux messages qui dÃ©bloquent dâ€™autres personnes."
  },
  {
    id:'lib_org_delegation',
    cat:'planning',
    emoji:'ğŸ¤',
    titre:'TÃ¢ches Ã  dÃ©lÃ©guer identifiÃ©es',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'hebdo',
    baseMin:10,
    recurrence:1,
    desc:"RepÃ©rez les tÃ¢ches qui ne nÃ©cessitent pas absolument votre prÃ©sence.\nNotez Ã  qui elles pourraient Ãªtre confiÃ©es.\nClarifiez le rÃ©sultat attendu plutÃ´t que la maniÃ¨re de faire."
  },
  {
    id:'lib_org_pause_programmee',
    cat:'planning',
    emoji:'â˜•',
    titre:'Pause rÃ©elle planifiÃ©e',
    type:'group',
    scope:'commun',
    modeDefault:'commun',
    freqDefault:'quotidien',
    baseMin:10,
    recurrence:5,
    desc:"Choisissez au moins une pause dans la journÃ©e et inscrivez-la.\nÃ‰loignez-vous rÃ©ellement de lâ€™Ã©cran pendant ce temps.\nUtilisez ce moment pour respirer, marcher ou boire un verre dâ€™eau."
  }
];

// CatÃ©gories lisibles pour le filtre dâ€™ajout
const LIB_CAT_LABELS = {
  tous:'Tous',
  individuel:'Individuel',
  coloc:'Colocation',
  famille:'Famille',
  asso:'Association',
  classe:'Classe',
  bureau:'Bureau',
  cuisine:'Cuisine',
  linge:'Linge',
  rangement:'Rangement',
  planning:'Organisation / planning'
};

const claps={};
(()=>{ // "likes" de dÃ©mo
  const all=[...CHALLENGES,...GROUP_CHALLENGES,...FAMILY_CHALLENGES,...CLASS_CHALLENGES,...OFFICE_CHALLENGES,...ASSOCIATION_CHALLENGES,...LIBRARY_HABITS];
  all.forEach(c=>{
    claps[c.id]={};
    [...new Set([...(c.amis||[]),'Moi'])].forEach(n=>claps[c.id][n]=Math.floor(Math.random()*101));
  });
})();

/* Ã‰tats / stock */
const HABIT_DESC={}, HABIT_TITLE_CUSTOM={}, SPACE_DESC_TXT={};
const BASE_MINUTES={}, HABIT_MODE={}, LOCKED_COMMUN={}, LOCKED_BY={}, DONE_SETS={};
const HAS_DESC={}, DELETED_HABITS=new Set();
const FREQ_MODE={}, HABIT_REC={};

/* Utils */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function fmtDate(d){const M=['01','02','03','04','05','06','07','08','09','10','11','12'][d.getMonth()];const j=String(d.getDate()).padStart(2,'0');const J=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'][d.getDay()];return `${J} ${j}/${M}`;}
function weekLabel(d){
  const day=d.getDay(); // 0=dim
  const monday=new Date(d);monday.setDate(d.getDate()-((day+6)%7));
  const sunday=new Date(monday);sunday.setDate(monday.getDate()+6);
  const f=x=>`${String(x.getDate()).padStart(2,'0')}/${String(x.getMonth()+1).padStart(2,'0')}`;
  return `Semaine du ${f(monday)} au ${f(sunday)}`;
}
function genCode(){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';let s='';for(let i=0;i<6;i++)s+=c[Math.floor(Math.random()*c.length)];return s;}
const round15=m=>Math.round(m/15)*15;function rint(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function pickQuarterUpTo75(){return 15*rint(1,5)}
function lvlEmoji(v){if(v<=7)return'ğŸŒ°';if(v<=14)return'ğŸŒ±';if(v<=21)return'ğŸ€';if(v<=28)return'ğŸŒ¼';if(v<=35)return'ğŸŒ»';if(v<=42)return'ğŸŒ·';if(v<=49)return'ğŸŒ¹';if(v<=56)return'ğŸª»';if(v<=64)return'ğŸ’';return'ğŸ‹';}
function names(xs,m=3){if(xs.length<=m)return xs.join(', ');const s=xs.slice(0,m).join(', ');return `${s}â€¦ et ${xs.length-m} autres`;}
function m2txt(m){const h=Math.floor(m/60),mn=m%60;return `${h}h${String(mn).padStart(2,'0')}`;}
function m2txtShort(m){if(!m)return'0m';const h=(m/60)|0, mn=m%60;return h?`${h}h${String(mn).padStart(2,'0')}`:`${mn}m`;}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
const GENERIC_TIPS=["Commence petit et rÃ©gulier.","PrÃ©pare ton matÃ©riel Ã  lâ€™avance.","Bloque un crÃ©neau fixe au calendrier.","Annonce ton objectif Ã  un ami.","Trace tes progrÃ¨s chaque jour.","CÃ©lÃ¨bre chaque micro-victoire.","RÃ©duis la friction: rends lâ€™action Ã©vidente.","Associe lâ€™habitude Ã  un dÃ©clencheur simple.","Fais-le mÃªme 2 minutes les jours difficiles.","Rends lâ€™environnement compatible.","Supprime une distraction Ã©vidente.","CrÃ©e une check-list de 3 Ã©tapes.","Plan B si tu rates ton horaire.","Ferme la boucle: fais un petit bilan.","PrÃ©pare une version â€˜voyageâ€™ minimaliste.","Utilise un rappel doux (alarme ou post-it).","Vis au rythme: respire avant de commencer.","Visualise le rÃ©sultat attendu.","Ralentis pour Ãªtre prÃ©cis, puis accÃ©lÃ¨re.","Note une difficultÃ© & une solution.","Partage un retour dâ€™expÃ©rience avec un pair.","Automatise ce qui peut lâ€™Ãªtre.","Range immÃ©diatement aprÃ¨s lâ€™action.","RÃ©compense-toi sans culpabilitÃ©.","Passe en mode avion 20 minutes."];

/* Descriptions 2â€“8 phrases */
function buildDesc(min=2,max=8){
  const n=rint(min,max);
  return shuffle([...GENERIC_TIPS]).slice(0,n).join('\n');
}
function oneLiner(s){return (s||'').replace(/\s*\n\s*/g,' Â· ')}

/* Global */
let period='30', spaceId='D0PWE3', userName='Moi', dayOff=0;

/* Spaces (orgMode: day ou week) */
const SPACES={
 'D0PWE3':{emoji:'ğŸ‘¤',label:'ğŸ‘¤ Individu',type:'private',orgMode:'day',ch:CHALLENGES,desc:'Jardin personnel.'},
 'E8D3FS':{emoji:'ğŸ ',label:'ğŸ  Colocation',type:'group',orgMode:'day',ch:GROUP_CHALLENGES,desc:'Jardin partagÃ© Ã  la maison.'},
 'AS50CI':{emoji:'ğŸ›ï¸',label:'ğŸ›ï¸ Association',type:'group',orgMode:'week',ch:ASSOCIATION_CHALLENGES,desc:'Rituels dâ€™Ã©quipe pour une asso.'},
 'WS32D7':{emoji:'ğŸŒ',label:'ğŸŒ Famille',type:'group',orgMode:'day',ch:FAMILY_CHALLENGES,desc:'Routines familiales au quotidien.'},
 'SR3S0D':{emoji:'ğŸ«',label:'ğŸ« Classe',type:'group',orgMode:'week',ch:CLASS_CHALLENGES,desc:'Vie de classe et rituels pÃ©dagogiques.'},
 'PD03XZ':{emoji:'ğŸ¢',label:'ğŸ¢ Bureau',type:'group',orgMode:'week',ch:OFFICE_CHALLENGES,desc:'Rituels simples pour mieux travailler.'}
};
const HABIT_TITLE_IS_CUSTOM={};

/* FrÃ©quence : tout = quotidien par dÃ©faut (UI conservÃ©e) */
function defaultFreqMode(){return {type:'quotidien'}}
function isVisibleToday(){return true}

/* Init */
;[...CHALLENGES,...GROUP_CHALLENGES,...FAMILY_CHALLENGES,...CLASS_CHALLENGES,...OFFICE_CHALLENGES,...ASSOCIATION_CHALLENGES,...LIBRARY_HABITS].forEach(h=>{
  FREQ_MODE[h.id]={type:(h.freqDefault||'quotidien')};
});

/* ===== Helpers visuels encadrÃ©s ===== */
function applyCardClass(card,st,owner,helping,modeType){
  card.className=card.className.replace(/\bs0shared\b|\bs0\b|\bs1me\b|\bs1help\b|\bs1other\b|\bs2me\b|\bs2other\b/g,'').trim();
  if(st===0){
    if(modeType==='commun') card.classList.add('s0shared'); else card.classList.add('s0');
  }else if(st===1){
    if(owner==='Moi') card.classList.add('s1me');
    else if(helping)  card.classList.add('s1help');
    else              card.classList.add('s1other');
  }else if(st===2){
    if(owner==='Moi') card.classList.add('s2me');
    else              card.classList.add('s2other');
  }
}

/* Utils cartes */
function ensureOwnerBadge(friends,owner,it,btn){
  let b=friends.querySelector('.owner-badge');
  if(!owner){ if(b) b.remove(); return; }
  if(!b){
    b=document.createElement('button');
    b.type='button';
    b.className='badge owner-badge';
    b.addEventListener('click',(e)=>{e.stopPropagation(); openDetail(it.id,btn); selectDetailTab('members');});
    friends.appendChild(b);
  }
  b.textContent=`ğŸ§‘â€ğŸŒ¾ ${owner}`;
}
function ensureHelperBadge(friends,helpers){
  helpers=[...new Set(helpers||[])];
  let b=friends.querySelector('.helper-badge');
  if(helpers.length===0){ if(b) b.remove(); return; }
  if(!b){ b=document.createElement('div'); b.className='badge helper-badge'; friends.appendChild(b); }
  b.textContent=`ğŸ¤ ${names(helpers,3)}`;
}
function ensureHeartBadge(friends,shouldShow,namesList,btnRef){
  let b=friends.querySelector('.heart-badge');
  if(!shouldShow){
    if(b) b.remove();
    return;
  }
  if(!b){
    b=document.createElement('button');
    b.type='button';
    b.className='badge heart heart-badge';
    friends.appendChild(b);
    b.addEventListener('click',(e)=>{
      e.stopPropagation();
      const arr = JSON.parse(btnRef.dataset.heartList||'[]');
      const meIdx = arr.indexOf('Moi');
      if(meIdx>=0) arr.splice(meIdx,1); else arr.unshift('Moi');
      btnRef.dataset.heartList = JSON.stringify(arr);
      b.textContent = `â¤ï¸ ${arr.length?arr.join(', '):' '}`;
      b.classList.toggle('liked', arr.includes('Moi'));
    });
  }
  b.textContent=`â¤ï¸ ${namesList.length?namesList.join(', '):' '}`;
  b.classList.toggle('liked', namesList.includes('Moi'));
}

/* Tag "Chacun" â€” supprimÃ© */
function ensureModeTag(){ /* no-op */ }

/* Description open/close */
let openCard=null;
function collapseOpenDesc(){
  if(!openCard) return;
  const d=openCard.querySelector('.desc');
  if(d){d.classList.remove('open');d.classList.add('hidden');d.textContent=d.dataset.short||'';}
  openCard.classList.remove('ready');openCard=null;
}
document.addEventListener('click',e=>{if(openCard && !e.target.closest('.card')) collapseOpenDesc();},{capture:true})
function setupDesc(desc,hid){
  if(!HABIT_DESC[hid]) HABIT_DESC[hid]=buildDesc(2,8);
  desc.dataset.full=HABIT_DESC[hid]||'';
  desc.dataset.short=oneLiner(desc.dataset.full);
  desc.dataset.has=desc.dataset.full? '1':'0';
  desc.textContent=desc.dataset.short;
  desc.classList.add('hidden');
}

/* Global helpers */
function curDate(){const t=new Date();t.setHours(0,0,0,0);t.setDate(t.getDate()+dayOff);return t;}
function getSpace(){return SPACES[spaceId]||SPACES['D0PWE3'];}
function isWeekMode(){return getSpace().orgMode==='week';}
function listChallenges(){return getSpace().ch;}
function findAny(id){
  return [
    ...CHALLENGES,...GROUP_CHALLENGES,...FAMILY_CHALLENGES,
    ...CLASS_CHALLENGES,...OFFICE_CHALLENGES,...ASSOCIATION_CHALLENGES,
    ...LIBRARY_HABITS
  ].find(c=>c.id===id);
}
function habitLabel(it){const custom=HABIT_TITLE_CUSTOM[it.id];return custom&&custom.trim()?custom.trim():it.titre;}

/* TodayCount : somme des minutes des tÃ¢ches non faites + en cours */
function minutesForTodayCount(base,st){return (st===0||st===1)? round15(base) : 0;}
function sumTodayMinutes(){return $$('#cards .levelBtn').map(b=>{const st=+b.dataset.state||0, base=+b.dataset.baseMin||0;return minutesForTodayCount(base,st);}).reduce((a,b)=>a+b,0)}
function renderDateBar(){
  const d=curDate();
  if(isWeekMode()){
    $("#dateLabel").textContent=weekLabel(d);
  }else{
    $("#dateLabel").textContent=fmtDate(d);
  }
  $("#todayCount").textContent=m2txt(round15(sumTodayMinutes()));
}

/* Emojis & bouton */
function currentBigEmoji(btn,tot){return btn.dataset.override|| (tot<=7?'ğŸŒ°':tot<=14?'ğŸŒ±':tot<=21?'ğŸ€':tot<=28?'ğŸŒ¼':tot<=35?'ğŸŒ»':tot<=42?'ğŸŒ·':tot<=49?'ğŸŒ¹':tot<=56?'ğŸª»':tot<=64?'ğŸ’':'ğŸ‹');}
function drawBtn(btn){
  const p=+btn.dataset.plants||0, s=+btn.dataset.suns||0, tot=p+s;
  const st=+btn.dataset.state||0, base=+btn.dataset.baseMin||0;
  const helping = btn.dataset.helping==='1';
  const isWeek = btn.dataset.week==='1';
  const R = +btn.dataset.recur||1;
  const count = +btn.dataset.count||0;
  const owner = btn.dataset.owner||'';
  let val='';

  if(st===0){
    // Ã€ faire + durÃ©e sur 2 lignes
    val = `Ã€ faire<br>${m2txtShort(base)}`;
  }else if(st===1){
    if(owner==='Moi'){
      // Je fais + durÃ©e sur 2 lignes (jour & semaine)
      val = `Je fais<br>${m2txtShort(base)}`;
    }else if(isWeek){
      const label = owner ? 'En cours' : 'Ã€ faire';
      val = `${label} Â· ${count}/${R}`;
    }else{
      val = helping ? "J'aide" : 'En cours';
    }
  }else if(st===2){
    if(isWeek){
      // Fait + R/R sur 2 lignes (sans "Â·")
      val = `Fait<br>${R}/${R}`;
    }else{
      val = 'Fait';
    }
  }else{
    val = m2txtShort(base);
  }

  btn.innerHTML=`<div class="big">${currentBigEmoji(btn,tot)}</div><div class="scoreText">${val}</div>`;
}

/* Init per habit */
function ensureHabit(hid){
  const def=findAny(hid)||{};
  if(!BASE_MINUTES[hid]) BASE_MINUTES[hid]=def.baseMin || pickQuarterUpTo75();
  if(HABIT_DESC[hid]===undefined){HABIT_DESC[hid]=def.desc || buildDesc(2,8);}
  if(!HABIT_MODE[hid]){
    if(def.modeDefault){
      HABIT_MODE[hid]={type:(def.modeDefault==='commun'?'commun':def.modeDefault==='partage'?'commun':'libre'),n:2};
    }else{
      const sp=getSpace();
      if(sp.type==='private'){HABIT_MODE[hid]={type:'libre',n:2}}
      else{HABIT_MODE[hid]= Math.random()<0.8 ? {type:'commun',n:2} : {type:'libre',n:2};}
    }
  }
  if(!DONE_SETS[hid]) DONE_SETS[hid]=new Set();
  if(LOCKED_COMMUN[hid]===undefined){LOCKED_COMMUN[hid]=false;LOCKED_BY[hid]=null;}
  if(!HABIT_REC[hid]) HABIT_REC[hid]=Math.max(1,Math.min(7,def.recurrence||rint(1,4)));
}

/* SÃ©lection quotidienne 4â€“9 habitudes par espace (dÃ©terministe par jour) */
function dayKey(){const d=curDate();return `${spaceId}:${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;}
function hashStr(s){let h=0;for(let i=0;i<s.length;i++){h=(h*31 + s.charCodeAt(i))>>>0;}return h>>>0;}
function rngSeed(seed){let x=seed>>>0;return ()=>{x=(x*1664525+1013904223)>>>0;return (x>>>0)/4294967296;};}
function pickVisibleList(arr){
  const seed=hashStr(dayKey());
  const rand=rngSeed(seed);
  const count=Math.min(arr.length, 4 + Math.floor(rand()*6)); // 4..9
  const a=arr.slice();
  for(let i=0;i<a.length-1;i++){const j=Math.floor(rand()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
  return a.slice(0,count);
}

/* Cartes */
function renderCards(){
  const root=$("#cards");root.innerHTML='';const d=curDate();
  const items = pickVisibleList(listChallenges());
  items.forEach(it=>{
    if(DELETED_HABITS.has(it.id)) return;
    if(!isVisibleToday(it.id,d)) return; ensureHabit(it.id);

    const card=document.createElement('article');card.className='card';
    const cont=document.createElement('div');cont.className='content';
    const title=document.createElement('div');title.className='title';
    const left=document.createElement('div');left.className='left';
    const displayTitle=habitLabel(it);

    left.innerHTML=`<span style="font-size:24px">${it.emoji}</span><span class="base">${displayTitle}</span>`;
    title.append(left);

    const pen=document.createElement('button');
    pen.className='editPen'; pen.title='Ã‰diter'; pen.textContent='âœï¸';
    title.appendChild(pen);

    const desc=document.createElement('div');desc.className='desc';setupDesc(desc,it.id);

    const friends=document.createElement('div');friends.className='friends';
    cont.append(title,desc,friends);

    const col=document.createElement('div');col.className='levelCol';
    const btn=document.createElement('button');btn.className='levelBtn';btn.dataset.cid=it.id;
    const basePlants=Math.floor(Math.random()*65), suns=claps[it.id]?.['Moi']??0;
    btn.dataset.basePlants=String(basePlants);btn.dataset.plants=String(basePlants);btn.dataset.suns=String(suns);
    btn.dataset.baseMin=String(BASE_MINUTES[it.id]);
    btn.dataset.recur=String(HABIT_REC[it.id]||1);
    btn.dataset.count='0';
    btn.dataset.week = isWeekMode() ? '1' : '0';

    const mode=HABIT_MODE[it.id]||{type:'libre'};
    let st=0, owner='', helpers=[];
    const r=Math.random();
    if(r<0.3){
      st=1;
      const byMe = Math.random()<1/3;
      owner = byMe ? 'Moi' : (it.amis && it.amis[Math.floor(Math.random()*it.amis.length)]) || 'Quelqu\'un';
      if(isWeekMode()) btn.dataset.count=String(rint(1,HABIT_REC[it.id]||1));
    }else if(r<0.6){
      st=2;
      const byMe = Math.random()<1/3;
      owner = byMe ? 'Moi' : (it.amis && it.amis[Math.floor(Math.random()*it.amis.length)]) || 'Quelqu\'un';
      if(isWeekMode()) btn.dataset.count=String(HABIT_REC[it.id]||1);
    }else{
      st=0;
    }

    btn.dataset.state=String(st);
    btn.dataset.owner=owner;
    btn.dataset.helping='0';
    btn.dataset.helpers = JSON.stringify(helpers);

    const baseHeartNames = (()=> {
      if(Math.random()<0.5) return [];
      const pool=[...new Set(it.amis||[])];
      shuffle(pool);
      return pool.slice(0, Math.max(1, Math.min(3, Math.floor(Math.random()*4))));
    })();
    btn.dataset.heartList = JSON.stringify(baseHeartNames);

    const setVisualFromState=(stNow)=>{
      const baseEl=title.querySelector('.base');
      const ownerNow=btn.dataset.owner||'';
      const helpingNow=btn.dataset.helping==='1';
      applyCardClass(card,stNow,ownerNow,helpingNow,(HABIT_MODE[it.id]||{type:'libre'}).type);
      baseEl.classList.toggle('strike', stNow===2 && ownerNow==='Moi');
      ensureModeTag();
    };

    const renderBadges=()=>{
      const stNow=+btn.dataset.state||0;
      const ownerNow=btn.dataset.owner||'';
      const helpingNow=btn.dataset.helping==='1';
      if(mode.type==='commun'){
        ensureOwnerBadge(friends, (stNow===1||stNow===2)? ownerNow : '', it, btn);
        const hlist = (btn.dataset.helpers? JSON.parse(btn.dataset.helpers): [])||[];
        ensureHelperBadge(friends, hlist);
      }else{
        ensureOwnerBadge(friends, stNow===2?'Moi':'', it, btn);
        ensureHelperBadge(friends, []);
      }
      const shouldHeart = (stNow===1) || (stNow===2 && ownerNow!=='Moi');
      const arr = JSON.parse(btn.dataset.heartList||'[]');
      ensureHeartBadge(friends, shouldHeart, arr, btn);
    };

    const ensureOpenDesc=()=>{ if(openCard!==card){ collapseOpenDesc(); openCard=card; }
      if(!desc.classList.contains('open')){ desc.classList.remove('hidden'); desc.classList.add('open'); desc.textContent=desc.dataset.full||''; }
    };
    const hideDescNow=()=>{ desc.classList.remove('open'); desc.classList.add('hidden'); desc.textContent=desc.dataset.short||''; if(openCard===card) openCard=null; };

    const applyState=(nst,{keepOwner=false}={})=>{
      btn.dataset.state=String(nst);
      if(!keepOwner && nst===0){ btn.dataset.owner=''; btn.dataset.helping='0'; btn.dataset.helpers='[]'; btn.dataset.count='0'; }
      if(nst===1 && !btn.dataset.owner){ btn.dataset.owner='Moi'; }
      if(nst===2 && !btn.dataset.owner){ btn.dataset.owner='Moi'; }
      drawBtn(btn); setVisualFromState(nst); renderBadges();
      if(nst===1){ ensureOpenDesc(); } else { hideDescNow(); }
      renderDateBar();
    };

    // Clic mode semaine : X/R
    const clickWeekly = ()=>{
      let st=+btn.dataset.state||0;
      let count=+btn.dataset.count||0;
      const R=+btn.dataset.recur||1;

      if(st===0){
        st=1; count=1; btn.dataset.owner='Moi';
      }else if(st===1){
        if(count < R){ count++; }
        else{ st=2; }
      }else if(st===2){
        st=0; count=0; btn.dataset.owner='';
      }
      btn.dataset.count=String(count);
      applyState(st,{keepOwner:st!==0});
    };

    const clickCommon = ()=>{
      if(isWeekMode()){ clickWeekly(); return; }
      const st=+btn.dataset.state||0;
      const owner=btn.dataset.owner||'';
      if(st===0){
        btn.dataset.owner='Moi';
        applyState(1);
        return;
      }
      if(st===1){
        if(owner==='Moi'){
          applyState(2,{keepOwner:true});
        }else{
          const helping = btn.dataset.helping==='1';
          btn.dataset.helping = helping?'0':'1';
          let hs = JSON.parse(btn.dataset.helpers||'[]');
          if(helping){ hs = hs.filter(n=>n!=='Moi'); } else { if(!hs.includes('Moi')) hs.push('Moi'); }
          btn.dataset.helpers = JSON.stringify(hs);
          drawBtn(btn); setVisualFromState(1); renderBadges(); renderDateBar();
        }
        return;
      }
      if(st===2){
        if(owner==='Moi'){
          applyState(0);
        }
        return;
      }
    };

    const clickLibre = ()=>{
      if(isWeekMode()){ clickWeekly(); return; }
      const st=+btn.dataset.state||0;
      const next = st===0?1 : (st===1?2 : 0);
      if(next===1){ btn.dataset.owner='Moi'; }
      if(next===2){ btn.dataset.owner='Moi'; }
      applyState(next);
    };

    const handleClick=()=>{ (mode.type==='commun') ? clickCommon() : clickLibre(); };

    drawBtn(btn);
    setVisualFromState(st);
    renderBadges();

    pen.addEventListener('click',(e)=>{ e.stopPropagation(); openDetail(it.id,btn); selectDetailTab('settings'); });
    if(st===1) ensureOpenDesc();

    col.addEventListener('click',handleClick);
    cont.addEventListener('click',(e)=>{ if(e.target.closest('.badge')) return; handleClick(); });

    col.append(btn);card.append(col,cont);root.appendChild(card);
  });
  renderDateBar();
}

/* ===== Calendriers ===== */
let calOff=0;
function minfo(off=0){const b=new Date();b.setDate(1);b.setMonth(b.getMonth()+off);const y=b.getFullYear(),m=b.getMonth();return{y,m,fd:(new Date(y,m,1).getDay()+6)%7,days:new Date(y,m+1,0).getDate()}}
function populateCalWho(){const sel=$("#calWho");sel.innerHTML='';sel.add(new Option('Tous','__all__'));sel.add(new Option('Moi','Moi'));(findAny(activeId)?.amis||[]).forEach(n=>sel.add(new Option(n,n)));sel.value='__all__';}
function renderCalendar(){
  const wrap=$("#cal");wrap.innerHTML='';const {y,m,fd,days}=minfo(calOff);const months=['Jan','FÃ©v','Mar','Avr','Mai','Juin','Juil','AoÃ»','Sep','Oct','Nov','DÃ©c'];let monthMinutes=0;
  for(let i=0;i<fd;i++){const c=document.createElement('div');c.className='cell';c.style.opacity=.35;wrap.appendChild(c)}
  const today=new Date(),sameMonth=(calOff===0);
  for(let d=1;d<=days;d++){
    const c=document.createElement('div');c.className='cell';
    const dn=document.createElement('div');dn.className='dayNum';dn.textContent=String(d);c.appendChild(dn);
    if(Math.random()<0.6){
      const min=pickQuarterUpTo75();
      const mark=document.createElement('div');mark.className='seedMark';mark.textContent='ğŸ§‘â€ğŸŒ¾';c.appendChild(mark);
      const dur=document.createElement('div');dur.className='dur';dur.textContent=m2txtShort(min);c.appendChild(dur);
      monthMinutes+=min;
    }
    if(sameMonth&&d===today.getDate()){c.style.outline=`2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--green')}`;}
    c.onclick=()=>{const b=new Date();b.setDate(1);b.setMonth(b.getMonth()+calOff);const tgt=new Date(b.getFullYear(),b.getMonth(),d),now=new Date();now.setHours(0,0,0,0);dayOff=Math.round((tgt-now)/86400000);showHome();renderCards();renderDateBar();window.scrollTo({top:0,behavior:'smooth'})};
    wrap.appendChild(c);
  }
  $("#monthLabel").textContent=`${months[m]} ${y}  ğŸ§‘â€ğŸŒ¾${m2txt(round15(monthMinutes))}`;
}
$("#prevMonth").onclick=()=>{calOff--;renderCalendar()};$("#nextMonth").onclick=()=>{calOff++;renderCalendar()};$("#calWho")?.addEventListener('change',renderCalendar);

/* ===== Navigation vues ===== */
function showHome(){hideAll();$("#home").classList.add('active');$("#daysWrap").classList.remove('hide')}
function hideAll(){$$('#home,#detail,#space').forEach(v=>v.classList.remove('active'))}
$("#backHome").onclick=showHome;

/* ===== Classement (texte simple â¤ï¸ğŸ¤) ===== */
function demoHM(rangeDays){const min=round15(rint(30,25*60));return {min, txt:m2txt(min)}}
function likeFactorFromMin(min){return 0.5+(min/60)/25}
function renderRank(){
  const it=findAny(activeId);const days=period==='7'?7:period==='30'?30:120;
  const rows=[...(it?.amis||[]).map(n=>({n,me:false})),{n:userName||'Moi',me:true}].map(x=>{
    const v=demoHM(days);const baseLikes=Math.max(0,Math.round(v.min/60*likeFactorFromMin(v.min)));const help=rint(2,10);
    return {...x,totalMin:v.min,txt:v.txt,likes:baseLikes,help};
  }).sort((a,b)=>b.totalMin-a.totalMin);
  const root=$("#rank");root.innerHTML='';
  rows.forEach(({n,totalMin,txt,me,likes,help})=>{
    const row=document.createElement('div');row.className='row';
    const left=document.createElement('div');left.className='leftRank';
    const big=document.createElement('span');big.className='scoreEmoji';big.textContent=`${lvlEmoji(Math.min(65,Math.round(totalMin/60)))} ${txt}`;
    const name=document.createElement('b');name.textContent=`${n}${me?' (toi)':''}`;
    left.append(big,name);
    const right=document.createElement('div');right.style.display='flex';right.style.gap='8px';
    const helpTxt=document.createElement('span');helpTxt.textContent=`ğŸ¤ ${help}h`;
    const likeTxt=document.createElement('span');likeTxt.textContent=`â¤ï¸ ${likes}`;
    right.append(helpTxt,likeTxt);
    row.append(left,right);root.appendChild(row);
  });
}
function updPeriodBtns(){$$('#btnP7,#btnP30,#btnPAll').forEach(b=>b.classList.toggle('active',b.dataset.period===period))}
$('#btnP7').onclick=()=>{period='7';updPeriodBtns();renderRank()};
$('#btnP30').onclick=()=>{period='30';updPeriodBtns();renderRank()};
$('#btnPAll').onclick=()=>{period='all';updPeriodBtns();renderRank()};

/* ===== ParamÃ¨tres habitude ===== */
let activeId=null, refBtn=null;
function openDetail(id,btnRef){
  activeId=id;refBtn=btnRef;hideAll();$("#detail").classList.add('active');$("#daysWrap").classList.add('hide');
  $$('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="members"]').classList.add('active');
  $$('#detail .view').forEach(v=>v.classList.remove('active'));$('#tab-members').classList.add('active');
  const it=findAny(id);$("#detailTitle").textContent=`${it.emoji} ${habitLabel(it)}`;
  renderRank();populateCalWho();renderCalendar();renderHabitSettings();
}
function selectDetailTab(key){
  const b=[...document.querySelectorAll('#detail .tabs [data-tab]')].find(x=>x.dataset.tab===key); if(!b)return;
  document.querySelectorAll('#detail .tabs [data-tab]').forEach(x=>x.classList.remove('active')); b.classList.add('active');
  document.querySelectorAll('#detail .section .view').forEach(v=>v.classList.remove('active'));
  document.querySelector(`#detail #${'tab-'+key}`)?.classList.add('active');
}

function renderHabitSettings(){
  if(!activeId)return; ensureHabit(activeId);
  const it=findAny(activeId);

  const titleInput=$("#habitTitleInput"), emojiEl=$("#habitTitleEmoji");
  if(it&&titleInput&&emojiEl){
    emojiEl.textContent=it.emoji||'ğŸŒ±';
    if(document.activeElement!==titleInput) titleInput.value=habitLabel(it);
    if(!titleInput.dataset.bound){
      titleInput.addEventListener('input',()=>{const raw=titleInput.value; if(raw.trim()){HABIT_TITLE_CUSTOM[activeId]=raw;}else{delete HABIT_TITLE_CUSTOM[activeId];} $("#detailTitle").textContent=`${it.emoji} ${habitLabel(it)}`; renderCards();});
      titleInput.dataset.bound='1';
    }
  }
  const desc=$("#habitDesc");
  if(desc){
    desc.value=HABIT_DESC[activeId]||'';
    if(!desc.dataset.bound){
      desc.addEventListener('input',()=>{HABIT_DESC[activeId]=desc.value;HAS_DESC[activeId]=!!desc.value.trim();renderCards();});
      desc.dataset.bound='1';
    }
  }

  const modeSel=$("#modeSelect");
  if(modeSel){
    const m=HABIT_MODE[activeId]||{type:'libre',n:2};
    modeSel.value=(m.type==='commun')?'commun':'libre';
    modeSel.onchange=()=>{const t=modeSel.value;HABIT_MODE[activeId]={type:t,n:2};renderCards();};
  }

  const ft=$("#freqType"), fx=$("#freqX"), fDate=$("#freqDate"), fJ=$("#freqSubJours");
  if(ft&&fx&&fDate&&fJ){
    ft.value='quotidien';
    $("#freqSubTousx").classList.add('hide');
    $("#freqSubPonctuelle").classList.add('hide');
    fJ.classList.add('hide');
  }

  const defaultDurSel=$("#mockDefaultDur");
  if(defaultDurSel && !defaultDurSel.dataset.bound){
    defaultDurSel.dataset.bound='1';
    defaultDurSel.addEventListener('change',()=>{
      const v=defaultDurSel.value.trim();
      let mins=15;
      if(v.startsWith('5 ')) mins=5;
      else if(v.startsWith('15')) mins=15;
      else if(v.startsWith('30')) mins=30;
      else if(v.startsWith('45')) mins=45;
      else if(v.startsWith('60')) mins=60;
      BASE_MINUTES[activeId]=mins;
      renderCards();
    });
  }

  const del=$("#deleteHabitBtn");
  if(del && !del.dataset.bound){
    del.onclick=()=>{ if(confirm('Supprimer cette habitude ?')){ DELETED_HABITS.add(activeId); showHome(); renderCards(); } };
    del.dataset.bound='1';
  }

  const save=$("#saveHabitBtn");
  if(save && !save.dataset.bound){
    save.onclick=()=>{ alert('Habitude sauvegardÃ©e (mock)'); };
    save.dataset.bound='1';
  }
}

/* ===== Espace ===== */
function openSpacePage(){hideAll();$("#space").classList.add('active');$("#daysWrap").classList.add('hide');updSpaceHeader();renderSpaceRank();setupSpaceInfo();populateSpaceWho();renderSpaceCalendar();maybeTogglePrivateAdd();}
function updSpaceHeader(){
  const sp=getSpace();
  $("#spaceHeaderTitle").textContent=sp.label;
  $("#paramSpaceLabel").value=sp.label;
  $("#paramName").value=userName||'Moi';
  const orgSel=$("#spaceOrgMode");
  if(orgSel) orgSel.value=sp.orgMode||'day';
}
function setupSpaceInfo(){
  const sp=getSpace();const t=$("#spaceDescInfo");
  t.value=SPACE_DESC_TXT[spaceId]??(sp.desc||'');t.classList.add('editing');
  t.oninput=()=>{SPACE_DESC_TXT[spaceId]=t.value;sp.desc=t.value}
}
function allMembersOfSpace(){const ch=listChallenges();const set=new Set(['Moi']);ch.forEach(c=>(c.amis||[]).forEach(a=>set.add(a)));return Array.from(set)}
function renderSpaceRank(){
  const root = $("#spaceRank"); root.innerHTML = '';
  const days = sPeriod==='7' ? 7 : (sPeriod==='30' ? 30 : 120);
  const rows = allMembersOfSpace().map(n=>{const v = demoHM(days);const baseLikes = Math.max(0, Math.round(v.min/60 * likeFactorFromMin(v.min)));return { n, txt:v.txt, min:v.min, me:(n===userName||n==='Moi'), likes:baseLikes, help:rint(2,10) };}).sort((a,b)=>b.min-a.min);
  rows.forEach(({n,txt,min,me,likes,help})=>{
    const row=document.createElement('div'); row.className='row';
    const left=document.createElement('div'); left.className='leftRank';
    const big=document.createElement('span'); big.className='scoreEmoji';big.textContent = `${lvlEmoji(Math.min(65,Math.round(min/60)))} ${txt}`;
    const name=document.createElement('b'); name.textContent = `${n}${me?' (toi)':''}`;
    left.append(big,name);
    const right=document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
    const helpTxt=document.createElement('span'); helpTxt.textContent=`ğŸ¤ ${help}h`;
    const likeTxt=document.createElement('span'); likeTxt.textContent=`â¤ï¸ ${likes}`;
    right.append(helpTxt,likeTxt);
    row.append(left, right);root.appendChild(row);
  });
}
let sPeriod = '30';
function updSpacePeriodBtns(){$$('#sBtnP7,#sBtnP30,#sBtnPAll').forEach(b=>b.classList.toggle('active', b.dataset.speriod===sPeriod));}
$('#sBtnP7').onclick = ()=>{ sPeriod='7';  updSpacePeriodBtns(); renderSpaceRank(); };
$('#sBtnP30').onclick= ()=>{ sPeriod='30'; updSpacePeriodBtns(); renderSpaceRank(); };
$('#sBtnPAll').onclick = ()=>{ sPeriod='all';updSpacePeriodBtns(); renderSpaceRank(); };

let sCalOff=0;
function populateSpaceWho(){const sel=$("#sCalWho");sel.innerHTML='';sel.add(new Option('Tous','__all__'));allMembersOfSpace().forEach(n=>sel.add(new Option(n,n)));sel.value='__all__';}
function renderSpaceCalendar(){
  const wrap=$("#sCal");wrap.innerHTML='';const {y,m,fd,days}=minfo(sCalOff);const months=['Jan','FÃ©v','Mar','Avr','Mai','Juin','Juil','AoÃ»','Sep','Oct','Nov','DÃ©c'];let monthMinutes=0;
  for(let i=0;i<fd;i++){const c=document.createElement('div');c.className='cell';c.style.opacity=.35;wrap.appendChild(c)}
  for(let d=1;d<=days;d++){
    const c=document.createElement('div');c.className='cell';const dn=document.createElement('div');dn.className='dayNum';dn.textContent=String(d);c.appendChild(dn);
    if(Math.random()<0.65){const mins=pickQuarterUpTo75();const mark=document.createElement('div');mark.className='seedMark';mark.textContent='ğŸ§‘â€ğŸŒ¾';c.appendChild(mark);const dur=document.createElement('div');dur.className='dur';dur.textContent=m2txtShort(mins);c.appendChild(dur);monthMinutes+=mins;}
    wrap.appendChild(c);
  }
  $("#sMonthLabel").textContent=`${months[m]} ${y}  ğŸ§‘â€ğŸŒ¾${m2txt(round15(monthMinutes))}`;
}
$("#sPrevMonth").onclick=()=>{sCalOff--;renderSpaceCalendar()};$("#sNextMonth").onclick=()=>{sCalOff++;renderSpaceCalendar()};$("#sCalWho").addEventListener('change',renderSpaceCalendar);

/* SÃ©lecteur dâ€™espace */
function updSel(){
  const sel=$("#spaceSel");sel.innerHTML='';
  const order=['E8D3FS','AS50CI','D0PWE3','WS32D7','SR3S0D','PD03XZ'];
  order.forEach(id=>{if(SPACES[id]){const o=document.createElement('option');o.value=id;o.textContent=SPACES[id].label;sel.appendChild(o)}});
  Object.keys(SPACES).forEach(id=>{if(!order.includes(id)){const o=document.createElement('option');o.value=id;o.textContent=SPACES[id].label;sel.appendChild(o)}});
  sel.value=spaceId;
}
const selSpace=$("#spaceSel");selSpace.addEventListener('change',()=>{spaceId=selSpace.value;renderCards();showHome();});
$("#openSpace").onclick=openSpacePage;$("#backFromSpace").onclick=showHome;

/* Modales */
const mAdd=$("#modalAdd"),mHabit=$("#modalHabit"),mInvite=$("#modalInvite"),mSpace=$("#modalSpace"),mWizard=$("#modalWizard");
const open=m=>m.classList.add('on'), close=m=>m.classList.remove('on');
$("#addBtn").onclick=()=>{open(mAdd);maybeTogglePrivateAdd();};
$("#closeAdd").onclick=()=>close(mAdd);
$("#addHabit").onclick=()=>{close(mAdd);open(mHabit);step1()}
function maybeTogglePrivateAdd(){ const isPrivate=getSpace().type==='private'; $("#addPrivateHabit").classList.toggle('hide',!isPrivate); }
$("#addPrivateHabit").onclick=()=>{
  close(mAdd);
  const id='priv_'+genCode();
  const h={type:'private',id,cat:'individuel',emoji:'âœ¨',titre:'Nouvelle habitude privÃ©e âœ¨',amis:[]};
  CHALLENGES.unshift(h);
  HAS_DESC[id]=true; HABIT_DESC[id]=buildDesc(2,8);
  FREQ_MODE[id]={type:'quotidien'}; HABIT_MODE[id]={type:'libre',n:2};
  activeId=id; renderCards(); openDetail(id,null); selectDetailTab('settings');
};
$("#inviteFriend").onclick=()=>{close(mAdd);openInvite()};
$("#joinSpace").onclick=()=>{close(mAdd);open(mSpace)};
function openInvite(){const code=spaceId;$("#inviteLink").value=`https://habitu.be/?code=${code}`;open(mInvite)}
$("#closeInvite").onclick=()=>close(mInvite);
$("#copyInvite").onclick=async()=>{try{await navigator.clipboard.writeText($("#inviteLink").value);alert("Lien copiÃ© !")}catch(e){alert("Copie impossible")}}
$("#spaceGen").onclick=()=>{$("#spaceCode").value=genCode()};
$("#spaceCancel").onclick=()=>close(mSpace);
$("#closeSpace").onclick=()=>close(mSpace);

/* Space join/wizard (dÃ©mo) */
$("#spaceSave").onclick=()=>{
  const code=($("#spaceCode").value||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,6),
        name=($("#spaceName").value||'').trim()||'Moi';
  if(!code){alert("Entre un code de jardin.");return}
  if(SPACES[code]){spaceId=code;userName=name;updSel();renderCards();close(mSpace)}
  else{close(mSpace);launchWizard(code,name)}
};
let wiz={code:'',name:'',type:'private',profile:'Autre'};
function launchWizard(code,name){wiz={code,name,type:'private',profile:'Autre'};open(mWizard);wizProfileStep()}
function wizProfileStep(){
  const root=$("#wizStep");$("#wizTitle").textContent="Type de profil";root.innerHTML='';
  [
    {emoji:'ğŸ‘¤',label:'Individu',apply:()=>({emoji:'ğŸ‘¤',label:'ğŸ‘¤ Individu',type:'private',orgMode:'day',ch:CHALLENGES,desc:'Jardin personnel.'})},
    {emoji:'ğŸ ',label:'Colocation',apply:()=>({emoji:'ğŸ ',label:'ğŸ  Colocation',type:'group',orgMode:'day',ch:GROUP_CHALLENGES,desc:'Jardin partagÃ© Ã  la maison.'})},
    {emoji:'ğŸ›ï¸',label:'ğŸ›ï¸ Association',apply:()=>({emoji:'ğŸ›ï¸',label:'ğŸ›ï¸ Association',type:'group',orgMode:'week',ch:ASSOCIATION_CHALLENGES,desc:'Rituels dâ€™Ã©quipe pour une asso.'})},
    {emoji:'ğŸŒ',label:'Famille',apply:()=>({emoji:'ğŸŒ',label:'ğŸŒ Famille',type:'group',orgMode:'day',ch:FAMILY_CHALLENGES,desc:'Routines familiales au quotidien.'})},
    {emoji:'ğŸ«',label:'Classe',apply:()=>({emoji:'ğŸ«',label:'ğŸ« Classe',type:'group',orgMode:'week',ch:CLASS_CHALLENGES,desc:'Vie de classe et rituels pÃ©dagogiques.'})},
    {emoji:'ğŸ¢',label:'ğŸ¢ Bureau',apply:()=>({emoji:'ğŸ¢',label:'ğŸ¢ Bureau',type:'group',orgMode:'week',ch:OFFICE_CHALLENGES,desc:'Rituels simples pour mieux travailler.'})}
  ].forEach(opt=>{
    const el=document.createElement('div');el.className='opt';
    el.innerHTML=`<div class="emoji">${opt.emoji}</div><div><b>${opt.label}</b></div>`;
    el.onclick=()=>{SPACES[wiz.code]=opt.apply();spaceId=wiz.code;userName=wiz.name;updSel();renderCards();close(mWizard);};
    root.appendChild(el);
  });
}

/* Wizard bibliothÃ¨que multi-sÃ©lection */
function step1(){
  const root=$("#step1");const step2=$("#step2");
  $("#habitTitle").textContent="Nouvelle(s) habitude(s)";
  if(step2) step2.style.display='none';
  root.innerHTML='';

  // Barre sticky : filtre + bouton Ã  droite
  const bar=document.createElement('div');
  bar.className='addBar';

  const sel=document.createElement('select');
  sel.id='addCatFilter'; sel.className='select';
  Object.entries(LIB_CAT_LABELS).forEach(([id,label])=>{
    const opt=document.createElement('option');
    opt.value=id; opt.textContent=label;
    sel.appendChild(opt);
  });
  sel.value='tous';

  const btn=document.createElement('button');
  btn.className='btn primary';
  btn.id='addHabitsBtn';
  btn.textContent='Ajouter (0) habitude(s)';

  bar.appendChild(sel);
  bar.appendChild(btn);
  root.appendChild(bar);

  const list=document.createElement('div');
  list.id='habitChoiceList'; list.className='grid';
  root.appendChild(list);

  function updateAddLabel(){
    const count=[...list.querySelectorAll('input[type="checkbox"]:checked')].length;
    btn.textContent=`Ajouter (${count}) habitude(s)`;
  }

  function rebuild(){
    const cat=sel.value;
    const space=getSpace();
    const presentIds=new Set((space.ch||[]).map(h=>h.id));
    let items=LIBRARY_HABITS.filter(h=>{
      const okCat = (cat==='tous') || h.cat===cat;
      const notPresent=!presentIds.has(h.id);
      return okCat && notPresent;
    });
    items = items.slice().sort((a,b)=>a.titre.localeCompare(b.titre,'fr'));
    list.innerHTML='';
    if(!items.length){
      const empty=document.createElement('div');
      empty.className='miniInfo';
      empty.textContent="Aucune habitude disponible dans cette catÃ©gorie.";
      list.appendChild(empty);
      updateAddLabel();
      return;
    }
    items.forEach(h=>{
      const el=document.createElement('label');
      el.className='opt';
      const cb=document.createElement('input');
      cb.type='checkbox'; cb.value=h.id; cb.style.marginRight='8px';
      const inner=document.createElement('div');
      inner.innerHTML=`<div class="emoji">${h.emoji}</div><div><b>${h.titre}</b><div style="font-size:11px;color:#666">${oneLiner(h.desc)}</div></div>`;
      el.appendChild(cb);
      el.appendChild(inner);
      cb.addEventListener('change',updateAddLabel);
      list.appendChild(el);
    });
    updateAddLabel();
  }

  rebuild();
  sel.onchange=rebuild;

  btn.onclick=()=>{
    const checked=[...list.querySelectorAll('input[type="checkbox"]:checked')].map(x=>x.value);
    if(!checked.length){alert("SÃ©lectionne au moins une habitude.");return;}
    const sp=getSpace();
    checked.forEach(id=>{
      const h=LIBRARY_HABITS.find(x=>x.id===id);
      if(!h) return;
      if(!(sp.ch||[]).some(x=>x.id===id)){
        (sp.ch || (sp.ch=[])).push(h);
        ensureHabit(id);
      }
    });
    close(mHabit);
    renderCards();
  };
}
$("#closeHabit").onclick=()=>close(mHabit);

/* Jour +/- */
$("#prevDay").onclick=()=>{dayOff+= isWeekMode() ? -7 : -1;renderCards();renderDateBar()};
$("#nextDay").onclick=()=>{dayOff+= isWeekMode() ? 7 : 1;renderCards();renderDateBar()};

/* Lancement */
function renderCalendarAndKeepMonth(){renderCalendar()}
let dayInit=false;function renderDateOnce(){if(!dayInit){dayOff=0;renderDateBar();dayInit=true}}
function updAll(){renderCards();renderCalendarAndKeepMonth();renderDateOnce();updSel();maybeTogglePrivateAdd();updSpaceHeader()}
updAll();

/* Tabs util */
function switchViews(btn,groupAttr,prefix){
  const key=btn.getAttribute(groupAttr);
  document.querySelectorAll(`.tabs [${groupAttr}]`).forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll(`#${prefix} .view`).forEach(v=>v.classList.remove('active'));
  const target=document.querySelector(`#${prefix} #${(groupAttr==='data-tab'?'tab-':'')}${key}`);
  if(target)target.classList.add('active');
  if(key==='history'){populateCalWho?.();renderCalendar?.()}
  if(key==='shistory'){populateSpaceWho?.();renderSpaceCalendar?.()}
}
document.querySelectorAll('#detail .tabs [data-tab]').forEach(btn=>{btn.addEventListener('click',()=>switchViews(btn,'data-tab','detail'))});
document.querySelectorAll('#space .tabs [data-stab]').forEach(btn=>{btn.addEventListener('click',()=>switchViews(btn,'data-stab','space'))});
</script>
</body>
</html>
