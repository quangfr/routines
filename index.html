<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#2563eb" />
<link rel="manifest" href="manifest.webmanifest" />
<link rel="apple-touch-icon" href="icon-192.png" />
<link rel="icon" href="icon-192.png" sizes="192x192" />
<title>Routine Buddy ¬∑ Prototype</title>
<style>
:root{
  color-scheme:light;
  --bg:#f4f7fb;
  --panel:#ffffff;
  --muted:#5b708b;
  --text:#1a2433;
  --border:#d9e2ef;
  --accent:#2563eb;
  --ok:#16a34a;
  --warn:#eab308;
  --bad:#dc2626;
  --future:#e5edf9;
  --off:#f1f5f9;
  --radius:14px;
  --cat-Fitness:#34d399;
  --cat-Nutrition:#f97316;
  --cat-Rest:#a855f7;
  --cat-Connection:#f59e0b;
  --cat-Learning:#38bdf8;
  --cat-Leisure:#f472b6;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 "Inter", system-ui,-apple-system,"Segoe UI",sans-serif}
button{font:inherit;color:inherit}
.app{min-height:100svh;display:flex;flex-direction:column;}
header{position:sticky;top:0;z-index:4;background:rgba(255,255,255,.92);backdrop-filter:blur(16px);border-bottom:1px solid var(--border)}
.head-wrap{display:flex;align-items:center;gap:10px;padding:8px 14px;max-width:960px;margin:0 auto;width:100%}
.h-title{font-weight:700;font-size:17px;display:flex;align-items:center;gap:8px;white-space:nowrap}
.h-logo{width:22px;height:22px;border-radius:6px;box-shadow:0 2px 6px rgba(15,23,42,.15)}
.h-grow{flex:1}
.icon-btn{background:var(--panel);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:6px 10px;display:inline-flex;align-items:center;gap:6px;cursor:pointer;transition:all .15s ease;font-size:14px;line-height:1}
.icon-btn:hover{border-color:var(--accent);color:var(--accent)}
.icon-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(37,99,235,.08)}
.icon-btn:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
.icon-btn:active{transform:translateY(1px)}
.icon-btn.icon-only{width:36px;height:36px;justify-content:center;padding:0;font-size:18px}
.week-controls{position:sticky;top:48px;z-index:3;padding:6px 12px;background:rgba(244,247,251,.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--border)}
.week-controls .week-nav{max-width:960px;margin:0 auto;display:flex;align-items:center;gap:10px}
.week-label{flex:1;text-align:center;font-weight:600;color:var(--muted);font-size:14px}

main{flex:1;display:flex;flex-direction:column;gap:12px;padding:12px}
main>section{max-width:960px;width:100%;margin:0 auto}
.summary{border:1px solid var(--border);border-radius:var(--radius);padding:12px;background:var(--panel);box-shadow:0 8px 18px rgba(15,23,42,.06)}
.summary-line{display:flex;flex-wrap:nowrap;gap:8px;justify-content:flex-start;overflow-x:auto;padding-bottom:2px}
.summary-line::-webkit-scrollbar{height:6px}
.summary-line::-webkit-scrollbar-thumb{background:rgba(148,163,184,.5);border-radius:999px}
.summary-metric{display:flex;flex-direction:column;gap:4px;padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--off);min-width:96px;flex:0 0 auto}
.summary-metric.status-green{border-color:rgba(22,163,74,.24);background:rgba(22,163,74,.08)}
.summary-metric.status-yellow{border-color:rgba(234,179,8,.26);background:rgba(234,179,8,.12)}
.summary-metric.status-red{border-color:rgba(220,38,38,.28);background:rgba(220,38,38,.12)}
.summary-count{font-size:20px;font-weight:700}
.summary-label{font-size:13px;font-weight:600;color:var(--muted)}
.week-cell{width:34px;height:34px;border-radius:12px;border:1px solid transparent;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:11px;font-weight:600;gap:2px;cursor:default}
.week-cell.status-green{background:rgba(22,163,74,.12);color:#047857;border-color:rgba(22,163,74,.25)}
.week-cell.status-yellow{background:rgba(234,179,8,.18);color:#92400e;border-color:rgba(234,179,8,.28)}
.week-cell.status-red{background:rgba(220,38,38,.14);color:#b91c1c;border-color:rgba(220,38,38,.3)}
.week-cell.status-future{background:var(--future);color:#64748b;border:1px dashed rgba(148,163,184,.6)}
.week-cell.status-off{background:var(--off);color:#94a3b8;border:1px dashed rgba(148,163,184,.35)}

.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;max-width:960px;margin:0 auto;width:100%;align-content:start}
.card{--card-color:var(--accent);background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:8px;display:flex;flex-direction:column;gap:6px;min-height:0;box-shadow:0 6px 14px rgba(15,23,42,.05);cursor:pointer;transition:transform .15s ease, box-shadow .15s ease;border-top:4px solid var(--card-color)}
.card:hover{transform:translateY(-2px);box-shadow:0 14px 28px rgba(15,23,42,.08)}
.card-head{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:4px}
.card-title{display:flex;align-items:center;gap:6px;font-weight:700;font-size:15px}
.card-title .cat-symbol{font-size:18px}
.card h3{margin:0;font-size:15px;font-weight:700}
.catchup{display:flex;gap:4px;font-size:18px;min-height:24px;min-width:24px}
.count{font-size:12px;color:var(--muted);font-weight:600;text-align:right}
.cell-row{display:flex;gap:3px}
.cell-row .week-cell{flex:1;min-width:0;cursor:default;height:28px;font-size:10px}

.view{display:none}
.view.active{display:block}
.cat-head{display:flex;align-items:center;gap:10px;margin:4px 0 10px;flex-wrap:wrap}
.back{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);cursor:pointer;font-size:14px}
.add{margin-left:auto}
.cat-head h2{margin:0;font-size:18px;display:flex;align-items:center;gap:8px}
.cat-week{margin-left:auto;font-weight:600;color:var(--muted);font-size:13px}
.edit-cat{order:4}
.task{position:relative;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px 10px 10px 14px;display:flex;flex-direction:column;gap:10px;box-shadow:0 8px 18px rgba(15,23,42,.04);border-left:3px solid transparent}
.task[data-importance="must"]{border-left-color:var(--bad)}
.task[data-importance="should"]{border-left-color:var(--warn)}
.task + .task{margin-top:12px}
.task-header{display:flex;align-items:center;gap:10px}
.task .em{font-size:22px}
.task-info{flex:1;min-width:0}
.task .title{font-weight:600;font-size:15px;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.task .title .freq{font-size:16px}
.task-actions{display:flex;gap:6px;align-items:center;margin-left:auto}
.task-actions button{padding:4px 6px;border-radius:8px;border:1px solid var(--border);background:var(--off);cursor:pointer;font-size:14px;line-height:1}
.week-grid{display:flex;gap:6px;flex-wrap:wrap}
.week-cell button{all:unset}
.task-week{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:4px}
.task-week .week-cell{width:auto;height:38px}
.task-week .week-cell.clickable{cursor:pointer}
.task-week .week-cell.clickable:focus-visible{outline:2px solid var(--accent)}
.task-week .week-cell.disabled{opacity:.45;cursor:not-allowed}

.edit-cat{margin-left:0}

dialog{border:1px solid #cbd5e1;border-radius:18px;padding:0;background:var(--panel);color:var(--text);width:min(440px,calc(100vw - 32px));max-width:440px;max-height:calc(100vh - 32px);display:flex;flex-direction:column;overflow:hidden}
dialog:not([open]){display:none}
dialog::backdrop{background:rgba(15,23,42,.45)}

/* Dialog */
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);font-weight:700;font-size:16px}
.modal-body{padding:12px 14px;display:grid;gap:12px}
.field{display:grid;gap:6px}
.field label{font-weight:600;font-size:13px;color:#475569}
.modal-body input,.modal-body select,.modal-body textarea{background:var(--off);border:1px solid var(--border);color:var(--text);padding:7px 10px;border-radius:10px;font:inherit;font-size:14px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 14px;border-top:1px solid var(--border)}
.modal-actions button{padding:6px 14px;border-radius:10px;border:1px solid var(--border);background:var(--panel);cursor:pointer;font-weight:600;font-size:14px}
.modal-actions .primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.modal-actions .danger{color:var(--bad);border-color:rgba(220,38,38,.3)}

.emoji-picker{display:grid;gap:8px;border:1px solid var(--border);border-radius:12px;padding:6px;background:var(--off)}
.emoji-results{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));grid-auto-rows:38px;gap:6px;max-height:140px;overflow:auto;padding-right:2px}
.emoji-results button{background:var(--panel);border:1px solid var(--border);border-radius:8px;display:grid;place-items:center;font-size:20px;cursor:pointer;height:38px}
.emoji-results button:hover{border-color:var(--accent)}
.weekday-picker{display:flex;flex-wrap:wrap;gap:8px}
.weekday-picker label{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--panel);cursor:pointer;font-size:13px}
.weekday-picker input{accent-color:var(--accent)}

.config-panel{border:1px solid var(--border);border-radius:var(--radius);background:var(--panel);padding:16px;box-shadow:0 10px 22px rgba(15,23,42,.06);display:grid;gap:16px;max-width:520px;margin:0 auto}
.config-head{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.config-head h2{margin:0;font-size:18px}
.config-actions{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
.config-actions .icon-btn{width:100%;justify-content:center;padding:10px}
.config-note{color:var(--muted);font-size:13px}

@media (max-width:520px){
  .summary{padding:10px}
  .summary-line{gap:6px}
  .summary-metric{min-width:110px;flex:0 0 auto}
  .grid{gap:6px}
  .card{padding:8px}
  .task-week .week-cell{height:34px}
  .week-controls{top:44px}
}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="head-wrap">
      <div class="h-title"><img src="icon-192.png" alt="" class="h-logo" />Routine Buddy</div>
      <div class="h-grow"></div>
      <button class="icon-btn icon-only" id="configBtn" aria-label="Open configuration">‚öôÔ∏è</button>
    </div>
  </header>

  <div class="week-controls" id="weekControls">
    <div class="week-nav">
      <button class="icon-btn" id="weekPrev" aria-label="Previous week">‚Üê</button>
      <div class="week-label" id="weekLabel"></div>
      <button class="icon-btn" id="weekNext" aria-label="Next week">‚Üí</button>
    </div>
  </div>

  <main>
    <section class="summary" id="summary">
      <div class="summary-line">
        <div class="summary-metric status-green">
          <span class="summary-count" id="pillGreen">0</span>
          <span class="summary-label">On track</span>
        </div>
        <div class="summary-metric status-yellow">
          <span class="summary-count" id="pillYellow">0</span>
          <span class="summary-label">Keep up</span>
        </div>
        <div class="summary-metric status-red">
          <span class="summary-count" id="pillRed">0</span>
          <span class="summary-label">Catch up</span>
        </div>
      </div>
    </section>

    <section id="home" class="view active">
      <div class="grid" id="catGrid"></div>
    </section>

    <section id="category" class="view">
      <div class="cat-head">
        <button class="back" id="backBtn">‚Üê Home</button>
        <h2 id="catTitle"></h2>
        <div class="cat-week" id="catWeek"></div>
        <button class="icon-btn icon-only edit-cat" id="editCategory" aria-label="Edit category">‚úèÔ∏è</button>
        <button class="icon-btn icon-only add" id="addBtn" aria-label="Add activity">‚ûï</button>
      </div>
      <div id="taskList"></div>
    </section>

    <section id="config" class="view">
      <div class="config-panel">
        <div class="config-head">
          <h2>Configuration</h2>
        </div>
        <div class="config-actions">
          <button class="icon-btn" id="configAddCategory">Add category</button>
          <button class="icon-btn" id="configAddActivity">Add activity</button>
          <button class="icon-btn" id="configImport">Import backup (replace)</button>
          <button class="icon-btn" id="configExport">Export backup</button>
        </div>
        <p class="config-note">Importing a backup will replace your current routines and progress.</p>
      </div>
      <input type="file" id="configImportInput" accept="application/json" hidden />
    </section>
  </main>
</div>

<dialog id="taskDialog">
  <form method="dialog" id="taskForm">
    <div class="modal-head"><span id="dialogTitle">New activity</span><button type="button" class="icon-btn" id="closeDialog">‚úñ</button></div>
    <div class="modal-body">
      <div class="field">
        <label for="f_title">Name</label>
        <input type="text" id="f_title" placeholder="Ex: Brush teeth" required />
      </div>
      <div class="field">
        <label for="f_emoji">Emoji</label>
        <input type="text" id="f_emoji" placeholder="Ex: üòÅ" maxlength="3" />
        <div class="emoji-picker">
          <input type="search" id="emojiSearch" placeholder="Search (fruit, workout, relax...)" />
          <div class="emoji-results" id="emojiResults"></div>
        </div>
      </div>
      <div class="field">
        <label for="f_cat">Category</label>
        <select id="f_cat"></select>
      </div>
      <div class="field">
        <label for="f_importance">Priority</label>
        <select id="f_importance">
          <option value="must">üü• Must</option>
          <option value="should">üü® Should</option>
        </select>
      </div>
      <div class="field">
        <label for="f_recur">Frequency</label>
        <select id="f_recur">
          <option value="daily">Daily</option>
          <option value="specific">Specific day(s)</option>
          <option value="weekly">Weekly target</option>
        </select>
      </div>
      <div class="field" id="weeklyWrap" style="display:none">
        <label for="f_weeklyTimes">Times per week</label>
        <input type="number" id="f_weeklyTimes" min="1" max="6" value="1" />
      </div>
      <div class="field" id="specificWrap" style="display:none">
        <label>Days of the week</label>
        <div class="weekday-picker" id="specificDays"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="icon-btn" value="cancel">Cancel</button>
      <button type="button" class="icon-btn danger" id="deleteTask" style="display:none">Delete</button>
      <button class="icon-btn primary" id="saveTask" value="default">Save</button>
    </div>
  </form>
</dialog>

<dialog id="categoryDialog">
  <form method="dialog" id="categoryForm">
    <div class="modal-head"><span id="catDialogTitle">New category</span><button type="button" class="icon-btn" id="closeCategoryDialog">‚úñ</button></div>
    <div class="modal-body">
      <div class="field">
        <label for="c_name">Name</label>
        <input type="text" id="c_name" placeholder="Ex: Mindfulness" required />
      </div>
      <div class="field">
        <label for="c_emoji">Emoji</label>
        <input type="text" id="c_emoji" placeholder="Ex: üßò" maxlength="3" />
      </div>
      <div class="field">
        <label for="c_color">Accent color</label>
        <input type="color" id="c_color" value="#2563eb" />
      </div>
    </div>
    <div class="modal-actions">
      <button class="icon-btn" value="cancel">Cancel</button>
      <button type="button" class="icon-btn primary" id="saveCategory" value="default">Save</button>
    </div>
  </form>
</dialog>

<script>
const TZ = 'Europe/Paris'
const fmtDate = (d)=> new Date(d).toLocaleDateString('en-CA',{timeZone:TZ})
const todayISO = ()=> fmtDate(Date.now())
const uid = ()=> Math.random().toString(36).slice(2,9)
const WEEKDAY_SHORT = ['Mo','Tu','We','Th','Fr','Sa','Su']
const WEEKDAY_ORDER = [1,2,3,4,5,6,0]
const STORE_KEY='ROUTINE_BUDDY_V3'
const currentWeekStart = weekStart(todayISO())
const EMOJIS=[
  {char:'üçé', tags:['apple','fruit','nutrition','vitamin']},
  {char:'üç≥', tags:['egg','breakfast','protein','cooking']},
  {char:'ü•ó', tags:['salad','meal','veggies','nutrition']},
  {char:'ü•õ', tags:['milk','drink','calcium']},
  {char:'üíß', tags:['water','hydration']},
  {char:'ü´ñ', tags:['tea','drink']},
  {char:'‚òï', tags:['coffee','drink','break']},
  {char:'üöø', tags:['shower','hygiene']},
  {char:'ü™•', tags:['brush','teeth','hygiene']},
  {char:'üß¥', tags:['skincare','face','hygiene']},
  {char:'üßº', tags:['soap','hygiene']},
  {char:'ü§∏', tags:['warmup','fitness','mobility']},
  {char:'üèÉ', tags:['run','fitness','exercise']},
  {char:'üö∂', tags:['walk','stroll']},
  {char:'üí™', tags:['strength','workout','fitness']},
  {char:'üßò', tags:['yoga','relax','breathing']},
  {char:'üßò‚Äç‚ôÇÔ∏è', tags:['meditation','calm']},
  {char:'üßò‚Äç‚ôÄÔ∏è', tags:['yoga','calm']},
  {char:'üö≤', tags:['bike','fitness','outdoor']},
  {char:'üíÉ', tags:['dance','evening']},
  {char:'üõèÔ∏è', tags:['sleep','bed','night']},
  {char:'üìµ', tags:['digital detox','screen']},
  {char:'üò¥', tags:['nap','sleep']},
  {char:'ü™ü', tags:['airing','window']},
  {char:'üïØÔ∏è', tags:['ritual','calm']},
  {char:'üí¨', tags:['message','social']},
  {char:'ü§ù', tags:['friend','social','support']},
  {char:'üìû', tags:['call','family']},
  {char:'üï∫', tags:['dance','night out']},
  {char:'üìö', tags:['reading','book']},
  {char:'üìù', tags:['journal','writing']},
  {char:'üóÇÔ∏è', tags:['admin','paperwork']},
  {char:'üå≥', tags:['nature','walk']},
  {char:'üå¨Ô∏è', tags:['breathing','calm','rest']},
  {char:'üçΩÔ∏è', tags:['meal','connection','lunch']},
  {char:'üíª', tags:['course','learning','education']},
  {char:'üó£Ô∏è', tags:['language','speaking','education']},
  {char:'üé®', tags:['drawing','hobby','creativity']},
  {char:'üé∏', tags:['music','instrument','hobby']},
  {char:'üé≤', tags:['game','hobby','night']},
  {char:'üì∫', tags:['series','relax','hobby']},
  {char:'üéØ', tags:['goal','focus']},
  {char:'üß∫', tags:['laundry','chores']},
  {char:'üêü', tags:['fish','meal']},
  {char:'ü´ò', tags:['beans','meal']},
  {char:'üïØ', tags:['calm']},
  {char:'üçä', tags:['orange','fruit','vitamin']},
  {char:'üçã', tags:['lemon','fruit','citrus']},
  {char:'üçå', tags:['banana','fruit','potassium']},
  {char:'üçâ', tags:['watermelon','fruit','refresh']},
  {char:'üçá', tags:['grapes','fruit','snack']},
  {char:'üçì', tags:['strawberry','fruit','dessert']},
  {char:'ü´ê', tags:['blueberry','fruit','antioxidant']},
  {char:'üçí', tags:['cherry','fruit','dessert']},
  {char:'üçë', tags:['peach','fruit','snack']},
  {char:'ü•ù', tags:['kiwi','fruit','vitamin']},
  {char:'üçç', tags:['pineapple','fruit','tropical']},
  {char:'ü•≠', tags:['mango','fruit','tropical']},
  {char:'ü••', tags:['coconut','fruit','hydration']},
  {char:'ü•ë', tags:['avocado','fruit','healthy']},
  {char:'ü•¶', tags:['broccoli','veggie','greens']},
  {char:'ü•ï', tags:['carrot','veggie','beta']},
  {char:'üßÖ', tags:['onion','veggie','cooking']},
  {char:'ü•î', tags:['potato','veggie','starch']},
  {char:'üåΩ', tags:['corn','veggie','grains']},
  {char:'üç†', tags:['yam','veggie','roast']},
  {char:'ü•¨', tags:['lettuce','veggie','salad']},
  {char:'üçÜ', tags:['eggplant','veggie','grill']},
  {char:'üçÖ', tags:['tomato','veggie','garden']},
  {char:'üßÑ', tags:['garlic','veggie','seasoning']},
  {char:'ü´õ', tags:['peas','veggie','fiber']},
  {char:'ü•ú', tags:['peanut','snack','protein']},
  {char:'üçû', tags:['bread','carb','bakery']},
  {char:'ü•ê', tags:['croissant','bakery','breakfast']},
  {char:'ü•ñ', tags:['baguette','bread','bakery']},
  {char:'ü´ì', tags:['flatbread','bread','wrap']},
  {char:'ü•®', tags:['pretzel','snack','bakery']},
  {char:'üßÄ', tags:['cheese','dairy','protein']},
  {char:'ü•ö', tags:['egg','protein','breakfast']},
  {char:'ü•û', tags:['pancake','breakfast','brunch']},
  {char:'üßá', tags:['waffle','breakfast','brunch']},
  {char:'üçó', tags:['drumstick','meal','protein']},
  {char:'üçñ', tags:['ribs','meal','bbq']},
  {char:'ü•©', tags:['steak','meal','protein']},
  {char:'ü•ì', tags:['bacon','breakfast','protein']},
  {char:'üçî', tags:['burger','meal','fastfood']},
  {char:'üçü', tags:['fries','snack','fastfood']},
  {char:'üå≠', tags:['hotdog','meal','fastfood']},
  {char:'üçï', tags:['pizza','meal','slice']},
  {char:'ü•™', tags:['sandwich','meal','lunch']},
  {char:'üåÆ', tags:['taco','meal','fiesta']},
  {char:'üåØ', tags:['burrito','meal','wrap']},
  {char:'ü•ô', tags:['gyro','meal','mediterranean']},
  {char:'üßÜ', tags:['falafel','meal','veggie']},
  {char:'üçù', tags:['pasta','meal','comfort']},
  {char:'üçú', tags:['noodles','meal','broth']},
  {char:'üç≤', tags:['stew','meal','comfort']},
  {char:'üçõ', tags:['curry','meal','spicy']},
  {char:'üç£', tags:['sushi','meal','fresh']},
  {char:'üç§', tags:['shrimp','meal','seafood']},
  {char:'üç±', tags:['bento','meal','lunch']},
  {char:'ü•°', tags:['takeout','meal','box']},
  {char:'üçö', tags:['rice','staple','grain']},
  {char:'üçô', tags:['riceball','snack','bento']},
  {char:'üçò', tags:['cracker','snack','rice']},
  {char:'üç•', tags:['naruto','soup','ramen']},
  {char:'ü•ü', tags:['dumpling','meal','comfort']},
  {char:'üßÅ', tags:['cupcake','dessert','treat']},
  {char:'üç∞', tags:['cake','dessert','celebration']},
  {char:'üéÇ', tags:['birthday','cake','party']},
  {char:'üçÆ', tags:['flan','dessert','custard']},
  {char:'üç©', tags:['donut','dessert','snack']},
  {char:'üç™', tags:['cookie','dessert','bake']},
  {char:'üç´', tags:['chocolate','dessert','treat']},
  {char:'üç¨', tags:['candy','dessert','sweet']},
  {char:'üç≠', tags:['lollipop','dessert','sweet']},
  {char:'üçØ', tags:['honey','sweet','tea']},
  {char:'üçº', tags:['babybottle','feeding','infant']},
  {char:'ü•§', tags:['soda','drink','refresh']},
  {char:'üßã', tags:['bubbletea','drink','tapioca']},
  {char:'üçπ', tags:['cocktail','drink','party']},
  {char:'üç∏', tags:['martini','drink','evening']},
  {char:'üç∑', tags:['wine','drink','dinner']},
  {char:'üçª', tags:['beer','drink','cheers']},
  {char:'ü•Ç', tags:['cheers','drink','celebrate']},
  {char:'üç∫', tags:['lager','drink','pub']},
  {char:'ü•É', tags:['whiskey','drink','nightcap']},
  {char:'üç∂', tags:['sake','drink','japanese']},
  {char:'üçæ', tags:['champagne','drink','celebration']},
  {char:'ü•¢', tags:['chopsticks','utensil','eat']},
  {char:'üç¥', tags:['forkknife','utensil','dining']},
  {char:'ü•Ñ', tags:['spoon','utensil','stir']},
  {char:'üî™', tags:['knife','kitchen','prep']},
  {char:'üßä', tags:['ice','chill','drink']},
  {char:'üßÉ', tags:['juice','drink','box']},
  {char:'ü´ó', tags:['pour','drink','kitchen']},
  {char:'üçµ', tags:['greentea','drink','calm']},
  {char:'üßâ', tags:['mate','drink','energy']},
  {char:'ü´ï', tags:['fondue','meal','share']},
  {char:'üçß', tags:['shaveice','dessert','cool']},
  {char:'üç®', tags:['icecream','dessert','cold']},
  {char:'üç¶', tags:['softserve','dessert','treat']},
  {char:'üç°', tags:['dango','dessert','sweet']},
  {char:'üç¢', tags:['oden','meal','winter']},
  {char:'üçø', tags:['popcorn','snack','movie']},
  {char:'ü•´', tags:['canned','pantry','prep']},
  {char:'üßÇ', tags:['salt','seasoning','kitchen']},
  {char:'üßπ', tags:['cleaning','broom','chores']},
  {char:'üßΩ', tags:['cleaning','sponge','scrub']},
  {char:'üßª', tags:['paper','restroom','supplies']},
  {char:'ü™†', tags:['plunger','bathroom','repair']},
  {char:'ü™£', tags:['bucket','cleaning','water']},
  {char:'üßØ', tags:['extinguisher','safety','home']},
  {char:'üß∑', tags:['pin','sewing','kit']},
  {char:'üßñ', tags:['sauna','relax','spa']},
  {char:'üßñ‚Äç‚ôÇÔ∏è', tags:['sauna','relax','steam']},
  {char:'üßñ‚Äç‚ôÄÔ∏è', tags:['sauna','relax','spa']},
  {char:'üíÜ', tags:['massage','relax','selfcare']},
  {char:'üíÜ‚Äç‚ôÇÔ∏è', tags:['massage','calm','selfcare']},
  {char:'üíÜ‚Äç‚ôÄÔ∏è', tags:['massage','pamper','relax']},
  {char:'üíá', tags:['haircut','style','salon']},
  {char:'üíá‚Äç‚ôÇÔ∏è', tags:['barber','hair','grooming']},
  {char:'üíá‚Äç‚ôÄÔ∏è', tags:['hair','salon','trim']},
  {char:'üíÖ', tags:['nails','beauty','selfcare']},
  {char:'üíÑ', tags:['makeup','lipstick','beauty']},
  {char:'üíà', tags:['barber','pole','shop']},
  {char:'üóìÔ∏è', tags:['calendar','plan','schedule']},
  {char:'üìÜ', tags:['calendar','monthly','plan']},
  {char:'üìÖ', tags:['calendar','daily','organize']},
  {char:'üóíÔ∏è', tags:['notepad','notes','plan']},
  {char:'üìã', tags:['clipboard','checklist','tasks']},
  {char:'üìå', tags:['pin','reminder','board']},
  {char:'üìé', tags:['paperclip','organize','desk']},
  {char:'üìê', tags:['draft','geometry','measure']},
  {char:'üìè', tags:['measure','length','craft']},
  {char:'üßÆ', tags:['abacus','math','count']},
  {char:'üñäÔ∏è', tags:['pen','write','notes']},
  {char:'‚úèÔ∏è', tags:['pencil','sketch','notes']},
  {char:'üñáÔ∏è', tags:['paperclip','stack','desk']},
  {char:'üñ•Ô∏è', tags:['computer','work','desk']},
  {char:'‚å®Ô∏è', tags:['keyboard','type','office']},
  {char:'üñ±Ô∏è', tags:['mouse','computer','navigate']},
  {char:'üóÉÔ∏è', tags:['files','archive','storage']},
  {char:'üóÑÔ∏è', tags:['cabinet','files','office']},
  {char:'üìä', tags:['chart','analytics','report']},
  {char:'üìà', tags:['chart','growth','stats']},
  {char:'üìâ', tags:['chart','decline','analysis']},
  {char:'üßæ', tags:['receipt','budget','finance']},
  {char:'üèãÔ∏è', tags:['weights','gym','strength']},
  {char:'üèãÔ∏è‚Äç‚ôÇÔ∏è', tags:['weights','training','gym']},
  {char:'üèãÔ∏è‚Äç‚ôÄÔ∏è', tags:['weights','strength','fitness']},
  {char:'üèä', tags:['swim','pool','cardio']},
  {char:'üèä‚Äç‚ôÇÔ∏è', tags:['swim','exercise','pool']},
  {char:'üèä‚Äç‚ôÄÔ∏è', tags:['swim','fitness','pool']},
  {char:'üö¥', tags:['cycle','outdoor','cardio']},
  {char:'üö¥‚Äç‚ôÇÔ∏è', tags:['cycling','fitness','ride']},
  {char:'üö¥‚Äç‚ôÄÔ∏è', tags:['cycling','fitness','ride']},
  {char:'‚õπÔ∏è', tags:['dribble','sport','play']},
  {char:'‚õπÔ∏è‚Äç‚ôÇÔ∏è', tags:['basketball','sport','play']},
  {char:'‚õπÔ∏è‚Äç‚ôÄÔ∏è', tags:['fitness','basketball','sport']},
  {char:'ü§æ', tags:['handball','sport','active']},
  {char:'ü§æ‚Äç‚ôÇÔ∏è', tags:['sport','active','team']},
  {char:'ü§æ‚Äç‚ôÄÔ∏è', tags:['sport','active','team']},
  {char:'üèåÔ∏è', tags:['golf','outdoor','focus']},
  {char:'üèåÔ∏è‚Äç‚ôÇÔ∏è', tags:['golf','practice','swing']},
  {char:'üèåÔ∏è‚Äç‚ôÄÔ∏è', tags:['golf','outdoor','sport']},
]

const DEFAULT_CATEGORIES=[
  {id:'Fitness', name:'Fitness', emoji:'üí™', color:'#34d399'},
  {id:'Nutrition', name:'Nutrition', emoji:'ü•ó', color:'#f97316'},
  {id:'Rest', name:'Rest', emoji:'üò¥', color:'#a855f7'},
  {id:'Connection', name:'Connection', emoji:'ü§ù', color:'#f59e0b'},
  {id:'Learning', name:'Learning', emoji:'üìò', color:'#38bdf8'},
  {id:'Leisure', name:'Leisure', emoji:'üéâ', color:'#f472b6'},
]

function cloneDoneMap(source){
  const out={}
  if(source && typeof source==='object'){
    for(const [day, entries] of Object.entries(source)){
      if(entries && typeof entries==='object'){
        out[day]={...entries}
      }
    }
  }
  return out
}

function normalizeState(raw){
  const base = raw && typeof raw==='object' ? raw : {}
  const allowedViews=new Set(['home','category','config'])
  const next={
    tasks:Array.isArray(base.tasks) ? base.tasks.map(task=>({...task})) : [],
    done:cloneDoneMap(base.done),
    categories:Array.isArray(base.categories) ? base.categories.map(cat=>({...cat})) : [],
    ui: base.ui && typeof base.ui==='object' ? {...base.ui} : {},
  }
  next.ui.selectedWeekStart = next.ui.selectedWeekStart || next.ui.historyWeekStart || currentWeekStart
  next.ui.currentView = allowedViews.has(next.ui.currentView) ? next.ui.currentView : 'home'
  next.ui.currentCat = next.ui.currentCat || null
  next.ui.categoryWeekStart = next.ui.categoryWeekStart || next.ui.selectedWeekStart
  next.ui.editTaskId = null
  next.ui.editCategoryId = null
  delete next.ui.historyWeekStart
  delete next.ui.categorySource

  if(next.categories.length===0){
    next.categories = DEFAULT_CATEGORIES.map(c=>({...c}))
  }else{
    const defaults = Object.fromEntries(DEFAULT_CATEGORIES.map(c=>[c.id,c]))
    next.categories = next.categories.map(cat=>{
      const baseCat = defaults[cat.id] || {}
      const id = cat.id || ('cat-'+uid())
      return {
        id,
        name:cat.name || cat.label || baseCat.name || id,
        emoji:cat.emoji || baseCat.emoji || 'üìå',
        color:cat.color || baseCat.color || '#2563eb',
      }
    })
    for(const def of DEFAULT_CATEGORIES){
      if(!next.categories.some(c=>c.id===def.id)){
        next.categories.push({...def})
      }
    }
  }

  next.tasks = next.tasks.map(task=>{
    const copy={...task}
    copy.id = copy.id || uid()
    if(copy.importance==='nice'){ copy.importance='should' }
    if(copy.importance!=='must' && copy.importance!=='should'){ copy.importance='should' }
    if(!copy.recur || typeof copy.recur!=='object'){ copy.recur={type:'daily'} }
    if(copy?.recur?.type==='weekly' && Object.prototype.hasOwnProperty.call(copy.recur,'weekday')){
      delete copy.recur.weekday
    }
    if(copy?.recur?.type==='weekly'){
      if(typeof copy.recur.times!=='number' || copy.recur.times<1){ copy.recur.times=1 }
      copy.recur.times = Math.min(6, Math.max(1, Math.round(copy.recur.times)))
    }
    if(copy?.recur?.type==='specific' && Array.isArray(copy.recur.days)){
      copy.recur.days = copy.recur.days.map(d=> Number(d)).filter(d=> Number.isInteger(d))
    }
    if(!copy.cat){
      copy.cat = next.categories[0]?.id || DEFAULT_CATEGORIES[0]?.id || 'General'
    }
    return copy
  })

  for(const task of next.tasks){
    if(!next.categories.some(c=>c.id===task.cat)){
      next.categories.push({id:task.cat, name:task.cat, emoji:task.emoji || 'üìå', color:'#2563eb'})
    }
  }

  return next
}

let state = normalizeState(load() || seed())
save()

const els={
  summary: document.getElementById('summary'),
  pillGreen: document.getElementById('pillGreen'),
  pillYellow: document.getElementById('pillYellow'),
  pillRed: document.getElementById('pillRed'),
  catGrid: document.getElementById('catGrid'),
  home: document.getElementById('home'),
  category: document.getElementById('category'),
  config: document.getElementById('config'),
  weekControls: document.getElementById('weekControls'),
  weekLabel: document.getElementById('weekLabel'),
  weekPrev: document.getElementById('weekPrev'),
  weekNext: document.getElementById('weekNext'),
  configBtn: document.getElementById('configBtn'),
  backBtn: document.getElementById('backBtn'),
  catTitle: document.getElementById('catTitle'),
  catWeek: document.getElementById('catWeek'),
  editCategory: document.getElementById('editCategory'),
  addBtn: document.getElementById('addBtn'),
  taskList: document.getElementById('taskList'),
  taskDialog: document.getElementById('taskDialog'),
  closeDialog: document.getElementById('closeDialog'),
  dialogTitle: document.getElementById('dialogTitle'),
  f_title: document.getElementById('f_title'),
  f_emoji: document.getElementById('f_emoji'),
  f_cat: document.getElementById('f_cat'),
  f_importance: document.getElementById('f_importance'),
  f_recur: document.getElementById('f_recur'),
  weeklyWrap: document.getElementById('weeklyWrap'),
  f_weeklyTimes: document.getElementById('f_weeklyTimes'),
  specificWrap: document.getElementById('specificWrap'),
  specificDays: document.getElementById('specificDays'),
  emojiSearch: document.getElementById('emojiSearch'),
  emojiResults: document.getElementById('emojiResults'),
  saveTask: document.getElementById('saveTask'),
  deleteTask: document.getElementById('deleteTask'),
  categoryDialog: document.getElementById('categoryDialog'),
  categoryForm: document.getElementById('categoryForm'),
  catDialogTitle: document.getElementById('catDialogTitle'),
  closeCategoryDialog: document.getElementById('closeCategoryDialog'),
  c_name: document.getElementById('c_name'),
  c_emoji: document.getElementById('c_emoji'),
  c_color: document.getElementById('c_color'),
  saveCategory: document.getElementById('saveCategory'),
  configAddActivity: document.getElementById('configAddActivity'),
  configAddCategory: document.getElementById('configAddCategory'),
  configImport: document.getElementById('configImport'),
  configExport: document.getElementById('configExport'),
  configImportInput: document.getElementById('configImportInput'),
}

renderSummary()
renderHome()
if(state.ui.currentView==='category' && state.ui.currentCat){ renderCategory(state.ui.currentCat, state.ui.categoryWeekStart) }
updateWeekLabel()
updateView(state.ui.currentView)

els.backBtn.addEventListener('click', ()=>{
  state.ui.currentCat=null
  updateView('home')
})
els.addBtn.addEventListener('click', ()=> openTaskDialog('create'))
if(els.configBtn){
  els.configBtn.addEventListener('click', ()=>{
    if(state.ui.currentView==='config'){
      updateView('home')
    }else{
      state.ui.currentCat=null
      updateView('config')
    }
  })
}
if(els.configAddActivity){ els.configAddActivity.addEventListener('click', ()=> openTaskDialog('create')) }
if(els.configAddCategory){ els.configAddCategory.addEventListener('click', ()=> openCategoryDialog('create')) }
if(els.configExport){ els.configExport.addEventListener('click', exportBackup) }
if(els.configImport){ els.configImport.addEventListener('click', ()=>{ if(els.configImportInput) els.configImportInput.click() }) }
if(els.configImportInput){ els.configImportInput.addEventListener('change', handleImportFile) }
els.editCategory.addEventListener('click', ()=>{
  if(state.ui.currentCat){ openCategoryDialog('edit', state.ui.currentCat) }
})
els.closeDialog.addEventListener('click', ()=> els.taskDialog.close())
els.closeCategoryDialog.addEventListener('click', ()=> els.categoryDialog.close())
els.f_recur.addEventListener('change', onRecurChange)
els.weekPrev.addEventListener('click', ()=>{ changeSelectedWeek(-1) })
els.weekNext.addEventListener('click', ()=>{ changeSelectedWeek(1) })
els.emojiSearch.addEventListener('input', updateEmojiResults)
els.saveTask.addEventListener('click', submitTask)
els.deleteTask.addEventListener('click', deleteCurrentTask)
els.saveCategory.addEventListener('click', submitCategory)
if(els.categoryForm){ els.categoryForm.addEventListener('submit', e=>{ e.preventDefault(); submitCategory() }) }
if(els.categoryDialog){ els.categoryDialog.addEventListener('close', ()=>{ state.ui.editCategoryId=null }) }

updateEmojiResults()
initSpecificDayPicker()
onRecurChange()

function updateView(view){
  state.ui.currentView=view
  if(view==='category' && !state.ui.currentCat){
    state.ui.currentView='home'
    view='home'
  }
  const isCategory = view==='category'
  const isHome = view==='home'
  const isConfig = view==='config'
  if(!isCategory){
    state.ui.currentCat=null
  }
  els.home.classList.toggle('active', isHome)
  els.category.classList.toggle('active', isCategory)
  if(els.config){ els.config.classList.toggle('active', isConfig) }
  if(els.weekControls){ els.weekControls.style.display = isConfig ? 'none' : '' }
  if(els.summary){ els.summary.style.display = isConfig ? 'none' : '' }
  if(els.editCategory){
    els.editCategory.style.display = isCategory ? 'inline-flex' : 'none'
    els.editCategory.disabled = !isCategory
  }
  if(isCategory && state.ui.currentCat){
    renderCategory(state.ui.currentCat, state.ui.categoryWeekStart)
  }else if(isHome){
    renderHome()
  }
  updateConfigButton(view)
  save()
}

function updateConfigButton(view){
  if(!els.configBtn) return
  const isConfig = view==='config'
  els.configBtn.setAttribute('aria-label', isConfig ? 'Close configuration' : 'Open configuration')
  els.configBtn.setAttribute('aria-pressed', isConfig ? 'true' : 'false')
  els.configBtn.classList.toggle('active', isConfig)
}

function weekStart(ymd){
  const d = new Date(ymd+'T00:00:00')
  const day = (d.getDay()+6)%7
  d.setDate(d.getDate()-day)
  return fmtDate(d)
}
function addDays(ymd, days){
  const d = new Date(ymd+'T00:00:00')
  d.setDate(d.getDate()+days)
  return fmtDate(d)
}
function weekDays(weekStart){
  return Array.from({length:7}, (_,i)=> addDays(weekStart,i))
}
function formatWeekRange(weekStart){
  const start = new Date(weekStart+'T00:00:00')
  const end = new Date(start)
  end.setDate(start.getDate()+6)
  const opts={day:'numeric',month:'short'}
  return `${start.toLocaleDateString('en-US',opts)} ‚Äì ${end.toLocaleDateString('en-US',opts)}`
}
function compareDate(a,b){ return a.localeCompare(b) }
function limitDateForWeek(weekStart){
  if(weekStart===currentWeekStart){
    return todayISO()
  }
  return addDays(weekStart,6)
}
function isFuture(day, limit){ return compareDate(day, limit)>0 }

function renderSummary(){
  const week = state.ui.selectedWeekStart
  const days = weekDays(week)
  const limit = limitDateForWeek(week)
  const counts={green:0,yellow:0,red:0}
  for(const task of state.tasks){
    const status = taskWeeklyStatus(task, days, limit)
    if(status && Object.prototype.hasOwnProperty.call(counts, status)){
      counts[status]++
    }
  }
  els.pillGreen.textContent=counts.green
  els.pillYellow.textContent=counts.yellow
  els.pillRed.textContent=counts.red
}

function renderHome(){
  const week = state.ui.selectedWeekStart
  state.ui.categoryWeekStart = week
  const days = weekDays(week)
  const limit = limitDateForWeek(week)
  els.catGrid.innerHTML=''
  const categories = CATS()
  if(categories.length===0){
    els.catGrid.innerHTML='<p class="count">Add a category to get started.</p>'
    return
  }
  for(const c of categories){
    const tasks = state.tasks.filter(t=>t.cat===c.id)
    const statuses = tasks.length>0 ? days.map(day=> dayStatus(day, tasks, limit)) : days.map(()=> 'off')
    const countText = tasks.length>0 ? countsForCategory(tasks, days, limit) : 'Add activity'
    const catchup = tasks.length>0 ? catchupEmojis(tasks, days, limit) : []
    const catchupAttr = catchup.length ? '' : ' aria-hidden="true"'
    const catchupHtml = catchup.map(em=> escapeHtml(em||'‚ùó')).join('')
    const card=document.createElement('div')
    card.className='card'
    card.dataset.cat=c.id
    card.style.setProperty('--card-color', categoryColor(c.id))
    card.innerHTML=`
      <div class="card-head">
        <div class="catchup"${catchupAttr}>${catchupHtml}</div>
        <div class="card-title"><span class="cat-symbol">${escapeHtml(c.emoji || categoryEmoji(c.id))}</span><span>${escapeHtml(categoryLabel(c.id))}</span></div>
        <span class="count">${countText}</span>
      </div>
      <div class="cell-row">${statuses.map((s,idx)=>`<div class="week-cell status-${s}"><span>${WEEKDAY_SHORT[idx]}</span></div>`).join('')}</div>
    `
    card.addEventListener('click', ()=> openCategory(c.id, week))
    els.catGrid.appendChild(card)
  }
}

function catchupEmojis(tasks, days, limit){
  const set=new Set()
  for(const task of tasks){
    if(task.importance!=='must') continue
    if(taskWeeklyStatus(task, days, limit)==='red'){
      set.add(task.emoji || '‚ùó')
    }
  }
  return [...set]
}

function countsForCategory(tasks, days, limit){
  const relevantDays = days.filter(day=> !isFuture(day, limit))
  let totalOcc=0
  let doneOcc=0
  for(const task of tasks){
    if(task.recur.type==='weekly'){
      if(relevantDays.length===0) continue
      const times = task.recur.times || 1
      const doneCount = relevantDays.filter(day=> isDone(task, day)).length
      totalOcc+=times
      doneOcc+=Math.min(doneCount, times)
    }else{
      for(const day of relevantDays){
        if(isDue(task, day)){
          totalOcc+=1
          if(isDone(task, day)){ doneOcc+=1 }
        }
      }
    }
  }
  if(totalOcc===0) return '‚Äî'
  return `${doneOcc}/${totalOcc}`
}

function renderCategory(cat, week){
  state.ui.currentCat = cat
  const targetWeek = week || state.ui.selectedWeekStart
  state.ui.categoryWeekStart = targetWeek
  save()
  const tasks = state.tasks.filter(t=>t.cat===cat)
  els.catTitle.textContent = `${categoryEmoji(cat)} ${categoryLabel(cat)}`
  const weekLabel = targetWeek===currentWeekStart ? `This week ¬∑ ${formatWeekRange(targetWeek)}` : `Week ¬∑ ${formatWeekRange(targetWeek)}`
  els.catWeek.textContent = weekLabel
  const days = weekDays(targetWeek)
  const limit = limitDateForWeek(targetWeek)
  els.taskList.innerHTML=''
  if(tasks.length===0){
    els.taskList.innerHTML='<p class="count">Add an activity to this category.</p>'
    return
  }
  tasks.sort((a,b)=> (a.importance>b.importance?1:-1) || a.title.localeCompare(b.title))
  for(const task of tasks){
    const row=document.createElement('div')
    row.className='task'
    row.dataset.importance = task.importance
    const freqMark = frequencyEmoji(task.recur)
    row.innerHTML=`
      <div class="task-header">
        <span class="em">${escapeHtml(task.emoji||'üéØ')}</span>
        <div class="task-info">
          <div class="title">${escapeHtml(task.title)}${freqMark?` <span class="freq" aria-hidden="true">${freqMark}x</span>`:''}</div>
        </div>
        <div class="task-actions">
          <button type="button" data-act="edit" aria-label="Edit activity">‚úèÔ∏è</button>
        </div>
      </div>
      <div class="task-week"></div>
    `
    const weekRow = row.querySelector('.task-week')
    days.forEach((day,idx)=>{
      const status = dayStatusForTask(task, day, limit)
      const cell=document.createElement('button')
      cell.type='button'
      cell.className='week-cell status-'+status
      cell.dataset.day=day
      cell.dataset.task=task.id
      cell.textContent=WEEKDAY_SHORT[idx]
      const clickable = (status==='green' || status==='yellow' || status==='red')
      if(clickable){
        cell.classList.add('clickable')
        cell.addEventListener('click', ()=>{ toggleDone(task, day); refreshAll() })
      }else{
        cell.classList.add('disabled')
      }
      weekRow.appendChild(cell)
    })
    row.querySelector('[data-act=edit]').addEventListener('click', ()=> openTaskDialog('edit', task))
    els.taskList.appendChild(row)
  }
}

function refreshAll(){
  renderSummary()
  renderHome()
  if(state.ui.currentView==='category' && state.ui.currentCat){ renderCategory(state.ui.currentCat, state.ui.categoryWeekStart) }
  updateWeekLabel()
}

function updateWeekLabel(){
  if(!els.weekLabel) return
  const week = state.ui.selectedWeekStart
  const label = week===currentWeekStart ? `This week ¬∑ ${formatWeekRange(week)}` : `Week ¬∑ ${formatWeekRange(week)}`
  els.weekLabel.textContent = label
  if(els.weekNext){
    const canGoNext = compareDate(week, currentWeekStart)<0
    els.weekNext.disabled = !canGoNext
  }
}

function changeSelectedWeek(delta){
  const current = state.ui.selectedWeekStart
  const newWeek = addDays(current, delta*7)
  if(delta>0 && compareDate(newWeek, currentWeekStart)>0) return
  state.ui.selectedWeekStart = newWeek
  state.ui.categoryWeekStart = newWeek
  save()
  refreshAll()
}

function onRecurChange(){
  const v = els.f_recur.value
  els.specificWrap.style.display = v==='specific' ? 'block' : 'none'
  els.weeklyWrap.style.display = v==='weekly' ? 'block' : 'none'
}

function initSpecificDayPicker(){
  els.specificDays.innerHTML=''
  WEEKDAY_ORDER.forEach(day=>{
    const label=WEEKDAY_SHORT[(day+6)%7]
    const wrapper=document.createElement('label')
    wrapper.innerHTML=`<input type="checkbox" value="${day}">${label}`
    els.specificDays.appendChild(wrapper)
  })
}

function updateEmojiResults(){
  const q = els.emojiSearch.value.trim().toLowerCase()
  const list = q? EMOJIS.filter(e=> e.tags.some(t=>t.includes(q))): EMOJIS
  els.emojiResults.innerHTML=''
  list.forEach(e=>{
    const btn=document.createElement('button')
    btn.type='button'
    btn.textContent=e.char
    btn.addEventListener('click', ()=>{ els.f_emoji.value=e.char; els.f_emoji.focus() })
    els.emojiResults.appendChild(btn)
  })
}

function populateCategorySelect(selected){
  if(!els.f_cat) return
  const cats = CATS()
  els.f_cat.innerHTML = cats.map(c=>`<option value="${c.id}">${escapeHtml((c.emoji||categoryEmoji(c.id))+' '+categoryLabel(c.id))}</option>`).join('')
  if(selected && !cats.some(c=>c.id===selected)){
    const opt=document.createElement('option')
    opt.value=selected
    opt.textContent=categoryLabel(selected)
    els.f_cat.appendChild(opt)
  }
  if(selected){ els.f_cat.value=selected }
  if(!els.f_cat.value && els.f_cat.options.length>0){ els.f_cat.value = els.f_cat.options[0].value }
}

function openCategory(cat, week){
  state.ui.categoryWeekStart = week || state.ui.selectedWeekStart
  state.ui.currentCat = cat
  save()
  updateView('category')
}

function openCategoryDialog(mode, catId){
  if(!els.categoryDialog) return
  const isEdit = mode==='edit'
  const cat = isEdit ? state.categories.find(c=>c.id===catId) : null
  const editing = !!cat
  state.ui.editCategoryId = editing ? cat.id : null
  els.catDialogTitle.textContent = editing ? 'Edit category' : 'New category'
  if(editing){
    els.c_name.value = cat.name
    els.c_emoji.value = cat.emoji || ''
    els.c_color.value = cat.color || '#2563eb'
  }else{
    els.c_name.value=''
    els.c_emoji.value=''
    els.c_color.value='#2563eb'
  }
  els.categoryDialog.showModal()
  const focusField = ()=> els.c_name.focus()
  ;(window.requestAnimationFrame || window.setTimeout)(focusField, 0)
}

function openTaskDialog(mode, task){
  els.taskDialog.returnValue=''
  els.taskDialog.showModal()
  els.deleteTask.style.display = mode==='edit' ? 'inline-flex' : 'none'
  els.dialogTitle.textContent = mode==='edit' ? 'Edit activity' : 'New activity'
  state.ui.editTaskId = mode==='edit' ? task.id : null
  const cats = CATS()
  let selectedCat = mode==='edit' && task ? task.cat : state.ui.currentCat
  if(!selectedCat || !cats.some(c=>c.id===selectedCat)){
    selectedCat = cats[0]?.id || ''
  }
  populateCategorySelect(selectedCat)
  if(mode==='edit' && task){
    els.f_title.value = task.title
    els.f_emoji.value = task.emoji || ''
    els.f_cat.value = task.cat
    els.f_importance.value = task.importance
    if(task.recur.type==='daily'){ els.f_recur.value='daily' }
    else if(task.recur.type==='specific'){ els.f_recur.value='specific' }
    else { els.f_recur.value='weekly' }
    els.f_weeklyTimes.value = task.recur.type==='weekly' ? task.recur.times || 1 : 1
    onRecurChange()
    const boxes=[...els.specificDays.querySelectorAll('input')]
    boxes.forEach(box=>{ box.checked = task.recur.type==='specific' ? task.recur.days.includes(+box.value) : false })
  }else{
    els.f_title.value=''
    els.f_emoji.value=''
    els.f_cat.value = selectedCat || ''
    els.f_importance.value='must'
    els.f_recur.value='daily'
    els.f_weeklyTimes.value=1
    onRecurChange()
    els.specificDays.querySelectorAll('input').forEach(input=> input.checked=false)
  }
  updateEmojiResults()
}

function submitTask(e){
  e.preventDefault()
  const title = els.f_title.value.trim()
  if(!title) return
  const emoji = els.f_emoji.value.trim() || 'üéØ'
  const cat = els.f_cat.value
  const importance = els.f_importance.value
  const freq = els.f_recur.value
  if(!cat){ alert('Pick a category'); return }
  let recur
  if(freq==='daily') recur = {type:'daily'}
  if(freq==='specific'){
    const days = [...els.specificDays.querySelectorAll('input:checked')].map(i=> +i.value)
    if(days.length===0){ alert('Select at least one day'); return }
    recur = {type:'specific', days}
  }
  if(freq==='weekly'){
    let times = parseInt(els.f_weeklyTimes.value,10)
    if(Number.isNaN(times)){ times = 1 }
    times = Math.min(6, Math.max(1, times))
    els.f_weeklyTimes.value = times
    recur = {type:'weekly', times}
  }
  const nowWeek = todayISO()
  if(state.ui.editTaskId){
    const task = state.tasks.find(t=>t.id===state.ui.editTaskId)
    if(task){
      task.title=title
      task.emoji=emoji
      task.cat=cat
      task.importance=importance
      task.recur=recur
    }
  }else{
    state.tasks.push({id:uid(), cat, title, emoji, importance, recur, createdAt:nowWeek})
  }
  save()
  els.taskDialog.close()
  refreshAll()
}

function submitCategory(e){
  if(e){ e.preventDefault() }
  if(!els.categoryDialog) return
  const name = els.c_name.value.trim()
  if(!name){ els.c_name.focus(); return }
  let emoji = els.c_emoji.value.trim()
  if(!emoji){ emoji='üìå' }
  let color = (els.c_color.value || '#2563eb').trim()
  const hex = color.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i)
  if(!hex){
    color='#2563eb'
  }else if(hex[1].length===3){
    color = '#' + hex[1].split('').map(ch=>ch+ch).join('')
  }
  if(state.ui.editCategoryId){
    const cat = state.categories.find(c=>c.id===state.ui.editCategoryId)
    if(cat){
      cat.name = name
      cat.emoji = emoji
      cat.color = color
    }
  }else{
    const id = 'cat-'+uid()
    state.categories.push({id, name, emoji, color})
    state.ui.currentCat = id
  }
  state.ui.editCategoryId = null
  save()
  els.categoryDialog.close()
  populateCategorySelect(state.ui.currentCat)
  refreshAll()
}

function deleteCurrentTask(){
  if(!state.ui.editTaskId) return
  const idx = state.tasks.findIndex(t=>t.id===state.ui.editTaskId)
  if(idx>=0){ state.tasks.splice(idx,1) }
  for(const day in state.done){ if(state.done[day]) delete state.done[day][state.ui.editTaskId] }
  state.ui.editTaskId=null
  save()
  els.taskDialog.close()
  refreshAll()
}

function taskWeeklyStatus(task, days, limit){
  if(task.recur.type==='weekly'){
    const relevantDays = days.filter(day=> !isFuture(day, limit))
    if(relevantDays.length===0) return null
    const doneCount = relevantDays.filter(day=> isDone(task, day)).length
    const weekEnd = addDays(days[0],6)
    const isOngoing = compareDate(limit, weekEnd)<0
    if(isOngoing){
      if(doneCount>0) return 'green'
      return task.importance==='must' ? 'red' : 'yellow'
    }
    const target = task.recur.times || 1
    if(doneCount>=target) return 'green'
    return task.importance==='must' ? 'red' : 'yellow'
  }
  const dueDays = days.filter(day=> !isFuture(day, limit) && isDue(task, day))
  if(dueDays.length===0) return null
  const missing = dueDays.filter(day=> !isDone(task, day))
  if(missing.length===0) return 'green'
  return task.importance==='must' ? 'red' : 'yellow'
}

function dayStatus(day, tasks, limit){
  if(isFuture(day, limit)) return 'future'
  const due = tasks.filter(t=>isDue(t, day))
  if(due.length===0) return 'off'
  const missing = due.filter(t=>!isDone(t, day))
  if(missing.length===0) return 'green'
  const hasMust = missing.some(t=>{
    if(t.importance!=='must') return false
    if(t.recur.type==='weekly'){
      const weekEnd = addDays(weekStart(day),6)
      if(compareDate(limit, weekEnd)<0) return false
    }
    return true
  })
  return hasMust ? 'red' : 'yellow'
}

function dayStatusForTask(task, day, limit){
  if(isFuture(day, limit)) return 'future'
  if(!isDue(task, day)) return 'off'
  if(isDone(task, day)) return 'green'
  if(task.recur.type==='weekly'){
    const start = weekStart(day)
    const weekEnd = addDays(start,6)
    const span = weekDays(start)
    const doneSoFar = span.filter(d=> !isFuture(d, limit) && isDone(task, d)).length
    const target = task.recur.times || 1
    const isOngoing = compareDate(limit, weekEnd)<0
    if(isOngoing){
      if(doneSoFar>0) return 'yellow'
      return task.importance==='must' ? 'red' : 'yellow'
    }
    if(doneSoFar<target){
      return task.importance==='must' ? 'red' : 'yellow'
    }
    return 'off'
  }
  return task.importance==='must' ? 'red':'yellow'
}

function frequencyEmoji(recur){
  const map={1:'1Ô∏è‚É£',2:'2Ô∏è‚É£',3:'3Ô∏è‚É£',4:'4Ô∏è‚É£',5:'5Ô∏è‚É£',6:'6Ô∏è‚É£',7:'7Ô∏è‚É£'}
  if(!recur) return ''
  if(recur.type==='daily') return '7Ô∏è‚É£'
  if(recur.type==='weekly'){
    const times = Math.min(7, Math.max(1, recur.times||1))
    return map[times] || ''
  }
  if(recur.type==='specific'){
    const count = Array.isArray(recur.days) ? Math.min(7, Math.max(1, recur.days.length)) : 0
    return map[count] || ''
  }
  return ''
}

function statusFromDays(days){
  if(days.every(s=>s==='off' || s==='future' || s==='green')){
    if(days.some(s=>s==='green')) return 'green'
    return 'future'
  }
  if(days.some(s=>s==='red')) return 'red'
  if(days.some(s=>s==='yellow')) return 'yellow'
  return 'green'
}

function isDue(task, ymd){
  const d = new Date(ymd+'T00:00:00')
  const w = d.getDay()
  if(task.recur.type==='daily') return true
  if(task.recur.type==='weekly'){
    const start = weekStart(ymd)
    const span = weekDays(start)
    const idx = span.indexOf(ymd)
    if(idx<0) return false
    const times = task.recur.times || 1
    const doneBefore = span.slice(0, idx).filter(day=> isDone(task, day)).length
    return doneBefore < times
  }
  if(task.recur.type==='specific') return task.recur.days.includes(w)
  if(task.recur.type==='everyX'){ // fallback legacy
    const anchor = new Date((task.recur.anchor||task.createdAt)+'T00:00:00')
    const diff = Math.floor((d-anchor)/86400000)
    return diff>=0 && diff % (task.recur.interval||3)===0
  }
  return false
}

function isDone(task, ymd){ return !!(state.done[ymd] && state.done[ymd][task.id]) }
function toggleDone(task, ymd){
  state.done[ymd] = state.done[ymd] || {}
  if(isDone(task, ymd)){
    delete state.done[ymd][task.id]
    if(Object.keys(state.done[ymd]).length===0){ delete state.done[ymd] }
  }else{
    state.done[ymd][task.id] = true
  }
  save()
}

function categoryById(id){ return state.categories.find(c=>c.id===id) || null }
function categoryLabel(id){
  const cat = categoryById(id)
  return cat ? cat.name : id
}
function categoryEmoji(id){
  const cat = categoryById(id)
  return cat ? (cat.emoji || 'üìå') : 'üìå'
}
function categoryColor(id){
  const cat = categoryById(id)
  return cat ? (cat.color || '#2563eb') : '#2563eb'
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }

function CATS(){
  return state.categories.slice()
}

function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)) }
function load(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)) }catch(e){return null}}

function exportBackup(){
  try{
    const data = JSON.stringify(state, null, 2)
    const blob = new Blob([data], {type:'application/json'})
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `routine-buddy-backup-${todayISO()}.json`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
  }catch(err){
    console.error('Export failed', err)
  }
}

function handleImportFile(event){
  const input = event.target
  const file = input && input.files ? input.files[0] : null
  if(!file) return
  const reader = new FileReader()
  reader.onload = e=>{
    try{
      const text = typeof e.target?.result==='string' ? e.target.result : ''
      const parsed = JSON.parse(text)
      if(!confirm('Importing this backup will replace your current data. Continue?')) return
      const previousView = state.ui?.currentView || 'home'
      state = normalizeState(parsed)
      if(previousView==='config'){ state.ui.currentView='config' }
      save()
      renderSummary()
      renderHome()
      updateWeekLabel()
      updateView(state.ui.currentView)
    }catch(err){
      console.error('Import failed', err)
      alert('Could not import backup. Make sure the file is a valid Routine Buddy export.')
    }finally{
      input.value=''
    }
  }
  reader.onerror = ()=>{
    alert('Could not read the selected file.')
    input.value=''
  }
  reader.readAsText(file)
}

function seed(){
  const today = todayISO()
  const mk=(cat,title,emoji,importance,recur)=>({id:uid(),cat,title,emoji,importance,recur,createdAt:today})
  const S=[]
  S.push(mk('Fitness','5 min warm-up','ü§∏','should',{type:'daily'}))
  S.push(mk('Fitness','20 min cardio','üèÉ','must',{type:'specific',days:[1,3,5]}))
  S.push(mk('Fitness','15 min strength','üí™','must',{type:'specific',days:[2,4]}))
  S.push(mk('Fitness','Post-session stretches','üßò','should',{type:'daily'}))
  S.push(mk('Fitness','Bike ride','üö≤','should',{type:'specific',days:[6]}))

  S.push(mk('Nutrition','Protein breakfast','üç≥','must',{type:'daily'}))
  S.push(mk('Nutrition','2 fresh fruits','üçé','should',{type:'daily'}))
  S.push(mk('Nutrition','Drink 1.5L water','üíß','must',{type:'daily'}))
  S.push(mk('Nutrition','Veggie meal','ü•ó','should',{type:'specific',days:[1,4]}))
  S.push(mk('Nutrition','Fish meal','üêü','should',{type:'specific',days:[5]}))

  S.push(mk('Rest','In bed before 11pm','üõèÔ∏è','must',{type:'daily'}))
  S.push(mk('Rest','Screen off 1h before bed','üìµ','should',{type:'daily'}))
  S.push(mk('Rest','20 min nap','üò¥','should',{type:'specific',days:[1,4]}))
  S.push(mk('Rest','Calm breathing','üå¨Ô∏è','should',{type:'specific',days:[2,5]}))
  S.push(mk('Rest','Air out bedroom','ü™ü','should',{type:'daily'}))

  S.push(mk('Connection','Message a loved one','üí¨','should',{type:'specific',days:[2,4]}))
  S.push(mk('Connection','Call family','üìû','must',{type:'weekly',times:1}))
  S.push(mk('Connection','Shared lunch','üçΩÔ∏è','should',{type:'specific',days:[3]}))
  S.push(mk('Connection','Give a sincere compliment','ü§ù','should',{type:'daily'}))
  S.push(mk('Connection','Social outing','üï∫','must',{type:'specific',days:[5]}))

  S.push(mk('Learning','Read for 15 min','üìö','should',{type:'daily'}))
  S.push(mk('Learning','Online course','üíª','must',{type:'specific',days:[1,3]}))
  S.push(mk('Learning','Review vocabulary','üóÇÔ∏è','should',{type:'specific',days:[2,5]}))
  S.push(mk('Learning','Practice language','üó£Ô∏è','should',{type:'specific',days:[4]}))
  S.push(mk('Learning','Learning journal','üìù','should',{type:'weekly',times:1}))

  S.push(mk('Leisure','Drawing session','üé®','should',{type:'specific',days:[6]}))
  S.push(mk('Leisure','Play music','üé∏','should',{type:'specific',days:[2,5]}))
  S.push(mk('Leisure','Game night','üé≤','should',{type:'specific',days:[5]}))
  S.push(mk('Leisure','Nature outing','üå≥','should',{type:'specific',days:[6]}))
  S.push(mk('Leisure','Watch a show','üì∫','should',{type:'daily'}))

  return {
    tasks:S,
    done:{},
    categories: DEFAULT_CATEGORIES.map(c=>({...c})),
    ui:{currentView:'home', selectedWeekStart:currentWeekStart, categoryWeekStart:currentWeekStart, currentCat:null}
  }
}

if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('service-worker.js').catch(err=> console.error('SW registration failed', err))
  })
}
</script>
</body>
</html>
