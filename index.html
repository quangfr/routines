<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Routine Buddy Â· Prototype</title>
<style>
:root{
  color-scheme:light;
  --bg:#f4f7fb;
  --panel:#ffffff;
  --muted:#5b708b;
  --text:#1a2433;
  --border:#d9e2ef;
  --accent:#2563eb;
  --ok:#16a34a;
  --warn:#eab308;
  --bad:#dc2626;
  --future:#e5edf9;
  --off:#f1f5f9;
  --radius:18px;
  --cat-Fitness:#34d399;
  --cat-Nutrition:#f97316;
  --cat-Rest:#a855f7;
  --cat-Connection:#f59e0b;
  --cat-Learning:#38bdf8;
  --cat-Leisure:#f472b6;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 "Inter", system-ui,-apple-system,"Segoe UI",sans-serif}
button{font:inherit;color:inherit}
.app{min-height:100svh;display:flex;flex-direction:column;}
header{position:sticky;top:0;z-index:4;background:rgba(255,255,255,.92);backdrop-filter:blur(16px);border-bottom:1px solid var(--border)}
.head-wrap{display:flex;align-items:center;gap:12px;padding:12px 16px;max-width:960px;margin:0 auto;width:100%}
.h-title{font-weight:700;font-size:18px;display:flex;align-items:center;gap:8px}
.h-grow{flex:1}
.icon-btn{background:var(--panel);border:1px solid var(--border);color:var(--text);border-radius:12px;padding:8px 12px;display:inline-flex;align-items:center;gap:8px;cursor:pointer;transition:all .15s ease}
.icon-btn:hover{border-color:var(--accent);color:var(--accent)}
.icon-btn:active{transform:translateY(1px)}

main{flex:1;display:grid;grid-template-rows:auto 1fr;gap:12px;padding:12px}
main>section{max-width:960px;width:100%;margin:0 auto}
.summary{display:flex;flex-direction:column;gap:12px;border:1px solid var(--border);border-radius:var(--radius);padding:16px;background:var(--panel);box-shadow:0 12px 32px rgba(15,23,42,.08)}
.summary-head{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.week-label{font-weight:600;font-size:18px}
.status-pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{font-size:14px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--off);display:flex;gap:6px;align-items:center;font-weight:500}
.week-cells{display:flex;gap:6px;flex-wrap:wrap}
.week-cell{width:44px;height:44px;border-radius:12px;border:1px solid transparent;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:12px;font-weight:600;gap:2px;cursor:default}
.week-cell .dot{font-size:18px}
.week-cell.status-green{background:rgba(22,163,74,.12);color:#047857;border-color:rgba(22,163,74,.25)}
.week-cell.status-yellow{background:rgba(234,179,8,.18);color:#92400e;border-color:rgba(234,179,8,.28)}
.week-cell.status-red{background:rgba(220,38,38,.14);color:#b91c1c;border-color:rgba(220,38,38,.3)}
.week-cell.status-future{background:var(--future);color:#64748b;border:1px dashed rgba(148,163,184,.6)}
.week-cell.status-off{background:var(--off);color:#94a3b8;border:1px dashed rgba(148,163,184,.35)}

.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.card{background:var(--panel);border:2px solid var(--border);border-radius:var(--radius);padding:16px;display:flex;flex-direction:column;gap:12px;min-height:150px;box-shadow:0 12px 24px rgba(15,23,42,.06);cursor:pointer;transition:transform .15s ease, box-shadow .15s ease}
.card:hover{transform:translateY(-2px);box-shadow:0 18px 36px rgba(15,23,42,.08)}
.card-head{display:flex;align-items:center;gap:10px}
.card-head .dot{width:12px;height:12px;border-radius:50%}
.card h3{margin:0;font-size:18px;font-weight:700}
.status{margin-left:auto;border-radius:10px;padding:4px 10px;font-size:13px;border:1px solid var(--border);background:var(--off);font-weight:600}
.count{font-size:14px;color:var(--muted)}
.cell-row{display:flex;gap:6px}
.cell-row .week-cell{flex:1;min-width:0;cursor:default}

.view{display:none}
.view.active{display:block}
.cat-head{display:flex;align-items:center;gap:12px;margin:6px 0 14px}
.back{padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);cursor:pointer}
.add{margin-left:auto}
.cat-head h2{margin:0;font-size:22px}
.cat-week{margin-left:auto;font-weight:600;color:var(--muted)}
.task{position:relative;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:12px;box-shadow:0 10px 24px rgba(15,23,42,.04)}
.task + .task{margin-top:12px}
.task-header{display:flex;align-items:center;gap:12px}
.task .em{font-size:28px}
.task .title{font-weight:600;font-size:18px}
.task .badges{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:13px}
.task-actions{display:flex;gap:8px;align-items:center;margin-left:auto}
.task-actions button{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--off);cursor:pointer}
.week-grid{display:flex;gap:6px;flex-wrap:wrap}
.week-cell button{all:unset}
.task-week{display:flex;gap:6px;flex-wrap:wrap}
.task-week .week-cell{width:42px;height:46px}
.task-week .week-cell.clickable{cursor:pointer}
.task-week .week-cell.clickable:focus-visible{outline:2px solid var(--accent)}
.task-week .week-cell.disabled{opacity:.45;cursor:not-allowed}

.history-head{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.history-head h2{margin:0;font-size:20px}
.history-nav{display:flex;gap:8px;margin-left:auto}
.history-nav button{padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:var(--panel);cursor:pointer}
.history-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}

/* Dialog */
dialog{border:none;border-radius:18px;padding:0;background:var(--panel);color:var(--text);width:min(92vw,460px);box-shadow:0 28px 60px rgba(15,23,42,.24)}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--border);font-weight:700;font-size:18px}
.modal-body{padding:18px;display:grid;gap:16px}
.field{display:grid;gap:6px}
.field label{font-weight:600;font-size:14px;color:#475569}
.modal-body input,.modal-body select,.modal-body textarea{background:var(--off);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;font:inherit}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:16px 18px;border-top:1px solid var(--border)}
.modal-actions button{padding:8px 16px;border-radius:12px;border:1px solid var(--border);background:var(--panel);cursor:pointer;font-weight:600}
.modal-actions .primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.modal-actions .danger{color:var(--bad);border-color:rgba(220,38,38,.3)}

.emoji-picker{display:grid;gap:10px;border:1px solid var(--border);border-radius:14px;padding:10px;background:var(--off)}
.emoji-results{display:grid;grid-template-columns:repeat(auto-fit,minmax(40px,1fr));gap:6px;max-height:140px;overflow:auto}
.emoji-results button{background:var(--panel);border:1px solid var(--border);border-radius:10px;height:40px;display:grid;place-items:center;font-size:24px;cursor:pointer}
.emoji-results button:hover{border-color:var(--accent)}
.weekday-picker{display:flex;flex-wrap:wrap;gap:8px}
.weekday-picker label{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:12px;border:1px solid var(--border);background:var(--panel);cursor:pointer;font-size:14px}
.weekday-picker input{accent-color:var(--accent)}

footer{position:sticky;bottom:0;background:rgba(255,255,255,.94);backdrop-filter:blur(16px);border-top:1px solid var(--border)}
.nav{display:flex;gap:10px;padding:10px;max-width:960px;margin:0 auto;width:100%}
.nav button{flex:1;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);padding:12px;font-weight:600;cursor:pointer}
.nav button.active{background:var(--accent);color:#fff;border-color:var(--accent)}

@media (max-width:520px){
  .week-cell{width:42px;height:42px}
  .summary{padding:14px}
  .card{padding:14px}
  .task-week .week-cell{width:40px;height:44px}
}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="head-wrap">
      <div class="h-title"><span aria-hidden="true">ğŸ‘¥</span>Routine Buddy</div>
      <div class="h-grow"></div>
      <button class="icon-btn" id="quickAdd">+ New activity</button>
    </div>
  </header>

  <main>
    <section class="summary" id="summary">
      <div class="summary-head">
        <div class="week-label" id="summaryWeekLabel"></div>
        <div class="status-pills">
          <span class="pill">ğŸŸ© <span id="pillGreen">0</span></span>
          <span class="pill">ğŸŸ¨ <span id="pillYellow">0</span></span>
          <span class="pill">ğŸŸ¥ <span id="pillRed">0</span></span>
        </div>
      </div>
      <div class="week-cells" id="summaryCells"></div>
      <p class="count" style="margin:0" id="summaryLegend">A green week means every due task was completed.</p>
    </section>

    <section id="home" class="view active">
      <div class="grid" id="catGrid"></div>
    </section>

    <section id="history" class="view">
      <div class="history-head">
        <h2>Weekly history</h2>
        <div class="history-nav">
          <button class="icon-btn" id="historyPrev">â† Previous week</button>
          <button class="icon-btn" id="historyNext">Next week â†’</button>
        </div>
      </div>
      <div class="count" id="historyLabel"></div>
      <div class="history-grid" id="historyGrid"></div>
    </section>

    <section id="category" class="view">
      <div class="cat-head">
        <button class="back" id="backBtn">â† Home</button>
        <h2 id="catTitle"></h2>
        <div class="cat-week" id="catWeek"></div>
        <button class="icon-btn add" id="addBtn">+ Add</button>
      </div>
      <div id="taskList"></div>
    </section>
  </main>

  <footer>
    <div class="nav">
      <button id="navHome" class="active">ğŸ  Home</button>
      <button id="navHistory">ğŸ“š History</button>
    </div>
  </footer>
</div>

<dialog id="taskDialog">
  <form method="dialog" id="taskForm">
    <div class="modal-head"><span id="dialogTitle">New activity</span><button type="button" class="icon-btn" id="closeDialog">âœ–</button></div>
    <div class="modal-body">
      <div class="field">
        <label for="f_title">Name</label>
        <input type="text" id="f_title" placeholder="Ex: Brush teeth" required />
      </div>
      <div class="field">
        <label for="f_emoji">Emoji</label>
        <input type="text" id="f_emoji" placeholder="Ex: ğŸ˜" maxlength="3" />
        <div class="emoji-picker">
          <input type="search" id="emojiSearch" placeholder="Search (fruit, workout, relax...)" />
          <div class="emoji-results" id="emojiResults"></div>
        </div>
      </div>
      <div class="field">
        <label for="f_cat">Category</label>
        <select id="f_cat"></select>
      </div>
      <div class="field">
        <label for="f_importance">Priority</label>
        <select id="f_importance">
          <option value="must">Must do</option>
          <option value="nice">Nice to have</option>
        </select>
      </div>
      <div class="field">
        <label for="f_recur">Frequency</label>
        <select id="f_recur">
          <option value="daily">Daily</option>
          <option value="specific">Specific day(s)</option>
          <option value="weekly">Weekly</option>
        </select>
      </div>
      <div class="field" id="specificWrap" style="display:none">
        <label>Days of the week</label>
        <div class="weekday-picker" id="specificDays"></div>
      </div>
      <div class="field" id="weeklyWrap" style="display:none">
        <label for="f_weekday">Preferred day</label>
        <select id="f_weekday">
          <option value="1">Monday</option>
          <option value="2">Tuesday</option>
          <option value="3">Wednesday</option>
          <option value="4">Thursday</option>
          <option value="5">Friday</option>
          <option value="6">Saturday</option>
          <option value="0">Sunday</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="icon-btn" value="cancel">Cancel</button>
      <button type="button" class="icon-btn danger" id="deleteTask" style="display:none">Delete</button>
      <button class="icon-btn primary" id="saveTask" value="default">Save</button>
    </div>
  </form>
</dialog>

<script>
const TZ = 'Europe/Paris'
const fmtDate = (d)=> new Date(d).toLocaleDateString('en-CA',{timeZone:TZ})
const todayISO = ()=> fmtDate(Date.now())
const uid = ()=> Math.random().toString(36).slice(2,9)
const WEEKDAY_SHORT = ['Mo','Tu','We','Th','Fr','Sa','Su']
const WEEKDAY_ORDER = [1,2,3,4,5,6,0]
const STORE_KEY='ROUTINE_BUDDY_V3'
const currentWeekStart = weekStart(todayISO())
const EMOJIS=[
  {char:'ğŸ', tags:['apple','fruit','nutrition','vitamin']},
  {char:'ğŸ³', tags:['egg','breakfast','protein','cooking']},
  {char:'ğŸ¥—', tags:['salad','meal','veggies','nutrition']},
  {char:'ğŸ¥›', tags:['milk','drink','calcium']},
  {char:'ğŸ’§', tags:['water','hydration']},
  {char:'ğŸ«–', tags:['tea','drink']},
  {char:'â˜•', tags:['coffee','drink','break']},
  {char:'ğŸš¿', tags:['shower','hygiene']},
  {char:'ğŸª¥', tags:['brush','teeth','hygiene']},
  {char:'ğŸ§´', tags:['skincare','face','hygiene']},
  {char:'ğŸ§¼', tags:['soap','hygiene']},
  {char:'ğŸ¤¸', tags:['warmup','fitness','mobility']},
  {char:'ğŸƒ', tags:['run','fitness','exercise']},
  {char:'ğŸš¶', tags:['walk','stroll']},
  {char:'ğŸ’ª', tags:['strength','workout','fitness']},
  {char:'ğŸ§˜', tags:['yoga','relax','breathing']},
  {char:'ğŸ§˜â€â™‚ï¸', tags:['meditation','calm']},
  {char:'ğŸ§˜â€â™€ï¸', tags:['yoga','calm']},
  {char:'ğŸš²', tags:['bike','fitness','outdoor']},
  {char:'ğŸ’ƒ', tags:['dance','evening']},
  {char:'ğŸ›ï¸', tags:['sleep','bed','night']},
  {char:'ğŸ“µ', tags:['digital detox','screen']},
  {char:'ğŸ˜´', tags:['nap','sleep']},
  {char:'ğŸªŸ', tags:['airing','window']},
  {char:'ğŸ•¯ï¸', tags:['ritual','calm']},
  {char:'ğŸ’¬', tags:['message','social']},
  {char:'ğŸ¤', tags:['friend','social','support']},
  {char:'ğŸ“', tags:['call','family']},
  {char:'ğŸ•º', tags:['dance','night out']},
  {char:'ğŸ“š', tags:['reading','book']},
  {char:'ğŸ“', tags:['journal','writing']},
  {char:'ğŸ—‚ï¸', tags:['admin','paperwork']},
  {char:'ğŸŒ³', tags:['nature','walk']},
  {char:'ğŸŒ¬ï¸', tags:['breathing','calm','rest']},
  {char:'ğŸ½ï¸', tags:['meal','connection','lunch']},
  {char:'ğŸ’»', tags:['course','learning','education']},
  {char:'ğŸ—£ï¸', tags:['language','speaking','education']},
  {char:'ğŸ¨', tags:['drawing','hobby','creativity']},
  {char:'ğŸ¸', tags:['music','instrument','hobby']},
  {char:'ğŸ²', tags:['game','hobby','night']},
  {char:'ğŸ“º', tags:['series','relax','hobby']},
  {char:'ğŸ¯', tags:['goal','focus']},
  {char:'ğŸ§º', tags:['laundry','chores']},
  {char:'ğŸŸ', tags:['fish','meal']},
  {char:'ğŸ«˜', tags:['beans','meal']},
  {char:'ğŸ•¯', tags:['calm']}
]

let state = load() || seed()
if(!state.ui){ state.ui={} }
state.ui.historyWeekStart = state.ui.historyWeekStart || currentWeekStart
state.ui.currentView = state.ui.currentView || 'home'
state.ui.currentCat = state.ui.currentCat || null
state.ui.categoryWeekStart = state.ui.categoryWeekStart || currentWeekStart
state.ui.editTaskId = null
save()

const els={
  summaryWeekLabel: document.getElementById('summaryWeekLabel'),
  summaryCells: document.getElementById('summaryCells'),
  pillGreen: document.getElementById('pillGreen'),
  pillYellow: document.getElementById('pillYellow'),
  pillRed: document.getElementById('pillRed'),
  summaryLegend: document.getElementById('summaryLegend'),
  catGrid: document.getElementById('catGrid'),
  home: document.getElementById('home'),
  history: document.getElementById('history'),
  category: document.getElementById('category'),
  navHome: document.getElementById('navHome'),
  navHistory: document.getElementById('navHistory'),
  quickAdd: document.getElementById('quickAdd'),
  historyPrev: document.getElementById('historyPrev'),
  historyNext: document.getElementById('historyNext'),
  historyLabel: document.getElementById('historyLabel'),
  historyGrid: document.getElementById('historyGrid'),
  backBtn: document.getElementById('backBtn'),
  catTitle: document.getElementById('catTitle'),
  catWeek: document.getElementById('catWeek'),
  addBtn: document.getElementById('addBtn'),
  taskList: document.getElementById('taskList'),
  taskDialog: document.getElementById('taskDialog'),
  closeDialog: document.getElementById('closeDialog'),
  dialogTitle: document.getElementById('dialogTitle'),
  f_title: document.getElementById('f_title'),
  f_emoji: document.getElementById('f_emoji'),
  f_cat: document.getElementById('f_cat'),
  f_importance: document.getElementById('f_importance'),
  f_recur: document.getElementById('f_recur'),
  specificWrap: document.getElementById('specificWrap'),
  specificDays: document.getElementById('specificDays'),
  weeklyWrap: document.getElementById('weeklyWrap'),
  f_weekday: document.getElementById('f_weekday'),
  emojiSearch: document.getElementById('emojiSearch'),
  emojiResults: document.getElementById('emojiResults'),
  saveTask: document.getElementById('saveTask'),
  deleteTask: document.getElementById('deleteTask'),
}

renderSummary()
renderHome()
renderHistory()
if(state.ui.currentView==='category' && state.ui.currentCat){ openCategory(state.ui.currentCat, state.ui.categoryWeekStart) }
updateView(state.ui.currentView)

els.navHome.addEventListener('click', ()=>{ updateView('home') })
els.navHistory.addEventListener('click', ()=>{ updateView('history') })
els.backBtn.addEventListener('click', ()=>{ updateView('home'); state.ui.currentCat=null; save() })
els.addBtn.addEventListener('click', ()=> openTaskDialog('create'))
els.quickAdd.addEventListener('click', ()=> openTaskDialog('create'))
els.closeDialog.addEventListener('click', ()=> els.taskDialog.close())
els.f_recur.addEventListener('change', onRecurChange)
els.historyPrev.addEventListener('click', ()=>{ changeHistoryWeek(-1) })
els.historyNext.addEventListener('click', ()=>{ changeHistoryWeek(1) })
els.emojiSearch.addEventListener('input', updateEmojiResults)
els.saveTask.addEventListener('click', submitTask)
els.deleteTask.addEventListener('click', deleteCurrentTask)

updateEmojiResults()
initSpecificDayPicker()
onRecurChange()

function updateView(view){
  state.ui.currentView=view
  save()
  els.home.classList.toggle('active', view==='home')
  els.history.classList.toggle('active', view==='history')
  els.category.classList.toggle('active', view==='category')
  els.navHome.classList.toggle('active', view==='home')
  els.navHistory.classList.toggle('active', view==='history')
  if(els.quickAdd){ els.quickAdd.style.display = view==='home' ? 'inline-flex' : 'none' }
  if(view==='home'){ renderSummary(); renderHome() }
  if(view==='history'){ renderHistory() }
  if(view==='category' && state.ui.currentCat){ renderCategory(state.ui.currentCat, state.ui.categoryWeekStart) }
}

function weekStart(ymd){
  const d = new Date(ymd+'T00:00:00')
  const day = (d.getDay()+6)%7
  d.setDate(d.getDate()-day)
  return fmtDate(d)
}
function addDays(ymd, days){
  const d = new Date(ymd+'T00:00:00')
  d.setDate(d.getDate()+days)
  return fmtDate(d)
}
function weekDays(weekStart){
  return Array.from({length:7}, (_,i)=> addDays(weekStart,i))
}
function formatWeekRange(weekStart){
  const start = new Date(weekStart+'T00:00:00')
  const end = new Date(start)
  end.setDate(start.getDate()+6)
  const opts={day:'numeric',month:'short'}
  return `${start.toLocaleDateString('en-US',opts)} â€“ ${end.toLocaleDateString('en-US',opts)}`
}
function compareDate(a,b){ return a.localeCompare(b) }
function limitDateForWeek(weekStart){
  if(weekStart===currentWeekStart){
    return todayISO()
  }
  return addDays(weekStart,6)
}
function isFuture(day, limit){ return compareDate(day, limit)>0 }

function renderSummary(){
  const week = currentWeekStart
  const days = weekDays(week)
  const limit = limitDateForWeek(week)
  els.summaryWeekLabel.textContent = `Week ${formatWeekRange(week)}`
  const counts={green:0,yellow:0,red:0}
  for(const task of state.tasks){
    const status = taskWeeklyStatus(task, days, limit)
    if(status){ counts[status]++ }
  }
  els.pillGreen.textContent=counts.green
  els.pillYellow.textContent=counts.yellow
  els.pillRed.textContent=counts.red
  els.summaryCells.innerHTML=''
  const statuses = days.map((day,i)=> dayStatus(day, state.tasks, limit))
  statuses.forEach((status,idx)=>{
    const cell=document.createElement('div')
    cell.className='week-cell status-'+status
    cell.innerHTML=`<span>${WEEKDAY_SHORT[idx]}</span>`
    els.summaryCells.appendChild(cell)
  })
}

function renderHome(){
  const week = currentWeekStart
  const days = weekDays(week)
  const limit = limitDateForWeek(week)
  els.catGrid.innerHTML=''
  for(const c of CATS()){
    const tasks = state.tasks.filter(t=>t.cat===c.id)
    if(tasks.length===0) continue
    const statuses = days.map(day=> dayStatus(day, tasks, limit))
    const card=document.createElement('div')
    card.className='card'
    card.dataset.cat=c.id
    card.innerHTML=`
      <div class="card-head">
        <div class="dot" style="background:${c.color}"></div>
        <h3>${escapeHtml(categoryLabel(c.id))}</h3>
        <span class="status">${statusLabel(statusFromDays(statuses))}</span>
      </div>
      <div class="count">${countsForCategory(tasks, days, limit)}</div>
      <div class="cell-row">${statuses.map((s,idx)=>`<div class="week-cell status-${s}"><span>${WEEKDAY_SHORT[idx]}</span></div>`).join('')}</div>
    `
    card.addEventListener('click', ()=> openCategory(c.id, week))
    els.catGrid.appendChild(card)
  }
}

function countsForCategory(tasks, days, limit){
  const relevantDays = days.filter(day=> !isFuture(day, limit))
  const totalOcc=relevantDays.reduce((acc,day)=> acc + tasks.filter(t=>isDue(t,day)).length,0)
  const doneOcc=relevantDays.reduce((acc,day)=> acc + tasks.filter(t=>isDue(t,day) && isDone(t,day)).length,0)
  return `${doneOcc}/${totalOcc} completions`
}

function renderHistory(){
  const week = state.ui.historyWeekStart
  const days = weekDays(week)
  const limit = limitDateForWeek(week)
  els.historyLabel.textContent = `Week ${formatWeekRange(week)}`
  els.historyGrid.innerHTML=''
  for(const c of CATS()){
    const tasks = state.tasks.filter(t=>t.cat===c.id)
    if(tasks.length===0) continue
    const statuses = days.map(day=> dayStatus(day, tasks, limit))
    const card=document.createElement('div')
    card.className='card'
    card.innerHTML=`
      <div class="card-head">
        <div class="dot" style="background:${c.color}"></div>
        <h3>${escapeHtml(categoryLabel(c.id))}</h3>
        <span class="status">${statusLabel(statusFromDays(statuses))}</span>
      </div>
      <div class="count">${countsForCategory(tasks, days, limit)}</div>
      <div class="cell-row">${statuses.map((s,idx)=>`<div class="week-cell status-${s}"><span>${WEEKDAY_SHORT[idx]}</span></div>`).join('')}</div>
    `
    card.addEventListener('click', ()=> openCategory(c.id, week))
    els.historyGrid.appendChild(card)
  }
  const canGoNext = compareDate(week, currentWeekStart)<0
  els.historyNext.disabled = !canGoNext
}

function renderCategory(cat, week){
  state.ui.currentCat = cat
  state.ui.categoryWeekStart = week
  save()
  const tasks = state.tasks.filter(t=>t.cat===cat)
  els.catTitle.textContent = categoryLabel(cat)
  els.catWeek.textContent = formatWeekRange(week)
  const days = weekDays(week)
  const limit = limitDateForWeek(week)
  els.taskList.innerHTML=''
  if(tasks.length===0){
    els.taskList.innerHTML='<p class="count">Add an activity to this category.</p>'
    return
  }
  tasks.sort((a,b)=> (a.importance>b.importance?1:-1) || a.title.localeCompare(b.title))
  for(const task of tasks){
    const row=document.createElement('div')
    row.className='task'
    const badges = [`${task.importance==='must'?'Must do':'Nice to have'}`, recurLabel(task.recur)]
    row.innerHTML=`
      <div class="task-header">
        <span class="em">${escapeHtml(task.emoji||'ğŸ¯')}</span>
        <div>
          <div class="title">${escapeHtml(task.title)}</div>
          <div class="badges">${badges.map(b=>`<span>${escapeHtml(b)}</span>`).join('')}</div>
        </div>
        <div class="task-actions">
          <button type="button" data-act="edit">âœï¸ Edit</button>
        </div>
      </div>
      <div class="task-week"></div>
    `
    const weekRow = row.querySelector('.task-week')
    days.forEach((day,idx)=>{
      const status = dayStatusForTask(task, day, limit)
      const cell=document.createElement('button')
      cell.type='button'
      cell.className='week-cell status-'+status
      cell.dataset.day=day
      cell.dataset.task=task.id
      cell.textContent=WEEKDAY_SHORT[idx]
      const clickable = (status==='green' || status==='yellow' || status==='red')
      if(clickable){
        cell.classList.add('clickable')
        cell.addEventListener('click', ()=>{ toggleDone(task, day); refreshAll() })
      }else{
        cell.classList.add('disabled')
      }
      weekRow.appendChild(cell)
    })
    row.querySelector('[data-act=edit]').addEventListener('click', ()=> openTaskDialog('edit', task))
    els.taskList.appendChild(row)
  }
}

function refreshAll(){
  renderSummary()
  renderHome()
  renderHistory()
  if(state.ui.currentView==='category' && state.ui.currentCat){ renderCategory(state.ui.currentCat, state.ui.categoryWeekStart) }
}

function changeHistoryWeek(delta){
  const current = state.ui.historyWeekStart
  const newWeek = addDays(current, delta*7)
  if(delta>0 && compareDate(newWeek, currentWeekStart)>0) return
  state.ui.historyWeekStart = newWeek
  save()
  renderHistory()
}

function onRecurChange(){
  const v = els.f_recur.value
  els.specificWrap.style.display = v==='specific' ? 'block' : 'none'
  els.weeklyWrap.style.display = v==='weekly' ? 'block' : 'none'
}

function initSpecificDayPicker(){
  els.specificDays.innerHTML=''
  WEEKDAY_ORDER.forEach(day=>{
    const label=WEEKDAY_SHORT[(day+6)%7]
    const wrapper=document.createElement('label')
    wrapper.innerHTML=`<input type="checkbox" value="${day}">${label}`
    els.specificDays.appendChild(wrapper)
  })
}

function updateEmojiResults(){
  const q = els.emojiSearch.value.trim().toLowerCase()
  const list = q? EMOJIS.filter(e=> e.tags.some(t=>t.includes(q))): EMOJIS.slice(0,30)
  els.emojiResults.innerHTML=''
  list.forEach(e=>{
    const btn=document.createElement('button')
    btn.type='button'
    btn.textContent=e.char
    btn.addEventListener('click', ()=>{ els.f_emoji.value=e.char; els.f_emoji.focus() })
    els.emojiResults.appendChild(btn)
  })
}

function populateCategorySelect(selected){
  if(!els.f_cat) return
  const cats = CATS()
  els.f_cat.innerHTML = cats.map(c=>`<option value="${c.id}">${escapeHtml(categoryLabel(c.id))}</option>`).join('')
  if(selected && !cats.some(c=>c.id===selected)){
    const opt=document.createElement('option')
    opt.value=selected
    opt.textContent=categoryLabel(selected)
    els.f_cat.appendChild(opt)
  }
  if(selected){ els.f_cat.value=selected }
  if(!els.f_cat.value && els.f_cat.options.length>0){ els.f_cat.value = els.f_cat.options[0].value }
}

function openCategory(cat, week){
  state.ui.categoryWeekStart = week
  state.ui.currentCat = cat
  save()
  updateView('category')
}

function openTaskDialog(mode, task){
  els.taskDialog.returnValue=''
  els.taskDialog.showModal()
  els.deleteTask.style.display = mode==='edit' ? 'inline-flex' : 'none'
  els.dialogTitle.textContent = mode==='edit' ? 'Edit activity' : 'New activity'
  state.ui.editTaskId = mode==='edit' ? task.id : null
  const cats = CATS()
  let selectedCat = mode==='edit' && task ? task.cat : state.ui.currentCat
  if(!selectedCat || !cats.some(c=>c.id===selectedCat)){
    selectedCat = cats[0]?.id || ''
  }
  populateCategorySelect(selectedCat)
  if(mode==='edit' && task){
    els.f_title.value = task.title
    els.f_emoji.value = task.emoji || ''
    els.f_cat.value = task.cat
    els.f_importance.value = task.importance
    if(task.recur.type==='daily'){ els.f_recur.value='daily' }
    else if(task.recur.type==='specific'){ els.f_recur.value='specific' }
    else { els.f_recur.value='weekly'; els.f_weekday.value = String(task.recur.weekday ?? 1) }
    onRecurChange()
    const boxes=[...els.specificDays.querySelectorAll('input')]
    boxes.forEach(box=>{ box.checked = task.recur.type==='specific' ? task.recur.days.includes(+box.value) : false })
  }else{
    els.f_title.value=''
    els.f_emoji.value=''
    els.f_cat.value = selectedCat || ''
    els.f_importance.value='must'
    els.f_recur.value='daily'
    els.f_weekday.value='1'
    onRecurChange()
    els.specificDays.querySelectorAll('input').forEach(input=> input.checked=false)
  }
  updateEmojiResults()
}

function submitTask(e){
  e.preventDefault()
  const title = els.f_title.value.trim()
  if(!title) return
  const emoji = els.f_emoji.value.trim() || 'ğŸ¯'
  const cat = els.f_cat.value
  const importance = els.f_importance.value
  const freq = els.f_recur.value
  if(!cat){ alert('Pick a category'); return }
  let recur
  if(freq==='daily') recur = {type:'daily'}
  if(freq==='specific'){
    const days = [...els.specificDays.querySelectorAll('input:checked')].map(i=> +i.value)
    if(days.length===0){ alert('Select at least one day'); return }
    recur = {type:'specific', days}
  }
  if(freq==='weekly'){ recur = {type:'weekly', weekday:+els.f_weekday.value} }
  const nowWeek = todayISO()
  if(state.ui.editTaskId){
    const task = state.tasks.find(t=>t.id===state.ui.editTaskId)
    if(task){
      task.title=title
      task.emoji=emoji
      task.cat=cat
      task.importance=importance
      task.recur=recur
    }
  }else{
    state.tasks.push({id:uid(), cat, title, emoji, importance, recur, createdAt:nowWeek})
  }
  save()
  els.taskDialog.close()
  refreshAll()
}

function deleteCurrentTask(){
  if(!state.ui.editTaskId) return
  const idx = state.tasks.findIndex(t=>t.id===state.ui.editTaskId)
  if(idx>=0){ state.tasks.splice(idx,1) }
  for(const day in state.done){ if(state.done[day]) delete state.done[day][state.ui.editTaskId] }
  state.ui.editTaskId=null
  save()
  els.taskDialog.close()
  refreshAll()
}

function taskWeeklyStatus(task, days, limit){
  const dueDays = days.filter(day=> !isFuture(day, limit) && isDue(task, day))
  if(dueDays.length===0) return null
  const missing = dueDays.filter(day=> !isDone(task, day))
  if(missing.length===0) return 'green'
  return task.importance==='must' ? 'red' : 'yellow'
}

function dayStatus(day, tasks, limit){
  if(isFuture(day, limit)) return 'future'
  const due = tasks.filter(t=>isDue(t, day))
  if(due.length===0) return 'off'
  const missing = due.filter(t=>!isDone(t, day))
  if(missing.length===0) return 'green'
  const hasMust = missing.some(t=>t.importance==='must')
  return hasMust ? 'red' : 'yellow'
}

function dayStatusForTask(task, day, limit){
  if(isFuture(day, limit)) return 'future'
  if(!isDue(task, day)) return 'off'
  return isDone(task, day) ? 'green' : (task.importance==='must' ? 'red':'yellow')
}

function statusLabel(status){
  if(status==='green') return 'ğŸŸ© On track'
  if(status==='yellow') return 'ğŸŸ¨ Needs attention'
  if(status==='red') return 'ğŸŸ¥ Catch up'
  return 'â¬œ Upcoming'
}

function statusFromDays(days){
  if(days.every(s=>s==='off' || s==='future' || s==='green')){
    if(days.some(s=>s==='green')) return 'green'
    return 'future'
  }
  if(days.some(s=>s==='red')) return 'red'
  if(days.some(s=>s==='yellow')) return 'yellow'
  return 'green'
}

function isDue(task, ymd){
  const d = new Date(ymd+'T00:00:00')
  const w = d.getDay()
  if(task.recur.type==='daily') return true
  if(task.recur.type==='weekly') return w === (task.recur.weekday ?? 1)
  if(task.recur.type==='specific') return task.recur.days.includes(w)
  if(task.recur.type==='everyX'){ // fallback legacy
    const anchor = new Date((task.recur.anchor||task.createdAt)+'T00:00:00')
    const diff = Math.floor((d-anchor)/86400000)
    return diff>=0 && diff % (task.recur.interval||3)===0
  }
  return false
}

function isDone(task, ymd){ return !!(state.done[ymd] && state.done[ymd][task.id]) }
function toggleDone(task, ymd){
  state.done[ymd] = state.done[ymd] || {}
  if(isDone(task, ymd)){
    delete state.done[ymd][task.id]
    if(Object.keys(state.done[ymd]).length===0){ delete state.done[ymd] }
  }else{
    state.done[ymd][task.id] = true
  }
  save()
}

function recurLabel(r){
  if(r.type==='daily') return 'Daily'
  if(r.type==='weekly') return 'Weekly'
  if(r.type==='specific'){
    return 'Days: '+ r.days.map(d=> WEEKDAY_SHORT[(d+6)%7]).join(', ')
  }
  if(r.type==='everyX') return `Every ${r.interval} days`
  return ''
}

function categoryLabel(id){
  const map={
    Fitness:'Fitness',
    Nutrition:'Nutrition',
    Rest:'Rest',
    Connection:'Connection',
    Learning:'Learning',
    Leisure:'Leisure'
  }
  return map[id] || id
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }

function CATS(){
  return [
    {id:'Fitness', color:getComputedStyle(document.documentElement).getPropertyValue('--cat-Fitness').trim()},
    {id:'Nutrition', color:getComputedStyle(document.documentElement).getPropertyValue('--cat-Nutrition').trim()},
    {id:'Rest', color:getComputedStyle(document.documentElement).getPropertyValue('--cat-Rest').trim()},
    {id:'Connection', color:getComputedStyle(document.documentElement).getPropertyValue('--cat-Connection').trim()},
    {id:'Learning', color:getComputedStyle(document.documentElement).getPropertyValue('--cat-Learning').trim()},
    {id:'Leisure', color:getComputedStyle(document.documentElement).getPropertyValue('--cat-Leisure').trim()},
  ]
}

function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)) }
function load(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)) }catch(e){return null}}

function seed(){
  const today = todayISO()
  const mk=(cat,title,emoji,importance,recur)=>({id:uid(),cat,title,emoji,importance,recur,createdAt:today})
  const S=[]
  S.push(mk('Fitness','5 min warm-up','ğŸ¤¸','nice',{type:'daily'}))
  S.push(mk('Fitness','20 min cardio','ğŸƒ','must',{type:'specific',days:[1,3,5]}))
  S.push(mk('Fitness','15 min strength','ğŸ’ª','must',{type:'specific',days:[2,4]}))
  S.push(mk('Fitness','Post-session stretches','ğŸ§˜','nice',{type:'daily'}))
  S.push(mk('Fitness','Bike ride','ğŸš²','nice',{type:'specific',days:[6]}))

  S.push(mk('Nutrition','Protein breakfast','ğŸ³','must',{type:'daily'}))
  S.push(mk('Nutrition','2 fresh fruits','ğŸ','nice',{type:'daily'}))
  S.push(mk('Nutrition','Drink 1.5L water','ğŸ’§','must',{type:'daily'}))
  S.push(mk('Nutrition','Veggie meal','ğŸ¥—','nice',{type:'specific',days:[1,4]}))
  S.push(mk('Nutrition','Fish meal','ğŸŸ','nice',{type:'specific',days:[5]}))

  S.push(mk('Rest','In bed before 11pm','ğŸ›ï¸','must',{type:'daily'}))
  S.push(mk('Rest','Screen off 1h before bed','ğŸ“µ','nice',{type:'daily'}))
  S.push(mk('Rest','20 min nap','ğŸ˜´','nice',{type:'specific',days:[1,4]}))
  S.push(mk('Rest','Calm breathing','ğŸŒ¬ï¸','nice',{type:'specific',days:[2,5]}))
  S.push(mk('Rest','Air out bedroom','ğŸªŸ','nice',{type:'daily'}))

  S.push(mk('Connection','Message a loved one','ğŸ’¬','nice',{type:'specific',days:[2,4]}))
  S.push(mk('Connection','Call family','ğŸ“','must',{type:'weekly',weekday:0}))
  S.push(mk('Connection','Shared lunch','ğŸ½ï¸','nice',{type:'specific',days:[3]}))
  S.push(mk('Connection','Give a sincere compliment','ğŸ¤','nice',{type:'daily'}))
  S.push(mk('Connection','Social outing','ğŸ•º','must',{type:'specific',days:[5]}))

  S.push(mk('Learning','Read for 15 min','ğŸ“š','nice',{type:'daily'}))
  S.push(mk('Learning','Online course','ğŸ’»','must',{type:'specific',days:[1,3]}))
  S.push(mk('Learning','Review vocabulary','ğŸ—‚ï¸','nice',{type:'specific',days:[2,5]}))
  S.push(mk('Learning','Practice language','ğŸ—£ï¸','nice',{type:'specific',days:[4]}))
  S.push(mk('Learning','Learning journal','ğŸ“','nice',{type:'weekly',weekday:6}))

  S.push(mk('Leisure','Drawing session','ğŸ¨','nice',{type:'specific',days:[6]}))
  S.push(mk('Leisure','Play music','ğŸ¸','nice',{type:'specific',days:[2,5]}))
  S.push(mk('Leisure','Game night','ğŸ²','nice',{type:'specific',days:[5]}))
  S.push(mk('Leisure','Nature outing','ğŸŒ³','nice',{type:'specific',days:[6]}))
  S.push(mk('Leisure','Watch a show','ğŸ“º','nice',{type:'daily'}))

  return {tasks:S, done:{}, ui:{currentView:'home', historyWeekStart:currentWeekStart, categoryWeekStart:currentWeekStart, currentCat:null}}
}
</script>
</body>
</html>
